---
title: "HCL Overnight Analysis"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(tools)
library(arsenal)
library(cgmanalysis)
library(car)
library(skimr)
library(Hmisc)
library(knitr)
library(lmerTest)
library(nlme)
library(performance)
library(MASS)
library(tidyverse)
library(broom)
library(broom.mixed)
library(emmeans)
knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "B:/Projects"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
}
knitr::opts_knit$set(root.dir = home_dir)
```

```{r echo=FALSE,include=FALSE}
# Import Cari's data
source("~/GitHub/BDC-Code/Erin Cobry/Nocturnal Alarms/AdvancedClosedLoopCl_R_2020-01-05_1101.r")
# Demographics
demographics <- data %>% 
  filter(redcap_event_name %in% c("baseline_arm_1","baseline_arm_2"),
         !is.na(child_ya))
# remove missing
no_data <- c("27","30","38","41")
demographics <- demographics[-c(which(demographics$record_id %in% no_data)),]
# Manually corrected a few dates in CSV file.
# Read in (manually converted to long format from Erin's Excel spreadsheet)
overnight_alarms <- read.csv("./Erin Cobry/Nocturnal Alarms/Data_Cleaned/nocturnal_alarms.csv",
                             na.strings = c("","No Data"))
overnight_alarms = overnight_alarms[overnight_alarms$num_nights > 0,]
# Match IDs and filter
dates = read.csv("./Erin Cobry/Nocturnal Alarms/Data_Cleaned/subject_dates.csv")
overnight_alarms$id = dates$id[match(gsub(" ","",overnight_alarms$id),tolower(gsub(" ","",dates$name)))]
overnight_alarms <- overnight_alarms %>% filter(!(id %in% no_data))
# Format date columns
overnight_alarms[,c("start_date","end_date")] <- 
  lapply(overnight_alarms[,c("start_date","end_date")], 
         function(x) {lubridate::mdy(as.character(x))})
# Numeric timepoints in months
overnight_alarms$numeric_time <- 
  car::recode(overnight_alarms$timepoint,
              "'Baseline' = 0;'Post' = 0.5;'T1' = 3;'T2' = 6;'T3' = 9;'T4' = 12")
overnight_alarms$numeric_time <- 
  as.numeric(as.character(overnight_alarms$numeric_time))
# Alarms per day
alarm_vars = c("num_alarms","threshold_alarms","maintenance_alarms","hcl_alarms",
               "pump_alarms","other_alarms")
overnight_alarms = overnight_alarms %>%
  mutate(across(all_of(alarm_vars),.fns = ~./num_nights,.names = "{col}_per_night"))
 # Get Erin's participants 
demographics <- demographics[which(demographics$record_id %in% overnight_alarms$id),]
# Combine CGM and pump hx levels
levels(demographics$demographics_cgmhx.factor) <-
  c("< 1 month","> 1 month","> 1 month","> 1 month","> 1 month","> 1 month")
levels(demographics$demographics_pumphx.factor) <-
  c("< 1 month","> 1 month","> 1 month","> 1 month","> 1 month","> 1 month")
```

# Descriptive Characteristics

```{r echo=FALSE,results='asis'}
# Labels
labels <- list(demographics_t1d_duration = "Diabetes Dur. (years)", 
               demographics_ethnicity.factor = "Ethnicity",
               demographics_sex.factor = "Sex",
               demographics_cgmhx.factor = "CGM History", 
               demographics_pumphx.factor = "Pump History")
# Table 1
t1 <- tableby(~ hba1c + kwt(demographics_age,"median","q1q3","range") + 
                kwt(demographics_t1d_duration,"median","q1q3") + 
                demographics_sex.factor + demographics_ethnicity.factor +
                demographics_cgmhx.factor + demographics_pumphx.factor,
              data = demographics)
# Print
summary(t1,labelTranslations = labels)
```

```{r echo=FALSE,include=FALSE}
# Read in CGM data
cgm <- read.csv("./Erin Cobry/Nocturnal Alarms/Data_Cleaned/cgm_variables.csv",stringsAsFactors = F)
# ID and timepoint
cgm$id <- as.numeric(gsub("[[:alpha:]]","",sapply(strsplit(cgm$subject_id,"_"),`[[`,1)))
cgm$timepoint <- sapply(strsplit(cgm$subject_id,"_"),`[[`,2)
cgm$timepoint[cgm$timepoint == "week 2"] = "Post"
# Select columns
cgm <- cgm %>% select(id,timepoint,nighttime_avg_sens_glucose,
                      percent_time_70_180_night,percent_time_under_70_night)
# Merge
overnight_alarms <- left_join(overnight_alarms,cgm,by = c("id","timepoint"))
# Read in corrected AM data
am_correct <- read.csv("./Erin Cobry/Nocturnal Alarms/Data_Cleaned/REDCap AM Data.csv")
am_correct$timepoint[am_correct$timepoint == "week 2"] = "Post"
# Add to overnight alarms
overnight_alarms <- left_join(overnight_alarms,am_correct,by = c("id", "timepoint"))
# Order timepoints
overnight_alarms$timepoint <- factor(overnight_alarms$timepoint,
                                     levels = c("Baseline","Post","T1","T2","T3","T4" ))
levels(overnight_alarms$timepoint) <- c("Baseline","Week 2",
                                        "T1","T2","T3","T4" )
overnight_alarms = overnight_alarms %>% arrange(id,timepoint)
# Remove discontinuers
discont = overnight_alarms %>% group_by(id) %>% 
  summarise(discont = any(sensor_wear <= 10,na.rm = T)) %>%
  filter(discont == T) %>% .$id
```

Discontinuers were defined as any participant who had $\leq$ 10% sensor wear at any timepoint. These participants were excluded from all models below. 

# Longitudinal Analysis

```{r echo=FALSE}
overnight_alarms = overnight_alarms %>% filter(!id %in% discont)
```

All alarms were analyzed using a linear mixed model with random intercept for participant and continuous AR1 correlation structure. All other outcomes were analyzed using a generalized Poisson mixed model with random intercept for subject and continuous AR1 correlation structure.

## Alarms per Night By Timepoint

### Model Results - Unadjusted

#### Comparison to Baseline

```{r echo=FALSE,message=FALSE}
# Random intercept (not enough data for a random slope)
mod_ri_car1 <- lme(num_alarms_per_night ~ timepoint,random = ~1|id,
                   data = overnight_alarms,correlation = corCAR1(form = ~numeric_time))
results <- tidy(mod_ri_car1,effects = "fixed",conf.int = T)
results$term <- sub("timepoint","",results$term)
results$p.value <- format.pval(results$p.value,eps = 0.001,digits = 2)
# Anova
an_res <- as.data.frame(Anova(mod_ri_car1,type = 3))
# Print
kable(results[,c("term","estimate","conf.low","conf.high","p.value")],digits = 2)
```

There was a statistically significant effect of timepoint on the rate of alarms per night (overall p = `r round(an_res["timepoint",3],3)`).

#### Mean at Each Timepoint

```{r echo=FALSE}
emm1 = emmeans(mod_ri_car1,~timepoint)
means = data.frame(emm1)
kable(means,digits = 2)
means$numeric_time = c(0,0.5,3,6,9,12)
```

#### Comparison to week 2

```{r echo=FALSE}
base = c(1,0,0,0,0,0)
w2 = c(0,1,0,0,0,0)
t1 = c(0,0,1,0,0,0)
t2 = c(0,0,0,1,0,0)
t3 = c(0,0,0,0,1,0)
t4 = c(0,0,0,0,0,1)
con = contrast(emm1,method = list("Baseline to Week 2"= w2 - base,
                            "Week 2 to T1"=t1 - w2,
                            "Week 2 to T2"=t2 - w2,
                            "Week 2 to T3"=t3 - w2,
                            "Week 2 to T4"=t4 - w2))
kable(con,digits = 2)
```

### Alarms per Night Over Time

```{r echo=FALSE,warning=FALSE,dpi=600}
alarms_over_time <- 
  ggplot(overnight_alarms,aes(x = numeric_time, y = num_alarms_per_night,group = id)) + 
  geom_line(alpha=0.1) + 
  geom_line(data=means,aes(x=numeric_time,y=as.numeric(emmean),group=1),
            size = 1,inherit.aes = F) + 
  theme_bw() +xlab("Timepoint") + ylab("Alarms per Night") + 
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust=1)) +
  scale_x_continuous(breaks=c(0,0.5,3,6,9,12),
                   labels=c("Baseline","Week 2","3 Month","6 Month","9 Month","12 Month"))
alarms_over_time
```

### Model Results - Adjusted for Time in AM

```{r echo=FALSE,message=FALSE}
# Random intercept (not enough data for a random slope)
mod_ri_car1 = lme(num_alarms_per_night ~ timepoint + time_am,random = ~1|id,na.action = na.omit,
                   data = overnight_alarms,correlation = corCAR1(form = ~numeric_time))
results <- tidy(mod_ri_car1,effects = "fixed",conf.int = T)
results$term <- c("(Intercept)","Week 2","T1","T2","T3","T4","% Time in AM" )
results$p.value <- format.pval(results$p.value,eps = 0.001,digits = 2)
# Anova
an_res <- as.data.frame(Anova(mod_ri_car1,type = 3))
# Print
kable(results[,c("term","estimate","conf.low","conf.high","p.value")],digits = 2)

```

There was no effect of timepoint on the rate of alarms per night after adjusting for time in AM (overall p = `r round(an_res["timepoint",3],3)`). There was a statistically significant effect of time in AM on the rate of alarms per night (overall p = `r round(an_res["time_am",3],3)`).

#### LS Mean at Each Timepoint

```{r echo=FALSE}
emm1 = emmeans(mod_ri_car1,~timepoint)
means = data.frame(emm1)
kable(means,digits = 2)
means$numeric_time = c(0,0.5,3,6,9,12)
```

#### Comparison to week 2

```{r echo=FALSE}
base = c(1,0,0,0,0,0)
w2 = c(0,1,0,0,0,0)
t1 = c(0,0,1,0,0,0)
t2 = c(0,0,0,1,0,0)
t3 = c(0,0,0,0,1,0)
t4 = c(0,0,0,0,0,1)
con = contrast(emm1,method = list("Baseline to Week 2"= w2 - base,
                            "Week 2 to T1"=t1 - w2,
                            "Week 2 to T2"=t2 - w2,
                            "Week 2 to T3"=t3 - w2,
                            "Week 2 to T4"=t4 - w2))
kable(con,digits = 2)
```

### Model Results - Adjusted for Sensor Wear

```{r echo=FALSE,message=FALSE}
# Random intercept (not enough data for a random slope)
mod_ri_car1 = lme(num_alarms_per_night ~ timepoint + sensor_wear,random = ~1|id,
                  na.action = na.omit,data = overnight_alarms,
                  correlation = corCAR1(form = ~numeric_time))
results <- tidy(mod_ri_car1,effects = "fixed",conf.int = T)
results$term <- c("(Intercept)","Week 2","T1","T2","T3","T4","% Sensor Wear" )
results$p.value <- format.pval(results$p.value,eps = 0.001,digits = 2)
# Anova
an_res <- as.data.frame(Anova(mod_ri_car1,type = 3))
# Print
kable(results[,c("term","estimate","conf.low","conf.high","p.value")],digits = 2)

```

There was a significant effect of timepoint on the rate of alarms per night after adjusting for sensor wear (overall p = `r round(an_res["timepoint",3],3)`). There was not a statistically significant effect of sensor wear on the rate of alarms per night (overall p = `r round(an_res["sensor_wear",3],3)`).

#### LS Mean at Each Timepoint

```{r echo=FALSE}
emm1 = emmeans(mod_ri_car1,~timepoint)
means = data.frame(emm1)
kable(means,digits = 2)
means$numeric_time = c(0,0.5,3,6,9,12)
```

#### Comparison to week 2

```{r echo=FALSE}
base = c(1,0,0,0,0,0)
w2 = c(0,1,0,0,0,0)
t1 = c(0,0,1,0,0,0)
t2 = c(0,0,0,1,0,0)
t3 = c(0,0,0,0,1,0)
t4 = c(0,0,0,0,0,1)
con = contrast(emm1,method = list("Baseline to Week 2"= w2 - base,
                            "Week 2 to T1"=t1 - w2,
                            "Week 2 to T2"=t2 - w2,
                            "Week 2 to T3"=t3 - w2,
                            "Week 2 to T4"=t4 - w2))
kable(con,digits = 2)
```

## Threshold Alarms per Night By Timepoint

### Plot

```{r echo=FALSE,warning=FALSE,dpi=600}
alarms_over_time <- 
  ggplot(overnight_alarms,aes(x = timepoint, y = threshold_alarms_per_night,group = id)) + 
  geom_line(aes(color=factor(id))) + theme_bw() + 
  xlab("Timepoint") + ylab("Threshold Alarms per Night") + 
  theme(legend.position = "none")
alarms_over_time
```

### Model Results - Unadjusted

```{r echo=FALSE,message=FALSE}
# Random intercept (not enough data for a random slope)
mod_ri_car1 = lme(threshold_alarms_per_night ~ timepoint,
                  random = ~1|id,na.action = na.omit,
                   data = overnight_alarms,
                  correlation = corCAR1(form = ~numeric_time))
results <- tidy(mod_ri_car1,effects = "fixed",conf.int = T,exponentiate = T)
results$term <- sub("timepoint","",results$term)
results[,c("estimate","conf.low","conf.high")] = 
  lapply(results[,c("estimate","conf.low","conf.high")],exp)
results$p.value <- format.pval(results$p.value,eps = 0.001,digits = 2)
# Anova
an_res <- as.data.frame(Anova(mod_ri_car1,type = 3))
# Print
kable(results[,c("term","estimate","conf.low","conf.high","p.value")],digits = 2)

```

There was a statistically significant effect of timepoint on the rate of threshold alarms per night (overall p = `r round(an_res["timepoint",3],3)`). The estimates presented above are interpreted as incidence rate ratios.

#### LS Mean at Each Timepoint

```{r echo=FALSE}
emm1 = emmeans(mod_ri_car1,~timepoint)
means = data.frame(emm1)
kable(means,digits = 2)
means$numeric_time = c(0,0.5,3,6,9,12)
```

#### Comparison to week 2

```{r echo=FALSE}
base = c(1,0,0,0,0,0)
w2 = c(0,1,0,0,0,0)
t1 = c(0,0,1,0,0,0)
t2 = c(0,0,0,1,0,0)
t3 = c(0,0,0,0,1,0)
t4 = c(0,0,0,0,0,1)
con = contrast(emm1,method = list("Baseline to Week 2"= w2 - base,
                            "Week 2 to T1"=t1 - w2,
                            "Week 2 to T2"=t2 - w2,
                            "Week 2 to T3"=t3 - w2,
                            "Week 2 to T4"=t4 - w2))
kable(con,digits = 2)
```

### Model Results - Adjusted for Time in AM

```{r echo=FALSE,message=FALSE}
# Random intercept (not enough data for a random slope)
mod_ri_car1 = lme(threshold_alarms_per_night ~ timepoint + time_am,
                  random = ~1|id,na.action = na.omit,
                   data = overnight_alarms,
                  correlation = corCAR1(form = ~numeric_time))
results <- tidy(mod_ri_car1,effects = "fixed",conf.int = T)
results$term <- c("(Intercept)","Week 2","T1","T2","T3","T4","% Time in AM" )
results$p.value <- format.pval(results$p.value,eps = 0.001,digits = 2)
results[,c("estimate","conf.low","conf.high")] = 
  lapply(results[,c("estimate","conf.low","conf.high")],exp)
# Anova
an_res <- as.data.frame(Anova(mod_ri_car1))
# Print
kable(results[,c("term","estimate","conf.low","conf.high","p.value")],digits = 2)

```

There was a significant effect of timepoint on the rate of threshold alarms per night after adjusting for time in AM (overall p = `r round(an_res["timepoint",3],3)`). There was not a  statistically significant effect of time in AM on the rate of alarms per night (overall p = `r round(an_res["time_am",3],3)`). The estimates presented above are interpreted as incidence rate ratios.

#### LS Mean at Each Timepoint

```{r echo=FALSE}
emm1 = emmeans(mod_ri_car1,~timepoint)
means = data.frame(emm1)
kable(means,digits = 2)
means$numeric_time = c(0,0.5,3,6,9,12)
```

#### Comparison to week 2

```{r echo=FALSE}
base = c(1,0,0,0,0,0)
w2 = c(0,1,0,0,0,0)
t1 = c(0,0,1,0,0,0)
t2 = c(0,0,0,1,0,0)
t3 = c(0,0,0,0,1,0)
t4 = c(0,0,0,0,0,1)
con = contrast(emm1,method = list("Baseline to Week 2"= w2 - base,
                            "Week 2 to T1"=t1 - w2,
                            "Week 2 to T2"=t2 - w2,
                            "Week 2 to T3"=t3 - w2,
                            "Week 2 to T4"=t4 - w2))
kable(con,digits = 2)
```

### Model Results - Adjusted for Sensor Wear

```{r echo=FALSE,message=FALSE}
# Random intercept (not enough data for a random slope)
mod_ri_car1 = lme(threshold_alarms_per_night ~ timepoint + sensor_wear,
                  random = ~1|id,na.action = na.omit,
                   data = overnight_alarms,
                  correlation = corCAR1(form = ~numeric_time))
results <- tidy(mod_ri_car1,effects = "fixed",conf.int = T)
results$term <- c("(Intercept)","Week 2","T1","T2","T3","T4","% Sensor Wear" )
results$p.value <- format.pval(results$p.value,eps = 0.001,digits = 2)
results[,c("estimate","conf.low","conf.high")] = 
  lapply(results[,c("estimate","conf.low","conf.high")],exp)
# Anova
an_res <- as.data.frame(Anova(mod_ri_car1))
# Print
kable(results[,c("term","estimate","conf.low","conf.high","p.value")],digits = 2)

```

There was not a significant effect of timepoint on the rate of threshold alarms per night after adjusting for sensor wear (overall p = `r round(an_res["timepoint",3],3)`). There was also not a statistically significant effect of sensor wear on the rate of alarms per night (overall p = `r round(an_res["sensor_wear",3],3)`). The estimates presented above are interpreted as incidence rate ratios.

#### LS Mean at Each Timepoint

```{r echo=FALSE}
emm1 = emmeans(mod_ri_car1,~timepoint)
means = data.frame(emm1)
kable(means,digits = 2)
means$numeric_time = c(0,0.5,3,6,9,12)
```

#### Comparison to week 2

```{r echo=FALSE}
base = c(1,0,0,0,0,0)
w2 = c(0,1,0,0,0,0)
t1 = c(0,0,1,0,0,0)
t2 = c(0,0,0,1,0,0)
t3 = c(0,0,0,0,1,0)
t4 = c(0,0,0,0,0,1)
con = contrast(emm1,method = list("Baseline to Week 2"= w2 - base,
                            "Week 2 to T1"=t1 - w2,
                            "Week 2 to T2"=t2 - w2,
                            "Week 2 to T3"=t3 - w2,
                            "Week 2 to T4"=t4 - w2))
kable(con,digits = 2)
```

## Maintenance Alarms per Night By Timepoint

### Plot

```{r echo=FALSE,warning=FALSE,dpi=600}
alarms_over_time <- 
  ggplot(overnight_alarms,aes(x = timepoint, y = maintenance_alarms_per_night,group = id)) + 
  geom_line(aes(color=factor(id))) + theme_bw() + 
  xlab("Timepoint") + ylab("Maintenance Alarms per Night") + 
  theme(legend.position = "none")
alarms_over_time
```

### Model Results - Unadjusted

```{r echo=FALSE,message=FALSE}
# Random intercept (not enough data for a random slope)
mod_ri_car1 = lme(maintenance_alarms_per_night ~ timepoint,
                  random = ~1|id,na.action = na.omit,
                   data = overnight_alarms,
                  correlation = corCAR1(form = ~numeric_time))
results <- tidy(mod_ri_car1,effects = "fixed",conf.int = T)
results$term <- sub("timepoint","",results$term)
results$p.value <- format.pval(results$p.value,eps = 0.001,digits = 2)

# Anova
an_res <- as.data.frame(Anova(mod_ri_car1,type = 3))
# Print
kable(results[,c("term","estimate","conf.low","conf.high","p.value")],digits = 2)

```

There was an effect of timepoint on the rate of maintenance alarms per night (overall p = `r round(an_res["timepoint",3],3)`). The estimates presented above are interpreted as incidence rate ratios.

#### LS Mean at Each Timepoint

```{r echo=FALSE}
emm1 = emmeans(mod_ri_car1,~timepoint)
means = data.frame(emm1)
kable(means,digits = 2)
means$numeric_time = c(0,0.5,3,6,9,12)
```

#### Comparison to week 2

```{r echo=FALSE}
base = c(1,0,0,0,0,0)
w2 = c(0,1,0,0,0,0)
t1 = c(0,0,1,0,0,0)
t2 = c(0,0,0,1,0,0)
t3 = c(0,0,0,0,1,0)
t4 = c(0,0,0,0,0,1)
con = contrast(emm1,method = list("Baseline to Week 2"= w2 - base,
                            "Week 2 to T1"=t1 - w2,
                            "Week 2 to T2"=t2 - w2,
                            "Week 2 to T3"=t3 - w2,
                            "Week 2 to T4"=t4 - w2))
kable(con,digits = 2)
```

### Model Results - Adjusted for Time in AM

```{r echo=FALSE,message=FALSE}
# Random intercept (not enough data for a random slope)
mod_ri_car1 = lme(maintenance_alarms_per_night ~ timepoint + time_am,
                  random = ~1|id,na.action = na.omit,
                   data = overnight_alarms,
                  correlation = corCAR1(form = ~numeric_time))
results <- tidy(mod_ri_car1,effects = "fixed",conf.int = T)
results$term <- c("(Intercept)","Week 2","T1","T2","T3","T4","% Time in AM" )
results$p.value <- format.pval(results$p.value,eps = 0.001,digits = 2)

# Anova
an_res <- as.data.frame(Anova(mod_ri_car1,type = 3))
# Print
kable(results[,c("term","estimate","conf.low","conf.high","p.value")],digits = 2)

```

There was an effect of timepoint on the rate of maintenance alarms per night after adjusting for time in AM (overall p = `r round(an_res["timepoint",3],3)`). There was also an effect of time in AM on the rate of alarms per night (overall p = `r round(an_res["time_am",3],3)`). The estimates presented above are interpreted as incidence rate ratios.

#### LS Mean at Each Timepoint

```{r echo=FALSE}
emm1 = emmeans(mod_ri_car1,~timepoint)
means = data.frame(emm1)
kable(means,digits = 2)
means$numeric_time = c(0,0.5,3,6,9,12)
```

#### Comparison to week 2

```{r echo=FALSE}
base = c(1,0,0,0,0,0)
w2 = c(0,1,0,0,0,0)
t1 = c(0,0,1,0,0,0)
t2 = c(0,0,0,1,0,0)
t3 = c(0,0,0,0,1,0)
t4 = c(0,0,0,0,0,1)
con = contrast(emm1,method = list("Baseline to Week 2"= w2 - base,
                            "Week 2 to T1"=t1 - w2,
                            "Week 2 to T2"=t2 - w2,
                            "Week 2 to T3"=t3 - w2,
                            "Week 2 to T4"=t4 - w2))
kable(con,digits = 2)
```

### Model Results - Adjusted for Sensor Wear

Model would not converge.

```{r echo=FALSE,message=FALSE,eval=FALSE}
# Random intercept (not enough data for a random slope)
mod_ri_car1 = lme(maintenance_alarms_per_night ~ timepoint + sensor_wear,
                  random = ~1|id,na.action = na.omit,
                   data = overnight_alarms,
                  correlation = corCAR1(form = ~numeric_time))
results <- tidy(mod_ri_car1,effects = "fixed",conf.int = T)
results$term <- c("(Intercept)","Week 2","T1","T2","T3","T4","% Time in AM" )
results$p.value <- format.pval(results$p.value,eps = 0.001,digits = 2)

# Anova
an_res <- as.data.frame(Anova(mod_ri_car1,type = 3))
# Print
kable(results[,c("term","estimate","conf.low","conf.high","p.value")],digits = 2)

```

## HCL Alarms per Night By Timepoint

### Plot

```{r echo=FALSE,warning=FALSE,dpi=600}
alarms_over_time <- 
  ggplot(overnight_alarms,aes(x = timepoint, y = hcl_alarms_per_night,group = id)) + 
  geom_line(aes(color=factor(id))) + theme_bw() + 
  xlab("Timepoint") + ylab("HCL Alarms per Night") + 
  theme(legend.position = "none")
alarms_over_time
```

### Model Results - Unadjusted

```{r echo=FALSE,message=FALSE}
# Random intercept (not enough data for a random slope)
mod_ri_car1 = lme(hcl_alarms_per_night ~ timepoint,
                  random = ~1|id,na.action = na.omit,
                   data = overnight_alarms,
                  correlation = corCAR1(form = ~numeric_time))
results <- tidy(mod_ri_car1,effects = "fixed",conf.int = T)
results$term <- sub("timepoint","",results$term)
results$p.value <- format.pval(results$p.value,eps = 0.001,digits = 2)

# Anova
an_res <- as.data.frame(Anova(mod_ri_car1))
# Print
kable(results[,c("term","estimate","conf.low","conf.high","p.value")],digits = 2)
```

There was a significant effect of timepoint on the rate of HCL alarms per night (overall p < 0.001). The estimates presented above are interpreted as incidence rate ratios.

#### LS Mean at Each Timepoint

```{r echo=FALSE}
emm1 = emmeans(mod_ri_car1,~timepoint)
means = data.frame(emm1)
kable(means,digits = 2)
means$numeric_time = c(0,0.5,3,6,9,12)
```

#### Comparison to week 2

```{r echo=FALSE}
base = c(1,0,0,0,0,0)
w2 = c(0,1,0,0,0,0)
t1 = c(0,0,1,0,0,0)
t2 = c(0,0,0,1,0,0)
t3 = c(0,0,0,0,1,0)
t4 = c(0,0,0,0,0,1)
con = contrast(emm1,method = list("Baseline to Week 2"= w2 - base,
                            "Week 2 to T1"=t1 - w2,
                            "Week 2 to T2"=t2 - w2,
                            "Week 2 to T3"=t3 - w2,
                            "Week 2 to T4"=t4 - w2))
kable(con,digits = 2)
```

### Model Results - Adjusted for Time in AM

```{r echo=FALSE,message=FALSE}
# Random intercept (not enough data for a random slope)
mod_ri_car1 = lme(hcl_alarms_per_night ~ timepoint + time_am,
                  random = ~1|id,na.action = na.omit,
                   data = overnight_alarms,
                  correlation = corCAR1(form = ~numeric_time))
results <- tidy(mod_ri_car1,effects = "fixed",conf.int = T)
results$term <- c("(Intercept)","Week 2","T1","T2","T3","T4","% Time in AM" )
results$p.value <- format.pval(results$p.value,eps = 0.001,digits = 2)

# Anova
an_res <- as.data.frame(Anova(mod_ri_car1,type = 3))
# Print
kable(results[,c("term","estimate","conf.low","conf.high","p.value")],digits = 2)

```

There was an effect of timepoint on the rate of maintenance alarms per night after adjusting for time in AM (overall p = `r round(an_res["timepoint",3],3)`). There was also an effect of time in AM on the rate of alarms per night (overall p = `r round(an_res["time_am",3],3)`). The estimates presented above are interpreted as incidence rate ratios.

#### LS Mean at Each Timepoint

```{r echo=FALSE}
emm1 = emmeans(mod_ri_car1,~timepoint)
means = data.frame(emm1)
kable(means,digits = 2)
means$numeric_time = c(0,0.5,3,6,9,12)
```

#### Comparison to week 2

```{r echo=FALSE}
base = c(1,0,0,0,0,0)
w2 = c(0,1,0,0,0,0)
t1 = c(0,0,1,0,0,0)
t2 = c(0,0,0,1,0,0)
t3 = c(0,0,0,0,1,0)
t4 = c(0,0,0,0,0,1)
con = contrast(emm1,method = list("Baseline to Week 2"= w2 - base,
                            "Week 2 to T1"=t1 - w2,
                            "Week 2 to T2"=t2 - w2,
                            "Week 2 to T3"=t3 - w2,
                            "Week 2 to T4"=t4 - w2))
kable(con,digits = 2)
```

### Model Results - Adjusted for Sensor Wear

```{r echo=FALSE,message=FALSE}
# Random intercept (not enough data for a random slope)
mod_ri_car1 = lme(hcl_alarms_per_night ~ timepoint + sensor_wear,
                  random = ~1|id,na.action = na.omit,
                   data = overnight_alarms,
                  correlation = corCAR1(form = ~numeric_time))
results <- tidy(mod_ri_car1,effects = "fixed",conf.int = T)
results$term <- c("(Intercept)","Week 2","T1","T2","T3","T4","% Time in AM" )
results$p.value <- format.pval(results$p.value,eps = 0.001,digits = 2)

# Anova
an_res <- as.data.frame(Anova(mod_ri_car1))
# Print
kable(results[,c("term","estimate","conf.low","conf.high","p.value")],digits = 2)

```

There was a significant effect of timepoint on the rate of HCL alarms per night after adjusting for time in AM (overall p = `r round(an_res["timepoint",3],3)`). There was also a significant effect of time in AM on the rate of alarms per night (overall p < 0.001). The estimates presented above are interpreted as incidence rate ratios.

#### LS Mean at Each Timepoint

```{r echo=FALSE}
emm1 = emmeans(mod_ri_car1,~timepoint)
means = data.frame(emm1)
kable(means,digits = 2)
means$numeric_time = c(0,0.5,3,6,9,12)
```

#### Comparison to week 2

```{r echo=FALSE}
base = c(1,0,0,0,0,0)
w2 = c(0,1,0,0,0,0)
t1 = c(0,0,1,0,0,0)
t2 = c(0,0,0,1,0,0)
t3 = c(0,0,0,0,1,0)
t4 = c(0,0,0,0,0,1)
con = contrast(emm1,method = list("Baseline to Week 2"= w2 - base,
                            "Week 2 to T1"=t1 - w2,
                            "Week 2 to T2"=t2 - w2,
                            "Week 2 to T3"=t3 - w2,
                            "Week 2 to T4"=t4 - w2))
kable(con,digits = 2)
```

## Maintenance Alarms per Night By Timepoint

### Model Results - Unadjusted

```{r echo=FALSE,message=FALSE}
# Random intercept (not enough data for a random slope)
mod_ri_car1 = lme(maintenance_alarms_per_night ~ timepoint,
                  random = ~1|id,na.action = na.omit,
                   data = overnight_alarms,
                  correlation = corCAR1(form = ~numeric_time))
results <- tidy(mod_ri_car1,effects = "fixed",conf.int = T)
results$term <- sub("timepoint","",results$term)
results$p.value <- format.pval(results$p.value,eps = 0.001,digits = 2)

# Anova
an_res <- as.data.frame(Anova(mod_ri_car1))
# Print
kable(results[,c("term","estimate","conf.low","conf.high","p.value")],digits = 2)

```

#### LS Mean at Each Timepoint

```{r echo=FALSE}
emm1 = emmeans(mod_ri_car1,~timepoint)
means = data.frame(emm1)
kable(means,digits = 2)
means$numeric_time = c(0,0.5,3,6,9,12)
```

#### Comparison to week 2

```{r echo=FALSE}
base = c(1,0,0,0,0,0)
w2 = c(0,1,0,0,0,0)
t1 = c(0,0,1,0,0,0)
t2 = c(0,0,0,1,0,0)
t3 = c(0,0,0,0,1,0)
t4 = c(0,0,0,0,0,1)
con = contrast(emm1,method = list("Baseline to Week 2"= w2 - base,
                            "Week 2 to T1"=t1 - w2,
                            "Week 2 to T2"=t2 - w2,
                            "Week 2 to T3"=t3 - w2,
                            "Week 2 to T4"=t4 - w2))
kable(con,digits = 2)
```

### Model Results - Adjusted for Time in AM

```{r echo=FALSE,message=FALSE}
# Random intercept (not enough data for a random slope)
mod_ri_car1 = lme(maintenance_alarms_per_night ~ timepoint + time_am,
                  random = ~1|id,na.action = na.omit,
                   data = overnight_alarms,
                  correlation = corCAR1(form = ~numeric_time))
results <- tidy(mod_ri_car1,effects = "fixed",conf.int = T)
results$term <- c("(Intercept)","Week 2","T1","T2","T3","T4","% Time in AM" )
results$p.value <- format.pval(results$p.value,eps = 0.001,digits = 2)

# Anova
an_res <- as.data.frame(Anova(mod_ri_car1,type = 3))
# Print
kable(results[,c("term","estimate","conf.low","conf.high","p.value")],digits = 2)

```

There was an effect of timepoint on the rate of maintenance alarms per night after adjusting for time in AM (overall p = `r round(an_res["timepoint",3],3)`). There was also an effect of time in AM on the rate of alarms per night (overall p = `r round(an_res["time_am",3],3)`). The estimates presented above are interpreted as incidence rate ratios.

#### LS Mean at Each Timepoint

```{r echo=FALSE}
emm1 = emmeans(mod_ri_car1,~timepoint)
means = data.frame(emm1)
kable(means,digits = 2)
means$numeric_time = c(0,0.5,3,6,9,12)
```

#### Comparison to week 2

```{r echo=FALSE}
base = c(1,0,0,0,0,0)
w2 = c(0,1,0,0,0,0)
t1 = c(0,0,1,0,0,0)
t2 = c(0,0,0,1,0,0)
t3 = c(0,0,0,0,1,0)
t4 = c(0,0,0,0,0,1)
con = contrast(emm1,method = list("Baseline to Week 2"= w2 - base,
                            "Week 2 to T1"=t1 - w2,
                            "Week 2 to T2"=t2 - w2,
                            "Week 2 to T3"=t3 - w2,
                            "Week 2 to T4"=t4 - w2))
kable(con,digits = 2)
```

### Model Results - Adjusted for Sensor Wear

Model did not converge

```{r echo=FALSE,message=FALSE,eval=FALSE}
# Random intercept (not enough data for a random slope)
mod_ri_car1 = lme(maintenance_alarms_per_night ~ timepoint + sensor_wear,
                  random = ~1|id,na.action = na.omit,
                   data = overnight_alarms,
                  correlation = corCAR1(form = ~numeric_time))
results <- tidy(mod_ri_car1,effects = "fixed",conf.int = T)
results$term <- c("(Intercept)","Week 2","T1","T2","T3","T4","% Time in AM" )
results$p.value <- format.pval(results$p.value,eps = 0.001,digits = 2)

# Anova
an_res <- as.data.frame(Anova(mod_ri_car1,type = 3))
# Print
kable(results[,c("term","estimate","conf.low","conf.high","p.value")],digits = 2)
```

## Sensor Wear

```{r echo=FALSE,message=FALSE}
# Random intercept (not enough data for a random slope)
mod_ri_car1 = lme(sensor_wear ~ timepoint,
                  random = ~1|id,na.action = na.omit,
                   data = overnight_alarms,
                  correlation = corCAR1(form = ~numeric_time))
results <- tidy(mod_ri_car1,effects = "fixed",conf.int = T)
results$term <- sub("timepoint","",results$term)
results$p.value <- format.pval(results$p.value,eps = 0.001,digits = 2)

# Anova
an_res <- as.data.frame(Anova(mod_ri_car1))
# Print
kable(results[,c("term","estimate","conf.low","conf.high","p.value")],digits = 2)
```

#### LS Mean at Each Timepoint

```{r echo=FALSE}
emm1 = emmeans(mod_ri_car1,~timepoint)
means = data.frame(emm1)
kable(means,digits = 2)
means$numeric_time = c(0,0.5,3,6,9,12)
```

#### Comparison to week 2

```{r echo=FALSE}
base = c(1,0,0,0,0,0)
w2 = c(0,1,0,0,0,0)
t1 = c(0,0,1,0,0,0)
t2 = c(0,0,0,1,0,0)
t3 = c(0,0,0,0,1,0)
t4 = c(0,0,0,0,0,1)
con = contrast(emm1,method = list("Baseline to Week 2"= w2 - base,
                            "Week 2 to T1"=t1 - w2,
                            "Week 2 to T2"=t2 - w2,
                            "Week 2 to T3"=t3 - w2,
                            "Week 2 to T4"=t4 - w2))
kable(con,digits = 2)
```

## HCL Use

```{r echo=FALSE,message=FALSE}
overnight_alarms = overnight_alarms[overnight_alarms$timepoint != "Baseline",]
overnight_alarms$timepoint = droplevels(overnight_alarms$timepoint)
# Random intercept (not enough data for a random slope)
mod_ri_car1 = lme(time_am ~ timepoint,
                  random = ~1|id,na.action = na.omit,
                   data = overnight_alarms,
                  correlation = corCAR1(form = ~numeric_time))
results <- tidy(mod_ri_car1,effects = "fixed",conf.int = T)
results$term <- sub("timepoint","",results$term)
results$p.value <- format.pval(results$p.value,eps = 0.001,digits = 2)
# Anova
an_res <- as.data.frame(Anova(mod_ri_car1))
# Print
kable(results[,c("term","estimate","conf.low","conf.high","p.value")],digits = 2)
```

#### LS Mean at Each Timepoint

```{r echo=FALSE}
emm1 = emmeans(mod_ri_car1,~timepoint)
means = data.frame(emm1)
kable(means,digits = 2)
means$numeric_time = c(0.5,3,6,9,12)
```

#### Comparison to week 2

```{r echo=FALSE}
w2 = c(1,0,0,0,0)
t1 = c(0,1,0,0,0)
t2 = c(0,0,1,0,0)
t3 = c(0,0,0,1,0)
t4 = c(0,0,0,0,1)
con = contrast(emm1,method = list("Week 2 to T1"=t1 - w2,
                            "Week 2 to T2"=t2 - w2,
                            "Week 2 to T3"=t3 - w2,
                            "Week 2 to T4"=t4 - w2))
kable(con,digits = 2)
```
