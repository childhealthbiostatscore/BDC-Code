---
title: "HCL and Sleep (ADA 2022)"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(redcapAPI)
library(arsenal)
library(tidyverse)
library(lmerTest)
library(broom.mixed)
library(emmeans)
library(performance)
library(knitr)
knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "B:/Projects"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
}
knitr::opts_knit$set(root.dir = home_dir)
```

```{r api import,include=FALSE}
token = read.table("./Erin Cobry/ADA 2022/HCL and Sleep/api_token.txt")[1,1]
rcon <- redcapConnection(url = "https://redcap.ucdenver.edu/api/",token = token)
data = exportRecords(rcon,dates = F)
ids = data$record_id
times = data$redcap_event_name
exclude = c(101,201,102,202,103,203,110,210,119,219,121,221,131,231,141,241)
```

# Table 1a: Parent Characteristics

```{r results='asis'}
# Basic demographics
parent_demographics = exportRecords(rcon,forms = "parent_demographics")
parent_demographics$record_id = ids
parent_demographics$age = 
  as.numeric(difftime(parent_demographics$parent_demographics_timestamp,
                      parent_demographics$parent_bday,units = "days"))/365.25
parent_demographics = parent_demographics %>% 
  select(record_id,age,parent_gender,race,parent_check_night,child_check_glucose,
         insulinmethod,previous_cgm_use,currenthcltech) %>% 
  filter(!record_id %in% exclude)
parent_demographics = 
  parent_demographics[rowSums(is.na(parent_demographics)) < (ncol(parent_demographics)-1),]
# Table
f = as.formula(paste("~",paste0(colnames(parent_demographics)[-1],collapse = "+")))
t1a = tableby(f,data = parent_demographics)
summary(t1a,digits = 2,labelTranslations = list(age = "Age (years)",
                                                currenthcltech = "currenthcltech"))
```

# Table 1b: Child Characteristics

```{r results='asis'}
# Basic demographics
child_demographics = exportRecords(rcon,forms = "child_demographics_chart_review")
child_demographics$record_id = ids
child_demographics$t1d_duration = 
  as.numeric(difftime(child_demographics$consent_date,
                      child_demographics$t1d_diagnosis,units = "days"))/365.25
child_demographics = child_demographics %>% 
  select(record_id,cons_age,childgender,t1d_duration) %>%
  filter(!record_id %in% exclude)
child_demographics = 
  child_demographics[rowSums(is.na(child_demographics)) < (ncol(child_demographics)-1),]
# Table
f = as.formula(paste("~",paste0(colnames(child_demographics)[-1],collapse = "+")))
t1a = tableby(f,data = child_demographics)
summary(t1a,digits = 3,labelTranslations = list(t1d_duration = "T1D Duration (years)"))
```

```{r model functions}
fit_mod = function(outcome,df,plot = T,diagnostics = T){
  # Format timepoint
  df$timepoint = as.factor(df$timepoint)
  levels(df$timepoint) = gsub("baseline_.*","Baseline",levels(df$timepoint))
  levels(df$timepoint) = gsub("hcl_month_3_.*","Month 3",levels(df$timepoint))
  levels(df$timepoint) = gsub("hcl_month_6_.*","Month 6",levels(df$timepoint))
  # Fit random intercept model
  f = as.formula(paste0(outcome,"~timepoint+(1|record_id)"))
  mod = lmer(f,data = df)
  # Plot
  if(plot){
    p = 
      ggplot(data = df,aes_string(x = "timepoint",y = outcome,
                                  color = "record_id",group = "record_id")) + 
      geom_point() + geom_line() + xlab("Timepoint") +
      theme_bw() + theme(legend.position = "none")
    print(p)
  }
  # Type 3
  type3 = data.frame(car::Anova(mod,type = 3))
  colnames(type3)[3] = "p.value"
  print(kable(type3,digits = 3,caption = "Test of Overall Effect"))
  # Model results
  res = tidy(mod,"fixed")
  res$term = sub("timepoint","",res$term)
  res$effect = NULL
  print(kable(res,digits = 3,caption = "Comparison to Baseline"))
  # Means
  means = data.frame(emmeans(mod,~timepoint))
  print(kable(means,digits = 3,caption = "Model Means"))
  # Check model
  if(diagnostics){
    print(check_model(mod))
  }
}
```

# Methods

Each outcome was modeled using a linear mixed effects model with random intercept for participant to account for within-subject correlation. Random slope models would not converge for several outcomes, including average sleep time.

# Actigraphy

```{r}
# Get total sleep time, sleep efficiency, and WASO
child_activity = exportRecords(rcon,forms = "wrist_actigraphy")
child_activity$record_id = ids
child_activity$timepoint = times
child_activity = child_activity %>% 
  select(record_id,timepoint,totalsleep_avg,sleepefficency_avg,waso_avg) %>% 
  filter(!record_id %in% exclude,grepl("baseline|month_3|month_6",timepoint),
         record_id >= 200,rowSums(is.na(.)) < ncol(.)-2) %>%
  mutate(totalsleep_avg = as.numeric(lubridate::hms(totalsleep_avg))/60) %>%
  filter(totalsleep_avg < 21*60)
# Same for parents
```

## Average sleep time

Average sleep time was converted to minutes for all analyses.

### Children

Participant 225 had an average of 21 hours of sleep at month 6, so this value was excluded.

```{r results='asis'}
fit_mod(outcome = "totalsleep_avg",df = child_activity)
```