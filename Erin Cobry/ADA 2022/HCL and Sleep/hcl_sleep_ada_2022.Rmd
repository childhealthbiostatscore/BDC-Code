---
title: "HCL and Sleep (ADA 2022)"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float: yes
---

```{r setup, include=FALSE}
library(redcapAPI)
library(naniar)
library(arsenal)
library(tidyverse)
library(lmerTest)
library(broom.mixed)
library(emmeans)
library(performance)
library(knitr)
library(DT)
library(GLMMadaptive)

# knitr::opts_chunk$set(echo = FALSE,warning = FALSE)
# if(Sys.info()["sysname"] == "Windows"){
#   home_dir = "S:/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
# } else if (Sys.info()["sysname"] == "Linux"){
#   home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
# } else if (Sys.info()["sysname"] == "Darwin"){
#   home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
# }
# knitr::opts_knit$set(root.dir = home_dir)
```

```{r api import,include=FALSE}
token = read.table("S:/Laura/BDC/Projects/Erin Cobry/ADA 2022/HCL and Sleep/api_token.txt")[1,1]
rcon <- redcapConnection(url = "https://redcap.ucdenver.edu/api/",token = token)
data = exportRecords(rcon,dates = F)
ids = data$record_id
times = data$redcap_event_name
exclude = c(101,201,102,202,103,203,110,210,119,219,121,221,131,231,141,241)
```

# Table 1a: Parent Characteristics

```{r results='asis'}
# Basic demographics
parent_demographics = exportRecords(rcon,forms = "parent_demographics")
parent_demographics$record_id = ids
parent_demographics$age = 
  as.numeric(difftime(parent_demographics$parent_demographics_timestamp,
                      parent_demographics$parent_bday,units = "days"))/365.25
parent_demographics = parent_demographics %>% 
  select(record_id,age,parent_gender,race,parent_check_night,child_check_glucose,
         insulinmethod,previous_cgm_use,currenthcltech) %>% 
  filter(!record_id %in% exclude)
parent_demographics = 
  parent_demographics[rowSums(is.na(parent_demographics)) < (ncol(parent_demographics)-1),]
# Table
f = as.formula(paste("~",paste0(colnames(parent_demographics)[-1],collapse = "+")))
t1a = tableby(f,data = parent_demographics)
summary(t1a,digits = 2,labelTranslations = list(age = "Age (years)",
                                                currenthcltech = "currenthcltech"))
```

# Table 1b: Child Characteristics

```{r results='asis'}
# Basic demographics
child_demographics = exportRecords(rcon,forms = "child_demographics_chart_review")
child_demographics$record_id = ids
# Get Hba1c
hba1c = exportRecords(rcon,forms = "glycemic_data")
hba1c$record_id = ids
hba1c = hba1c %>% filter(record_id >= 200,gyl_timepoint == "Baseline") %>%
  select(record_id,hba1c)
# Format
child_demographics$t1d_duration = 
  as.numeric(difftime(child_demographics$consent_date,
                      child_demographics$t1d_diagnosis,units = "days"))/365.25
child_demographics = child_demographics %>% 
  select(record_id,cons_age,childgender,t1d_duration) %>%
  filter(!record_id %in% exclude)
child_demographics = 
  child_demographics[rowSums(is.na(child_demographics)) < (ncol(child_demographics)-1),]
# Add Hba1c
child_demographics = left_join(child_demographics,hba1c,by = "record_id")
# Table
f = as.formula(paste("~",paste0(colnames(child_demographics)[-1],collapse = "+")))
t1a = tableby(f,data = child_demographics)
summary(t1a,digits = 3,labelTranslations = list(t1d_duration = "T1D Duration (years)"))
```

# Glycemic Data

```{r results='asis'}
# Get data
glyc = exportRecords(rcon,forms = "glycemic_data")
glyc$record_id = ids
glyc = glyc %>% filter(!(record_id %in% exclude)) %>% select(record_id, gyl_timepoint, sensor_g251:sensor_sd, night_sensor_low,night_sensor_below, night_sensor_target, night_sensor_above, night_sensor_high, night_sensor_mean, night_sensor_sd, time_am,sensor_wear) %>% filter(record_id > 199) %>% filter(!is.na(gyl_timepoint))

# Table
f_2 = as.formula(paste("gyl_timepoint ~",paste0(colnames(glyc)[-(1:2)],collapse = "+")))
t_glyc = tableby(f_2,data = glyc)
summary(t_glyc,digits = 3, labelTranslations = list(night_sensor_low = "Night < 54",
                                                    night_sensor_below = "Night 55-69",
                                                    night_sensor_target = "Night 70-180",
                                                    night_sensor_above = "Night 181-250",
                                                    night_sensor_high = "Night >251",
                                                    night_sensor_mean = "Night Sensor Mean",
                                                    night_sensor_sd = "Night Sensor SD"))
```

```{r model functions,include=FALSE}
fit_mod = function(outcome,df,plot = T,diagnostics = F){
  # Format timepoint
  df$timepoint = as.factor(df$timepoint)
  levels(df$timepoint) = gsub("baseline_.*","Baseline",levels(df$timepoint))
  levels(df$timepoint) = gsub("hcl_month_3_.*","Month 3",levels(df$timepoint))
  levels(df$timepoint) = gsub("hcl_month_6_.*","Month 6",levels(df$timepoint))
  # Fit random intercept model
  f = as.formula(paste0(outcome,"~timepoint+(1|record_id)"))
  mod = lmer(f,data = df)
  # Plot
  if(plot){
    p = 
      ggplot(data = df,aes_string(x = "timepoint",y = outcome,
                                  color = "record_id",group = "record_id")) + 
      geom_point() + geom_line() + xlab("Timepoint") +
      theme_bw() + theme(legend.position = "none")
    print(p)
  }
  # Type 3
  type3 = data.frame(car::Anova(mod,type = 3))
  colnames(type3)[3] = "p.value"
  print(kable(type3,digits = 3,caption = "Test of Overall Effect"))
  # Model results
  res = tidy(mod,"fixed")
  res$term = sub("timepoint","",res$term)
  res$effect = NULL
  print(kable(res,digits = 3,caption = "Comparison to Baseline"))
  # Means
  means = data.frame(emmeans(mod,~timepoint))
  print(kable(means,digits = 3,caption = "Model Means"))
  # Number of obs
  cat("\n")
  cat(paste("This model was fit using",nobs(mod),"observations."))
  cat("\n")
  # Check model
  if(diagnostics){
    print(check_model(mod))
  }
}
```

# Methods

Each outcome was modeled using a linear mixed effects model with random intercept for participant to account for within-subject correlation. Random slope models would not converge for several outcomes, including average sleep time.

# Actigraphy

```{r,include=FALSE}
# Get total sleep time, sleep efficiency, and WASO
activity = exportRecords(rcon,forms = "wrist_actigraphy")
activity$record_id = ids
activity$timepoint = times
child_activity = activity %>% 
  select(record_id,timepoint,totalsleep_avg,sleepefficency_avg,waso_avg,onsetlatency_avg) %>% 
  filter(!record_id %in% exclude,grepl("baseline|month_3|month_6",timepoint),
         record_id >= 200,rowSums(is.na(.)) < ncol(.)-2) %>%
  mutate(avg_sleep = as.character(totalsleep_avg),
         totalsleep_avg = as.numeric(lubridate::hms(totalsleep_avg))/60) %>%
  filter(totalsleep_avg < 21*60)
child_activity = left_join(child_activity,child_demographics,by = "record_id")
child_activity$sufficient = apply(child_activity,1,function(r){
  age = as.numeric(r["cons_age"])
  time = as.numeric(r["totalsleep_avg"])/60
  if(age <= 2){
    if(time >= 11 & time <= 14){suff = "Yes"} else {suff = "No"}
  } else if (age <= 5){
    if(time >= 10 & time <= 13){suff = "Yes"} else {suff = "No"}
  } else if (age <= 12){
    if(time >= 9 & time <= 12){suff = "Yes"} else {suff = "No"}
  } else if (age <= 17){
    if(time >= 8 & time <= 10){suff = "Yes"} else {suff = "No"}
  } else if (age > 17) {
    if(time >= 7){suff = "Yes"} else {suff = "No"}
  }
})
child_activity$sufficient = as.factor(child_activity$sufficient)

# add in age groups to stratify actigraphy outcomes
child_activity = child_activity %>% mutate(age_grp = case_when(cons_age < 6 ~ "3-5",
                                                               cons_age <= 12 & cons_age >= 6  ~ "6-12",
                                                               cons_age > 12 ~ "13-17"))
child_activity_35 = child_activity %>% filter(age_grp=="3-5")
child_activity_612 = child_activity %>% filter(age_grp=="6-12")
child_activity_1317 = child_activity %>% filter(age_grp=="13-17")
# Same for parents
parent_activity = activity %>% 
  select(record_id,timepoint,totalsleep_avg,sleepefficency_avg,waso_avg,onsetlatency_avg) %>% 
  filter(!record_id %in% exclude,grepl("baseline|month_3|month_6",timepoint),
         record_id < 200,rowSums(is.na(.)) < ncol(.)-2) %>%
  mutate(avg_sleep = as.character(totalsleep_avg),
         totalsleep_avg = as.numeric(lubridate::hms(totalsleep_avg))/60,
         sufficient = ifelse(totalsleep_avg >= 7*60,"Yes","No"))
parent_activity$sufficient = as.factor(parent_activity$sufficient)
```
## Average sleep latency

### Children
#### OVERALL
```{r results='asis'}
fit_mod(outcome = "onsetlatency_avg",df = child_activity)
```

#### 3-5

```{r results='asis'}
fit_mod(outcome = "onsetlatency_avg",df = child_activity_35)
```

#### 6-12

```{r results='asis'}
fit_mod(outcome = "onsetlatency_avg",df = child_activity_612)
```

#### 13-17

```{r results='asis'}
fit_mod(outcome = "onsetlatency_avg",df = child_activity_1317)
```

### Parents

```{r results='asis'}
fit_mod(outcome = "onsetlatency_avg",df = parent_activity)
```



## Average sleep time

Average sleep time was converted to minutes for all analyses.

### Children

Participant 225 had an average of 21 hours of sleep at month 6, so this value was excluded.

#### overall

```{r results='asis'}
fit_mod(outcome = "totalsleep_avg",df = child_activity)
```

#### 3-5

```{r results='asis'}
fit_mod(outcome = "totalsleep_avg",df = child_activity_35)
```

#### 6-12

```{r results='asis'}
fit_mod(outcome = "totalsleep_avg",df = child_activity_612)
```

#### 13-17

```{r results='asis'}
fit_mod(outcome = "totalsleep_avg",df = child_activity_1317)
```

### Parents

```{r results='asis'}
fit_mod(outcome = "totalsleep_avg",df = parent_activity)
```

## Average sleep efficiency

### Children

#### OVERALL

```{r results='asis'}
fit_mod(outcome = "sleepefficency_avg",df = child_activity)
```

#### 35

```{r results='asis'}
fit_mod(outcome = "sleepefficency_avg",df = child_activity_35)
```

#### 6-12

```{r results='asis'}
fit_mod(outcome = "sleepefficency_avg",df = child_activity_612)
```

#### 13-17

```{r results='asis'}
fit_mod(outcome = "sleepefficency_avg",df = child_activity_1317)
```

### Parents

```{r results='asis'}
fit_mod(outcome = "sleepefficency_avg",df = parent_activity)
```

## Average WASO

### Children

#### OVERALL

```{r results='asis'}
fit_mod(outcome = "waso_avg",df = child_activity)
```

#### 3-5

```{r results='asis'}
fit_mod(outcome = "waso_avg",df = child_activity_35)
```

#### 6-12

```{r results='asis'}
fit_mod(outcome = "waso_avg",df = child_activity_612)
```

#### 13-17

```{r results='asis'}
fit_mod(outcome = "waso_avg",df = child_activity_1317)
```


### Parents

```{r results='asis'}
fit_mod(outcome = "waso_avg",df = parent_activity)
```

## Sufficient sleep

### Children

```{r results='asis'}
child_activity %>% select(record_id,timepoint,cons_age,avg_sleep,sufficient) %>% 
  datatable(.)
```

```{r}
child_activity %>% group_by(timepoint) %>% count(sufficient) %>% kable(.)
```

### Parents

```{r results='asis'}
parent_activity %>%select(record_id,timepoint,avg_sleep,sufficient) %>% 
  datatable(.)
```

```{r}
parent_activity %>% group_by(timepoint) %>% count(sufficient) %>% kable(.)
```

# Surveys

# Hypoglycemia Fear Survey Child

```{r hfs c scoring,include=FALSE}
## HFS Scoring
# parents
# hfs_p = data %>% select(record_id,redcap_event_name,timepoint, hypoglycemia_fear_survey_parent_timestamp:hypoglycemia_fear_survey_parent_complete) %>% 
#   filter(grepl("enrollment|month_3|month_6",redcap_event_name), record_id < 200,rowSums(is.na(.)) < ncol(.)-2)  %>% 
#   mutate(across(c(snacks:having_low), as.integer)) %>% mutate(across(c(snacks:having_low),function(x){x-1})) %>%
#   select(-c(hfs_12_months_severe_lows___0:hypoglycemia_fear_survey_parent_complete))
#  
# hfs_p = hfs_p %>% rowwise() %>% 
#   mutate(behave_s = sum(c_across(snacks:nighttime)),
#          worry_s = sum(c_across(recognize:having_low)),
#          maintain_high_s_p = sum(c_across(c(safe_side, higher_alone, away))),
#          worry_lowbg_s_p = sum(c_across(c(recognize, food, dizzy, asleep_low, low_alone, no_one, seizure, complications_low, faint, having_low))),
#          worry_negsc_s_p = sum(c_across(c(embarrassing, clumsy, behavior, accident, bad_evaluation))),
#          total_s = sum(c_across(behave_s:worry_s))) %>% ungroup()
# 
# hfs_p$total_z_p = (hfs_p$total_s - mean(hfs_p$total_s, na.rm = T))/sd(hfs_p$total_s, na.rm = T)
# 
# hfs_p = hfs_p %>% select(record_id, redcap_event_name, maintain_high_s_p, worry_lowbg_s_p, worry_negsc_s_p, total_z_p)
# # change event and id
# substring(hfs_p$redcap_event_name,nchar(hfs_p$redcap_event_name),nchar(hfs_p$redcap_event_name)) ="2"
# hfs_p$record_id = sub("1", "2", hfs_p$record_id)
#####################################################
hfs_c = exportRecords(rcon,forms = "hypoglycemia_fear_survey_childteen",dates = F)
hfs_c$record_id = ids
hfs_c$timepoint = times

hfs_c = hfs_c  %>% 
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         rowSums(is.na(.)) < ncol(.)-2)
hfs_c$timepoint = sub("enrollment_","baseline_",hfs_c$timepoint)

# survey scoring
hfs_c = hfs_c %>% mutate(across(c(bedtime_snacks:having_low_sugar), as.integer)) %>% mutate(across(c(bedtime_snacks:having_low_sugar),function(x){x-1})) 
hfs_c = hfs_c %>% rowwise() %>%
  mutate(behave_s = sum(c_across(bedtime_snacks:check_often)),
         worry_s = sum(c_across(recognizing_low:having_low_sugar)),
         maintain_high_s = sum(c_across(c(high_safe, alone_higher, higher_away))),
         worry_lowbg_s= sum(c_across(c(recognizing_low, food_low, passing_out, low_asleep, low_while_alone, no_help, mistake, long_term, woozy))),
         worry_negsc_s = sum(c_across(c(embarrassing_myself, looking_clumsy, trouble_at_school, seizure_low))),
         total_s = sum(c_across(behave_s:worry_s))) %>% ungroup()

hfs_c$total_z = (hfs_c$total_s - mean(hfs_c$total_s, na.rm = T))/sd(hfs_c$total_s, na.rm = T)

#hfs_c = hfs_c %>% select(record_id, redcap_event_name, maintain_high_s, worry_lowbg_s, worry_negsc_s, total_z)

# n 
hfs_c_n = hfs_c %>% filter(hypoglycemia_fear_survey_childteen_complete == "Complete") %>% group_by(timepoint) %>% summarize(n = n())
```

```{r results='asis'}
kable(hfs_c_n)
#mod
fit_mod(outcome = "total_z", df = hfs_c)
```


# Diabetes Technology Questionnaire

```{r dtc scoring,include=FALSE}
dtq = exportRecords(rcon,forms = "diabetes_technology_questionnaire",dates = F)
dtq$record_id = ids
dtq$timepoint = times

dtq = dtq  %>% 
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         rowSums(is.na(.)) < ncol(.)-2)
dtq$timepoint = sub("enrollment_","baseline_",dtq$timepoint)

levels(dtq$tech) = c(1,2,3,4,5)
levels(dtq$life_easier) = c(1,2,3,4,5)
levels(dtq$health) = c(1,2,3,4,5)
levels(dtq$good) = c(1,2,3,4,5)
levels(dtq$time) = c(1,2,3,4,5)

dtq = dtq %>% mutate(dtq_total = as.numeric(tech) + as.numeric(life_easier) + as.numeric(health) + as.numeric(good) + as.numeric(time))

dtq_p  = dtq %>% filter(record_id %in% parent_demographics$record_id)
dtq_c  = dtq %>% filter(record_id %in% child_demographics$record_id)

```


### Children

```{r results='asis'}
# n 
kable(dtq_c %>% filter(diabetes_technology_questionnaire_complete == "Complete") %>% group_by(timepoint) %>% summarize(n = n()))

fit_mod(outcome = "dtq_total", df = dtq_c)
```


### Parents

```{r results='asis'}
# n 
kable(dtq_p %>% filter(diabetes_technology_questionnaire_complete == "Complete") %>% group_by(timepoint) %>% summarize(n = n()))

fit_mod(outcome = "dtq_total", df = dtq_p)
```


# childrens sleep habits questionnaire

```{r childrens shq scoring,include=FALSE}
cshq = exportRecords(rcon,forms = "childrens_sleep_habits_questionnaire_27",dates = F)
cshq$record_id = ids
cshq$timepoint = times

cshq = cshq  %>% 
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         rowSums(is.na(.)) < ncol(.)-2)
cshq$timepoint = sub("enrollment_","baseline_",cshq$timepoint)

# regular score 1,2,3,10
levels(cshq$same_time) = c(1,2,3,4,5)
levels(cshq$falls_asleep) = c(1,2,3,4,5)
levels(cshq$own_bed) = c(1,2,3,4,5)
levels(cshq$amount) = c(1,2,3,4,5)

# reverse score rest
levels(cshq$parents_bed) = c(5,4,3,2,1)
levels(cshq$rocking) = c(5,4,3,2,1)
levels(cshq$object) = c(5,4,3,2,1)
levels(cshq$parent) = c(5,4,3,2,1)
levels(cshq$resists) = c(5,4,3,2,1)
levels(cshq$afraid) = c(5,4,3,2,1)
levels(cshq$moves) = c(5,4,3,2,1)
levels(cshq$moves_beds) = c(5,4,3,2,1)
levels(cshq$dentist) = c(5,4,3,2,1)
levels(cshq$snores_loudly) = c(5,4,3,2,1)
levels(cshq$sweating) = c(5,4,3,2,1)
levels(cshq$naps_day) = c(5,4,3,2,1)
levels(cshq$wakes_once) = c(5,4,3,2,1)
levels(cshq$wakes_up) = c(5,4,3,2,1)
levels(cshq$early_wake_up) = c(5,4,3,2,1)
levels(cshq$daytime_tired) = c(5,4,3,2,1)
levels(cshq$asleep_activities) = c(5,4,3,2,1)
# remove questions 6, 9, 13, 19 = col 10, 13, 17, 23
vars = c(5:9,11:12, 15,16,18:21,24,27:30)
cshq = cshq %>% mutate_at(c(5:13, 15:21,23,24,27:30), as.numeric)
cshq = cshq %>% mutate(cshq_total = rowSums(.[vars])/18)
```

```{r results='asis'}
# n 
kable(cshq %>% filter(childrens_sleep_habits_questionnaire_27_complete == "Complete") %>% group_by(timepoint) %>% summarize(n = n()))
# mod
fit_mod(outcome = "cshq_total", df = cshq)
```


# PAID peds

```{r paid peds scoring,include=FALSE}
paid_p = exportRecords(rcon,forms = "paidpeds",dates = F)
paid_p$record_id = ids
paid_p$timepoint = times

paid_p = paid_p  %>% 
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         rowSums(is.na(.)) < ncol(.)-2)
paid_p$timepoint = sub("enrollment_","baseline_",paid_p$timepoint)

# set levels
paid_p[3:22] = lapply(paid_p[3:22], function(x) {levels(x) = c(4,3,2,1,0);x } )
paid_p = paid_p %>% mutate_at(c(3:22), as.integer)
paid_p = paid_p %>% mutate_at(c(3:22), function(x){y = x-1;y})

# score 
paid_p = paid_p %>% mutate(paid_peds_total = (rowSums(.[3:22])/20)*25)
```

```{r results='asis'}
# n 
kable(paid_p %>% filter(paidpeds_complete == "Complete") %>%group_by(timepoint) %>% summarize(n = n()))
# mod
fit_mod(outcome = "paid_peds_total", df = paid_p)
```


# PAID PR

```{r paid pr scoring,include=FALSE}
paid_pr = exportRecords(rcon,forms = "paidpr",dates = F)
paid_pr$record_id = ids
paid_pr$timepoint = times

paid_pr = paid_pr  %>% 
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         rowSums(is.na(.)) < ncol(.)-2)
paid_pr$timepoint = sub("enrollment_","baseline_",paid_pr$timepoint)

# set levels
paid_pr[3:20] = lapply(paid_pr[3:20], function(x) {levels(x) = c(4,3,2,1,0);x } )
paid_pr = paid_pr %>% mutate_at(c(3:20), as.integer)
paid_pr = paid_pr %>% mutate_at(c(3:20), function(x){y = x-1;y})

# score 
paid_pr = paid_pr %>% mutate(paid_pr_total = (rowSums(.[3:20])/20)*25)
```

```{r results='asis'}
# n 
kable(paid_pr %>% filter(paidpr_complete == "Complete") %>% group_by(timepoint) %>% summarize(n = n()))
# mod
fit_mod(outcome = "paid_pr_total", df = paid_pr)
```

# PAID T

no data for paid t

# PEDS QL PR Teens

```{r pedsqlprt scoring,include=FALSE}
pedsql_pr_t = exportRecords(rcon,forms = "pedsql_parent_report_for_teens_1318",dates = F)
pedsql_pr_t$record_id = ids
pedsql_pr_t$timepoint = times

pedsql_pr_t = pedsql_pr_t  %>% 
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         rowSums(is.na(.)) < ncol(.)-2)
pedsql_pr_t$timepoint = sub("enrollment_","baseline_",pedsql_pr_t$timepoint)

# set levels
pedsql_pr_t[3:30] = lapply(pedsql_pr_t[3:30], function(x) {levels(x) = c(4,3,2,1,0);x } )
pedsql_pr_t = pedsql_pr_t %>% mutate_at(c(3:30), as.integer)
pedsql_pr_t = pedsql_pr_t %>% mutate_at(c(3:30), function(x){y = (x-1)*25;y})

# score 
pedsql_pr_t = pedsql_pr_t %>% mutate(pedsql_pr_t_total = (rowSums(.[3:30])/28))
```

```{r results='asis'}
# n 
kable(pedsql_pr_t %>% filter(pedsql_parent_report_for_teens_1318_complete == "Complete") %>% group_by(timepoint) %>% summarize(n = n()))
# mod
fit_mod(outcome = "pedsql_pr_t_total", df = pedsql_pr_t)
```

# PEDS QL PR Childrem

```{r pedsqlprc scoring,include=FALSE}
pedsql_pr_c = exportRecords(rcon,forms = "pedsql_parent_report_for_children_812",dates = F)
pedsql_pr_c$record_id = ids
pedsql_pr_c$timepoint = times

pedsql_pr_c = pedsql_pr_c  %>% 
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         rowSums(is.na(.)) < ncol(.)-2)
pedsql_pr_c$timepoint = sub("enrollment_","baseline_",pedsql_pr_c$timepoint)

# set levels
pedsql_pr_c[3:30] = lapply(pedsql_pr_c[3:30], function(x) {levels(x) = c(4,3,2,1,0);x } )
pedsql_pr_c = pedsql_pr_c %>% mutate_at(c(3:30), as.integer)
pedsql_pr_c = pedsql_pr_c %>% mutate_at(c(3:30), function(x){y = (x-1)*25;y})

# score 
pedsql_pr_c = pedsql_pr_c %>% mutate(pedsql_pr_c_total = (rowSums(.[3:30])/28))
```

```{r results='asis'}
# n 
kable(pedsql_pr_c %>% filter(pedsql_parent_report_for_children_812_complete == "Complete") %>% group_by(timepoint) %>% summarize(n = n()))
# mod
fit_mod(outcome = "pedsql_pr_c_total", df = pedsql_pr_c)
```

# PEDS QL PR Young Childrem

```{r pedsqlpryc scoring,include=FALSE}
pedsql_pr_yc = exportRecords(rcon,forms = "pedsql_parent_report_for_young_children_57",dates = F)
pedsql_pr_yc$record_id = ids
pedsql_pr_yc$timepoint = times

pedsql_pr_yc = pedsql_pr_yc  %>% 
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         rowSums(is.na(.)) < ncol(.)-2)
pedsql_pr_yc$timepoint = sub("enrollment_","baseline_",pedsql_pr_yc$timepoint)

# set levels
pedsql_pr_yc[3:30] = lapply(pedsql_pr_yc[3:30], function(x) {levels(x) = c(4,3,2,1,0);x } )
pedsql_pr_yc = pedsql_pr_yc %>% mutate_at(c(3:30), as.integer)
pedsql_pr_yc = pedsql_pr_yc %>% mutate_at(c(3:30), function(x){y = (x-1)*25;y})

# score 
pedsql_pr_yc = pedsql_pr_yc %>% mutate(pedsql_pr_yc_total = (rowSums(.[3:30])/28))
```

```{r results='asis'}
# n 
kable(pedsql_pr_yc %>% filter(pedsql_parent_report_for_young_children_57_complete == "Complete") %>% group_by(timepoint) %>% summarize(n = n()))
# mod
fit_mod(outcome = "pedsql_pr_yc_total", df = pedsql_pr_yc)
```

# PEDS QL PR toddlers

```{r pedsqlprto scoring,include=FALSE}
pedsql_pr_t = exportRecords(rcon,forms = "pedsql_parent_report_for_toddlers_24",dates = F)
pedsql_pr_t$record_id = ids
pedsql_pr_t$timepoint = times

pedsql_pr_t = pedsql_pr_t  %>% 
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         rowSums(is.na(.)) < ncol(.)-2)
pedsql_pr_t$timepoint = sub("enrollment_","baseline_",pedsql_pr_t$timepoint)

# set levels
pedsql_pr_t[3:30] = lapply(pedsql_pr_t[3:30], function(x) {levels(x) = c(4,3,2,1,0);x } )
pedsql_pr_t = pedsql_pr_t %>% mutate_at(c(3:30), as.integer)
pedsql_pr_t = pedsql_pr_t %>% mutate_at(c(3:30), function(x){y = (x-1)*25;y})

# score 
pedsql_pr_t = pedsql_pr_t %>% mutate(pedsql_pr_t_total = (rowSums(.[3:30])/28))
```

```{r results='asis'}
# n 
kable(pedsql_pr_t %>% filter(pedsql_parent_report_for_toddlers_24_complete == "Complete") %>% group_by(timepoint) %>% summarize(n = n()))
# mod
fit_mod(outcome = "pedsql_pr_t_total", df = pedsql_pr_t)
```

# PEDS QL Teen report

```{r pedsqlt scoring,include=FALSE}
pedsql_t = exportRecords(rcon,forms = "pedsql_teen_report_1318",dates = F)
pedsql_t$record_id = ids
pedsql_t$timepoint = times

pedsql_t = pedsql_t  %>% 
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         rowSums(is.na(.)) < ncol(.)-2)
pedsql_t$timepoint = sub("enrollment_","baseline_",pedsql_t$timepoint)

# set levels
pedsql_t[3:30] = lapply(pedsql_t[3:30], function(x) {levels(x) = c(4,3,2,1,0);x } )
pedsql_t = pedsql_t %>% mutate_at(c(3:30), as.integer)
pedsql_t = pedsql_t %>% mutate_at(c(3:30), function(x){y = (x-1)*25;y})

# score 
pedsql_t = pedsql_t %>% mutate(pedsql_t_total = (rowSums(.[3:30])/28))
```

```{r results='asis'}
# n 
kable(pedsql_t %>% filter(pedsql_teen_report_1318_complete == "Complete") %>% group_by(timepoint) %>% summarize(n = n()))
# mod
fit_mod(outcome = "pedsql_t_total", df = pedsql_t)
```

# PEDS QL child report

```{r pedsqlc scoring,include=FALSE}
pedsql_c = exportRecords(rcon,forms = "pedsql_child_report_812",dates = F)
pedsql_c$record_id = ids
pedsql_c$timepoint = times

pedsql_c = pedsql_c  %>% 
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         rowSums(is.na(.)) < ncol(.)-2)
pedsql_c$timepoint = sub("enrollment_","baseline_",pedsql_c$timepoint)

# set levels
pedsql_c[3:30] = lapply(pedsql_c[3:30], function(x) {levels(x) = c(4,3,2,1,0);x } )
pedsql_c = pedsql_c %>% mutate_at(c(3:30), as.integer)
pedsql_c = pedsql_c %>% mutate_at(c(3:30), function(x){y = (x-1)*25;y})

# score 
pedsql_c = pedsql_c %>% mutate(pedsql_c_total = (rowSums(.[3:30])/28))
```

```{r results='asis'}
# n 
kable(pedsql_c %>% filter(pedsql_child_report_812_complete == "Complete") %>% group_by(timepoint) %>% summarize(n = n()))
# mod
fit_mod(outcome = "pedsql_c_total", df = pedsql_c)
```

# PEDS QL young child report

```{r pedsqlyc scoring,include=FALSE}
pedsql_yc = exportRecords(rcon,forms = "pedsql_young_child_report_57",dates = F)
pedsql_yc$record_id = ids
pedsql_yc$timepoint = times

pedsql_yc = pedsql_yc  %>% 
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         rowSums(is.na(.)) < ncol(.)-2)
pedsql_yc$timepoint = sub("enrollment_","baseline_",pedsql_yc$timepoint)

# set levels
pedsql_yc[3:30] = lapply(pedsql_yc[3:30], function(x) {levels(x) = c(4,3,2,1,0);x } )
pedsql_yc = pedsql_yc %>% mutate_at(c(3:30), as.integer)
pedsql_yc = pedsql_yc %>% mutate_at(c(3:30), function(x){y = (x-1)*25;y})

# score 
pedsql_yc = pedsql_yc %>% mutate(pedsql_yc_total = (rowSums(.[3:30])/28))
```

```{r results='asis'}
# n 
kable(pedsql_yc %>% filter(pedsql_young_child_report_57_complete == "Complete") %>% group_by(timepoint) %>% summarize(n = n()))
# mod
fit_mod(outcome = "pedsql_yc_total", df = pedsql_yc)
```

# Inspire Parent

```{r inspirep scoring,include=FALSE}
# baseline
inspire_pb = exportRecords(rcon,forms = "inspire_parent_baseline",dates = F)
inspire_pb$record_id = ids
inspire_pb$timepoint = times

inspire_pb = inspire_pb  %>% 
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         rowSums(is.na(.)) < ncol(.)-2)
inspire_pb$timepoint = sub("enrollment_","baseline_",inspire_pb$timepoint)

# set levels
#inspire_pb[3:23] = lapply(inspire_pb[3:23], function(x) {levels(x) = c(4,3,2,1,0, -99);x } )
inspire_pb = inspire_pb %>% mutate_at(c(3:23), as.integer)
inspire_pb = inspire_pb %>% replace_with_na(replace = list(x = 6))
inspire_pb = inspire_pb %>% mutate_at(c(3:23), function(x){y = (x-1)*25;y})

# score 
inspire_pb = inspire_pb %>% mutate(inspire_p_total = (rowMeans(.[3:23])))

# followup
inspire_pf = exportRecords(rcon,forms = "inspire_parent_follow_up",dates = F)
inspire_pf$record_id = ids
inspire_pf$timepoint = times

inspire_pf = inspire_pf  %>% 
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         rowSums(is.na(.)) < ncol(.)-2)
inspire_pf$timepoint = sub("enrollment_","baseline_",inspire_pf$timepoint)

# set levels
inspire_pf[3:23] = lapply(inspire_pf[3:23], function(x) {levels(x) = c(4,3,2,1,0, -99);x } )
inspire_pf = inspire_pf %>% mutate_at(c(3:23), as.integer)
inspire_pf = inspire_pf %>% replace_with_na(replace = list(x = 6))
inspire_pf = inspire_pf %>% mutate_at(c(3:23), function(x){y = (x-1)*25;y})

# score 
inspire_pf = inspire_pf %>% mutate(inspire_p_total = (rowMeans(.[3:23])))

# one dataframe
inspire_p = full_join(inspire_pb, inspire_pf)
```

```{r results='asis'}
# n 
kable(inspire_p %>% filter(inspire_parent_baseline_complete == "Complete") %>% group_by(timepoint) %>% summarize(n = n()))
kable(inspire_p %>% filter(inspire_parent_follow_up_complete == "Complete") %>% group_by(timepoint) %>% summarize(n = n()))

# mod
fit_mod(outcome = "inspire_p_total", df = inspire_p)
```

# Inspire Youth

```{r inspirey scoring,include=FALSE}
# baseline
inspire_yb = exportRecords(rcon,forms = "inspire_youth_baseline",dates = F)
inspire_yb$record_id = ids
inspire_yb$timepoint = times

inspire_yb = inspire_yb  %>% 
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         rowSums(is.na(.)) < ncol(.)-2)
inspire_yb$timepoint = sub("enrollment_","baseline_",inspire_yb$timepoint)

# set levels
inspire_yb[3:19] = lapply(inspire_yb[3:19], function(x) {levels(x) = c(0,1,2,3,4, -99);x } )
inspire_yb = inspire_yb %>% mutate_at(c(3:19), as.integer)
inspire_yb = inspire_yb %>% replace_with_na(replace = list(x = 6))
inspire_yb = inspire_yb %>% mutate_at(c(3:19), function(x){y = (x-1)*25;y})

# score 
inspire_yb = inspire_yb %>% mutate(inspire_total = (rowMeans(.[3:19])))

# followup
inspire_yf = exportRecords(rcon,forms = "inspire_youth_follow_up",dates = F)
inspire_yf$record_id = ids
inspire_yf$timepoint = times

inspire_yf = inspire_yf  %>% 
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         rowSums(is.na(.)) < ncol(.)-2)
inspire_yf$timepoint = sub("enrollment_","baseline_",inspire_yf$timepoint)

# set levels
inspire_yf[3:19] = lapply(inspire_yf[3:19], function(x) {levels(x) = c(0,1,2,3,4, -99);x } )
inspire_yf = inspire_yf %>% mutate_at(c(3:19), as.integer)
inspire_yf = inspire_yf %>% replace_with_na(replace = list(x = 6))
inspire_yf = inspire_yf %>% mutate_at(c(3:19), function(x){y = (x-1)*25;y})

# score 
inspire_yf = inspire_yf %>% mutate(inspire_total = (rowMeans(.[3:19])))

# one dataframe
inspire_y = full_join(inspire_yb, inspire_yf)
```

```{r results='asis'}
# n 
kable(inspire_y %>% filter(inspire_youth_baseline_complete == "Complete") %>% group_by(timepoint) %>% summarize(n = n()))
kable(inspire_y %>% filter(inspire_youth_follow_up_complete == "Complete") %>% group_by(timepoint) %>% summarize(n = n()))

# mod
fit_mod(outcome = "inspire_total", df = inspire_y)
```

# PSQI 

```{r,include=FALSE}
psqi = exportRecords(rcon,forms = "psqi",dates = F)
psqi$record_id = ids
psqi$timepoint = times
psqi = psqi %>% select(record_id,timepoint,psqi_total) %>% 
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         rowSums(is.na(.)) < ncol(.)-2)
psqi$timepoint = sub("enrollment_","baseline_",psqi$timepoint)
```

```{r results='asis'}
# n 
kable(psqi %>% group_by(timepoint) %>% summarize(n = n()))
# mod
fit_mod(outcome = "psqi_total",df = psqi)
```

# PROMIS: Sleep Disturbance

### Children

```{r,include=FALSE}
# Import select, filter, etc.
promis_peds = exportRecords(rcon,forms = "promis_pediatric_817")
promis_peds$record_id = ids
promis_peds$timepoint = times
promis_peds = promis_peds %>% select(record_id,timepoint,falling_asleep:bad_mood_sleepy) %>%
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         record_id >= 200,rowSums(is.na(.)) < ncol(.)-2) %>%
  mutate(across(falling_asleep:bad_mood_sleepy,.fns = as.numeric),
         through_night = 6 - through_night) %>% 
  mutate(disturbance = rowSums(select(.,falling_asleep:tossed_and_turned)),
         impairment = rowSums(select(.,daytime:bad_mood_sleepy)))
promis_peds$timepoint = sub("enrollment_","baseline_",promis_peds$timepoint)
# Convert to T scores
peds_disturbance = read.csv("S:/Laura/BDC/Projects/Erin Cobry/ADA 2022/HCL and Sleep/Data_Clean/peds_sleep_disturbance.csv")
peds_impairment = read.csv("S:/Laura/BDC/Projects/Erin Cobry/ADA 2022/HCL and Sleep/Data_Clean/peds_sleep_impairment.csv")
promis_peds$disturbance = 
  peds_disturbance$T.Score[match(promis_peds$disturbance,
                                 peds_disturbance$Raw.Summed.Score)]
promis_peds$impairment = 
  peds_impairment$T.Score[match(promis_peds$impairment,
                                peds_impairment$Raw.Summed.Score)]
```

```{r results='asis'}
# n 
kable(promis_peds %>%  group_by(timepoint) %>% summarize(n = n()))
# mod
fit_mod(outcome = "disturbance",df = promis_peds)
```

### Parents

```{r,include=FALSE}
# Import select, filter, etc.
promis_parent = exportRecords(rcon,forms = "promis_parent_proxy_817")
promis_parent$record_id = ids
promis_parent$timepoint = times
promis_parent = promis_parent %>% select(record_id,timepoint,asleep:bad_mood) %>%
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         record_id < 200,rowSums(is.na(.)) < ncol(.)-2) %>%
  mutate(across(asleep:bad_mood,.fns = as.numeric),
         night = 6 - night) %>% 
  mutate(disturbance = rowSums(select(.,asleep:tossed)),
         impairment = rowSums(select(.,sleepy:bad_mood)))
promis_parent$timepoint = sub("enrollment_","baseline_",promis_parent$timepoint)
# Convert to T scores
parent_disturbance = read.csv("S:/Laura/BDC/Projects/Erin Cobry/ADA 2022/HCL and Sleep/Data_Clean/parent_proxy_sleep_disturbance.csv")
parent_impairment = read.csv("S:/Laura/BDC/Projects/Erin Cobry/ADA 2022/HCL and Sleep/Data_Clean/parent_proxy_sleep_impairment.csv")
promis_parent$disturbance = 
  parent_disturbance$T.Score[match(promis_parent$disturbance,
                                   parent_disturbance$Raw.Summed.Score)]
promis_parent$impairment = 
  parent_impairment$T.Score[match(promis_parent$impairment,
                                  parent_impairment$Raw.Summed.Score)]
```

```{r results='asis'}
# n 
kable(promis_parent %>% group_by(timepoint) %>% summarize(n = n()))
# mod
fit_mod(outcome = "disturbance",df = promis_parent)
```

# PROMIS: Impairment

### Children

```{r results='asis'}
fit_mod(outcome = "impairment",df = promis_peds)
```

### Parents

```{r results='asis'}
fit_mod(outcome = "impairment",df = promis_parent)
```

# Awakenings

Due to the large number of participants with 0 awakenings (diabetes-related or otherwise), awakening outcomes were modeled using a zero-inflated Poisson mixed model. The Poisson model was found to perform better than a negative binomial.

The interpretation of the coefficients from a zero-inflated Poisson model are: the expected number of awakenings (for those with more than 0 awakenings) changes by $x$ amount compared to baseline. However, unlike the mixed models above, these coefficients are multiplicative, so given a coefficient of 0.694 for month 3 and an average of 0.173 awakenings at baseline, the expected number of awakenings at month 3 is: $0.173*0.694$.

```{r,include=FALSE}
# Data cleaning
data$timepoint = times
child_awakenings = data %>% 
  select(record_id,timepoint,diabetes_awakenings,all_awakenings) %>% 
  filter(!record_id %in% exclude,grepl("baseline|month_3|month_6",timepoint),
         record_id >= 200,rowSums(is.na(.)) < ncol(.)-2)
child_awakenings$timepoint = as.factor(child_awakenings$timepoint)
levels(child_awakenings$timepoint) = 
  gsub("baseline_.*","Baseline",levels(child_awakenings$timepoint))
levels(child_awakenings$timepoint) = 
  gsub("hcl_month_3_.*","Month 3",levels(child_awakenings$timepoint))
levels(child_awakenings$timepoint) = 
  gsub("hcl_month_6_.*","Month 6",levels(child_awakenings$timepoint))
# Parents
parent_awakenings = data %>% 
  select(record_id,timepoint,diabetes_awakenings,all_awakenings) %>% 
  filter(!record_id %in% exclude,grepl("baseline|month_3|month_6",timepoint),
         record_id < 200,rowSums(is.na(.)) < ncol(.)-2)
parent_awakenings$timepoint = as.factor(parent_awakenings$timepoint)
levels(parent_awakenings$timepoint) = 
  gsub("baseline_.*","Baseline",levels(parent_awakenings$timepoint))
levels(parent_awakenings$timepoint) = 
  gsub("hcl_month_3_.*","Month 3",levels(parent_awakenings$timepoint))
levels(parent_awakenings$timepoint) = 
  gsub("hcl_month_6_.*","Month 6",levels(parent_awakenings$timepoint))
```

# Diabetes-Related Awakenings

### Children

```{r results='asis'}
# Plot
p = ggplot(data = child_awakenings,aes(x = timepoint,y = diabetes_awakenings,
                                color = record_id,group = record_id)) + 
  geom_point() + geom_line() + xlab("Timepoint") +
  theme_bw() + theme(legend.position = "none")
print(p)
# Model
mod <- mixed_model(diabetes_awakenings ~ timepoint, random = ~ 1 | record_id, 
                   data = child_awakenings,
                   family = zi.poisson(), 
                   zi_fixed = ~1,zi_random = ~ 1 | record_id)
res = tidy(mod,"fixed")
res$term = sub("timepoint","",res$term)
res = res[,c("term","estimate","conf.low","conf.high","std.error","p.value")]
res[,c("estimate","conf.low","conf.high")] = exp(res[,c("estimate","conf.low","conf.high")])
print(kable(res,digits = 3,caption = "Comparison to Baseline"))
```

### Parents

```{r results='asis'}
# Plot
p = ggplot(data = parent_awakenings,aes(x = timepoint,y = diabetes_awakenings,
                                color = record_id,group = record_id)) + 
  geom_point() + geom_line() + xlab("Timepoint") +
  theme_bw() + theme(legend.position = "none")
print(p)
# Model
mod <- mixed_model(diabetes_awakenings ~ timepoint, random = ~ 1 | record_id, 
                   data = parent_awakenings,control = list(iter_EM = 0),
                   family = zi.poisson(), 
                   zi_fixed = ~1,zi_random = ~ 1 | record_id)
res = tidy(mod,"fixed")
res$term = sub("timepoint","",res$term)
res = res[,c("term","estimate","conf.low","conf.high","std.error","p.value")]
res[,c("estimate","conf.low","conf.high")] = exp(res[,c("estimate","conf.low","conf.high")])
print(kable(res,digits = 3,caption = "Comparison to Baseline"))
```

# All Awakenings

### Children

```{r results='asis'}
# Plot
p = ggplot(data = child_awakenings,aes(x = timepoint,y = all_awakenings,
                                color = record_id,group = record_id)) + 
  geom_point() + geom_line() + xlab("Timepoint") +
  theme_bw() + theme(legend.position = "none")
print(p)
# Model
mod <- mixed_model(all_awakenings ~ timepoint, random = ~ 1 | record_id, 
                   data = child_awakenings,control = list(iter_EM = 0),
                   family = zi.poisson(), 
                   zi_fixed = ~1,zi_random = ~ 1 | record_id)
# Anova

# Results
res = tidy(mod,"fixed")
res$term = sub("timepoint","",res$term)
res = res[,c("term","estimate","conf.low","conf.high","std.error","p.value")]
res[,c("estimate","conf.low","conf.high")] = exp(res[,c("estimate","conf.low","conf.high")])
print(kable(res,digits = 3,caption = "Comparison to Baseline"))
```

### Parents

```{r results='asis'}
# Plot
p = ggplot(data = parent_awakenings,aes(x = timepoint,y = all_awakenings,
                                color = record_id,group = record_id)) + 
  geom_point() + geom_line() + xlab("Timepoint") +
  theme_bw() + theme(legend.position = "none")
print(p)
# Model
mod <- mixed_model(all_awakenings ~ timepoint, random = ~ 1 | record_id, 
                   data = parent_awakenings,control = list(iter_EM = 0),
                   family = zi.poisson(), 
                   zi_fixed = ~1,zi_random = ~ 1 | record_id)
res = tidy(mod,"fixed")
res$term = sub("timepoint","",res$term)
res = res[,c("term","estimate","conf.low","conf.high","std.error","p.value")]
res[,c("estimate","conf.low","conf.high")] = exp(res[,c("estimate","conf.low","conf.high")])
print(kable(res,digits = 3,caption = "Comparison to Baseline"))
```
