---
title: ""
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 5
    toc_float: yes
---

```{r setup, include=FALSE}
library(arsenal)
library(tidyverse)
library(performance)
library(knitr)
library(readxl)
library(table1)
library(nlme)
library(emmeans)

# data upload
# first sheet demog
lyumjev_demog <- read_excel("S:/Laura/BDC/Projects/Erin Cobry/Lyumjuv/Clean excel_lyumjev.xlsx", 
    sheet = "Demographics")

# seondsheet the pre post data
lyumjev_data <- read_excel("S:/Laura/BDC/Projects/Erin Cobry/Lyumjuv/Clean excel_lyumjev.xlsx", 
    sheet = "Data")

```

```{r functions, include = FALSE}
fit_mod = function(outcome, df){

    # Fit model
  f = as.formula(paste0(outcome,"~","gmonth + randomization_group + gmonth*randomization_group"))
  mod = lme(f,
            random = ~1|pid,
            data = df,
            na.action = na.omit)
    cat("\n")
  print(outcome)
  cat("\n")
   # Means
  mod_means = emmeans(mod,specs=pairwise ~ gmonth*randomization_group, adjust="none")

  mod_means2 = emmeans(mod,specs=~ gmonth*randomization_group, adjust="none")
  
  print(kable(mod_means$contrasts,digits = 3,caption = "Timepoint Contrasts"))
  print(kable(mod_means2,digits = 3,caption = "Timepoint Means"))

}
```

Demographics we would like to include: 
Age
Sex
Diabetes duration
% lyumjev
% Fiasp


Analysis plan: 
                Background: Lyumjev and Fiasp are new ultra-rapid acting insulins now on the market, currently labelled for use in Medtronic and Tandem. These insulins are designed to work-faster in the hopes of reducing post-prandial excursions. OP5 is an AID that is commonly used, but there is no published real-world data on the use of these insulins with this specific pump model. We are comparing glycemic and behavioral measures before and after switching to either lyumjev or aspart. We anticipate we will likely see no difference in glycemic measures but potentially in behavioral measure (ie overrides, and bolus/day). Would like 3 subgroup analysis: pre vs post as a whole, pre vs post lyumjev only, pre vs post fiasp only. We are not doing head-to-head of lyumjev to fiasp. We are aware n will be small for the single-type insulin analysis. 
