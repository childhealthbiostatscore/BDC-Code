---
title: "ISPAD Analysis"
author: "Casey Sakamoto"
date: '2022-03-21'
output: html_document
---

```{r setup, include=FALSE}
library(readr)
library(tidyverse)
library(Hmisc)
library(redcapAPI)
library(knitr) # kable
library(nlme) # mixed models
library(emmeans) # contrast statement

knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "S:/Laura/BDC/Projects/Erin Cobry/ISPAD 2022"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Erin Cobry/ISPAD 2022"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Erin Cobry/ISPAD 2022"
}
knitr::opts_knit$set(root.dir = home_dir)

setwd("S:/Laura/BDC/Projects/Erin Cobry/Prospective HCL and sleep study")

```


```{r data import,include=FALSE}
token = read.table("S:/Laura/BDC/Projects/Erin Cobry/ADA 2022/HCL and Sleep/api_token.txt")[1,1]
rcon <- redcapConnection(url = "https://redcap.ucdenver.edu/api/",token = token)
data = exportRecords(rcon,dates = F)
ids = data$record_id
times = data$redcap_event_name
exclude = c(101,201,102,202,103,203,110,210,119,219,121,221,131,231,141,241)

# exclude 8 dyads
data = data  %>% filter(!(record_id %in% exclude)) 

######## Basic demographics & glycemic #################
child_demographics = exportRecords(rcon,forms = "child_demographics_chart_review")
child_demographics$record_id = ids
# Get glycemic measures
glyc = exportRecords(rcon,forms = "glycemic_data")
glyc$record_id = ids
glyc= glyc %>% filter(record_id >= 200,gyl_timepoint %in% c( "Baseline", "3 Months", "6 Months")) %>% 
  mutate(timepoint = case_when(gyl_timepoint == "Baseline" ~ "baseline_day_1_arm_2",
                               gyl_timepoint == "3 Months" ~ "hcl_month_3_day_1_arm_2",
                               gyl_timepoint == "6 Months" ~ "hcl_month_6_day_1_arm_2"
                               )) %>%
  select(record_id, timepoint, hba1c, gmi,sensor_g251, sensor_181_250, sensor_70_180, sensor_55_69, sensor_u54)
# Format
child_demographics$t1d_duration = 
  as.numeric(difftime(child_demographics$consent_date,
                      child_demographics$t1d_diagnosis,units = "days"))/365.25
child_demographics = child_demographics %>% 
  select(record_id,cons_age,childgender,t1d_duration) %>%
  filter(!record_id %in% exclude)
child_demographics = 
  child_demographics[rowSums(is.na(child_demographics)) < (ncol(child_demographics)-1),]
# Add Hba1c
child_demographics = left_join(child_demographics,glyc,by = "record_id")
###############################################

############### Actigraphy #####################
# Get total sleep time, sleep efficiency, and WASO
activity = exportRecords(rcon,forms = "wrist_actigraphy")
activity$record_id = ids
activity$timepoint = times
child_activity = activity %>% 
  select(record_id,timepoint,totalsleep_avg,sleepefficency_avg,waso_avg) %>% 
  filter(!record_id %in% exclude,grepl("baseline|month_3|month_6",timepoint),
         record_id >= 200,rowSums(is.na(.)) < ncol(.)-2) %>%
  mutate(avg_sleep = as.character(totalsleep_avg),
         totalsleep_avg = as.numeric(lubridate::hms(totalsleep_avg))/60) %>%
  filter(totalsleep_avg < 21*60)
child_activity = left_join(child_activity,child_demographics) %>% distinct()
# child_activity$sufficient = apply(child_activity,1,function(r){
#   age = as.numeric(r["cons_age"])
#   time = as.numeric(r["totalsleep_avg"])/60
#   if(age <= 2){
#     if(time >= 11 & time <= 14){suff = "Yes"} else {suff = "No"}
#   } else if (age <= 5){
#     if(time >= 10 & time <= 13){suff = "Yes"} else {suff = "No"}
#   } else if (age <= 12){
#     if(time >= 9 & time <= 12){suff = "Yes"} else {suff = "No"}
#   } else if (age <= 17){
#     if(time >= 8 & time <= 10){suff = "Yes"} else {suff = "No"}
#   } else if (age > 17) {
#     if(time >= 7){suff = "Yes"} else {suff = "No"}
#   }
# })
# child_activity$sufficient = as.factor(child_activity$sufficient)

# Same for parents
parent_activity = activity %>% 
  select(record_id,timepoint,totalsleep_avg,sleepefficency_avg,waso_avg) %>% 
  filter(!record_id %in% exclude,grepl("baseline|month_3|month_6",timepoint),
         record_id < 200,rowSums(is.na(.)) < ncol(.)-2) %>%
  mutate(avg_sleep = as.character(totalsleep_avg),
         totalsleep_avg = as.numeric(lubridate::hms(totalsleep_avg))/60,
         sufficient = ifelse(totalsleep_avg >= 7*60,"Yes","No"))
parent_activity$sufficient = as.factor(parent_activity$sufficient)


# Import select, filter, etc.
promis_peds = exportRecords(rcon,forms = "promis_pediatric_817")
promis_peds$record_id = ids
promis_peds$timepoint = times
promis_peds = promis_peds %>% select(record_id,timepoint,falling_asleep:bad_mood_sleepy) %>%
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         record_id >= 200,rowSums(is.na(.)) < ncol(.)-2) %>%
  mutate(across(falling_asleep:bad_mood_sleepy,.fns = as.numeric),
         through_night = 6 - through_night) %>% 
  mutate(disturbance = rowSums(select(.,falling_asleep:tossed_and_turned)),
         impairment = rowSums(select(.,daytime:bad_mood_sleepy)))
promis_peds$timepoint = sub("enrollment_","baseline_",promis_peds$timepoint)
# Convert to T scores \Erin Cobry\ADA 2022\HCL and Sleep
peds_disturbance = read.csv("S:/Laura/BDC/Projects/Erin Cobry/ADA 2022/HCL and Sleep/Data_Clean/peds_sleep_disturbance.csv")
peds_impairment = read.csv("S:/Laura/BDC/Projects/Erin Cobry/ADA 2022/HCL and Sleep/Data_Clean/peds_sleep_impairment.csv")
promis_peds$disturbance = 
  peds_disturbance$T.Score[match(promis_peds$disturbance,
                                 peds_disturbance$誰..Raw.Summed.Score)]
promis_peds$impairment = 
  peds_impairment$T.Score[match(promis_peds$impairment,
                                peds_impairment$誰..Raw.Summed.Score)]
# PROMIS PARENTS
# Import select, filter, etc.
promis_parent = exportRecords(rcon,forms = "promis_parent_proxy_817")
promis_parent$record_id = ids
promis_parent$timepoint = times
promis_parent = promis_parent %>% select(record_id,timepoint,asleep:bad_mood) %>%
  filter(!record_id %in% exclude,grepl("enrollment|month_3|month_6",timepoint),
         record_id < 200,rowSums(is.na(.)) < ncol(.)-2) %>%
  mutate(across(asleep:bad_mood,.fns = as.numeric),
         night = 6 - night) %>% 
  mutate(disturbance = rowSums(select(.,asleep:tossed)),
         impairment = rowSums(select(.,sleepy:bad_mood)))
promis_parent$timepoint = sub("enrollment_","baseline_",promis_parent$timepoint)
# Convert to T scores
parent_disturbance = read.csv("S:/Laura/BDC/Projects/Erin Cobry/ADA 2022/HCL and Sleep/Data_Clean/parent_proxy_sleep_disturbance.csv")
parent_impairment = read.csv("S:/Laura/BDC/Projects/Erin Cobry/ADA 2022/HCL and Sleep/Data_Clean/parent_proxy_sleep_impairment.csv")
promis_parent$disturbance = 
  parent_disturbance$T.Score[match(promis_parent$disturbance,
                                   parent_disturbance$誰..Raw.Summed.Score)]
promis_parent$impairment = 
  parent_impairment$T.Score[match(promis_parent$impairment,
                                  parent_impairment$誰..Raw.Summed.Score)]
```

```{r group derive, include = FALSE}
# put parents into psqi score >5
# score parent outcomes; 1 = > 5, 0 = <=5, na else
bl_psqi_groups = data %>% mutate(psqi_group = case_when(psqi_total > 5 ~ 1,
                                              psqi_total <= 5 ~ 0)) %>%
  filter(redcap_event_name == "enrollment_arm_1") %>%
  select(record_id, psqi_total, psqi_group)
bl_psqi_groups$psqi_group = factor(bl_psqi_groups$psqi_group, levels = c(0,1), labels = c("Parent Good Sleeper", "Parent Poor Sleeper") )
# note 127 missing baseline psqi, but has a subsequent value of 4

# add a child id for merging later
bl_psqi_groups$child_id = sub("1", "2", bl_psqi_groups$record_id)
bl_psqi_groups = bl_psqi_groups %>% select(child_id, psqi_group) 
bl_psqi_groups = rename(bl_psqi_groups, c( "record_id" = "child_id"))
```

```{r data merge, include=FALSE}
# child actigraphy, demog, & glycemic already merged
# merge w parent actigraphy (rename vars to add _p)
parent_activity$record_id = sub("1", "2", parent_activity$record_id)
parent_activity = rename(parent_activity, c( "totalsleep_avg_p" = "totalsleep_avg"))
parent_activity = rename(parent_activity, c( "sleepefficiency_avg_p" = "sleepefficency_avg"))
parent_activity = rename(parent_activity, c( "waso_avg_p" = "waso_avg"))
parent_activity = parent_activity %>% select(record_id, timepoint, totalsleep_avg_p, sleepefficiency_avg_p, waso_avg_p)
# change arm so timepoint match up
substring(parent_activity$timepoint,nchar(parent_activity$timepoint),nchar(parent_activity$timepoint)) ="2"

# merge promis, child and parent (rename vars to add _p)
promis_peds = promis_peds %>% select(record_id, timepoint, impairment, disturbance)
promis_peds$timepoint = str_replace(promis_peds$timepoint, "baseline_arm_2", "baseline_day_1_arm_2")

promis_parent = promis_parent %>% select(record_id, timepoint, impairment, disturbance)
promis_parent$record_id = sub("1", "2", promis_parent$record_id)
promis_parent = rename(promis_parent, c("impairment_p" = "impairment"))
promis_parent = rename(promis_parent, c("disturbance_p" = "disturbance"))
substring(promis_parent$timepoint,nchar(promis_parent$timepoint),nchar(promis_parent$timepoint)) ="2"
promis_parent$timepoint = str_replace(promis_parent$timepoint, "baseline_arm_2", "baseline_day_1_arm_2")
promis = full_join(promis_peds, promis_parent)

analysis = full_join(child_activity, parent_activity) %>% distinct()
analysis = full_join(analysis, promis) %>% distinct()
analysis = full_join(bl_psqi_groups, analysis) %>% distinct()

# test = exportRecords(rcon,forms = "glycemic_data")
```

```{r model functions, include=FALSE}
fit_mod = function(outcome,df,plot = T,diagnostics = F){
  
  # Format timepoint
  df$timepoint = as.factor(df$timepoint)
  levels(df$timepoint) = gsub("baseline_.*","Baseline",levels(df$timepoint))
  levels(df$timepoint) = gsub("hcl_month_3_.*","Month 3",levels(df$timepoint))
  levels(df$timepoint) = gsub("hcl_month_6_.*","Month 6",levels(df$timepoint))
 
  # Fit random intercept model
  f = as.formula(paste0(outcome,"~timepoint*psqi_group"))
  mod = lme(f,
            random = ~1|record_id,
            data = df,
            na.action = na.omit)
  # Plot
  if(plot){
    p = 
      ggplot(data = df,aes_string(x = "timepoint",y = outcome,
                                  color = "psqi_group",group = "record_id")) + 
      geom_point() + geom_line() + xlab("Timepoint") +
      theme_bw() 
    print(p)
  }
  
  # Anova
  mod_anova = anova.lme(mod, type="marginal")
  print(kable(mod_anova,digits = 3,caption = "Test of Overall Effect"))

 
   # Means
  mod_means = emmeans(mod,specs=pairwise ~ factor(timepoint):psqi_group, adjust="tukey")
  print(kable(mod_means$contrasts[c(3,8,12),],digits = 3,caption = "Timepoint Means"))
 # print(kable(mod_means$contrasts[c(3,8,12),],caption="Time point means.",format.args = list(scientific = FALSE)))

   # Number of obs
  cat("\n")
  cat(paste("This model was fit using",nobs(mod),"observations."))
  cat("\n")
 
   # Check model
  if(diagnostics){
    print(check_model(mod))
  }
}
```



# Results
## Stratify Parents into Poor/Good Sleepers Before Intervention
```{r results 1}
kable(analysis %>% group_by(psqi_group) %>% summarise(n = n_distinct(record_id)))
```
Parent Good Sleeper n = 15 (0.385)
Parent Poor Sleeper n = 23 (0.590)
Note: Subj 127 is missing baseline psqi score, but has very large value for question 4. Confirm this value is correct? Seems like it should be divided by 30

## Compare Groups at each timepoint for glycemic, actigraphy, survey data
### Child Glycemic Measures 
TBR(<54): No difference in groups at each time point (p = 0.65, 0.78, 0.99)
TBR(55-69): No difference in groups at each time point (p = 0.89, 0.93, 0.86)
TIR(70-180): No difference in groups at each time point (p = 0.97, 0.60, 0.92)
TAR(180-250): No difference in groups at each time point (p = 0.91, 0.68, 0.18)
TAR(>251): No difference in groups at each time point (p = 0.78, 0.72, 0.90)
Hba1c: No difference in groups at each time point (p = 0.99, 0.45, 0.77)
GMI: No difference in groups at each time point (p = 0.87, 0.66, 0.99)

```{r results glycemic}
# TIR, TAB, TBR, a1c, gmi
fit_mod("sensor_u54", analysis)
fit_mod("sensor_55_69",analysis)
fit_mod("sensor_70_180", analysis)
fit_mod("sensor_181_250", analysis)
fit_mod("sensor_g251", analysis)
fit_mod("hba1c", analysis)
fit_mod("gmi", analysis)
```

### Actigraphy Measures
#### Parent
Total Sleep: No difference in groups at each time point (p = 0.99, 0.74, 0.81)
Sleep Efficacy: No difference in groups at each time point (p = 0.62, 0.92, 0.98)
WASO: No difference in groups at each time point (p = 0.60, 0.82, 0.91)
#### Child
Total Sleep: No difference in groups at each time point (p = 0.87, 0.99, 0.99)
Sleep Efficacy: No difference in groups at each time point (p = 0.68, 0.99, 0.74)
WASO: No difference in groups at each time point (p = 0.97, 0.95, 0.79)
```{r results Actigraphy}
# Total sleep avg (minutes), wasp, efficiency
# parent
fit_mod("totalsleep_avg_p", analysis)
fit_mod("sleepefficiency_avg_p",analysis)
fit_mod("waso_avg_p", analysis)
# children
fit_mod("totalsleep_avg", analysis)
fit_mod("sleepefficency_avg",analysis)
fit_mod("waso_avg", analysis)
```
  c.	HFS (Total, sub analysis as previously done, eg maintain high)
    i.	Parent self-report
### HFS
#### Parent
#### Child
```{r hfs}

```
### PROMIS
#### Parent Proxy
Disturbance: No difference in groups at each time point (p = 0.86, 0.99, 0.99)
Sleep Related Impairment: No difference in groups at each time point (p = 0.45, 0.57, 0.77)
#### Child
Disturbance: No difference in groups at each time point (p = 0.25, 0.94, 0.84)
Sleep Related Impairment: No difference in groups at each time point (p = 0.73, 0.98, 0.90)
```{r results PROMIS}
# disturbance, impairment
# parent
fit_mod("disturbance_p", analysis)
fit_mod("impairment_p",analysis)
# children
fit_mod("disturbance", analysis)
fit_mod("impairment",analysis)
```

3.	Compare change in Actigraphy, survey, and glycemic data in each group over time
  a.	Poor sleepers from baseline to 3 month and baseline to 6 month
  b.	Good sleepers from baseline to 3 month and baseline to 6 month

4.	Calculate the number of parents in the poor and good sleeper groups who meet criteria for poor and good sleep over time. 
  a.	Looking for the number of parents who change category at each time point
Look at changes over time for glycemic and patient reported outcomes. Do parents defined as poor sleepers (by PSQI score) have children that experience greater change in TIR, parent and child FOH, than good sleepers? How many poor sleepers transitioned to good sleepers after 3 months and 6 months of HCL use? 