---
title: ""
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 5
    toc_float: yes
---

```{r setup, include=FALSE}
library(tidyverse)
library(Seurat) # need these for Differential expression testing
library(SeuratObject)
library(data.table)

# update the dfs as change (changes in first chunk of version 3 on the Lambda)
perc_express_cluster <- read.csv("S:/Laura/BDC/Projects/Howard Davidson/perc_express_cluster_TEST.csv")

# check donor cluster level
perc_express_donorcluster  <- read.csv("S:/Laura/BDC/Projects/Howard Davidson/perc_express_donorcluster_TEST.csv")
#rownames(df2) = colnames(perc_express_donorcluster)
```


```{r fun, include = FALSE}
gene_list = function(df, cutoff){
  # df is one cluster w/ all donors at perc_expr level
  dft = as.data.frame(t(df)[-1,])
  donors  = colnames(dft)
  donorgenes = list()
  for(i in donors){
    nam = dft %>% select(i)
    donor_vec = nam %>% filter(.[[1]] > cutoff)  %>% rownames()
    donorgenes[[i]] = donor_vec
  }
  return(donorgenes)
}


# test code for function above
# c_0 = perc_express_donorcluster %>% filter(cluster == 0) %>% select(-cluster)
# # start fn
# c_0_t = as.data.frame(t(c_0)[-1,])
# donor1_0 = c_0_t %>% select(V1) %>% filter(V1 > 20) %>% rownames() %>% c()# ~ 1400 genes at 20% cutoff for d1c0
# genes_1_0 = rownames(donor1_0)
# donor2_0 = c_0_t %>% select(V2) %>% filter(V2 > 20) # ~ 1400 genes at 20% cutoff for d1c0
# genes_2_0 = rownames(donor2_0)
# gene_list_0_test = intersect(genes_1_0, genes_2_0)
```
Calculate gene frequencies for each donor in cluster 0 and remove genes that have a freq < X eg 0.2

Add cluster tag to gene name to create unique ID eg B2M  becomes “0-B2M” etc

Bind rows for each donor

Determine number of occurrences for each gene and remove those with values less than 23.

Repeat for other clusters.


Clarify: 

For each Cluster,

get percent expressions by donor to get a list of genes expressing above a minimum % cutoff
remove the genes not expressed by all donors within the cluster (only take the intersection of these gene lists)

```{r col clusters, include = F}
# Cluster 0
c_0 = perc_express_donorcluster %>% filter(cluster == 0) %>% select(-cluster)
a = gene_list(c_0, 22.3) 
cluster0_genes = Reduce(intersect, a) # 22.3 for 505 

# Cluster 1
c_1 = perc_express_donorcluster %>% filter(cluster == 1) %>% select(-cluster)
a = gene_list(c_1, 28) # 28 for 502
cluster1_genes = Reduce(intersect, a)

# Cluster 2
c_2 = perc_express_donorcluster %>% filter(cluster == 2) %>% select(-cluster)
a = gene_list(c_2, 26)
cluster2_genes = Reduce(intersect, a) #26% for 500 exactly hot dog

# Cluster 3
c_3 = perc_express_donorcluster %>% filter(cluster == 3) %>% select(-cluster)
a = gene_list(c_3, 28)
cluster3_genes = Reduce(intersect, a)
# Cluster 4
c_4 = perc_express_donorcluster %>% filter(cluster == 4) %>% select(-cluster)
a = gene_list(c_4, 31.6)
cluster4_genes = Reduce(intersect, a)
# Cluster 5
c_5 = perc_express_donorcluster %>% filter(cluster == 5) %>% select(-cluster)
a = gene_list(c_5, 29.4)
cluster5_genes = Reduce(intersect, a)
# Cluster 6
c_6 = perc_express_donorcluster %>% filter(cluster == 6) %>% select(-cluster)
a = gene_list(c_6, 21)
cluster6_genes = Reduce(intersect, a)
# Cluster 7
c_7 = perc_express_donorcluster %>% filter(cluster == 7) %>% select(-cluster)
a = gene_list(c_7,26)
cluster7_genes = Reduce(intersect, a)
# Cluster 8
c_8 = perc_express_donorcluster %>% filter(cluster == 8) %>% select(-cluster)
a = gene_list(c_8, 26.3)
cluster8_genes = Reduce(intersect, a)
# Cluster 9
c_9 = perc_express_donorcluster %>% filter(cluster == 9) %>% select(-cluster)
a = gene_list(c_9,19.3)
cluster9_genes = Reduce(intersect, a)
# Cluster 10
c_10 = perc_express_donorcluster %>% filter(cluster == 10) %>% select(-cluster)
a = gene_list(c_10,6.5)
cluster10_genes = Reduce(intersect, a)
# Cluster 11
c_11 = perc_express_donorcluster %>% filter(cluster == 11) %>% select(-cluster)
a = gene_list(c_11,0)
cluster11_genes = Reduce(intersect, a) # only 400 shared genes between these
# Cluster 12
c_12 = perc_express_donorcluster %>% filter(cluster == 12) %>% select(-cluster)
a = gene_list(c_12,0)
cluster12_genes = Reduce(intersect, a) # only 275 shared genes between donors

```

```{r previous output}

```
QUESTIONS:

- Understanding of avg by donor cells then by cluster; is this still in percent expressed, or have we gone into mean express territory?
-- for percent expressed when aggregated first into donor-cluster cells then back into cluster over a quarter have 100% expressed for c0;
--------for AL627309 (first col in un transposed donor-cluster ) in  we have 11/23 subjects in cluster 0 with very small % express -- into the cluster form we have 47.8% is this the correct % we are looking for?


UPDATE: next steps similar to difacto study (emailed from kristen);
1) identify features corr w outcome -- delta, auc (coded in previous citeseq seurat analysis)
-- average by donor cells then by cluster (intersect the cluster with the donors cells -- 20% or x% perc expression)

2) pseudobulk/ elasticnet