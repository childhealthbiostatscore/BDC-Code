---
title: "Vira Kravets - Mixed model - updates for PLOS BIO"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE)

library(nlme)
library(robustlmm)
library(geoR)
library(sjstats)
library(car)
library(readxl)
library(dplyr)
library(emmeans)
library(data.table)

fig1f <- read.csv("B:/Projects/Vira Kravets/PLOS BIO resubmission/Fig 1F By Cell_IslNorm.csv")
colnames(fig1f) <- c("ID",colnames(fig1f[,2:8]))
fig1f$mouse <- substring(fig1f$ID,1,5)
fig1f$islet <- sub(".*_", "", fig1f$ID)
# need to assign a cell ID within islets
fig1f$unique_islet <- NA
for (i in 1:nrow(fig1f)) {
  fig1f[i,]$unique_islet <- paste0(fig1f[i,]$mouse,fig1f[i,]$islet)
}
fig1f <- fig1f %>% group_by(unique_islet) %>% mutate(cell = sequence(n()))

# make a long dataset
fig1f_long <- reshape(fig1f, direction="long", idvar = c("mouse","islet","cell"), 
                      varying = c("X1st.resp","w.or","w.end","last.resp","hub.like..p1.","hub.like..p2."),
                      v.names = "value",timevar = "Characteristic",
                      times=c("X1st.resp","w.or","w.end","last.resp","hub.like..p1.","hub.like..p2."))
fig1f_long <- fig1f_long %>% arrange(mouse,islet,cell)
fig1f_long$l_value <- log(fig1f_long$value)

###########
# FIG 1f  #
###########

mod_1f <- lme(l_value ~ Characteristic,random=~1|unique_islet,data = fig1f_long,na.action=na.omit)
resid_1f <- residuals(mod_1f)
# QQplot
a_1f <- qqnorm(mod_1f,abline = c(0,1))
x_1f <- a_1f$panel.args[[1]]$x
y_1f <- a_1f$panel.args[[1]]$y
points_1f <- cbind(x_1f,y_1f)
write.csv(points_2c,"B:\\Projects\\Vira Kravets\\Output\\qqplot_fig2c.csv")


```

# Figure 2c 

```{r echo=FALSE, comment=""}
summary(mod_2c)
```

Interpretation of model above: for a 1% increase in initial, repeated changes by `r summary(mod_2c)$tTable[2,1]`%.

```{r echo=FALSE, comment=""}
a_2c
shapiro.test(resid(mod_2c))
r2(mod_2c)
```

