---
title: "Vira Kravets - Mixed model - updates for PLOS BIO"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE)

library(nlme)
library(robustlmm)
library(geoR)
library(sjstats)
library(car)
library(readxl)
library(dplyr)
library(emmeans)
library(data.table)
library(knitr)
library(stringr)

# read in fig 1f
fig1f <- read.csv("B:/Projects/Vira Kravets/PLOS BIO resubmission/Fig 1F By Cell_IslNorm.csv")
colnames(fig1f) <- c("ID",colnames(fig1f[,2:8]))
fig1f$mouse <- substring(fig1f$ID,1,5)
fig1f$islet <- sub(".*_", "", fig1f$ID)
# need to assign a cell ID within islets
fig1f$unique_islet <- NA
for (i in 1:nrow(fig1f)) {
  fig1f[i,]$unique_islet <- paste0(fig1f[i,]$mouse,fig1f[i,]$islet)
}
fig1f <- fig1f %>% group_by(unique_islet) %>% mutate(cell = sequence(n()))
# make a long dataset
fig1f_long <- reshape(fig1f, direction="long", idvar = c("mouse","islet","cell"), 
                      varying = c("Islet","X1st.resp","w.or","w.end","last.resp","hub.like..p1.","hub.like..p2."),
                      v.names = "value",timevar = "Characteristic",
                      times=c("Islet","X1st.resp","w.or","w.end","last.resp","hub.like..p1.","hub.like..p2."))
fig1f_long <- fig1f_long %>% arrange(mouse,islet,cell)
fig1f_long$l_value <- log(fig1f_long$value)
fig1f_long$Characteristic <- as.factor(fig1f_long$Characteristic)

# read in fig 1g
fig1g <- read.csv("B:/Projects/Vira Kravets/PLOS BIO resubmission/Fig 1G byCell_IslNorm.csv")
colnames(fig1g) <- c("ID",colnames(fig1g[,2:8]))
fig1g$mouse <- substring(fig1g$ID,1,5)
fig1g$islet <- sub(".*_", "", fig1g$ID)
# need to assign a cell ID within islets
fig1g$unique_islet <- NA
for (i in 1:nrow(fig1g)) {
  fig1g[i,]$unique_islet <- paste0(fig1g[i,]$mouse,fig1g[i,]$islet)
}
fig1g <- fig1g %>% group_by(unique_islet) %>% mutate(cell = sequence(n()))
# make a long dataset
fig1g_long <- reshape(fig1g, direction="long", idvar = c("mouse","islet","cell"), 
                      varying = c("Islet","X1st.resp","w.or","w.end","last.resp","hub.like..p1.","hub.like..p2."),
                      v.names = "value",timevar = "Characteristic",
                      times=c("Islet","X1st.resp","w.or","w.end","last.resp","hub.like..p1.","hub.like..p2."))
fig1g_long <- fig1g_long %>% arrange(mouse,islet,cell)
fig1g_long$Characteristic <- as.factor(fig1g_long$Characteristic)

# read in fig S2
files <- list.files(path = "B:/Projects/Vira Kravets/PLOS BIO resubmission/Fig S2 individual sheets",
                          full.names = TRUE,recursive = T)
figs2 <- NULL
for (f in 1:length(files)) {
  table <- read.csv(files[f],stringsAsFactors = FALSE,
                               header = TRUE,
                               na.strings = "")
  table$id <- as.factor(as.character(str_extract_all(files[f], "(?<=sheets/).+(?=.csv)")))
  figs2 <- rbind(figs2, table)
}
figs2$Ã¯.. <- NULL
figs2$Distance.to.1st.resp <- NULL
figs2$um <- NULL
colnames(figs2) <- c("Response_time","Distance_1st_resp","ID")

###########
# FIG 1f  #
###########

mod_1f <- lme(value ~ Characteristic,random=~1|unique_islet,data = fig1f_long,na.action=na.omit)
resid_1f <- residuals(mod_1f)
shapiro.test(resid(mod_1f))
# QQplot
a_1f <- qqnorm(mod_1f,abline = c(0,1))
# ANOVA table
mod_1f_anova <- anova.lme(mod_1f, type="marginal")
# use emmeans 
mod_1f_means <- emmeans(mod_1f,"Characteristic")
mod_1f_pairs <-  pairs(mod_1f_means)

###########
# FIG 1g  #
###########

mod_1g <- lme(value ~ Characteristic,random=~1|unique_islet,data = fig1g_long,na.action=na.omit)
resid_1g <- residuals(mod_1g)
shapiro.test(resid(mod_1g))
# QQplot
a_1g <- qqnorm(mod_1g,abline = c(0,1))
# ANOVA table
mod_1g_anova <- anova.lme(mod_1g, type="marginal")
# use emmeans 
mod_1g_means <- emmeans(mod_1g,"Characteristic")
mod_1g_pairs <-  pairs(mod_1g_means)

###########
# FIG S2  #
###########

mod_s2 <- lme(Response_time ~ Distance_1st_resp,random=~1|ID,data = figs2,na.action=na.omit)
resid_s2 <- residuals(mod_s2)
shapiro.test(resid(mod_s2))
# QQplot
a_s2 <- qqnorm(mod_s2,abline = c(0,1))
# ANOVA table
mod_s2_anova <- anova.lme(mod_s2, type="marginal")

```

# Figure 1f

This is the overall summary of the model.  However, most of the information you will need is below in the ANOVA table, estimated means, and pairwise comparisons.

```{r echo=FALSE, comment=""}
summary(mod_1f)
```

## ANOVA table

The p-value for Characteristic is the overall test of the effect.

```{r echo=FALSE, comment=""}
kable(mod_1f_anova)
```

## Estimated means

The table below provides estimates of each mean.

```{r echo=FALSE, comment=""}
kable(mod_1f_means)
```

## Pairwise comparison of means with Tukey's HSD adjustment for multiple testing

The table below provides a comparison of each pairwise combination of means.

```{r echo=FALSE, comment=""}
kable(mod_1f_pairs)
```

# Figure 1g

This is the overall summary of the model.  However, most of the information you will need is below in the ANOVA table, estimated means, and pairwise comparisons.

```{r echo=FALSE, comment=""}
summary(mod_1g)
```

## ANOVA table

The p-value for Characteristic is the overall test of the effect.

```{r echo=FALSE, comment=""}
kable(mod_1g_anova)
```

## Estimated means

The table below provides estimates of each mean.

```{r echo=FALSE, comment=""}
kable(mod_1g_means)
```

## Pairwise comparison of means with Tukey's HSD adjustment for multiple testing

The table below provides a comparison of each pairwise combination of means.

```{r echo=FALSE, comment=""}
kable(mod_1g_pairs)
```

# Figure S2

This is the overall summary of the model. The slope of the regression of response time on distance can be found in the table labeled "fixed effects," under the column labeled "Value," in the row labeled "Distance_1st_resp."

```{r echo=FALSE, comment=""}
summary(mod_s2)
```

## ANOVA table

The p-value for Distance_1st_resp is the test of whether there is a significant non-zero slope.

```{r echo=FALSE, comment=""}
kable(mod_s2_anova)
```
