---
title: "CGM and BMT Functional Data Analysis (FDA)"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(redcapAPI)
library(lubridate)
library(plotly)
library(lcmm)
library(fda)
library(knitr)
library(tidyverse)
knitr::opts_chunk$set(echo = FALSE)
home_dir = 
  ifelse(.Platform$OS.type != "unix",
         "Z:/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Jenna Sopfe/",
         "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Jenna Sopfe/")
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data import}
# REDCap import
api <- read.table("./api_token.txt",header = T,sep = "\t")
rcon <- redcapConnection(url = "https://redcap.ucdenver.edu/api/",
                         token = as.character(api[1,1]))
data_full <- exportRecords(rcon)
# Remove participant 10
data_full <- data_full %>% filter(study_id != "10")
# Fill down Tx date
data_full <- data_full %>% group_by(study_id) %>% fill(date_of_tx)
# Format dates
datecols = c("time_engraft","time_plt_engraft")
data_full[,datecols] <- lapply(data_full[,datecols],lubridate::ymd)
data_full$study_id = as.numeric(data_full$study_id)
# Clean
cgm = read.csv("./CGM Accuracy in BMT/Data_Cleaned/Prospective HSCT CGM Data Updated 6.24.19 FULL DATA SET.csv",na.strings = "")
cgm$Time = mdy_hm(cgm$Time)
cgm$Tx_date = mdy(cgm$Tx_date)
cgm$dx_cat = factor(cgm$dx_cat)
cgm$tx_type = factor(cgm$tx_type)
# Get other dates
dates = data_full %>% select(study_id,all_of(datecols)) %>% 
  group_by(study_id) %>% fill(all_of(datecols),.direction = "updown") %>%
  filter(row_number() == 1)
cgm = left_join(cgm,dates,by = c("SubjectID" = "study_id"))
cgm$time_engraft_minus_3 = cgm$time_engraft - 3
# Time since engraftment
cgm$time_from_engraft = as.numeric(difftime(cgm$Time,cgm$time_engraft_minus_3,units = "mins"))
# Wide format for SAS
cgm_wide = cgm %>% filter(time_from_engraft >= 0 & time_from_engraft <= 8640) %>%
  group_by(SubjectID) %>% mutate(n = row_number()) %>% 
  select(SubjectID,tx_type,dx_cat,Historic_Glucose,time_from_engraft,n) %>%
  pivot_wider(names_from = n,
              values_from = c("Historic_Glucose","time_from_engraft")) %>%
  filter(!is.na(tx_type) & !is.na(dx_cat)) %>% ungroup()
# Write CSV for checking with SAS
write.csv(cgm_wide,file = "./CGM and BMT FDA/Data_Cleaned/cleaned_for_traj.csv",
          row.names = F,na = "")
```

# Latent class analysis

```{r}
traj = function(df,n_class=NULL){
  # Base model (one class)
  m = hlme(Historic_Glucose ~ poly(time,2),subject = 'SubjectID',
            data=df,ng = 1,verbose = FALSE)
  assign("m1",m,envir = globalenv())
  # Increase number of classes
  if(is.null(n_class)){n_class = length(unique(df$SubjectID))}
  for (c in 2:n_class) {
    m = hlme(Historic_Glucose ~ poly(time,2),mixture = ~poly(time,2),
             subject = 'SubjectID',data=df, ng = c,
             B = m1,verbose = FALSE)
    assign(paste0("m",c),m,envir = globalenv())
  }
  # Print model metrics
  do.call(summaryplot,mget(paste0("m",1:n_class),envir = globalenv()))
}
plot_traj = function(model_obj,df){
  plot_df = predictY(model_obj,df,var.time = "time")
  plot_df = data.frame(cbind(df$SubjectID,df$Historic_Glucose,plot_df$times,plot_df$pred))
  plot_df = plot_df %>% pivot_longer(starts_with("Ypred_"))
  plot_df$name = sub("Ypred_","",plot_df$name)
  ggplot(plot_df,aes(x = time,y = value)) + 
    geom_line(aes(color = name)) + 
    geom_point(aes(x = time,y = df.Historic_Glucose),shape = ".") + 
    xlab("Time from Tx") + ylab("Sensor Glucose") +
    theme_bw() + theme(legend.title = element_blank())
}
```

## Time near engraftment

```{r}

```

### Two classes

```{r}
t = cgm %>% filter(!is.na(time),time >= 0 & time <= 6)
```

#### Model metrics by number of classes

For BIC and ICL, lower is better. For entropy, closer to 1 is better.

```{r}
traj(t,n_class = 2)
plot_traj(m2,t)
```
