---
title: "CGM and BMT Functional Data Analysis (FDA)"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(redcapAPI)
library(lubridate)
library(plotly)
library(kmlShape)
library(reshape2)
library(knitr)
library(tidyverse)
library(refund)
library(refund.shiny)
library(tidyfun)
knitr::opts_chunk$set(echo = TRUE)
home_dir = 
  ifelse(.Platform$OS.type != "unix",
         "Z:/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Jenna Sopfe/",
         "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Jenna Sopfe/")
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data import}
# REDCap import
api <- read.table("./api_token.txt",header = T,sep = "\t")
rcon <- redcapConnection(url = "https://redcap.ucdenver.edu/api/",
                         token = as.character(api[1,1]))
data_full <- exportRecords(rcon)
# Remove participant 10
data_full <- data_full %>% filter(study_id != "10")
# Fill down Tx date
data_full <- data_full %>% group_by(study_id) %>% fill(date_of_tx)
# Format dates
datecols = c("time_engraft","time_plt_engraft")
data_full[,datecols] <- lapply(data_full[,datecols],lubridate::ymd)
data_full$study_id = as.numeric(data_full$study_id)
# Calculate BMI
data_full$bmi = data_full$weight/((data_full$height/100)^2)
# Clean
cgm = read.csv("./CGM Accuracy in BMT/Data_Cleaned/Prospective HSCT CGM Data Updated 6.24.19 FULL DATA SET.csv",na.strings = "")
cgm$Time = mdy_hm(cgm$Time)
cgm$Tx_date = mdy(cgm$Tx_date)
cgm$dx_cat = factor(cgm$dx_cat)
cgm$tx_type = factor(cgm$tx_type)
# Get other dates
dates = data_full %>% select(study_id,bmi,all_of(datecols)) %>% 
  group_by(study_id) %>% fill(all_of(datecols),.direction = "updown") %>%
  filter(row_number() == 1)
cgm = left_join(cgm,dates,by = c("SubjectID" = "study_id"))
cgm$time_engraft_minus_3 = cgm$time_engraft - 3
# Time since engraftment
cgm$time_from_engraft = as.numeric(difftime(cgm$Time,cgm$time_engraft_minus_3,units = "mins"))
# Wide format for SAS
cgm_wide = cgm %>% filter(time_from_engraft >= 0) %>%
  group_by(SubjectID) %>% mutate(n = row_number()) %>% 
  select(SubjectID,tx_type,dx_cat,bmi,Historic_Glucose,time_from_engraft,n) %>%
  pivot_wider(names_from = n,
              values_from = c("Historic_Glucose","time_from_engraft")) %>%
  filter(!is.na(tx_type) & !is.na(dx_cat)) %>% ungroup()
# Write CSV for checking with SAS
write.csv(cgm_wide,file = "./CGM and BMT FDA/Data_Cleaned/cleaned_for_traj.csv",
          row.names = F,na = "")
```

# Trajectory analysis

```{r}
# Time from engraftment
dn = cgm %>% 
  select(SubjectID,time_from_engraft,Historic_Glucose) %>%
  filter(time_from_engraft >=0 & time_from_engraft <= 450)
myClds <- cldsLong(dn)
kmlShape(myClds,2)
```

# Functional data analysis

## Transplant type

```{r warning=FALSE}
fda_df = cgm %>% group_by(SubjectID) %>% fill(tx_type) %>% ungroup() %>%
  filter(time_from_engraft >= 0 & time_from_engraft <= 1440) %>% 
  select(SubjectID,time_from_engraft,tx_type,Historic_Glucose) %>%
  tf_nest(Historic_Glucose,.id = SubjectID,.arg = time_from_engraft)
fda_df %>% ggplot(aes(y = Historic_Glucose,color = tx_type)) + 
  geom_spaghetti(alpha = 0.3) +
  theme_bw()
```

```{r}
Y = fda_df %>% tf_spread(value = Historic_Glucose,arg = 0:1440) %>% data.matrix(.)
fpca_res = fpca.sc(Y)
```
