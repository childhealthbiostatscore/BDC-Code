---
title: "CGM and BMT Functional Data Analysis (FDA)"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(plotly)
library(lcmm)
library(fda)
library(knitr)
knitr::opts_chunk$set(echo = FALSE,cache = TRUE)
home_dir = 
  ifelse(.Platform$OS.type != "unix",
         "Z:/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Jenna Sopfe/CGM Accuracy in BMT/",
         "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Jenna Sopfe/CGM Accuracy in BMT/")
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data import}
# Clean
cgm = read.csv("./Data_Cleaned/Prospective HSCT CGM Data Updated 6.24.19 FULL DATA SET.csv",
               na.strings = "")
cgm$Time = mdy_hm(cgm$Time)
cgm$Tx_date = mdy(cgm$Tx_date)
cgm$dx_cat = factor(cgm$dx_cat)
cgm$tx_type = factor(cgm$tx_type)
# Convert to time since transplant
cgm$time_from_tx = as.numeric(difftime(cgm$Time,cgm$Tx_date,units = "mins"))
```

# Plots

## Colored by ID

```{r}
all_plot = ggplot(cgm,aes(x = time_from_tx,y = Historic_Glucose,color = factor(SubjectID))) + 
  geom_line(alpha = 0.2) + 
  xlab("Minutes from Transplant") + ylab("Sensor Glucose (mg/dL)") +
  theme_bw() + 
  theme(legend.position = "none")
ggplotly(all_plot)
```

## Colored by Dx Category

```{r}
dx_plot = ggplot(cgm,aes(x = time_from_tx,y = Historic_Glucose,color = dx_cat)) + 
  geom_line(alpha = 0.2) + 
  xlab("Minutes from Transplant") + ylab("Sensor Glucose (mg/dL)") +
  theme_bw()
ggplotly(dx_plot)
```

## Colored by Tx Type

```{r}
tx_plot = ggplot(cgm,aes(x = time_from_tx,y = Historic_Glucose,color = tx_type)) + 
  geom_line(alpha = 0.2) + 
  xlab("Minutes from Transplant") + ylab("Sensor Glucose (mg/dL)") +
  theme_bw()
ggplotly(tx_plot)
```

# Latent class analysis

```{r}
traj = function(df,n_class=NULL){
  # Base model (one class)
  m = hlme(Historic_Glucose ~ poly(time_from_tx,2),subject = 'SubjectID',
            data=df,ng = 1,verbose = FALSE)
  assign("m1",m,envir = globalenv())
  # Increase number of classes
  if(is.null(n_class)){n_class = length(unique(df$SubjectID))}
  for (c in 2:n_class) {
    m = hlme(Historic_Glucose ~ poly(time_from_tx,2),mixture = ~poly(time_from_tx,2),
             subject = 'SubjectID',data=df, ng = c,B = m1,verbose = FALSE)
    assign(paste0("m",c),m,envir = globalenv())
  }
  # Print model metrics
  do.call(summaryplot,mget(paste0("m",1:n_class),envir = globalenv()))
}
plot_traj = function(model_obj,df){
  plot_df = predictY(model_obj,df,var.time = "time_from_tx")
  plot_df = data.frame(cbind(df$SubjectID,df$Historic_Glucose,plot_df$times,plot_df$pred))
  plot_df = plot_df %>% pivot_longer(starts_with("Ypred_"))
  plot_df$name = sub("Ypred_","",plot_df$name)
  ggplot(plot_df,aes(x = time_from_tx,y = value)) + 
    geom_line(aes(color = name)) + 
    geom_point(aes(x = time_from_tx,y = df.Historic_Glucose),shape = ".") + 
    xlab("Time from Tx") + ylab("Sensor Glucose") +
    theme_bw() + theme(legend.title = element_blank())
}
```

## Model metrics by number of classes

For BIC and ICL, lower is better. For entropy, closer to 1 is better.

### One day after Tx

```{r}
t = cgm[cgm$time_from_tx >=0 & cgm$time_from_tx <= 1440,]
traj(t,n_class = 5)
```

```{r}
plot_traj(m4,t)
```

```{r efpc,eval=FALSE}
# Each column is a participant
y_mat = cgm %>% select(SubjectID,time_from_tx,Historic_Glucose) %>% 
  pivot_wider(names_from = SubjectID,names_prefix = "ID",
              values_from = Historic_Glucose) %>% 
  select(-time_from_tx) %>% data.matrix(.)
# B splines
basis = 
  create.bspline.basis(rangeval = c(min(cgm$time_from_tx),max(cgm$time_from_tx)),
                       nbasis = 5)
# FD
W.fd=smooth.basis(y=y_mat, fdParobj=basis)
```
