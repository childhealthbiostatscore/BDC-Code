---
title: "CGM and BMT Functional Data Analysis (FDA)"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(redcapAPI)
library(lubridate)
library(plotly)
library(kmlShape)
library(reshape2)
library(knitr)
library(tidyverse)
library(refund)
library(refund.shiny)
library(tidyfun)
library(refundr)
knitr::opts_chunk$set(echo = TRUE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "B:/Projects/Jenna Sopfe/"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Jenna Sopfe/"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Jenna Sopfe/"
}
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data import}
# REDCap import
api <- read.table("./api_token.txt",header = T,sep = "\t")
rcon <- redcapConnection(url = "https://redcap.ucdenver.edu/api/",
                         token = as.character(api[1,1]))
data_full <- exportRecords(rcon)
# Remove participant 10
data_full <- data_full %>% filter(study_id != "10")
# Fill down Tx date
data_full <- data_full %>% group_by(study_id) %>% fill(date_of_tx)
# Format dates
datecols = c("time_engraft","time_plt_engraft")
data_full[,datecols] <- lapply(data_full[,datecols],lubridate::ymd)
data_full$study_id = as.numeric(data_full$study_id)
# Calculate BMI
data_full$bmi = data_full$weight/((data_full$height/100)^2)
# Clean
cgm = read.csv("./CGM Accuracy in BMT/Data_Cleaned/Prospective HSCT CGM Data Updated 6.24.19 FULL DATA SET.csv",na.strings = "")
cgm$Time = mdy_hm(cgm$Time)
cgm$Tx_date = mdy(cgm$Tx_date)
cgm$dx_cat = factor(cgm$dx_cat)
cgm$tx_type = factor(cgm$tx_type)
# Get other dates
dates = data_full %>% select(study_id,bmi,all_of(datecols)) %>% 
  group_by(study_id) %>% fill(all_of(datecols),.direction = "updown") %>%
  filter(row_number() == 1)
cgm = left_join(cgm,dates,by = c("SubjectID" = "study_id"))
cgm$time_engraft_minus_3 = cgm$time_engraft - 3
# Time since engraftment
cgm$time_from_engraft = as.numeric(difftime(cgm$Time,cgm$time_engraft_minus_3,units = "mins"))
# Wide format for SAS
cgm_wide = cgm %>% filter(time_from_engraft >= 0) %>%
  group_by(SubjectID) %>% mutate(n = row_number()) %>% 
  select(SubjectID,tx_type,dx_cat,bmi,Historic_Glucose,time_from_engraft,n) %>%
  pivot_wider(names_from = n,
              values_from = c("Historic_Glucose","time_from_engraft")) %>%
  filter(!is.na(tx_type) & !is.na(dx_cat)) %>% ungroup()
# Write CSV for checking with SAS
write.csv(cgm_wide,file = "./CGM and BMT FDA/Data_Cleaned/cleaned_for_traj.csv",
          row.names = F,na = "")
```

# Q score

```{r}
# Convert to mmol/L
cgm$mmol = cgm$Historic_Glucose / 18.0182
# Split by ID and sensor number
cgm_list = split.data.frame(cgm,list(cgm$SubjectID,cgm$SensorNum))
# Q score for each sensor - calculate hours per day from percent time
q_scores = lapply(cgm_list, function(df){
  tg3.9 = mean(df$mmol < 3.9,na.rm = T) * 24
  tg8.9 = mean(df$mmol > 8.9,na.rm = T) * 24
  mbg = mean(cgm$mmol,na.rm = T)
  r = abs(diff(range(cgm$mmol,na.rm = T)))
  df$round_time = lubridate::round_date(df$Time,unit = "5 minutes")
  df$round_time = sapply(strsplit(as.character(df$round_time)," "),"[[",2)
  modd = df %>% group_by(round_time) %>% 
    mutate(t_diff = abs(mmol - lag(mmol)))
  modd = mean(modd$t_diff,na.rm = T)
  q = 8 + (mbg - 7.8)/1.7 + (r - 7.5)/2.9 + (tg3.9-0.6)/1.2 + (tg8.9 - 6.2)/5.7 + 
    (modd - 1.8)/0.9
})
```

