---
title: "AHA clinical model"
author: "Laura Pyle and Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
library(sas7bdat)
library(glmnet)
library(tidyr)
library(glinternet)
library(dplyr)
library(survival)
library(performance)
library(UpSetR)
library(knitr)
library(corrplot)
library(survminer)
library(Hmisc)
library(purrr)
library(skimr)
library(stringr)
library(caret)
library(parallel)
library(pROC)
library(PooledCohort)
library(haven)

knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "B:/Projects"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
}
knitr::opts_knit$set(root.dir = home_dir)
```

```{r, warning=FALSE}
source("C:/Users/pylell/Documents/GitHub/shared-resources/lasso/glinternet.R")
#source("/home/laura/Documents/Github/shared-resources/lasso/glinternet.R")
#source("/home/tim/GitHub/Helper-Functions/glinternet.R")
#### DATA FRAME WITH LIPID MEDS AND EGDR COMPONENTS
#allvisits_long <- read.sas7bdat("./Janet Snell-Bergeon/AHA collaborative grant/Combined predictive model/allvisits_long.sas7bdat")
allvisits_long <- read.sas7bdat("T:/Janet Snell-Bergeon/AHA collaborative grant/Combined predictive model/allvisits_long.sas7bdat")
allvisits_long <- allvisits_long[allvisits_long$StudyID != 2389,]
v1 <- allvisits_long[allvisits_long$Visit==1,]
v1 <- v1[,c("StudyID","age","duration","bmi","whr","onhypermeds","onlipidmeds","avediabp","avesystbp","smkstatus","ldl","hdlc","tri",
            "CKDepi","ac","albuminuria","insdoseperkg","hba1c","l45vsf","l45sqf","egdr","apob","crp","fib","homo","pai1","sex")]
#cac <- read.csv("./Janet Snell-Bergeon/AHA collaborative grant/Proteomics/Data_Cleaned/cac_groups.csv")
cac <- read.csv("T:/Janet Snell-Bergeon/AHA collaborative grant/Proteomics/Data_Cleaned/cac_groups.csv")
cac$CACprogV3 <- ifelse(cac$C3 - cac$C1 >= 2.5,"Progression","No Progression")
cac$CACprogV3[is.na(cac$CACprogV3)] <- "Unknown"
cac <- cac[,c("StudyID","CACprogV3")]
final <- merge(cac,v1,by="StudyID",all.x = T, all.y = T)
#ua <- read.sas7bdat("./Janet Snell-Bergeon/AHA collaborative grant/Combined predictive model/uricacid_b.sas7bdat")
ua <- read.sas7bdat("T:/Janet Snell-Bergeon/AHA collaborative grant/Combined predictive model/uricacid_b.sas7bdat")
ua <- ua[,c("StudyID","UA")]
final <- merge(final,ua,by="StudyID",all.x = T, all.y = F)
#pat <- read.sas7bdat("./Janet Snell-Bergeon/AHA collaborative grant/Combined predictive model/PATwide.sas7bdat")
pat <- read.sas7bdat("T:/Janet Snell-Bergeon/AHA collaborative grant/Combined predictive model/PATwide.sas7bdat")
pat$StudyID <- pat$STUDYID
pat <- pat[,c("StudyID","pfatcm_v1")]
final <- merge(final,pat,by="StudyID",all.x = T, all.y = F)
final <- final[final$CACprogV3 != "Unknown",]
final$CACprogV3_num <- ifelse(final$CACprogV3=="Progression",1,0)
final$CACprogV3 <- NULL
final$alb_num <- ifelse(final$albuminuria %in% c("mac","mic"),1,
                                  ifelse(final$albuminuria=="non",0,NA))
final$albuminuria <- NULL
final$smknum <- ifelse(final$smkstatus=="Current",1,
                                 ifelse(final$smkstatus %in% c("Former","Never"),0,NA))
final$smkstatus <- NULL
# drop albuminuria status - we don't want it and AC together
final$alb_num <- NULL
# recode sex
final$sex_0m1f <- ifelse(final$sex==1,0,1) 
final$sex <- NULL
# drop egdr
final$egdr <- NULL

#event <- read.csv("./Janet Snell-Bergeon/AHA collaborative grant/Combined predictive model/QVisits_LastVisit_20211205.csv")
event <- read.csv("T:/Janet Snell-Bergeon/AHA collaborative grant/Combined predictive model/QVisits_LastVisit_8-10-21.csv")
race <- event[,c("StudyID","race","cholV1","dia")]
final <- merge(final,race,by="StudyID",all.x = T,all.y = F)

# calculate 10 yr ASCVD risk
final$pcr_probs <- predict_10yr_ascvd_risk(
  sex=final$sex_0m1f,
  sex_levels = list(female="1",male="0"),
  race=final$race,
  race_levels = list(black="6",white=c("1","2","3","4","5","7","9")),
  age_years = final$age,
  chol_total_mgdl = final$cholV1,
  chol_hdl_mgdl = final$hdlc,
  bp_sys_mmhg = final$avesystbp,
  bp_meds = final$onhypermeds,
  bp_meds_levels = list(no="0",yes="1"),
  smoke_current = final$smknum,
  smoke_current_levels = list(no="0",yes="1"),
  diabetes = final$dia,
  diabetes_levels = list(no="1",yes="0"),
  override_boundary_errors = TRUE
)
final$pcr_percent <- final$pcr_probs*100
final$pcr_probs <- NULL

# read in Janet's risk scores and compare
#sas_check <- read.sas7bdat("./Janet Snell-Bergeon/AHA collaborative grant/Combined predictive model/allvisits_cvdrisk.sas7bdat")
#sas_check$StudyID <- sas_check$study_id
#keep <- final[,c("StudyID","pcr_percent")]
#sas_check <- merge(sas_check,keep,by="StudyID")
#sas_check$diff <- sas_check$ASCVD_10yr - sas_check$pcr_percent

# only complete cases
complete_lipidmeds_egdr_components <- drop_na(final)

# log transform nonnormal vars
#complete_lipidmeds_egdr_components$l.duration <- log(complete_lipidmeds_egdr_components$duration)
#complete_lipidmeds_egdr_components$l.duration_2 <- log(complete_lipidmeds_egdr_components$duration^2)
# dichotomize duration above and below median
complete_lipidmeds_egdr_components$duration_cat <- ifelse(complete_lipidmeds_egdr_components$duration<23,0,1)
complete_lipidmeds_egdr_components$duration <- NULL
complete_lipidmeds_egdr_components$l.bmi <- log(complete_lipidmeds_egdr_components$bmi)
complete_lipidmeds_egdr_components$bmi <- NULL
complete_lipidmeds_egdr_components$l.avediabp <- log(complete_lipidmeds_egdr_components$avediabp)
complete_lipidmeds_egdr_components$avediabp <- NULL
complete_lipidmeds_egdr_components$l.avesystbp <- log(complete_lipidmeds_egdr_components$avesystbp)
complete_lipidmeds_egdr_components$avesystbp <- NULL
complete_lipidmeds_egdr_components$l.hdlc <- log(complete_lipidmeds_egdr_components$hdlc)
complete_lipidmeds_egdr_components$hdlc <- NULL
complete_lipidmeds_egdr_components$l.tri <- log(complete_lipidmeds_egdr_components$tri)
complete_lipidmeds_egdr_components$tri <- NULL
complete_lipidmeds_egdr_components$l.CKDepi <- log(complete_lipidmeds_egdr_components$CKDepi)
complete_lipidmeds_egdr_components$CKDepi <- NULL
complete_lipidmeds_egdr_components$l.ac <- log(complete_lipidmeds_egdr_components$ac)
complete_lipidmeds_egdr_components$ac <- NULL
complete_lipidmeds_egdr_components$l.insdoseperkg <- log(complete_lipidmeds_egdr_components$insdoseperkg)
complete_lipidmeds_egdr_components$insdoseperkg <- NULL
complete_lipidmeds_egdr_components$l.hba1c <- log(complete_lipidmeds_egdr_components$hba1c)
complete_lipidmeds_egdr_components$hba1c <- NULL
complete_lipidmeds_egdr_components$l.l45vsf <- log(complete_lipidmeds_egdr_components$l45vsf)
complete_lipidmeds_egdr_components$l45vsf <- NULL
complete_lipidmeds_egdr_components$l.l45sqf <- log(complete_lipidmeds_egdr_components$l45sqf)
complete_lipidmeds_egdr_components$l45sqf <- NULL
complete_lipidmeds_egdr_components$l.crp <- log(complete_lipidmeds_egdr_components$crp)
complete_lipidmeds_egdr_components$crp <- NULL
complete_lipidmeds_egdr_components$l.fib <- log(complete_lipidmeds_egdr_components$fib)
complete_lipidmeds_egdr_components$fib <- NULL
complete_lipidmeds_egdr_components$l.homo <- log(complete_lipidmeds_egdr_components$homo)
complete_lipidmeds_egdr_components$homo <- NULL
complete_lipidmeds_egdr_components$l.pai1 <- log(complete_lipidmeds_egdr_components$pai1)
complete_lipidmeds_egdr_components$pai1 <- NULL
complete_lipidmeds_egdr_components$l.UA <- log(complete_lipidmeds_egdr_components$UA)
complete_lipidmeds_egdr_components$UA <- NULL
complete_lipidmeds_egdr_components$l.pfatcm_v1 <- log(complete_lipidmeds_egdr_components$pfatcm_v1)
complete_lipidmeds_egdr_components$pfatcm_v1 <- NULL

######
### make dfs with event data
# death
death <- event[,c("StudyID","Deceased","PersonYrsDeath")]
death$death <- ifelse(event$Deceased=="Deceased",1,0)
death$Deceased <- NULL
complete_lipidmeds_egdr_components_death <- merge(complete_lipidmeds_egdr_components,death,by="StudyID",all.x = T,all.y = F)
complete_lipidmeds_egdr_components_death$CACprogV3_num <- NULL
# CAD
cad <- event[,c("StudyID","CAD","PersonYrsCAD")]
complete_lipidmeds_egdr_components_cad<- merge(complete_lipidmeds_egdr_components,cad,by="StudyID",all.x = T,all.y = F)
complete_lipidmeds_egdr_components_cad$CACprogV3_num <- NULL
# HardCAD
hardcad <- event[,c("StudyID","HardCAD","PersonYrsHardCAD")]
complete_lipidmeds_egdr_components_hardcad<- merge(complete_lipidmeds_egdr_components,hardcad,by="StudyID",all.x = T,all.y = F)
complete_lipidmeds_egdr_components_hardcad$CACprogV3_num <- NULL
# CVD
cvd <- event[,c("StudyID","CVD","PersonYrsCVD")]
complete_lipidmeds_egdr_components_cvd<- merge(complete_lipidmeds_egdr_components,cvd,by="StudyID",all.x = T,all.y = F)
complete_lipidmeds_egdr_components_cvd$CACprogV3_num <- NULL
# HardCVD
hardcvd <- event[,c("StudyID","HardCVD","PersonYrsHardCVD")]
complete_lipidmeds_egdr_components_hardcvd<- merge(complete_lipidmeds_egdr_components,hardcvd,by="StudyID",all.x = T,all.y = F)
complete_lipidmeds_egdr_components_hardcvd$CACprogV3_num <- NULL
####
#### check missingness of CAC variables and calculate change in CAC per year
#cac <- read.csv("./Janet Snell-Bergeon/AHA collaborative grant/Proteomics/Data_Cleaned/cac_groups.csv")
cac <- read.csv("T:/Janet Snell-Bergeon/AHA collaborative grant/Proteomics/Data_Cleaned/cac_groups.csv")
x <- cac[,c("StudyID","C1","C2","C3","C4")]
x$last <- ifelse(!is.na(x$C4),4,
                 ifelse(!is.na(x$C3),3,
                        ifelse(!is.na(x$C2),2,1)))
x$cac_change_per_yr <- ifelse(x$last==4,(x$C4-x$C1)/12,
                              ifelse(x$last==3,(x$C3-x$C1)/6,(x$C2-x$C1)/3))
x <- x[,c("StudyID","cac_change_per_yr")]
complete_lipidmeds_egdr_components_ccc <- merge(complete_lipidmeds_egdr_components,x,by="StudyID",all.x = T,all.y = F)
complete_lipidmeds_egdr_components_ccc$CACprogV3_num <- NULL
####
# set number of levels for glinternet
numLevels_lipidmeds_egdr_components <- c(1,1,1,1,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2)
numLevels_lipidmeds_egdr_components_simple <- c(1,1,1,2,2,1,1,1,1,1,1,1,1,1,2,2)

# read in omics data - for now, we won't worry about SNPs
load(file="./Janet Snell-Bergeon/AHA collaborative grant/aha_master_data.Rdata")
omics_data <- df[,c("StudyID","gly_P02671.7","gly_P02671.5","gly_P02671.4","gly_P02671.3","AAA01201000179.0807263.4","gly_P02679",
                    "HMDB00510161.0696402.9","AAA01201000179.0809235.7","gly_P02675.4","gly_P02675","gly_P02647","P02655","gly_P02647.1",
                    "HMDB00510161.0694436","gly_P02652","gly_P01009","gly_P01834.11","P01817","AcCa 10:3","HMDB0028822260.1378628.6",
                    "AAA01201000179.0807263.4","gly_P02671.3","gly_P02671.7")]
omics_data_ids <- omics_data$StudyID
d <- duplicated(omics_data_ids)
dups <- omics_data_ids[d]
omics_data <- omics_data[!omics_data$StudyID %in% dups,]

# merge omics data with the CAD dataset
ada_data <- merge(complete_lipidmeds_egdr_components_cad,omics_data,by="StudyID",all.x = T,all.y = F)

# find subset of people with variables in model 4.4 AND all omics variables
# the clinical variables are age, onhypermeds, onlipidmeds, ldl, smknum, race, cholV1, duration_cat, l.bmi, l.avediabp, l.hdlc,
# l.CKDepi, l.ac, l.insdoseperkg, l.hba1c
ada_data <- ada_data[,c("StudyID","CAD","PersonYrsCAD","gly_P02671.7","gly_P02671.5","gly_P02671.4","gly_P02671.3","AAA01201000179.0807263.4","gly_P02679",
                    "HMDB00510161.0696402.9","AAA01201000179.0809235.7","gly_P02675.4","gly_P02675","gly_P02647","P02655","gly_P02647.1",
                    "HMDB00510161.0694436","gly_P02652","gly_P01009","gly_P01834.11","P01817","AcCa 10:3","HMDB0028822260.1378628.6",
                    "AAA01201000179.0807263.4","gly_P02671.3","gly_P02671.7","age", "onhypermeds", "onlipidmeds", "ldl", "smknum", "race", 
                    "cholV1", "duration_cat", "l.bmi", "l.avediabp","l.avesystbp" ,"l.hdlc","l.CKDepi", "l.ac", "l.insdoseperkg", "l.hba1c")]
c <- complete.cases(ada_data)
ada_data_complete <- ada_data[c,]

# merge omics data with the CAD dataset
ada_data_cacp <- merge(complete_lipidmeds_egdr_components,omics_data,by="StudyID",all.x = T,all.y = F)
# find subset of people with variables in model 4.4 AND all omics variables
ada_data_cacp <- ada_data_cacp[,c("StudyID","CACprogV3_num","gly_P02671.7","gly_P02671.5","gly_P02671.4","gly_P02671.3","AAA01201000179.0807263.4","gly_P02679",
                    "HMDB00510161.0696402.9","AAA01201000179.0809235.7","gly_P02675.4","gly_P02675","gly_P02647","P02655","gly_P02647.1",
                    "HMDB00510161.0694436","gly_P02652","gly_P01009","gly_P01834.11","P01817","AcCa 10:3","HMDB0028822260.1378628.6",
                    "AAA01201000179.0807263.4","gly_P02671.3","gly_P02671.7",
                    "age", "onhypermeds", "onlipidmeds", "ldl", "smknum", "race","sex_0m1f",
                    "cholV1", "duration_cat", "l.bmi", "l.avediabp","l.avesystbp" ,"l.hdlc","l.tri","l.CKDepi", "l.ac", "l.insdoseperkg", "l.hba1c")]
c2 <- complete.cases(ada_data_cacp)
ada_data_cacp_complete <- ada_data_cacp[c2,]
```

# LASSO for CAC progression, using lipid lowering meds and A1c, WHR, onhypermeds

## LASSO without interactions

```{r, echo=FALSE, comment=""}
set.seed(3654)
# LASSO
x <- as.matrix(subset(complete_lipidmeds_egdr_components,select=-c(CACprogV3_num,StudyID,pcr_percent)))
glmmod1 <- glmnet(x, y=as.factor(complete_lipidmeds_egdr_components$CACprogV3_num), alpha=1, family="binomial",nfolds=nrow(complete_lipidmeds_egdr_components))
# find best value of lambda
cv.glmmod <- cv.glmnet(x, y=complete_lipidmeds_egdr_components$CACprogV3_num, alpha=1,nfolds=nrow(complete_lipidmeds_egdr_components))
best.lambda <- cv.glmmod$lambda.min
# coefficients at best lambda
round(coef(glmmod1,s=cv.glmmod$lambda.min),4)
prog_noint_coefs <- as.matrix(coef(glmmod1,s=cv.glmmod$lambda.min),4)
prog_noint_coefs <- rownames(prog_noint_coefs)[prog_noint_coefs[,1]!=0]

temp <- prog_noint_coefs[-1]
form <- paste0(temp,collapse = "+")
form <- paste0("~",form)
```

## GLM using variables selected by LASSO

```{r, echo=FALSE, comment=""}
form <- paste0("CACprogV3_num",form)
form <- str_replace(form,"l.duration\\+l.duration_2","poly(l.duration,2)")
refit_mod = glm(as.formula(form),complete_lipidmeds_egdr_components,family = binomial("logit"))
summary(refit_mod)
prog_noint_coefs_sig <- as.matrix(summary(refit_mod)$coef)
prog_noint_coefs_sig <- rownames(prog_noint_coefs_sig)[prog_noint_coefs_sig[,4]<0.05]
aic_values <- NA
aic_values <- c(aic_values,refit_mod$aic)
mod_names <- "CAC progression, no interactions"
```

## LASSO with interactions

```{r, echo=FALSE, comment=""}
set.seed(3654)
test <- complete_lipidmeds_egdr_components %>% select(-pcr_percent)
test$onlipidmeds <- as.factor(test$onlipidmeds)
test$onhypermeds <- as.factor(test$onhypermeds)
test$smknum <- as.factor(test$smknum)
test$sex_0m1f <- as.factor(test$sex_0m1f)
test$race <- as.factor(test$race)
test$CACprogV3_num <- as.factor(test$CACprogV3_num)
form_test <- easy_glinternet(df=test,outcome = "CACprogV3_num",id_vars = "StudyID",
                             fam = "binomial",cv_type = "loo",cores = 24)
form_test <- str_replace(form_test,"l.duration\\+l.duration_2","poly(l.duration,2)")
```

## GLM using variables selected by LASSO with interactions

```{r, echo=FALSE, comment=""}
refit_mod_int = glm(as.formula(form_test),data=test,family = binomial("logit"))
summary(refit_mod_int)
aic_values <- c(aic_values,refit_mod_int$aic)
mod_names <- c(mod_names,"CAC progression, with interactions")
#prog_int_coefs <- as.matrix(summary(refit_mod_int)$coef)
#prog_int_coefs <- row.names(prog_noint_coefs)
```

## LASSO of clinical variables, without interactions

```{r, echo=FALSE, comment=""}
set.seed(3654)
# LASSO
x <- as.matrix(subset(complete_lipidmeds_egdr_components,select=-c(CACprogV3_num,StudyID,l.crp,l.homo,l.pai1,l.fib,l.UA,whr,apob,l.l45vsf,l.l45sqf,l.pfatcm_v1,pcr_percent)))
glmmod1 <- glmnet(x, y=as.factor(complete_lipidmeds_egdr_components$CACprogV3_num), alpha=1, family="binomial",nfolds=nrow(complete_lipidmeds_egdr_components))
# find best value of lambda
cv.glmmod <- cv.glmnet(x, y=complete_lipidmeds_egdr_components$CACprogV3_num, alpha=1,nfolds=nrow(complete_lipidmeds_egdr_components))
best.lambda <- cv.glmmod$lambda.min
# coefficients at best lambda
round(coef(glmmod1,s=cv.glmmod$lambda.min),4)
temp_coefs <- as.matrix(coef(glmmod1,s=cv.glmmod$lambda.min),4)
temp_coefs <- rownames(temp_coefs)[temp_coefs[,1]!=0]
temp <- temp_coefs[-1]
form <- paste0(temp,collapse = "+")
form <- paste0("~",form)
```

## GLM using clinical variables selected by LASSO

```{r, echo=FALSE, comment=""}
form <- paste0("CACprogV3_num",form)
form <- str_replace(form,"l.duration\\+l.duration_2","poly(l.duration,2)")
form_cacp <- form
refit_mod = glm(as.formula(form),complete_lipidmeds_egdr_components,family = binomial("logit"))
summary(refit_mod)
aic_values <- c(aic_values,refit_mod$aic)
mod_names <- c(mod_names,"CAC progression, simple clinical variables, without interactions")

or_refit_mod <- round(exp(cbind(OR = coef(refit_mod), confint(refit_mod))),2)
```

## LASSO of clinical variables with interactions

```{r, echo=FALSE, comment=""}
set.seed(3654)
test <- subset(complete_lipidmeds_egdr_components,select=-c(l.crp,l.homo,l.pai1,l.fib,l.UA,whr,apob,l.l45vsf,l.l45sqf,l.pfatcm_v1,pcr_percent))
test$onlipidmeds <- as.factor(test$onlipidmeds)
test$onhypermeds <- as.factor(test$onhypermeds)
test$smknum <- as.factor(test$smknum)
test$sex_0m1f <- as.factor(test$sex_0m1f)
test$CACprogV3_num <- as.factor(test$CACprogV3_num)
test$race <- as.factor(test$race)
form_test <- easy_glinternet(df=test,outcome = "CACprogV3_num",id_vars = "StudyID",
                             fam ="binomial",cv_type = "loo",cores = 24)
```

## GLM using clinical variables selected by LASSO with interactions

```{r, echo=FALSE, comment=""}
refit_mod = glm(as.formula(form_test),data=test,family = binomial("logit"))
summary(refit_mod)
aic_values <- c(aic_values,refit_mod$aic)
mod_names <- c(mod_names,"CAC progression, simple clinical variables, with interactions")
```

## GLM using ASCVD 10 year risk

```{r, echo=FALSE, comment=""}
refit_mod = glm(CACprogV3_num ~ pcr_percent,data=complete_lipidmeds_egdr_components,family = binomial("logit"))
summary(refit_mod)
aic_values <- c(aic_values,refit_mod$aic)
mod_names <- c(mod_names,"CAC progression, ASCVD 10 year risk")
```

# LASSO for change in CAC per year using lipid lowering meds and A1c, WHR, onhypermeds

## LASSO without interactions

```{r, echo=FALSE, comment=""}
set.seed(3654)
# LASSO
x <- as.matrix(subset(complete_lipidmeds_egdr_components_ccc,select=-c(cac_change_per_yr,StudyID,pcr_percent)))
glmmod1 <- glmnet(x, y=complete_lipidmeds_egdr_components_ccc$cac_change_per_yr, alpha=1, family="gaussian",nfolds=nrow(complete_lipidmeds_egdr_components_ccc))
# find best value of lambda
cv.glmmod <- cv.glmnet(x, y=complete_lipidmeds_egdr_components_ccc$cac_change_per_yr, alpha=1,nfolds=nrow(complete_lipidmeds_egdr_components_ccc))
best.lambda <- cv.glmmod$lambda.min
# coefficients at best lambda
round(coef(glmmod1,s=cv.glmmod$lambda.min),4)
cac_noint_coefs <- as.matrix(coef(glmmod1,s=cv.glmmod$lambda.min),4)
cac_noint_coefs <- rownames(cac_noint_coefs)[cac_noint_coefs[,1]!=0]

temp <- cac_noint_coefs[-1]
form <- paste0(temp,collapse = "+")
form <- paste0("~",form)
```

## GLM using variables selected by LASSO

```{r, echo=FALSE, comment=""}
form <- paste0("cac_change_per_yr",form)
form <- str_replace(form,"l.duration\\+l.duration_2","poly(l.duration,2)")
refit_mod = glm(as.formula(form),complete_lipidmeds_egdr_components_ccc,family = "gaussian")
summary(refit_mod)
aic_values <- c(aic_values,refit_mod$aic)
mod_names <- c(mod_names,"CAC change per year, without interactions")
plot(refit_mod)
cac_noint_coefs_sig <- as.matrix(summary(refit_mod)$coef)
cac_noint_coefs_sig <- rownames(cac_noint_coefs_sig)[cac_noint_coefs_sig[,4]<0.05]
```

## LASSO with interactions

```{r, echo=FALSE, comment=""}
set.seed(3654)
test <- complete_lipidmeds_egdr_components_ccc %>% select(-pcr_percent)
test$onlipidmeds <- as.factor(test$onlipidmeds)
test$onhypermeds <- as.factor(test$onhypermeds)
test$smknum <- as.factor(test$smknum)
test$sex_0m1f <- as.factor(test$sex_0m1f)
test$race <- as.factor(test$race)
form_test <- easy_glinternet(df=test,outcome = "cac_change_per_yr",id_vars = "StudyID",
                             fam="gaussian",cv_type = "loo",cores = 24)
```

## GLM using variables selected by LASSO with interactions

```{r, echo=FALSE, comment=""}
refit_mod_int = glm(as.formula(form_test),data=test,family = "gaussian")
summary(refit_mod_int)
aic_values <- c(aic_values,refit_mod_int$aic)
mod_names <- c(mod_names,"CAC change per year, with interactions")
plot(refit_mod)
#cac_int_coefs <- as.matrix(summary(refit_mod_int)$coef)
#cac_int_coefs <- row.names(cac_int_coefs)
```

## LASSO of clinical variables, without interactions

```{r, echo=FALSE, comment=""}
set.seed(3654)
# LASSO
x <- as.matrix(subset(complete_lipidmeds_egdr_components_ccc,select=-c(cac_change_per_yr,StudyID,l.crp,l.homo,l.pai1,l.fib,l.UA,whr,apob,l.l45vsf,l.l45sqf,l.pfatcm_v1,pcr_percent)))
glmmod1 <- glmnet(x, y=complete_lipidmeds_egdr_components_ccc$cac_change_per_yr, alpha=1, family="gaussian",nfolds=nrow(complete_lipidmeds_egdr_components_ccc))
# find best value of lambda
cv.glmmod <- cv.glmnet(x, y=complete_lipidmeds_egdr_components_ccc$cac_change_per_yr, alpha=1,nfolds=nrow(complete_lipidmeds_egdr_components_ccc))
best.lambda <- cv.glmmod$lambda.min
# coefficients at best lambda
round(coef(glmmod1,s=cv.glmmod$lambda.min),4)
temp_coefs <- as.matrix(coef(glmmod1,s=cv.glmmod$lambda.min),4)
temp_coefs <- rownames(temp_coefs)[temp_coefs[,1]!=0]
temp <- temp_coefs[-1]
form <- paste0(temp,collapse = "+")
form <- paste0("~",form)
```

## GLM using clinical variables selected by LASSO

```{r, echo=FALSE, comment=""}
form <- paste0("cac_change_per_yr",form)
form <- str_replace(form,"l.duration\\+l.duration_2","poly(l.duration,2)")
refit_mod = glm(as.formula(form),complete_lipidmeds_egdr_components_ccc,family = "gaussian")
summary(refit_mod)
aic_values <- c(aic_values,refit_mod$aic)
mod_names <- c(mod_names,"CAC change per year, simple clinical variables, without interactions")
plot(refit_mod)
```

## LASSO of clinical variables with interactions

```{r, echo=FALSE, comment=""}
set.seed(3654)
test <- subset(complete_lipidmeds_egdr_components_ccc,select=-c(l.crp,l.homo,l.pai1,l.fib,l.UA,whr,apob,l.l45vsf,l.l45sqf,l.pfatcm_v1,pcr_percent))
test$onlipidmeds <- as.factor(test$onlipidmeds)
test$onhypermeds <- as.factor(test$onhypermeds)
test$smknum <- as.factor(test$smknum)
test$sex_0m1f <- as.factor(test$sex_0m1f)
test$race <- as.factor(test$race)
form_test <- easy_glinternet(df=test,outcome = "cac_change_per_yr",id_vars = "StudyID",
                             fam="gaussian",cv_type = "loo",cores = 24)
```

## GLM using clinical variables selected by LASSO with interactions

```{r, echo=FALSE, comment=""}
refit_mod = glm(as.formula(form_test),data=test,family = "gaussian")
summary(refit_mod)
aic_values <- c(aic_values,refit_mod$aic)
mod_names <- c(mod_names,"CAC change per year, simple clinical variables, with interactions")
plot(refit_mod)
```

## GLM using ASCVD 10 year risk

```{r, echo=FALSE, comment=""}
refit_mod = glm(cac_change_per_yr ~ pcr_percent,data=complete_lipidmeds_egdr_components_ccc,family = "gaussian")
summary(refit_mod)
aic_values <- c(aic_values,refit_mod$aic)
mod_names <- c(mod_names,"CAC change per year, ASCVD 10 year risk")
plot(refit_mod)
```

# Regularized Cox model for death without interactions, using lipid lowering meds and A1c, WHR, onhypermeds

## Regularized Cox model

```{r, echo=FALSE, comment=""}
set.seed(3654)
Y <- complete_lipidmeds_egdr_components_death[,c("death","PersonYrsDeath")]
X <- complete_lipidmeds_egdr_components_death %>% select(-c("StudyID","PersonYrsDeath","death","pcr_percent"))
S <- Surv(time = Y$PersonYrsDeath, event = Y$death)
cv.fit <- cv.glmnet(as.matrix(X), S, family="cox", type.measure = "deviance",nfolds=nrow(complete_lipidmeds_egdr_components_death))
# coefficients at best lambda
round(coef(cv.fit,s=cv.fit$lambda.min),4)
death_coefs <- as.matrix(coef(cv.fit,s=cv.fit$lambda.min),4)
death_coefs <- rownames(death_coefs)[death_coefs[,1]!=0]

temp <- death_coefs
form <- paste0(temp,collapse = "+")
form <- paste0("~",form)
form <- str_replace(form,"onhypermeds","as.factor(onhypermeds)")
form <- str_replace(form,"onlipidmeds","as.factor(onlipidmeds)")
form <- str_replace(form,"smknum","as.factor(smknum)")
form <- str_replace(form,"sex_0m1f","as.factor(sex_0m1f)")
form <- str_replace(form,"l.duration\\+l.duration_2","poly(l.duration,2)")
```

## Cox model using variables selected in regularized Cox model

### Model results

```{r, echo=FALSE, comment=""}
form <- paste0("Surv(PersonYrsDeath,death)",form)
c <- coxph(as.formula(form),data=complete_lipidmeds_egdr_components_death)
c
```

### Test of proportional hazards

```{r, echo=FALSE, comment=""}
test.ph <- cox.zph(c)
test.ph

death_coefs_sig <- as.matrix(summary(c)$coef)
death_coefs_sig <- rownames(death_coefs_sig)[death_coefs_sig[,5]<0.05]
aic_values <- c(aic_values,extractAIC(c)[2])
mod_names <- c(mod_names,"Death, without interactions")
```

## LASSO of clinical variables, without interactions

```{r, echo=FALSE, comment=""}
set.seed(3654)
Y <- complete_lipidmeds_egdr_components_death[,c("death","PersonYrsDeath")]
X <- complete_lipidmeds_egdr_components_death %>% select(-c("StudyID","PersonYrsDeath","death","l.crp","l.homo","l.pai1","l.fib","l.UA",
                                                            "whr","apob","l.l45vsf","l.l45sqf","l.pfatcm_v1","pcr_percent"))
S <- Surv(time = Y$PersonYrsDeath, event = Y$death)
cv.fit <- cv.glmnet(as.matrix(X), S, family="cox", type.measure = "deviance",nfolds=nrow(complete_lipidmeds_egdr_components_death))
# coefficients at best lambda
round(coef(cv.fit,s=cv.fit$lambda.min),4)

temp_coefs <- as.matrix(coef(cv.fit,s=cv.fit$lambda.min),4)
temp_coefs <- rownames(temp_coefs)[temp_coefs[,1]!=0]
form <- paste0(temp_coefs,collapse = "+")
form <- paste0("~",form)
form <- str_replace(form,"onhypermeds","as.factor(onhypermeds)")
form <- str_replace(form,"onlipidmeds","as.factor(onlipidmeds)")
form <- str_replace(form,"smknum","as.factor(smknum)")
form <- str_replace(form,"sex_0m1f","as.factor(sex_0m1f)")
form <- str_replace(form,"l.duration\\+l.duration_2","poly(l.duration,2)")
```

## Cox model using clinical variables selected by LASSO

### Model results

```{r, echo=FALSE, comment=""}
form <- paste0("Surv(PersonYrsDeath,death)",form)
c <- coxph(as.formula(form),data=complete_lipidmeds_egdr_components_death)
c
```

### Test of proportional hazards

```{r, echo=FALSE, comment=""}
test.ph <- cox.zph(c)
test.ph

aic_values <- c(aic_values,extractAIC(c)[2])
mod_names <- c(mod_names,"Death, simple clinical variables, without interactions")
```

## Cox model with ASCVD 10 year risk

### Model results

```{r, echo=FALSE, comment=""}
c <- coxph(Surv(PersonYrsDeath,death) ~ pcr_percent, data=complete_lipidmeds_egdr_components_death)
c
```

### Test of proportional hazards

```{r, echo=FALSE, comment=""}
test.ph <- cox.zph(c)
test.ph

aic_values <- c(aic_values,extractAIC(c)[2])
mod_names <- c(mod_names,"Death, ASCVD 10 year risk")
```

# Regularized Cox model for CAD without interactions, using lipid lowering meds and A1c, WHR, onhypermeds

## Regularized Cox model

```{r, echo=FALSE, comment=""}
set.seed(3654)
Y <- complete_lipidmeds_egdr_components_cad[,c("CAD","PersonYrsCAD")]
X <- complete_lipidmeds_egdr_components_cad %>% select(-c("StudyID","PersonYrsCAD","CAD","pcr_percent"))
S <- Surv(time = Y$PersonYrsCAD, event = Y$CAD)
cv.fit <- cv.glmnet(as.matrix(X), S, family="cox", type.measure = "deviance",nfolds=nrow(complete_lipidmeds_egdr_components_cad))
# coefficients at best lambda
round(coef(cv.fit,s=cv.fit$lambda.min),4)
cad_coefs <- as.matrix(coef(cv.fit,s=cv.fit$lambda.min),4)
cad_coefs <- rownames(cad_coefs)[cad_coefs[,1]!=0]

temp <- cad_coefs
form <- paste0(temp,collapse = "+")
form <- paste0("~",form)
form <- str_replace(form,"onhypermeds","as.factor(onhypermeds)")
form <- str_replace(form,"onlipidmeds","as.factor(onlipidmeds)")
form <- str_replace(form,"smknum","as.factor(smknum)")
form <- str_replace(form,"sex_0m1f","as.factor(sex_0m1f)")
form <- str_replace(form,"l.duration\\+l.duration_2","poly(l.duration,2)")
```

## Cox model using variables selected in regularized Cox model

### Model results

```{r, echo=FALSE, comment=""}
form <- paste0("Surv(PersonYrsCAD,CAD)",form)
c <- coxph(as.formula(form),data=complete_lipidmeds_egdr_components_cad)
c

cad_coefs_sig <- as.matrix(summary(c)$coef)
cad_coefs_sig <- rownames(cad_coefs_sig)[cad_coefs_sig[,5]<0.05]
```

### Test of proportional hazards

```{r, echo=FALSE, comment=""}
test.ph <- cox.zph(c)
test.ph

aic_values <- c(aic_values,extractAIC(c)[2])
mod_names <- c(mod_names,"CAD, without interactions")
```

## LASSO of clinical variables, without interactions

```{r, echo=FALSE, comment=""}
set.seed(3654)
Y <- complete_lipidmeds_egdr_components_cad[,c("CAD","PersonYrsCAD")]
X <- complete_lipidmeds_egdr_components_cad %>% select(-c("StudyID","PersonYrsCAD","CAD","l.crp","l.homo","l.pai1","l.fib","l.UA",
                                                            "whr","apob","l.l45vsf","l.l45sqf","l.pfatcm_v1","pcr_percent"))
S <- Surv(time = Y$PersonYrsCAD, event = Y$CAD)
cv.fit <- cv.glmnet(as.matrix(X), S, family="cox", type.measure = "deviance",nfolds=nrow(complete_lipidmeds_egdr_components_cad))
# coefficients at best lambda
round(coef(cv.fit,s=cv.fit$lambda.min),4)
temp_coefs <- as.matrix(coef(cv.fit,s=cv.fit$lambda.min),4)
temp_coefs <- rownames(temp_coefs)[temp_coefs[,1]!=0]
form <- paste0(temp_coefs,collapse = "+")
form <- paste0("~",form)
form <- str_replace(form,"onhypermeds","as.factor(onhypermeds)")
form <- str_replace(form,"onlipidmeds","as.factor(onlipidmeds)")
form <- str_replace(form,"smknum","as.factor(smknum)")
form <- str_replace(form,"sex_0m1f","as.factor(sex_0m1f)")
form <- str_replace(form,"l.duration\\+l.duration_2","poly(l.duration,2)")
form_cad_clinical <- form
```

## Cox model using clinical variables selected by LASSO

### Model results

```{r, echo=FALSE, comment=""}
form <- paste0("Surv(PersonYrsCAD,CAD)",form)
c <- coxph(as.formula(form),data=complete_lipidmeds_egdr_components_cad)
c
```

### Test of proportional hazards

```{r, echo=FALSE, comment=""}
test.ph <- cox.zph(c)
test.ph

aic_values <- c(aic_values,extractAIC(c)[2])
mod_names <- c(mod_names,"CAD, simple clinical variables, without interactions")
```

## Cox model with ASCVD 10 year risk

### Model results

```{r, echo=FALSE, comment=""}
c <- coxph(Surv(PersonYrsCAD,CAD) ~ pcr_percent,data=complete_lipidmeds_egdr_components_cad)
c
```

### Test of proportional hazards

```{r, echo=FALSE, comment=""}
test.ph <- cox.zph(c)
test.ph

aic_values <- c(aic_values,extractAIC(c)[2])
mod_names <- c(mod_names,"CAD, ASCVD 10 year risk")
```

# Regularized Cox model for hard CAD without interactions, using lipid lowering meds and A1c, WHR, onhypermeds

## Regularized Cox model

```{r, echo=FALSE, comment=""}
set.seed(3654)
Y <- complete_lipidmeds_egdr_components_hardcad[,c("HardCAD","PersonYrsHardCAD")]
X <- complete_lipidmeds_egdr_components_hardcad %>% select(-c("StudyID","PersonYrsHardCAD","HardCAD","pcr_percent"))
S <- Surv(time = Y$PersonYrsHardCAD, event = Y$HardCAD)
cv.fit <- cv.glmnet(as.matrix(X), S, family="cox", type.measure = "deviance",nfolds=nrow(complete_lipidmeds_egdr_components_hardcad))
# coefficients at best lambda
round(coef(cv.fit,s=cv.fit$lambda.min),4)
hardcad_coefs <- as.matrix(coef(cv.fit,s=cv.fit$lambda.min),4)
hardcad_coefs <- rownames(hardcad_coefs)[hardcad_coefs[,1]!=0]

temp <- hardcad_coefs
form <- paste0(temp,collapse = "+")
form <- paste0("~",form)
form <- str_replace(form,"onhypermeds","as.factor(onhypermeds)")
form <- str_replace(form,"onlipidmeds","as.factor(onlipidmeds)")
form <- str_replace(form,"smknum","as.factor(smknum)")
form <- str_replace(form,"sex_0m1f","as.factor(sex_0m1f)")
form <- str_replace(form,"l.duration\\+l.duration_2","poly(l.duration,2)")
```

## Cox model using variables selected in regularized Cox model

### Model results

```{r, echo=FALSE, comment=""}
form <- paste0("Surv(PersonYrsHardCAD,HardCAD)",form)
c <- coxph(as.formula(form),data=complete_lipidmeds_egdr_components_hardcad)
c
```

### Test of proportional hazards

```{r, echo=FALSE, comment=""}
test.ph <- cox.zph(c)
test.ph

hardcad_coefs_sig <- as.matrix(summary(c)$coef)
hardcad_coefs_sig <- rownames(hardcad_coefs_sig)[hardcad_coefs_sig[,5]<0.05]
aic_values <- c(aic_values,extractAIC(c)[2])
mod_names <- c(mod_names,"Hard CAD, without interactions")
```

## LASSO of clinical variables, without interactions

```{r, echo=FALSE, comment=""}
set.seed(3654)
Y <- complete_lipidmeds_egdr_components_hardcad[,c("HardCAD","PersonYrsHardCAD")]
X <- complete_lipidmeds_egdr_components_hardcad %>% select(-c("StudyID","PersonYrsHardCAD","HardCAD","l.crp","l.homo","l.pai1","l.fib","l.UA",
                                                            "whr","apob","l.l45vsf","l.l45sqf","l.pfatcm_v1","pcr_percent"))
S <- Surv(time = Y$PersonYrsHardCAD, event = Y$HardCAD)
cv.fit <- cv.glmnet(as.matrix(X), S, family="cox", type.measure = "deviance",nfolds=nrow(complete_lipidmeds_egdr_components_hardcad))
# coefficients at best lambda
round(coef(cv.fit,s=cv.fit$lambda.min),4)
temp_coefs <- as.matrix(coef(cv.fit,s=cv.fit$lambda.min),4)
temp_coefs <- rownames(temp_coefs)[temp_coefs[,1]!=0]
form <- paste0(temp_coefs,collapse = "+")
form <- paste0("~",form)
form <- str_replace(form,"onhypermeds","as.factor(onhypermeds)")
form <- str_replace(form,"onlipidmeds","as.factor(onlipidmeds)")
form <- str_replace(form,"smknum","as.factor(smknum)")
form <- str_replace(form,"sex_0m1f","as.factor(sex_0m1f)")
form <- str_replace(form,"l.duration\\+l.duration_2","poly(l.duration,2)")
```

## Cox model using clinical variables selected by LASSO

### Model results

```{r, echo=FALSE, comment=""}
form <- paste0("Surv(PersonYrsHardCAD,HardCAD)",form)
c <- coxph(as.formula(form),data=complete_lipidmeds_egdr_components_hardcad)
c
```

### Test of proportional hazards

```{r, echo=FALSE, comment=""}
test.ph <- cox.zph(c)
test.ph

aic_values <- c(aic_values,extractAIC(c)[2])
mod_names <- c(mod_names,"Hard CAD, simple clinical variables, without interactions")
```

## Cox model with ASCVD 10 year risk

### Model results

```{r, echo=FALSE, comment=""}
c <- coxph(Surv(PersonYrsHardCAD,HardCAD) ~ pcr_percent,data=complete_lipidmeds_egdr_components_hardcad)
c
```

### Test of proportional hazards

```{r, echo=FALSE, comment=""}
test.ph <- cox.zph(c)
test.ph

aic_values <- c(aic_values,extractAIC(c)[2])
mod_names <- c(mod_names,"Hard CAD, ASCVD 10 year risk")
```

# Regularized Cox model for CVD without interactions, using lipid lowering meds and A1c, WHR, onhypermeds

## Regularized Cox model

```{r, echo=FALSE, comment=""}
set.seed(3654)
Y <- complete_lipidmeds_egdr_components_cvd[,c("CVD","PersonYrsCVD")]
X <- complete_lipidmeds_egdr_components_cvd %>% select(-c("StudyID","PersonYrsCVD","CVD","pcr_percent"))
S <- Surv(time = Y$PersonYrsCVD, event = Y$CVD)
cv.fit <- cv.glmnet(as.matrix(X), S, family="cox", type.measure = "deviance",nfolds=nrow(complete_lipidmeds_egdr_components_cvd))
# coefficients at best lambda
round(coef(cv.fit,s=cv.fit$lambda.min),4)
cvd_coefs <- as.matrix(coef(cv.fit,s=cv.fit$lambda.min),4)
cvd_coefs <- rownames(cvd_coefs)[cvd_coefs[,1]!=0]

temp <- cvd_coefs
form <- paste0(temp,collapse = "+")
form <- paste0("~",form)
form <- str_replace(form,"onhypermeds","as.factor(onhypermeds)")
form <- str_replace(form,"onlipidmeds","as.factor(onlipidmeds)")
form <- str_replace(form,"smknum","as.factor(smknum)")
form <- str_replace(form,"sex_0m1f","as.factor(sex_0m1f)")
form <- str_replace(form,"l.duration\\+l.duration_2","poly(l.duration,2)")
```

## Cox model using variables selected in regularized Cox model

### Model results

```{r, echo=FALSE, comment=""}
form <- paste0("Surv(PersonYrsCVD,CVD)",form)
c <- coxph(as.formula(form),data=complete_lipidmeds_egdr_components_cvd)
summary(c)
```

### Test of proportional hazards

```{r, echo=FALSE, comment=""}
test.ph <- cox.zph(c)
test.ph

cvd_coefs_sig <- as.matrix(summary(c)$coef)
cvd_coefs_sig <- rownames(cvd_coefs_sig)[cvd_coefs_sig[,5]<0.05]
aic_values <- c(aic_values,extractAIC(c)[2])
mod_names <- c(mod_names,"CVD, without interactions")
```

## LASSO of clinical variables, without interactions

```{r, echo=FALSE, comment=""}
set.seed(3654)
Y <- complete_lipidmeds_egdr_components_cvd[,c("CVD","PersonYrsCVD")]
X <- complete_lipidmeds_egdr_components_cvd %>% select(-c("StudyID","PersonYrsCVD","CVD","l.crp","l.homo","l.pai1","l.fib","l.UA",
                                                            "whr","apob","l.l45vsf","l.l45sqf","l.pfatcm_v1","pcr_percent"))
S <- Surv(time = Y$PersonYrsCVD, event = Y$CVD)
cv.fit <- cv.glmnet(as.matrix(X), S, family="cox", type.measure = "deviance",nfolds=nrow(complete_lipidmeds_egdr_components_cvd))
# coefficients at best lambda
round(coef(cv.fit,s=cv.fit$lambda.min),4)
temp_coefs <- as.matrix(coef(cv.fit,s=cv.fit$lambda.min),4)
temp_coefs <- rownames(temp_coefs)[temp_coefs[,1]!=0]
form <- paste0(temp_coefs,collapse = "+")
form <- paste0("~",form)
form <- str_replace(form,"onhypermeds","as.factor(onhypermeds)")
form <- str_replace(form,"onlipidmeds","as.factor(onlipidmeds)")
form <- str_replace(form,"smknum","as.factor(smknum)")
form <- str_replace(form,"sex_0m1f","as.factor(sex_0m1f)")
form <- str_replace(form,"l.duration\\+l.duration_2","poly(l.duration,2)")
```

## Cox model using clinical variables selected by LASSO

### Model results

```{r, echo=FALSE, comment=""}
form <- paste0("Surv(PersonYrsCVD,CVD)",form)
c <- coxph(as.formula(form),data=complete_lipidmeds_egdr_components_cvd)
summary(c)
```

### Test of proportional hazards

```{r, echo=FALSE, comment=""}
test.ph <- cox.zph(c)
test.ph

aic_values <- c(aic_values,extractAIC(c)[2])
mod_names <- c(mod_names,"CVD, simple clinical variables, without interactions")
```

## Cox model with ASCVD 10 year risk

### Model results

```{r, echo=FALSE, comment=""}
c <- coxph(Surv(PersonYrsCVD,CVD) ~ pcr_percent,data=complete_lipidmeds_egdr_components_cvd)
summary(c)
```

### Test of proportional hazards

```{r, echo=FALSE, comment=""}
test.ph <- cox.zph(c)
test.ph

aic_values <- c(aic_values,extractAIC(c)[2])
mod_names <- c(mod_names,"CVD, ASCVD 10 year risk")
```

# Regularized Cox model for hard CVD without interactions, using lipid lowering meds and A1c, WHR, onhypermeds

## Regularized Cox model

```{r, echo=FALSE, comment=""}
set.seed(3654)
Y <- complete_lipidmeds_egdr_components_hardcvd[,c("HardCVD","PersonYrsHardCVD")]
X <- complete_lipidmeds_egdr_components_hardcvd %>% select(-c("StudyID","PersonYrsHardCVD","HardCVD","pcr_percent"))
S <- Surv(time = Y$PersonYrsHardCVD, event = Y$HardCVD)
cv.fit <- cv.glmnet(as.matrix(X), S, family="cox", type.measure = "deviance",nfolds=nrow(complete_lipidmeds_egdr_components_hardcvd))
# coefficients at best lambda
round(coef(cv.fit,s=cv.fit$lambda.min),4)
hardcvd_coefs <- as.matrix(coef(cv.fit,s=cv.fit$lambda.min),4)
hardcvd_coefs <- rownames(hardcvd_coefs)[hardcvd_coefs[,1]!=0]

temp <- hardcvd_coefs
form <- paste0(temp,collapse = "+")
form <- paste0("~",form)
form <- str_replace(form,"onhypermeds","as.factor(onhypermeds)")
form <- str_replace(form,"onlipidmeds","as.factor(onlipidmeds)")
form <- str_replace(form,"smknum","as.factor(smknum)")
form <- str_replace(form,"sex_0m1f","as.factor(sex_0m1f)")
form <- str_replace(form,"l.duration\\+l.duration_2","poly(l.duration,2)")
```

## Cox model using variables selected in regularized Cox model

### Model results

```{r, echo=FALSE, comment=""}
form <- paste0("Surv(PersonYrsHardCVD,HardCVD)",form)
c <- coxph(as.formula(form),data=complete_lipidmeds_egdr_components_hardcvd)
c
```

### Test of proportional hazards

```{r, echo=FALSE, comment=""}

test.ph <- cox.zph(c)
test.ph

hardcvd_coefs_sig <- as.matrix(summary(c)$coef)
hardcvd_coefs_sig <- rownames(hardcvd_coefs_sig)[hardcvd_coefs_sig[,5]<0.05]
aic_values <- c(aic_values,extractAIC(c)[2])
mod_names <- c(mod_names,"Hard CVD, without interactions")
```

## LASSO of clinical variables, without interactions

```{r, echo=FALSE, comment=""}
set.seed(3654)
Y <- complete_lipidmeds_egdr_components_hardcvd[,c("HardCVD","PersonYrsHardCVD")]
X <- complete_lipidmeds_egdr_components_hardcvd %>% select(-c("StudyID","PersonYrsHardCVD","HardCVD","l.crp","l.homo","l.pai1","l.fib","l.UA",
                                                            "whr","apob","l.l45vsf","l.l45sqf","l.pfatcm_v1","pcr_percent"))
S <- Surv(time = Y$PersonYrsHardCVD, event = Y$HardCVD)
cv.fit <- cv.glmnet(as.matrix(X), S, family="cox", type.measure = "deviance",nfolds=nrow(complete_lipidmeds_egdr_components_hardcvd))
# coefficients at best lambda
round(coef(cv.fit,s=cv.fit$lambda.min),4)
temp_coefs <- as.matrix(coef(cv.fit,s=cv.fit$lambda.min),4)
temp_coefs <- rownames(temp_coefs)[temp_coefs[,1]!=0]
form <- paste0(temp_coefs,collapse = "+")
form <- paste0("~",form)
form <- str_replace(form,"onhypermeds","as.factor(onhypermeds)")
form <- str_replace(form,"onlipidmeds","as.factor(onlipidmeds)")
form <- str_replace(form,"smknum","as.factor(smknum)")
form <- str_replace(form,"sex_0m1f","as.factor(sex_0m1f)")
form <- str_replace(form,"l.duration\\+l.duration_2","poly(l.duration,2)")
```

## Cox model using clinical variables selected by LASSO

### Model results

```{r, echo=FALSE, comment=""}
form <- paste0("Surv(PersonYrsHardCVD,HardCVD)",form)
c <- coxph(as.formula(form),data=complete_lipidmeds_egdr_components_hardcvd)
c
```

### Test of proportional hazards

```{r, echo=FALSE, comment=""}
test.ph <- cox.zph(c)
test.ph

aic_values <- c(aic_values,extractAIC(c)[2])
mod_names <- c(mod_names,"Hard CVD, simple clinical variables, without interactions")
```

## Cox model with ASCVD 10 year risk

### Model results

```{r, echo=FALSE, comment=""}
form <- paste0("",form)
c <- coxph(Surv(PersonYrsHardCVD,HardCVD) ~ pcr_percent,data=complete_lipidmeds_egdr_components_hardcvd)
c
```

### Test of proportional hazards

```{r, echo=FALSE, comment=""}
test.ph <- cox.zph(c)
test.ph

aic_values <- c(aic_values,extractAIC(c)[2])
mod_names <- c(mod_names,"Hard CVD, ASCVD 10 year risk")
```

# Upset plot

The upset plot reflects only models using lipid lowering medications (not statins) and does not include models with interactions.

Models from L to R are: CAC progression, rate of change in CAC volume per year, death, CAD, hard CAD, CVD, hard CVD.

```{r, echo=FALSE, comment="",warning=FALSE}
vars <- c(prog_noint_coefs,cac_noint_coefs,death_coefs,cad_coefs,hardcad_coefs,cvd_coefs,hardcvd_coefs)
vars <- unique(vars)
vars <- vars[-1]
# Format output
selected_vars = do.call(rbind,list(
  vars %in% prog_noint_coefs,
  vars %in% cac_noint_coefs,
  vars %in% death_coefs,
  vars %in% cad_coefs,
  vars %in% hardcad_coefs,
  vars %in% cvd_coefs,
  vars %in% hardcvd_coefs
))
colnames(selected_vars) = vars
selected_vars = data.frame(apply(selected_vars,2,as.numeric))
# Plot
png(filename = "/home/laura/Documents/Temp/plot.png",width=1200,height=1200)
upset(selected_vars,nsets = ncol(selected_vars),order.by = "freq",text.scale=3,mb.ratio = c(0.3,0.7),keep.order = T)
dev.off()
```

```{r, echo=FALSE, warning=FALSE}
knitr::include_graphics("/home/laura/Documents/Temp/plot.png")
```

# Upset plot of significant variables

The upset plot reflects only models using lipid lowering medications (not statins) and does not include models with interactions.  Only variables that were significant when the models selected by LASSO were refit are included here.

Models from L to R are: CAC progression, rate of change in CAC volume per year, death, CAD, hard CAD, CVD, hard CVD.

```{r, echo=FALSE, comment=""}
vars_sig <- c(prog_noint_coefs_sig,cac_noint_coefs_sig,death_coefs_sig,cad_coefs_sig,hardcad_coefs_sig,cvd_coefs_sig,hardcvd_coefs_sig)
vars_sig <- unique(vars_sig)
vars_sig <- vars_sig[-1]
# Format output
selected_vars_sig = do.call(rbind,list(
  vars_sig %in% prog_noint_coefs_sig,
  vars_sig %in% cac_noint_coefs_sig,
  vars_sig %in% death_coefs_sig,
  vars_sig %in% cad_coefs_sig,
  vars_sig %in% hardcad_coefs_sig,
  vars_sig %in% cvd_coefs_sig,
  vars_sig %in% hardcvd_coefs_sig
))
colnames(selected_vars_sig) = vars_sig
selected_vars_sig = data.frame(apply(selected_vars_sig,2,as.numeric))
# Plot
png(filename = "/home/laura/Documents/Temp/plot_sig.png",width=1200,height=1200)
upset(selected_vars_sig,nsets = ncol(selected_vars_sig),order.by = "freq",text.scale=3,mb.ratio = c(0.3,0.7),keep.order = T)
dev.off()
```

```{r, echo=FALSE, warning=FALSE}
knitr::include_graphics("/home/laura/Documents/Temp/plot_sig.png")
```

# Correlation plot

```{r, echo=FALSE, warning=FALSE}
allvars <- X
cormat <- cor(allvars)
corrplot(cormat, method="circle")
```

# Table of AIC values
```{r, echo=FALSE, warning=FALSE}
aic_values <- aic_values[-1]
aic_table <- cbind(mod_names,round(aic_values,2))
colnames(aic_table) <- c("Model","AIC")

kable(aic_table)
```

# Fit model 4.4 (CAD events) to AHA data using participants with complete data for clinical variables and omics data (not SNPs)

## Clinical model results

```{r, echo=FALSE, comment=""}
form_cad_clinical <- paste0("Surv(PersonYrsCAD,CAD)",form_cad_clinical)
c <- coxph(as.formula(form_cad_clinical),data=ada_data_complete)
c
```

# Fit model 1.6 (CAC progression) to AHA data using participants with complete data for clinical variables and omics data (not SNPs)

## Clinical model results

```{r, echo=FALSE, comment=""}
refit_mod = glm(as.formula(form_cacp),ada_data_cacp_complete,family = binomial("logit"))
summary(refit_mod)
refit_mod$aic

pred1 <- predict(refit_mod,ada_data_cacp_complete, type="response")
auc(ada_data_cacp_complete$CACprogV3_num,pred1)
```

## Add omics markers (not SNPs)

```{r, echo=FALSE, comment=""}
# model won't converge - need to pare it down

#form_cacp_omics <- paste0(form_cacp,"+ gly_P02671.7 + gly_P02671.5 + gly_P02671.4 + gly_P02671.3 + AAA01201000179.0807263.4 + gly_P02679 + HMDB00510161.0696402.9 + AAA01201000179.0809235.7 +
#                          gly_P02675.4 + gly_P02675 + gly_P02647 + P02655 + gly_P02647.1 + HMDB00510161.0694436 + gly_P02652 + gly_P01009 + gly_P01834.11 + P01817 +
#                          HMDB00510161.0694436 + gly_P02652 + gly_P01009 + gly_P01834.11 + P01817 + `AcCa 10:3` + HMDB0028822260.1378628.6 + AAA01201000179.0807263.4 + gly_P02671.3 + 
#                          gly_P02671.7")

#refit_mod_omics = glm(as.formula(form_cacp_omics),ada_data_cacp_complete,family = binomial("logit"))
#summary(refit_mod_omics)
#refit_mod_omics$aic

#pred1 <- predict(refit_mod_omics,ada_data_cacp_complete, type="response")
#auc(ada_data_cacp_complete$CACprogV3_num,pred1)
```

## Add omics markers (not SNPs) - only markers significant by moderated t-test

```{r, echo=FALSE, comment=""}
form_cacp_omics <- paste0(form_cacp,"+ AAA01201000179.0807263.4 + gly_P02671.7 + gly_P02671.3 + gly_P02671.5")

refit_mod_omics = glm(as.formula(form_cacp_omics),ada_data_cacp_complete,family = binomial("logit"))
summary(refit_mod_omics)
refit_mod_omics$aic

pred1 <- predict(refit_mod_omics,ada_data_cacp_complete, type="response")
auc(ada_data_cacp_complete$CACprogV3_num,pred1)
```

## Add omics markers (not SNPs) -  markers significant by moderated t-test plus top 5 hits from first PLS-DA component

```{r, echo=FALSE, comment=""}
form_cacp_omics <- paste0(form_cacp,"+ AAA01201000179.0807263.4 + gly_P02671.7 + gly_P02671.3 + gly_P02671.5 + gly_P02671.4 ")

refit_mod_omics = glm(as.formula(form_cacp_omics),ada_data_cacp_complete,family = binomial("logit"))
summary(refit_mod_omics)
refit_mod_omics$aic

pred1 <- predict(refit_mod_omics,ada_data_cacp_complete, type="response")
auc(ada_data_cacp_complete$CACprogV3_num,pred1)
```