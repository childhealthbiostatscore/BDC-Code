---
title: "AHA clinical model"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(broom)
library(survival)
library(performance)
library(knitr)
knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "B:/Projects"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
}
knitr::opts_knit$set(root.dir = home_dir)
rm(home_dir)
```

```{r}
source("~/GitHub/shared-resources/Machine Learning/Tim - ElasticNet CV/easy_elasticnet.R")
load("./Janet Snell-Bergeon/AHA collaborative grant/aha_master_data_no_snps.Rdata")
```

# LASSO for CAC progression, using lipid lowering meds and A1c, WHR, onhypermeds

## CAC progression - LASSO without interactions

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
selected = easy_elasticnet(data = df,outcome = "CACprogV3",
                           predictors = clinical_predictors,
                           model_type = "binomial")
```

```{r}
kable(selected,col.names = "Selected Variables")
```

## CAC progression - GLM using variables selected by LASSO

```{r}
f = as.formula(paste0("CACprogV3~",paste0(selected[[1]],collapse = "+")))
mod = glm(f,data = df,family = "binomial")
kable(tidy(mod),digits = 3)
```

Model was fit on `r nobs(mod)` observations.

```{r}
check_model(mod)
```

# LASSO for change in CAC per year using lipid lowering meds and A1c, WHR, onhypermeds

## Change in CAC per year - LASSO without interactions

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
selected = easy_elasticnet(data = df,outcome = "cac_change_per_yr",
                           predictors = clinical_predictors,
                           model_type = "gaussian")
```

```{r}
kable(selected,col.names = "Selected Variables")
```

## Change in CAC per year - LM using variables selected by LASSO

```{r}
f = as.formula(paste0("cac_change_per_yr~",paste0(selected[[1]],collapse = "+")))
mod = lm(f,data = df)
kable(tidy(mod),digits = 3)
```

Model was fit on `r nobs(mod)` observations.

```{r}
check_model(mod)
```

# Regularized Cox model for death without interactions, using lipid lowering meds and A1c, WHR, onhypermeds

## Death - Regularized Cox model

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
selected = easy_elasticnet(data = df,outcome = "Deceased",
                           predictors = clinical_predictors,
                           model_type = "cox",time = "PersonYrsDeath")
```

```{r}
kable(selected,col.names = "Selected Variables")
```

## Death - Cox model using variables selected by LASSO

```{r}
f = as.formula(paste0("Surv(time = df$PersonYrsDeath,event = df$Deceased)~",
                      paste0(selected[[1]],collapse = "+")))
mod = coxph(f,data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

Model was fit on `r nobs(mod)` observations.

```{r}
kable(cox.zph(mod)$table,caption = "Test of PH Assumption")
```

# Regularized Cox model for CAD without interactions, using lipid lowering meds and A1c, WHR, onhypermeds

## CAD - Regularized Cox model

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
selected = easy_elasticnet(data = df,outcome = "CAD",
                           predictors = clinical_predictors,
                           model_type = "cox",time = "PersonYrsCAD")
```

```{r}
kable(selected,col.names = "Selected Variables")
```

## CAD - Cox model using variables selected by LASSO

```{r}
f = as.formula(paste0("Surv(time = df$PersonYrsCAD,event = df$CAD)~",
                      paste0(selected[[1]],collapse = "+")))
mod = coxph(f,data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

Model was fit on `r nobs(mod)` observations.

```{r}
kable(cox.zph(mod)$table,caption = "Test of PH Assumption")
```

# Regularized Cox model for Hard CAD without interactions, using lipid lowering meds and A1c, WHR, onhypermeds

## Hard CAD - Regularized Cox model

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
selected = easy_elasticnet(data = df,outcome = "HardCAD",
                           predictors = clinical_predictors,
                           model_type = "cox",time = "PersonYrsHardCAD")
```

```{r}
kable(selected,col.names = "Selected Variables")
```

## Hard CAD - Cox model using variables selected by LASSO

```{r}
f = as.formula(paste0("Surv(time = df$PersonYrsHardCAD,event = df$HardCAD)~",
                      paste0(selected[[1]],collapse = "+")))
mod = coxph(f,data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

Model was fit on `r nobs(mod)` observations.

```{r}
kable(cox.zph(mod)$table,caption = "Test of PH Assumption")
```

# Regularized Cox model for CVD without interactions, using lipid lowering meds and A1c, WHR, onhypermeds

## CVD - Regularized Cox model

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
selected = easy_elasticnet(data = df,outcome = "CVD",
                           predictors = clinical_predictors,
                           model_type = "cox",time = "PersonYrsCVD")
```

```{r}
kable(selected,col.names = "Selected Variables")
```

## CVD - Cox model using variables selected by LASSO

```{r}
f = as.formula(paste0("Surv(time = df$PersonYrsCVD,event = df$CVD)~",
                      paste0(selected[[1]],collapse = "+")))
mod = coxph(f,data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

Model was fit on `r nobs(mod)` observations.

```{r}
kable(cox.zph(mod)$table,caption = "Test of PH Assumption")
```

# Regularized Cox model for Hard CVD without interactions, using lipid lowering meds and A1c, WHR, onhypermeds

## Hard CVD - Regularized Cox model

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
selected = easy_elasticnet(data = df,outcome = "HardCVD",
                           predictors = clinical_predictors,
                           model_type = "cox",time = "PersonYrsHardCVD")
```

```{r}
kable(selected,col.names = "Selected Variables")
```

## Hard CVD - Cox model using variables selected by LASSO

```{r}
f = as.formula(paste0("Surv(time = df$PersonYrsHardCVD,event = df$HardCVD)~",
                      paste0(selected[[1]],collapse = "+")))
mod = coxph(f,data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

Model was fit on `r nobs(mod)` observations.

```{r}
kable(cox.zph(mod)$table,caption = "Test of PH Assumption")
```
