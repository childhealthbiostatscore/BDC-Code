---
title: "AHA clinical model"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(broom)
library(survival)
library(performance)
library(mice)
library(knitr)
knitr::opts_chunk$set(echo = FALSE,cache = TRUE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "B:/Projects"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
}
knitr::opts_knit$set(root.dir = home_dir)
rm(home_dir)
```

```{r}
# Function and mastet data
source("~/GitHub/shared-resources/Machine Learning/Tim - ElasticNet CV/easy_elasticnet.R")
load("./Janet Snell-Bergeon/AHA collaborative grant/aha_master_data_no_snps.Rdata")
# omics selected by moderated t-test and PLSDA
omics = c("AAA01201000179.0807263.4","gly_P02671.7","gly_P02671.3",
          "gly_P02671.5","gly_P02671.4")
# Log transform 
df[,omics] = log(df[,omics])
```

# LASSO for CAC progression, using lipid lowering meds and A1c, WHR, onhypermeds

## CAC progression - LASSO without interactions

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
y = "CACprogV3"
selected = easy_elasticnet(data = df,outcome = y,
                           predictors = clinical_predictors,
                           model_type = "binomial",cores = 4)
```

## Imputation

```{r}
# Impute predictors (selected clinical model plus omics subset from PLSDA and moderated t tests)
imp = mice(df[,c(selected[[1]],omics)], seed = 1017, m = 10,
           print = FALSE,method = "rf")
# Diagnostics
densityplot(imp)
# Outcome
imp = cbind(imp,df[,y])
```

Five imputed dataset were created using random forest imputation. Two models were fit to the imputed data: one with only the selected clinical variables, and the other with selected clinical variables and the omics variables selected by moderated t test and PLS-DA. Models were compared using the multivariate Wald test (see [this page](https://stefvanbuuren.name/fimd/sec-multiparameter.html#sec:likelihoodratio) for additional details).

## CAC progression - GLM using variables selected by LASSO

```{r warning=FALSE}
f = as.formula(paste0("y~",paste0(selected[[1]],collapse = "+")))
clinical_fit = glm.mids(formula = f,family = "binomial",data = imp)
kable(summary(pool(clinical_fit)),digits = 3)
```

## CAC progression - GLM with omics variables added

```{r}
f = update(f,paste0("~ . +",paste0(omics,collapse = "+")))       
fit = glm.mids(formula = f,family = "binomial",data = imp)
kable(summary(pool(fit)),digits = 3)
```

## Model comparison

```{r}
D1(fit, clinical_fit)
```

# LASSO for change in CAC per year using lipid lowering meds and A1c, WHR, onhypermeds

## Change in CAC per year - LASSO without interactions

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
y = "cac_change_per_yr"
selected = easy_elasticnet(data = df,outcome = y,
                           predictors = clinical_predictors,
                           model_type = "gaussian",cores = 4)
```

## Change in CAC per year - LM using variables selected by LASSO

```{r}
f = as.formula(paste0("cac_change_per_yr~",paste0(selected[[1]],collapse = "+")))
mod = lm(f,data = df)
kable(tidy(mod),digits = 3)
```

Model was fit on `r nobs(mod)` observations.

```{r}
check_model(mod)
```

# Regularized Cox model for death without interactions, using lipid lowering meds and A1c, WHR, onhypermeds

## Death - Regularized Cox model

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
y = "Deceased"
t = "PersonYrsDeath"
selected = easy_elasticnet(data = df,outcome = y,
                           predictors = clinical_predictors,
                           model_type = "cox",time = t,
                           cores = 4)
```

## Death - Cox model using variables selected by LASSO

```{r}
f = as.formula(paste0("Surv(time = df$PersonYrsDeath,event = df$Deceased)~",
                      paste0(selected[[1]],collapse = "+")))
mod = coxph(f,data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

Model was fit on `r nobs(mod)` observations.

```{r}
kable(cox.zph(mod)$table,caption = "Test of PH Assumption")
```

# Regularized Cox model for CAD without interactions, using lipid lowering meds and A1c, WHR, onhypermeds

## CAD - Regularized Cox model

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
y = "CAD"
t = "PersonYrsCAD"
selected = easy_elasticnet(data = df,outcome = y,
                           predictors = clinical_predictors,
                           model_type = "cox",time = t,
                           cores = 4)
```

## CAD - Cox model using variables selected by LASSO

```{r}
f = as.formula(paste0("Surv(time = df$PersonYrsCAD,event = df$CAD)~",
                      paste0(selected[[1]],collapse = "+")))
mod = coxph(f,data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

Model was fit on `r nobs(mod)` observations.

```{r}
kable(cox.zph(mod)$table,caption = "Test of PH Assumption")
```

# Regularized Cox model for Hard CAD without interactions, using lipid lowering meds and A1c, WHR, onhypermeds

## Hard CAD - Regularized Cox model

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
y = "HardCAD"
t = "PersonYrsHardCAD"
selected = easy_elasticnet(data = df,outcome = y,
                           predictors = clinical_predictors,
                           model_type = "cox",time = t,
                           cores = 4)
```

## Hard CAD - Cox model using variables selected by LASSO

```{r}
f = as.formula(paste0("Surv(time = df$PersonYrsHardCAD,event = df$HardCAD)~",
                      paste0(selected[[1]],collapse = "+")))
mod = coxph(f,data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

Model was fit on `r nobs(mod)` observations.

```{r}
kable(cox.zph(mod)$table,caption = "Test of PH Assumption")
```

# Regularized Cox model for CVD without interactions, using lipid lowering meds and A1c, WHR, onhypermeds

## CVD - Regularized Cox model

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
y = "CVD"
t = "PersonYrsCVD"
selected = easy_elasticnet(data = df,outcome = y,
                           predictors = clinical_predictors,
                           model_type = "cox",time = t,
                           cores = 4)
```

## CVD - Cox model using variables selected by LASSO

```{r}
f = as.formula(paste0("Surv(time = df$PersonYrsCVD,event = df$CVD)~",
                      paste0(selected[[1]],collapse = "+")))
mod = coxph(f,data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

Model was fit on `r nobs(mod)` observations.

```{r}
kable(cox.zph(mod)$table,caption = "Test of PH Assumption")
```

# Regularized Cox model for Hard CVD without interactions, using lipid lowering meds and A1c, WHR, onhypermeds

## Hard CVD - Regularized Cox model

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
y = "HardCVD"
t = "PersonYrsHardCVD"
selected = easy_elasticnet(data = df,outcome = y,
                           predictors = clinical_predictors,
                           model_type = "cox",time = t,
                           cores = 4)
```

## Hard CVD - Cox model using variables selected by LASSO

```{r}
f = as.formula(paste0("Surv(time = df$PersonYrsHardCVD,event = df$HardCVD)~",
                      paste0(selected[[1]],collapse = "+")))
mod = coxph(f,data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

Model was fit on `r nobs(mod)` observations.

```{r}
kable(cox.zph(mod)$table,caption = "Test of PH Assumption")
```
