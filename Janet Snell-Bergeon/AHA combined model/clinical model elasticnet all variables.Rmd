---
title: "AHA clinical model - all variables"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(tidyverse)
library(broom)
library(survival)
library(performance)
library(knitr)
library(mice)
library(naniar)
knitr::opts_chunk$set(echo = FALSE,fig.height = 10,fig.width = 10)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "B:/Projects"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
}
knitr::opts_knit$set(root.dir = home_dir)
rm(home_dir)
```

```{r}
# Function and master data
source("~/GitHub/shared-resources/Machine Learning/Tim - ElasticNet CV/easy_elasticnet.R")
load("./Janet Snell-Bergeon/AHA collaborative grant/aha_master_data_no_snps.Rdata")
# omics selected by moderated t-test and PLSDA
omics = unique(c("gly_P02671.7","gly_P02671.5","gly_P02671.4","gly_P02671.3",
          "AAA01201000179.0807263.4","gly_P02679","HMDB00510161.0696402.9",
          "AAA01201000179.0809235.7","gly_P02675.4","gly_P02675","gly_P02647",
          "P02655","gly_P02647.1","HMDB00510161.0694436","gly_P02652",
          "gly_P01009","gly_P01834.11","P01817","AcCa 10:3",
          "HMDB0028822260.1378628.6","AAA01201000179.0807263.4",
          "gly_P02671.3","gly_P02671.7"))
limited_omics = c("AAA01201000179.0807263.4","gly.P02671.7","gly.P02671.3",
          "gly.P02671.5","gly.P02671.4")
# Take out people without diabetes, remove diabetes status from predictors
df = df[df$diabetic == 1,]
clinical_predictors = clinical_predictors[-which(clinical_predictors == "dia")]
# Log transform 
df[,omics] = log(df[,omics])
# Fix names
colnames(df)[which(colnames(df) %in% omics)] = make.names(omics,unique = T,allow_ = F)
omics = make.names(omics,unique = T,allow_ = F)
```

# ElasticNet on clinical variables only

## CAC progression

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
cac_prog_select = easy_elasticnet(data = df,outcome = "CACprogV3",
                           predictors = clinical_predictors,
                           model_type = "binomial")
```

### Clinical model results

```{r}
f_cac_prog = as.formula(paste0("CACprogV3~",paste0(cac_prog_select,collapse = "+")))
mod = glm(formula = f_cac_prog,data = df,family = "binomial")
kable(tidy(mod),digits = 3)
```

#### Model diagnostics

```{r}
check_model(mod)
```

Model was fit on `r nrow(model.matrix(mod))` observations.

### Omics model results (no imputation)

```{r}
mod = glm(formula = update(f_cac_prog,paste0("~ . +",paste0(limited_omics,collapse = "+"))),
          data = df,family = "binomial")
kable(tidy(mod),digits = 3)
```

#### Model diagnostics

```{r}
check_model(mod)
```

Model was fit on `r nrow(model.matrix(mod))` observations.

## Change in CAC per year

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
cac_change_select = easy_elasticnet(data = df,outcome = "cac_change_per_yr",
                           predictors = clinical_predictors,
                           model_type = "gaussian")
```

### Clinical model results

```{r}
f_cac_change = as.formula(paste0("cac_change_per_yr~",
                                 paste0(cac_change_select,collapse = "+")))
mod = lm(formula = f_cac_change,data = df)
kable(tidy(mod),digits = 3)
```

#### Model diagnostics

```{r}
check_model(mod)
```

Model was fit on `r nrow(model.matrix(mod))` observations.

### Omics model results (no imputation)

```{r}
mod = lm(formula = update(f_cac_change,paste0("~ . +",paste0(limited_omics,collapse = "+"))),
         data = df)
kable(tidy(mod),digits = 3)
```

#### Model diagnostics

```{r}
check_model(mod)
```

Model was fit on `r nrow(model.matrix(mod))` observations.

## Death

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
death_select = easy_elasticnet(data = df,outcome = "Deceased",
                           predictors = clinical_predictors,
                           model_type = "cox",time = "PersonYrsDeath")
```

### Clinical model results

```{r}
f_death = as.formula(paste0("Surv(time = df$PersonYrsDeath,event = df$Deceased)~",
                      paste0(death_select,collapse = "+")))
mod = coxph(formula = f_death,data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

#### PH assumption test

```{r}
kable(cox.zph(mod)$table,digits = 3)
```

Model was fit on `r nrow(model.matrix(mod))` observations.

### Omics model results (no imputation)

```{r}
mod = coxph(formula = update(f_death,paste0("~ . +",paste0(limited_omics,collapse = "+"))),
            data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

#### PH assumption test

```{r}
kable(cox.zph(mod)$table,digits = 3)
```

Model was fit on `r nrow(model.matrix(mod))` observations.

## CAD

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
cad_select = easy_elasticnet(data = df,outcome = "CAD",
                           predictors = clinical_predictors,
                           model_type = "cox",time = "PersonYrsCAD")
```

### Clinical model results

```{r}
f_cad = as.formula(paste0("Surv(time = df$PersonYrsCAD,event = df$CAD)~",
                      paste0(cad_select,collapse = "+")))
mod = coxph(formula = f_cad,data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

#### PH assumption test

```{r}
kable(cox.zph(mod)$table,digits = 3)
```

Model was fit on `r nrow(model.matrix(mod))` observations.

### Omics model results (no imputation)

```{r}
mod = coxph(formula = update(f_cad,paste0("~ . +",paste0(limited_omics,collapse = "+"))),
            data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

#### PH assumption test

```{r}
kable(cox.zph(mod)$table,digits = 3)
```

Model was fit on `r nrow(model.matrix(mod))` observations.

## Hard CAD

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
hard_cad_select = easy_elasticnet(data = df,outcome = "HardCAD",
                           predictors = clinical_predictors,
                           model_type = "cox",time = "PersonYrsHardCAD")
```

### Clinical model results

```{r}
f_hard_cad = as.formula(paste0("Surv(time = df$PersonYrsHardCAD,event = df$HardCAD)~",
                      paste0(hard_cad_select,collapse = "+")))
mod = coxph(formula = f_hard_cad,data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

#### PH assumption test

```{r}
kable(cox.zph(mod)$table,digits = 3)
```

Model was fit on `r nrow(model.matrix(mod))` observations.

### Omics model results (no imputation)

```{r}
mod = coxph(formula = update(f_hard_cad,paste0("~ . +",paste0(limited_omics,collapse = "+"))),
            data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

#### PH assumption test

Could not test due to odd SEs in above model.

```{r eval=FALSE}
kable(cox.zph(mod)$table,digits = 3)
```

Model was fit on `r nrow(model.matrix(mod))` observations.

## CVD

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
cvd_select = easy_elasticnet(data = df,outcome = "CVD",
                           predictors = clinical_predictors,
                           model_type = "cox",time = "PersonYrsCVD")
```

### Clinical model results

```{r}
f_cvd = as.formula(paste0("Surv(time = df$PersonYrsCVD,event = df$CVD)~",
                      paste0(cvd_select,collapse = "+")))
mod = coxph(formula = f_cvd,data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

#### PH assumption test

```{r}
kable(cox.zph(mod)$table,digits = 3)
```

Model was fit on `r nrow(model.matrix(mod))` observations.

### Omics model results (no imputation)

```{r}
mod = coxph(formula = update(f_cvd,paste0("~ . +",paste0(limited_omics,collapse = "+"))),
            data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

#### PH assumption test

```{r}
kable(cox.zph(mod)$table,digits = 3)
```

Model was fit on `r nrow(model.matrix(mod))` observations.

## Hard CVD

```{r include=FALSE}
# Sometimes using too many alpha/lambda values results in duplicate values for the 
# error metric. This doesn't seem to be a problem but throws a lot of warnings
hard_cvd_select = easy_elasticnet(data = df,outcome = "HardCVD",
                           predictors = clinical_predictors,
                           model_type = "cox",time = "PersonYrsHardCVD")
```

### Clinical model results

```{r}
f_hard_cvd = as.formula(paste0("Surv(time = df$PersonYrsHardCVD,event = df$HardCVD)~",
                      paste0(hard_cvd_select,collapse = "+")))
mod = coxph(formula = f_hard_cvd,data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

#### PH assumption test

```{r}
kable(cox.zph(mod)$table,digits = 3)
```

Model was fit on `r nrow(model.matrix(mod))` observations.

### Omics model results (no imputation)

```{r}
mod = coxph(formula = update(f_hard_cvd,paste0("~ . +",paste0(limited_omics,collapse = "+"))),
            data = df,id = StudyID)
kable(tidy(mod),digits = 3)
```

#### PH assumption test

Could not test due to odd SEs in above model.

```{r eval=FALSE}
kable(cox.zph(mod)$table,digits = 3)
```

Model was fit on `r nrow(model.matrix(mod))` observations.
