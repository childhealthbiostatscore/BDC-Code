---
title: "DAISY longitudinal T-cell responses to hybrid insulin peptides"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:   
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=F}
# required libraries
library(purrr)
library(tableone)
library(dplyr)
library(plyr)
library(zoo)
library(nlme)
library(lme4)
library(emmeans)
library(knitr)
library(car)
library(tidyr)
```

```{r, include=F}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE)

home_dir = ifelse(.Platform$OS.type != "unix","T:\\",
                  "/Volumes/som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects")
knitr::opts_knit$set(root.dir = home_dir)

# data for fig 1b
dat1 <- read.csv("T:\\Aaron Michels\\Temporal development of T-cell repertoires\\Data raw\\fig_1b_s2.csv",na.strings = c(""," ","X"))
# wide to long
dat1_long <- dat1 %>% gather(tp,clonality,-c(ID,Group))
dat1_long$time <- ifelse(dat1_long$tp=="TP.1",1,
                         ifelse(dat1_long$tp=="TP.2",2,
                                ifelse(dat1_long$tp=="TP.3",3,4)))
dat1_long$time <- as.factor(dat1_long$time)
dat1_long$l.clonality <- log(dat1_long$clonality)
dat1_long <- arrange(dat1_long,ID,time)
dat1_long_case <- dat1_long %>% filter(Group=="CASE")
dat1_long_control <- dat1_long %>% filter(Group=="CON")

# data for fig 1c
dat1_age <- read.csv("T:\\Aaron Michels\\Temporal development of T-cell repertoires\\Data raw\\fig_1b_s2_age.csv",na.strings = c(""," ","X"))
dat1_age$l.clonality <- log(dat1_age$Clonality)
dat1_age$TP <- as.factor(dat1_age$TP)
dat1_age_case <- dat1_age %>% filter(Group=="CASE")
dat1_age_control <- dat1_age %>% filter(Group=="CON")

# data for fig 4a
dat4a_aet <- read.csv("T:\\Aaron Michels\\Temporal development of T-cell repertoires\\Data raw\\fig 4a %AET.csv",na.strings = c(""," ","X"))
dat4a_aet$Time.point <- as.factor(dat4a_aet$Time.point)
dat4a_aet$l.templates <- log(dat4a_aet$X..Templates)
dat4a_aet$l.unique.CDR3s <- log(dat4a_aet$X..Unique.CDR3s)

dat4a_set <- read.csv("T:\\Aaron Michels\\Temporal development of T-cell repertoires\\Data raw\\fig 4a S%ET.csv",na.strings = c(""," ","X"))
dat4a_set$Time.point <- as.factor(dat4a_set$Time.point)
dat4a_set$l.templates <- log(dat4a_set$X..Templates)
dat4a_set$l.unique.CDR3s <- log(dat4a_set$X..Unique.CDR3s)

dat4a_sat <- read.csv("T:\\Aaron Michels\\Temporal development of T-cell repertoires\\Data raw\\fig 4a SA%T.csv",na.strings = c(""," ","X"))
dat4a_sat$Time.point <- as.factor(dat4a_sat$Time.point)
dat4a_sat$l.templates <- log(dat4a_sat$X..Templates)
dat4a_sat$l.unique.CDR3s <- log(dat4a_sat$X..Unique.CDR3s)

dat4a_sae <- read.csv("T:\\Aaron Michels\\Temporal development of T-cell repertoires\\Data raw\\fig 4a SAE%.csv",na.strings = c(""," ","X"))
dat4a_sae$Time.point <- as.factor(dat4a_sae$Time.point)
dat4a_sae$l.templates <- log(dat4a_sae$X..Templates)
dat4a_sae$l.unique.CDR3s <- log(dat4a_sae$X..Unique.CDR3s)

# read in data for fig s1
dats1 <- read.csv("T:\\Aaron Michels\\Temporal development of T-cell repertoires\\Data raw\\fig s1.csv",na.strings = c(""," ","X"))
dats1_long <- dats1 %>% gather(tp,Productive.template,-c(ID,Group))
dats1_long$time <- ifelse(dats1_long$tp=="Productive.template.1",1,
                         ifelse(dats1_long$tp=="Productive.template.2",2,
                                ifelse(dats1_long$tp=="Productive.template.3",3,4)))
dats1_long$time <- as.factor(dats1_long$time)
dats1_long_case <- dats1_long %>% filter(Group=="CASE")
dats1_long_control <- dats1_long %>% filter(Group=="CON")

# fig S6
dats6_lqs <- read.csv("T:\\Aaron Michels\\Temporal development of T-cell repertoires\\Data raw\\fig s6a %LQS.csv",na.strings = c(""," ","X"))
dats6_lqs$Time.point <- as.factor(dats6_lqs$Time.point)
dats6_lqs$l.templates <- log(dats6_lqs$X..Templates)
dats6_lqs$l.unique.CDR3s <- log(dats6_lqs$X..Unique.CDR3s)

dats6_sqs <- read.csv("T:\\Aaron Michels\\Temporal development of T-cell repertoires\\Data raw\\fig s6a S%QS.csv",na.strings = c(""," ","X"))
dats6_sqs$Time.point <- as.factor(dats6_sqs$Time.point)
dats6_sqs$l.templates <- log(dats6_sqs$X..Templates)
dats6_sqs$l.unique.CDR3s <- log(dats6_sqs$X..Unique.CDR3s)

dats6_sls <- read.csv("T:\\Aaron Michels\\Temporal development of T-cell repertoires\\Data raw\\fig s6a SL%S.csv",na.strings = c(""," ","X"))
dats6_sls$Time.point <- as.factor(dats6_sls$Time.point)
dats6_sls$l.templates <- log(dats6_sls$X..Templates)
dats6_sls$l.unique.CDR3s <- log(dats6_sls$X..Unique.CDR3s)

dats6_slq <- read.csv("T:\\Aaron Michels\\Temporal development of T-cell repertoires\\Data raw\\fig s6a SLQ%.csv",na.strings = c(""," ","X"))
dats6_slq$Time.point <- as.factor(dats6_slq$Time.point)
dats6_slq$l.templates <- log(dats6_slq$X..Templates)
dats6_slq$l.unique.CDR3s <- log(dats6_slq$X..Unique.CDR3s)

# fig S7
dats7_iag <- read.csv("T:\\Aaron Michels\\Temporal development of T-cell repertoires\\Data raw\\fig s7a %IAG.csv",na.strings = c(""," ","X"))
dats7_iag$Time.point <- as.factor(dats7_iag$Time.point)
dats7_iag$l.templates <- log(dats7_iag$X..Templates)
dats7_iag$l.unique.CDR3s <- log(dats7_iag$X..Unique.CDR3s)

dats7_sag <- read.csv("T:\\Aaron Michels\\Temporal development of T-cell repertoires\\Data raw\\fig s7a S%AG.csv",na.strings = c(""," ","X"))
dats7_sag$Time.point <- as.factor(dats7_sag$Time.point)
dats7_sag$l.templates <- log(dats7_sag$X..Templates)
dats7_sag$l.unique.CDR3s <- log(dats7_sag$X..Unique.CDR3s)

dats7_sig <- read.csv("T:\\Aaron Michels\\Temporal development of T-cell repertoires\\Data raw\\fig s7a SI%G.csv",na.strings = c(""," ","X"))
dats7_sig$Time.point <- as.factor(dats7_sig$Time.point)
dats7_sig$l.templates <- log(dats7_sig$X..Templates)
dats7_sig$l.unique.CDR3s <- log(dats7_sig$X..Unique.CDR3s)

dats7_sia <- read.csv("T:\\Aaron Michels\\Temporal development of T-cell repertoires\\Data raw\\fig s7a SIA%.csv",na.strings = c(""," ","X"))
dats7_sia$Time.point <- as.factor(dats7_sia$Time.point)
dats7_sia$l.templates <- log(dats7_sia$X..Templates)
dats7_sia$l.unique.CDR3s <- log(dats7_sia$X..Unique.CDR3s)

dats7_iag <- read.csv("T:\\Aaron Michels\\Temporal development of T-cell repertoires\\Data raw\\fig s7a IAG%.csv",na.strings = c(""," ","X"))
dats7_iag$Time.point <- as.factor(dats7_iag$Time.point)
dats7_iag$l.templates <- log(dats7_iag$X..Templates)
dats7_iag$l.unique.CDR3s <- log(dats7_iag$X..Unique.CDR3s)

dats7_agg <- read.csv("T:\\Aaron Michels\\Temporal development of T-cell repertoires\\Data raw\\fig s7a AGG%.csv",na.strings = c(""," ","X"))
dats7_agg$Time.point <- as.factor(dats7_agg$Time.point)
dats7_agg$l.templates <- log(dats7_agg$X..Templates)
dats7_agg$l.unique.CDR3s <- log(dats7_agg$X..Unique.CDR3s)
```

# Background


# Methods

fig 1 - Log transformed clonality but residuals still don't look great - could consider other transformations

fig 2 - OK, don't know what I needed to do there

try transforming data for fig 4? didn't look much better

fig s1 - assumed that one row=one person

# Results

## Figure 1b - all samples

```{r, echo=FALSE, message=FALSE}
mod <- lme(l.clonality ~ tp,random=~1|ID,data = dat1_long,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,"tp")
mod_pairs <-  pairs(mod_means,adjust="tukey")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure 1b - controls

```{r, echo=FALSE, message=FALSE}
mod <- lme(clonality ~ tp,random=~1|ID,data = dat1_long_control,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,"tp")
mod_pairs <-  pairs(mod_means,adjust="tukey")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure 1b - cases

```{r, echo=FALSE, message=FALSE}
mod <- lme(clonality ~ tp,random=~1|ID,data = dat1_long_case,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,"tp")
mod_pairs <-  pairs(mod_means,adjust="tukey")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure S2 - interaction of group and time

```{r, echo=FALSE, message=FALSE}
mod <- lme(l.clonality ~ Group*time,random=~1|ID,data = dat1_long,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Group*time)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Group")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between groups.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure 1c - all samples

```{r, echo=FALSE, message=FALSE}
mod <- lme(l.clonality ~ Age,random=~1|ID,data = dat1_age,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure 1c - controls

```{r, echo=FALSE, message=FALSE}
mod <- lme(l.clonality ~ Age,random=~1|ID,data = dat1_age_control,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure 1c - cases

```{r, echo=FALSE, message=FALSE}
mod <- lme(l.clonality ~ TP ,random=~1|ID,data = dat1_age_case,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure 4a - *AET templates

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Templates ~ Time.point*Diagnosis,random=~1|Patient,data = dat4a_aet,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure 4a - *AET diversity

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Unique.CDR3s ~ Time.point*Diagnosis,random=~1|Patient,data = dat4a_aet,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))

```

## Figure 4a - S*ET templates

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Templates ~ Time.point*Diagnosis,random=~1|Patient,data = dat4a_set,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure 4a - S*ET diversity

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Unique.CDR3s ~ Time.point*Diagnosis,random=~1|Patient,data = dat4a_set,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure 4a - SA*T templates

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Templates ~ Time.point*Diagnosis,random=~1|Patient,data = dat4a_sat,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure 4a - SA*T diversity

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Unique.CDR3s ~ Time.point*Diagnosis,random=~1|Patient,data = dat4a_sat,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure 4a - SAE* templates

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Templates ~ Time.point*Diagnosis,random=~1|Patient,data = dat4a_sae,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure 4a - SAE* diversity

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Unique.CDR3s ~ Time.point*Diagnosis,random=~1|Patient,data = dat4a_sae,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure S1 - all samples, combined time points

```{r, echo=FALSE, message=FALSE}
mod <- lme(Productive.template ~ Group,random=~1|ID,data = dats1_long,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,"Group")
mod_pairs <-  pairs(mod_means,adjust="tukey")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between groups.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure S1 - all samples, with interaction of group and time

```{r, echo=FALSE, message=FALSE}
mod <- lme(Productive.template ~ Group*time,random=~1|ID,data = dats1_long,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Group*time)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Group")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between groups.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure S6a - *LQS templates

Sample size was too small for the *LQS models to converge.

```{r, echo=FALSE, message=FALSE}
# mod <- lme(X..Templates ~ Time.point*Diagnosis,random=~1|Patient,data = dats6_lqs,na.action = na.omit)
# mod_anova <- anova.lme(mod, type="marginal")
# mod_means <- emmeans(mod,~Time.point*Diagnosis)
# mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")
# 
# kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
# kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
# kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))
# 
# qqnorm(resid(mod))
# qqline(resid(mod))
```

## Figure S6a - *LQS diversity

Sample size was too small for the *LQS models to converge.

```{r, echo=FALSE, message=FALSE}
# mod <- lme(X..Unique.CDR3s ~ Time.point*Diagnosis,random=~1|Patient,data = dats6_lqs,na.action = na.omit)
# mod_anova <- anova.lme(mod, type="marginal")
# mod_means <- emmeans(mod,~Time.point*Diagnosis)
# mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")
# 
# kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
# kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
# kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))
# 
# qqnorm(resid(mod))
# qqline(resid(mod))

```

## Figure S6a - S*QS templates

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Templates ~ Time.point*Diagnosis,random=~1|Patient,data = dats6_sqs,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure S6a - S*QS diversity

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Unique.CDR3s ~ Time.point*Diagnosis,random=~1|Patient,data = dats6_sqs,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))

```

## Figure S6a - SL*S templates

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Templates ~ Time.point*Diagnosis,random=~1|Patient,data = dats6_sls,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure S6a - SL*S diversity

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Unique.CDR3s ~ Time.point*Diagnosis,random=~1|Patient,data = dats6_sls,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))

```

## Figure S6a - SLQ* templates

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Templates ~ Time.point*Diagnosis,random=~1|Patient,data = dats6_slq,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure S6a - SLQ* diversity

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Unique.CDR3s ~ Time.point*Diagnosis,random=~1|Patient,data = dats6_slq,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))

```

## Figure S7a - *IAG templates

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Templates ~ Time.point*Diagnosis,random=~1|Patient,data = dats7_iag,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure S7a - *IAG diversity

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Unique.CDR3s ~ Time.point*Diagnosis,random=~1|Patient,data = dats7_iag,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))

```

## Figure S7a - S*AG templates

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Templates ~ Time.point*Diagnosis,random=~1|Patient,data = dats7_sag,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure S7a - S*AG diversity

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Unique.CDR3s ~ Time.point*Diagnosis,random=~1|Patient,data = dats7_sag,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))

```

## Figure S7a - SI*G templates

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Templates ~ Time.point*Diagnosis,random=~1|Patient,data = dats7_sig,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure S7a - SI*G diversity

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Unique.CDR3s ~ Time.point*Diagnosis,random=~1|Patient,data = dats7_sig,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))

```

## Figure S7a - SIA* templates

SIA* models would not converge due to sample size.

```{r, echo=FALSE, message=FALSE}
# mod <- lme(X..Templates ~ Time.point*Diagnosis,random=~1|Patient,data = dats7_sia,na.action = na.omit)
# mod_anova <- anova.lme(mod, type="marginal")
# mod_means <- emmeans(mod,~Time.point*Diagnosis)
# mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")
# 
# kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
# kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
# kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))
# 
# qqnorm(resid(mod))
# qqline(resid(mod))
```

## Figure S7a - SIA* diversity

SIA* models would not converge due to sample size.

```{r, echo=FALSE, message=FALSE}
# mod <- lme(X..Unique.CDR3s ~ Time.point*Diagnosis,random=~1|Patient,data = dats7_sia,na.action = na.omit)
# mod_anova <- anova.lme(mod, type="marginal")
# mod_means <- emmeans(mod,~Time.point*Diagnosis)
# mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")
# 
# kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
# kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
# kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))
# 
# qqnorm(resid(mod))
# qqline(resid(mod))

```

## Figure S7a - IAG* templates

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Templates ~ Time.point*Diagnosis,random=~1|Patient,data = dats7_iag,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure S7a - IAG* diversity

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Unique.CDR3s ~ Time.point*Diagnosis,random=~1|Patient,data = dats7_iag,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))

```

## Figure S7a - AGG* templates

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Templates ~ Time.point*Diagnosis,random=~1|Patient,data = dats7_agg,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))
```

## Figure S7a - AGG* diversity

```{r, echo=FALSE, message=FALSE}
mod <- lme(X..Unique.CDR3s ~ Time.point*Diagnosis,random=~1|Patient,data = dats7_agg,na.action = na.omit)
mod_anova <- anova.lme(mod, type="marginal")
mod_means <- emmeans(mod,~Time.point*Diagnosis)
mod_pairs <-  pairs(mod_means,adjust="tukey",simple="Diagnosis")

kable(mod_anova,caption="Type 3 tests of fixed effects.",format.args = list(scientific = FALSE))
kable(mod_means,caption="Time point means.",format.args = list(scientific = FALSE))
kable(mod_pairs,caption="Pair-wise comparisons between time points.",format.args = list(scientific = FALSE))

qqnorm(resid(mod))
qqline(resid(mod))

```