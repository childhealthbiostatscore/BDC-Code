---
title: ""
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 5
    toc_float: yes
---

```{r setup, include=FALSE}
library(arsenal)
library(tidyverse)
library(performance)
library(knitr)
library(readxl)
library(lubridate)

knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "S:/Shared/Shared Projects/Laura/BDC/Projects"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
}
knitr::opts_knit$set(root.dir = home_dir)
rm(home_dir)


# data upload
fakecarbs = read.csv("S:/Laura/BDC/Projects/Sarit Polsky/PICLS/Data_Clean/fake_carb_boluses.csv")
```

```{r functions, include = FALSE}
#  function to read sheet by sheet; from stack exchange
read_excel_allsheets <- function(filename, tibble = FALSE) {
    # I prefer straight data.frames
    # but if you like tidyverse tibbles (the default with read_excel)
    # then just pass tibble = TRUE
    sheets <- readxl::excel_sheets(filename)
    x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X))
    if(!tibble) x <- lapply(x, as.data.frame)
    names(x) <- sheets
    x
}

# clean the gest dates data (we want the "rightmost column of dates" per sarit)
# currently the sheets have unnamed columns due to clinic notes or some other magic
clean_gd = function(df){
  df = df %>% select(-where(is.character)) %>% select(-where(is.logical))
  df
}


# function to get a date dataset and merge by dates
gest_df_clean = function(df){
  # x = subj_data %>% filter(ID == df)
  # select only gest week, day, and rightmost date col
  y = df %>% select(1,2,length(df))
  # get the last date column and rename it to "visit_date"
  y = y %>% mutate(visit_date = .[[3]]) %>% select(1,2,visit_date)
  return(y)
}


```

```{r data clean, include = FALSE}
# derive visit date from week and rand date
fakecarbs = fakecarbs %>% mutate(visit_date = mdy(Randomization.Date) + (7*Week.Num.))

# create reference lists
id_list = fakecarbs %>% select(ID) %>% unique() 
gest_dates = read_excel_allsheets("S:/Laura/BDC/Projects/Sarit Polsky/PICLS/Data_Raw/CURRENT_Gestational Age Calculator_v6 .xlsx")
#remove weird columns from gest dates
gest_dates = lapply(gest_dates, clean_gd)
gest_dates = keep(gest_dates, names(gest_dates) %in% id_list$ID)

# select "rightmost" column and gest week/day -> all subj down to 3 col
gest_dates = lapply(gest_dates, gest_df_clean)

# add id column to gestdates to combine later
gest_dates = lapply(seq(gest_dates), function(x) "[[<-"(gest_dates[[x]], paste0("ID"), value = names(gest_dates)[x]))

# combine into one reference df
gest_dates = Reduce(full_join,gest_dates)

# create analysis dataset
analysis = left_join(fakecarbs, gest_dates) # joining on id and date -- perfectomundo
```


```{r analysis, include = FALSE}
# want % insulin from fake carbs (total bolus fake carbs/total bolus vol), avg per timepoint (trimesters)
# # bolus per week and avg per timepoint
# how many did/didnt put in fake carbs in each timepoint?



```