---
title: "TESS ADA 2022"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(arsenal)
library(tidyverse)
library(performance)
library(knitr)
library(lubridate)
library(AGD)
knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "B:/Projects"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
}
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data cleaning}
# Import demographics
subject = read.csv("./Brigitte Frohnert/TESS/Data_Raw/Tess Subject Information.csv",
                   stringsAsFactors = F)
# Age 
subject$Age = as.numeric(difftime(mdy(subject$Baseline.visit.date), 
                                  mdy_hm(subject$Date.of.Birth)))/365.25
# BMI z score
subject$Gender = as.factor(subject$Gender)
levels(subject$Gender) = c("F","M")
subject$BMI = subject$Weight..kg. / ((subject$Height..cm./100)^2)
subject$BMIz = y2z(subject$BMI,x=subject$Age, sex=subject$Gender, ref=nl4.bmi)
```

# Participant Characteristics at Baseline by FDR Status

```{r results='asis'}
t = tableby(FDR ~ Age + BMIz + A1C,data = subject)
summary(t,pfootnote = T)
```

# CGM and OGTT at Baseline by FDR Status

```{r}
# CGM and OGTT data at baseline
cgm = read.csv("./Brigitte Frohnert/TESS/Data_Raw/CGM data.csv",
               stringsAsFactors = F,na.strings = c("","NULL","-999.99"))
cgm = cgm[cgm$Visit == "Baseline",]
ogtt = read.csv("./Brigitte Frohnert/TESS/Data_Raw/OGTT data.csv",
                stringsAsFactors = F,na.strings = c("","NULL","-999.99"))
ogtt = ogtt[ogtt$Visit == "Baseline",]
ogtt_times = c("minus10","0","10","30","60","90","120")
ogtt_vars = c(paste0("ogtt_",ogtt_times[-1],"_cpep_result"),
              "ogtt_minus10_bg",paste0("ogtt_",ogtt_times[-1],"_glucose_result"))
ogtt = ogtt %>% select(ogtt_tess_id,all_of(ogtt_vars))
# Average CGM by ID
cgm = cgm %>% group_by(cgm_tess_id) %>%
  summarise(across(cgm_num_days:cgm_cov_calc,mean,na.rm = T))
cgm_vars = colnames(cgm)[-1]
# Merge
df = left_join(subject,cgm,by = c("TESS.ID" = "cgm_tess_id"))
df = left_join(df,ogtt,by = c("TESS.ID" = "ogtt_tess_id"))
```

```{r results='asis'}
metab_vars = paste0(paste0("kwt(",cgm_vars,")",collapse = "+"),"+",
                  paste0("kwt(",ogtt_vars,")",collapse = "+"))
f = as.formula(paste0("FDR ~ ",metab_vars))
t = tableby(f,data = df)
summary(t,pfootnote = T)
```

# Questionnaires at Baseline by FDR Status

## Attitude

```{r}
# Attitude
attitude = read.csv("./Brigitte Frohnert/TESS/Data_Raw/Attitude Survey.csv")
attitude = attitude[attitude$Visit == "Baseline",]
attitude$total = rowSums(attitude[,tail(colnames(attitude,3))])
attitude = attitude %>%
  select(att1_tess_id,att1_form_who,Importance.of.Control.score:total) %>%
  pivot_wider(id_cols = att1_tess_id,names_from = att1_form_who,
              values_from = Importance.of.Control.score:total)
df = left_join(subject,attitude,by = c("TESS.ID" = "att1_tess_id"))
```

```{r results='asis'}
f = as.formula(paste0("FDR ~ ",paste0(colnames(attitude)[-1],collapse = "+")))
t = tableby(f,data = df)
summary(t,pfootnote = T)
```

## Knowledge

```{r}
# Knowledge
knowledge = read.csv("./Brigitte Frohnert/TESS/Data_Raw/Diabetes Survey scored.csv")
knowledge = knowledge[knowledge$Visit == "Baseline",]
knowledge = knowledge %>%
  select(dia1_tess_id,dia1_form_who,TOTAL.score) %>%
  pivot_wider(id_cols = dia1_tess_id,names_from = dia1_form_who,
              values_from = TOTAL.score,names_prefix = "total_")
df = left_join(subject,knowledge,by = c("TESS.ID" = "dia1_tess_id"))
```

```{r results='asis'}
f = as.formula(paste0("FDR ~ ",paste0(colnames(knowledge)[-1],collapse = "+")))
t = tableby(f,data = df)
summary(t,pfootnote = T)
```

# Questionnaires by parent

## Attitude

```{r}
attitude = read.csv("./Brigitte Frohnert/TESS/Data_Raw/Attitude Survey.csv")
attitude %>% count(att1_form_who) %>% kable(.)
```

## Diabetes survey

```{r}
dia = read.csv("./Brigitte Frohnert/TESS/Data_Raw/Diabetes Survey scored.csv")
dia %>% count(dia1_form_who) %>% kable(.)
```

## Parent questionnaire

```{r}
parent = read.csv("./Brigitte Frohnert/TESS/Data_Raw/Parent Questionnaire.csv")
parent %>% count(pq1_formwho) %>% kable(.)
```

## PedsQL family impact 

```{r}
pedsql_family = read.csv("./Brigitte Frohnert/TESS/Data_Raw/PedsQL Family Impact Questionnaire.csv")
pedsql_family %>% count(pf1_form_who) %>% kable(.)
```

## PedsQL parent

```{r}
pedsql = read.csv("./Brigitte Frohnert/TESS/Data_Raw/PedsQL Parent Questionnaire.csv")
pedsql %>% count(pp1_form_whoform) %>% kable(.)
```

## PHQ8

```{r}
phq8 = read.csv("./Brigitte Frohnert/TESS/Data_Raw/PHQ8 Questionnaire.csv")
phq8 %>% count(phq1_form_who) %>% kable(.)
```

## Uncertainty

```{r}
uncertain = read.csv("./Brigitte Frohnert/TESS/Data_Raw/Uncertainty Survey.csv")
uncertain %>% count(unc1_form_who) %>% kable(.)
```