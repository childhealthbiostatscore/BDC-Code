---
title: "TESS ADA 2022"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(arsenal)
library(tidyverse)
library(performance)
library(knitr)
library(lubridate)
library(AGD)
knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "B:/Projects"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
}
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data cleaning}
# Import demographics
subject = read.csv("./Brigitte Frohnert/TESS/Data_Raw/Tess Subject Information.csv",
                   stringsAsFactors = F)
# Age 
subject$Age = as.numeric(difftime(mdy(subject$Baseline.visit.date), 
                                  mdy_hm(subject$Date.of.Birth)))/365.25
# BMI z score
subject$Gender = as.factor(subject$Gender)
levels(subject$Gender) = c("F","M")
subject$BMI = subject$Weight..kg. / ((subject$Height..cm./100)^2)
subject$BMIz = y2z(subject$BMI,x=subject$Age, sex=subject$Gender, ref=nl4.bmi)
# CGM and OGTT data at baseline
cgm = read.csv("./Brigitte Frohnert/TESS/Data_Raw/CGM data.csv",
               stringsAsFactors = F,na.strings = c("","NULL","-999.99"))
cgm = cgm[cgm$Visit == "Baseline",]
ogtt = read.csv("./Brigitte Frohnert/TESS/Data_Raw/OGTT data.csv",
                stringsAsFactors = F,na.strings = c("","NULL","-999.99"))
ogtt = ogtt[ogtt$Visit == "Baseline",]
ogtt_times = c("minus10","0","10","30","60","90","120")
ogtt_vars = c(paste0("ogtt_",ogtt_times[-1],"_cpep_result"),
              "ogtt_minus10_bg",paste0("ogtt_",ogtt_times[-1],"_glucose_result"))
ogtt = ogtt %>% select(ogtt_tess_id,all_of(ogtt_vars))
# Average CGM by ID
cgm = cgm %>% group_by(cgm_tess_id) %>% summarise(across(cgm_num_days:cgm_cov_calc,mean,na.rm = T))
cgm_vars = colnames(cgm)[-1]
# Merge
df = left_join(subject,cgm,by = c("TESS.ID" = "cgm_tess_id"))
df = left_join(df,ogtt,by = c("TESS.ID" = "ogtt_tess_id"))
```

# Participant Characteristics by FDR Status

```{r results='asis'}
kwt_vars = paste0(paste0("kwt(",cgm_vars,")",collapse = "+"),"+",
                  paste0("kwt(",ogtt_vars,")",collapse = "+"))
f = as.formula(paste0("FDR ~ Age + BMIz + A1C + ",kwt_vars))
t1 = tableby(f,data = df)
summary(t1,pfootnote = T)
```
