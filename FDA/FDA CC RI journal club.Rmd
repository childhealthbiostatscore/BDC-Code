---
title: "A gentle introduction to functional data analysis using R"
author: "Laura Pyle & Tim Vigers"
date: "November 10, 2021"
output: beamer_presentation
header-includes:
  \usepackage{bm}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(dplyr)
library(patchwork)
library(splines)
library(gam)
library(knitr)
library(kableExtra)
library(visreg)
data(WarsawApts, package = "HRW")
dat = read.csv("H:/Talks/FDA/for_jm_v3_kaci.csv")
```

## Acknowledgments

- Kristen (Campbell) Miller was a co-presenter on a related talk given to the BDC analytical discussion series from which some of these slides are taken.
- Julia Wroebel met with us to talk about FDA and the $refund$, $refund.shiny$, and $tidyfun$ packages.
- Andrew Leroux let us sit in on his FDA course.

## What are functional data?

- Data that provide information about curves, surfaces, or anything varying over a continuum
- Each observation is a function
- Often the function is defined over time, but it can be over spatial location, or any other continuous variable
- Examples:
  - Growth data
  - Imaging data 
  - Wearable device data
  - Accelerometry (physical activity) 
  - **Continuous glucose monitoring** (CGM)

## CGM ambulatory glucose profile

\includegraphics{abbott_agp.jpg}

## Goals of analysis

- The goals of FDA are essentially the same as other areas of statistics:
  1. Descriptive analysis and visualization
  2. Characterize sources of variability
  3. Relate patterns of variability in functional data to outcomes
  4. Relate individual characteristics to patterns of variability in the functional data 

## Functional Data Analysis (FDA) compared to other approaches

- FDA is semi- or non-parametric
  - Instead of estimating $\bm{\theta}$ in a model $p(x|\bm{\theta})$, we are interested in estimating $p$ itself
  - Only assumption is that the data are generated by a smooth continuous process 
  - In practice, we can't observe the underlying function so it is represented as a vector of measurements
- Related approaches include times series analysis and other types of longitudinal data analysis
- FDA is particularly useful for high-dimensional data and allows noise reduction through smoothing
- FDA is also well suited for nonlinear relationships and irregular sampling schedules
- FDA allows us to describe the function in terms of its derivatives (e.g., acceleration)

## Smoothing and basis functions

- One of the central issues in FDA is estimation of the function by smoothing

$$y_i = f(x_i)+\epsilon_i$$

- The true underlying function can't be observed, and observations are not continuous
- We smooth the observed data and estimate the underlying function via basis functions
- Common types of basis functions used in FDA include B-splines, natural cubic splines, thin plate splines, the Fourier basis
- Polynomials are a simple form of basis function:  $$y_i=\beta_1+\beta_2x+\beta_3x^2+\beta_4x^3+\beta_5x^4+\epsilon_i$$

## Polynomial Models

```{r}
ggplot(WarsawApts,aes(x=construction.date,y=areaPerMzloty)) +
  geom_point(alpha=0.3) + 
  geom_smooth(method='lm',formula=y~x,se=F,color="blue",size=1) +
  theme_bw() + ggtitle("Linear") +
  ylab("Area per Million Zloty") + xlab("Date")
```

## Polynomial Models

```{r}
ggplot(WarsawApts,aes(x=construction.date,y=areaPerMzloty)) +
  geom_point(alpha=0.3) + 
  geom_smooth(method='lm',formula=y~x+I(x^2),se=F,color="blue",size=1) +
  theme_bw() + ggtitle("Quadratic") +
  ylab("Area per Million Zloty") + xlab("Date")
```

## Polynomial Models

```{r}
ggplot(WarsawApts,aes(x=construction.date,y=areaPerMzloty)) +
  geom_point(alpha=0.3) + 
  geom_smooth(method='lm',formula=y~x+I(x^2)+I(x^3),se=F,color="blue",size=1) +
  theme_bw() + ggtitle("Cubic") +
  ylab("Area per Million Zloty") + xlab("Date")
```

## Splines

- Instead of a polynomial model across all of $X$, we can fit several models over different regions of $X$.
- With the constraint that they "join up" at each knot.

- For the simplest example we use a single knot $c$, which splits $X$ into two regions. 
  - Then we fit a linear model through each region:
  
$$
y_i=
    \begin{cases}
      \beta_{01}+\beta_{11}x_i, & \text{if}\ x_i<c \\
      \beta_{02}+\beta_{12}x_i, & \text{if}\ x_i\geq c
    \end{cases}
$$

## Spline Models

```{r}
fit = gam(areaPerMzloty~bs(construction.date,df = 2,degree = 1),data = WarsawApts)

ggplot(WarsawApts,aes(x=construction.date,y=areaPerMzloty)) +
  geom_point(alpha=0.3) + 
  geom_line(aes(y = predict(fit)),color="blue",size=1) +
  theme_bw() + ggtitle("Linear Splines with 1 Knot") +
  ylab("Area per Million Zloty") + xlab("Date")
```

## Improving the Fit

- We can increase the number of knots (K) and the degree to obtain a better fit.
- One way is to increase K until it produces the best looking curve.
  - Or can use cross validation (usually 10-fold) to see which K produces the lowest mean squared error (MSE).
- In practice piecewise cubic fits are often used.
  - Smoother
  - Nice numerical properties

## Spline Models

```{r}
fit = gam(areaPerMzloty~bs(construction.date,df = 21,degree = 1),data = WarsawApts)

ggplot(WarsawApts,aes(x=construction.date,y=areaPerMzloty)) +
  geom_point(alpha=0.3) + 
  geom_line(aes(y = predict(fit)),color="blue",size=1) +
  theme_bw() + ggtitle("Linear Splines with 20 Knots") +
  ylab("Area per Million Zloty") + xlab("Date")
```

## Spline Models

```{r}
fit = gam(areaPerMzloty~bs(construction.date,df = 8,degree = 3),data = WarsawApts)

ggplot(WarsawApts,aes(x=construction.date,y=areaPerMzloty)) +
  geom_point(alpha=0.3) + 
  geom_line(aes(y = predict(fit)),color="blue",size=1) +
  theme_bw() + ggtitle("Cubic Splines with 5 Knots") +
  ylab("Area per Million Zloty") + xlab("Date")
```

## Spline Models

```{r}
fit = gam(areaPerMzloty~bs(construction.date,df = 24,degree = 3),data = WarsawApts)

ggplot(WarsawApts,aes(x=construction.date,y=areaPerMzloty)) +
  geom_point(alpha=0.3) + 
  geom_line(aes(y = predict(fit)),color="blue",size=1) +
  theme_bw() + ggtitle("Cubic Splines with 20 Knots") +
  ylab("Area per Million Zloty") + xlab("Date")
```

## Smoothing and basis functions

- Basis functions are building blocks that can be "stacked" mathematically to approximate the true function

$f(t)= c_1\psi_1(t) + c_2\psi_2(t) + c_3\psi_3(t) + ... + c_k\psi_k(t)$

## Smoothing and basis functions

\includegraphics{covid_berlin.png}

\let\thefootnote\relax\footnotetext{credit: Johannes Wohlenberg towarddatascience.com}

## Smoothing and basis functions

- If $b_j(x)$ is the $j^{th}$ basis function, then: $$f(x)=\sum_{j=1}^k \beta_j b_j(x)$$

- We can add more basis functions to get a better fit to the data, although we risk overfitting
- For spline bases, we need to choose the number of knots (i.e., basis functions) and knot location
- How to choose K (the number of basis functions)?
  - Cross-validation
  - Penalization methods

## Functional principal components analysis (FPCA)

- FPCA is similar to PCA in that it characterizes the variability in functional data
- Variability is decomposed into basis functions on the population level 
  - The first FPC explains the largest source of variability, etc.
- Each individual has a score for each of the basis functions

$$Y_i(t)=\mu(t) + \sum_{k=1}^K c_{ik}\psi_k(t) + \epsilon_i(t)$$

- There are also methods for multilevel and time-varying FPCA

## Function on scalar regression

- We observe a vector of scalar covariates $\mathbf{x_i}=[x_{i1},...,x_{ip}]$ in addition to $Y_i(t)$
- Goal is to model conditional expectation of the functional response on the covariates

$$Y_i(t)=\beta_0(t) + \sum_{k=1}^p x_{ik}\beta_k(t) + \epsilon_i(t)$$
    
- $\beta_k(t)$ are fixed effects for each covariate
- They are interpreted similarly to coefficients in a multiple linear regression; however, they are defined over $t$
- A common approach to estimation and inference is to expand $\beta_k(t)$ using a spline basis
- There are also methods for scalar on function regression and function on function regression

## Software

- SAS
  - JMP Pro, PROC SSM
- R
  - $fda$
  - $fdapace$
  - $mgcv$ (Generalized Additive Models)
  - $refund$, $refund.shiny$, $tidyfun$ 

## Examples

## References

1. Ramsay, J. O., and B. W. Silverman. Functional Data Analysis. 2nd ed. Springer Series in Statistics. New York: Springer, 2005.

2. Harezlak J, Ruppert D, Wand MP. Semiparametric Regression with R. 1st ed. 2018. Springer New York: Imprint: Springer; 2018. doi:10.1007/978-1-4939-8853-2

3. James G, Witten D, Hastie T, Tibshirani R, eds. An Introduction to Statistical Learning: With Applications in R. Springer; 2013.

4. Wood SN. Generalized Additive Models: An Introduction with R. Second edition. CRC Press/Taylor & Francis Group; 2017.

5. Wrobel J, Park SY, Staicu AM, Goldsmith J. Interactive graphics for functional data analyses. Stat. 2016;5(1):108-118. doi:10.1002/sta4.109
