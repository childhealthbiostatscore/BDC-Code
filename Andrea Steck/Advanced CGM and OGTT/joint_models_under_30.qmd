---
title: "Advanced CGM and OGTT: Joint Models (Age < 30)"
author: "Tim Vigers"
date: "now"
date-format: "MMMM D, YYYY [at] hh:mm a"
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    page-layout: full
editor: source
---

```{r setup}
#| include: false
library(tidyverse)
library(plotly)
library(nlme)
library(JM)
library(JMbayes2)
library(ggsurvfit)
library(knitr)
home_dir <- switch(
  Sys.info()["user"],
  "laurapyle" = "/Users/laurapyle/Library/CloudStorage/OneDrive-SharedLibraries-UW(2)/Tim Vigers - UWMDI/Andrea Steck/Advanced CGM and OGTT",
  "lpyle" = "/Users/lpyle/Library/CloudStorage/OneDrive-SharedLibraries-UW(2)/Tim Vigers - UWMDI/Andrea Steck/Advanced CGM and OGTT",
  "pylell" = "/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW(2)/Tim Vigers - UWMDI/Andrea Steck/Advanced CGM and OGTT",
  "tvigers" = "/gscratch/togo/tvigers/Data/BDC/Andrea Steck/Advanced CGM and OGTT",
  "root" = "/gscratch/togo/tvigers/Data/BDC/Andrea Steck/Advanced CGM and OGTT",
  "tim" = "/Users/tim/Library/CloudStorage/OneDrive-UW/UWMDI/Andrea Steck/Advanced CGM and OGTT"
)
knitr::opts_knit$set(root.dir = home_dir)
```

# Age as time variable

```{r data cleaning}
setwd(home_dir)
# See GitHub/BDC-Code/Andrea Steck/Advanced CGM and OGTT/joint_models.r
load("./Data_Clean/joint_model_under_30_results.RData")
```

## Across the whole day

```{r}
#| fig-cap: Mean glucose over time
mean_plot <- ggplot(
  cgm_lmm,
  aes(x = Age, y = mean_glucose, color = ID)
) +
  geom_point(alpha = 0.1) +
  geom_line(alpha = 0.5) +
  theme_bw() +
  theme(legend.position = "none")
ggplotly(mean_plot)
```

```{r}
#| fig-cap: Glucose SD over time
sd_plot <- ggplot(
  cgm_lmm,
  aes(x = Age, y = sd_glucose, color = ID)
) +
  geom_point(alpha = 0.1) +
  geom_line(alpha = 0.5) +
  theme_bw() +
  theme(legend.position = "none")
ggplotly(sd_plot)
```

```{r}
survfit2(
  Surv(Ages, event) ~ 1,
  data = cgm_surv
) |>
  ggsurvfit() +
  labs(
    x = "Age (years)",
    y = "Overall survival probability"
  ) +
  add_confidence_interval()
```

### Cox model

#### Results

```{r}
summary(cox_fit)
```

#### Diagnostics

```{r}
performance::check_model(cox_fit, residual_type = "normal")
cox.zph(cox_fit)
plot(cox.zph(cox_fit))
```

### Mean glucose

#### Linear model results

```{r}
summary(lme_fit_mean_rs)
```

#### Linear model diagnostics

```{r}
performance::check_model(lme_fit_mean_rs)
```

#### Joint model results

```{r}
ggtraceplot(joint_fit_mean, "betas")
s <- summary(joint_fit_mean)
kable(s$Outcome1, caption = "Longitudinal Process", digits = 3)
kable(s$Survival, caption = "Event Process", digits = 3)
```

### SD

#### Linear model results

```{r}
summary(lme_fit_sd_rs)
```

#### Linear model diagnostics

```{r}
performance::check_model(lme_fit_sd_rs)
```

#### Joint model results

```{r}
ggtraceplot(joint_fit_sd, "betas")
s <- summary(joint_fit_sd)
kable(s$Outcome1, caption = "Longitudinal Process", digits = 3)
kable(s$Survival, caption = "Event Process", digits = 3)
```

### Mean and SD together

#### Joint model results

```{r}
ggtraceplot(joint_fit_mean_sd, "betas")
s <- summary(joint_fit_mean_sd)
kable(s$Outcome1, caption = "Longitudinal Process", digits = 3)
kable(s$Survival, caption = "Event Process", digits = 3)
```

### CV

#### Linear model results

```{r}
summary(lme_fit_cv_rs)
```

#### Linear model diagnostics

```{r}
performance::check_model(lme_fit_cv_rs)
```

#### Joint model results

```{r}
ggtraceplot(joint_fit_cv, "betas")
s <- summary(joint_fit_cv)
kable(s$Outcome1, caption = "Longitudinal Process", digits = 3)
kable(s$Survival, caption = "Event Process", digits = 3)
```

### TAR

In order to fit a negative binomial model, percent time over 140 was rounded to the nearest integer.

#### Linear model results

```{r}
summary(lme_fit_tar_rs)
```

#### Linear model diagnostics

```{r}
# performance::check_model(lme_fit_tar_rs)
```

#### Joint model results

```{r}
ggtraceplot(joint_fit_tar, "betas")
s <- summary(joint_fit_tar)
kable(s$Outcome1, caption = "Longitudinal Process", digits = 3)
kable(s$Survival, caption = "Event Process", digits = 3)
```

### HbA1c

#### Linear model results

```{r}
summary(lme_fit_hba1c_rs)
```

#### Linear model diagnostics

```{r}
performance::check_model(lme_fit_hba1c_rs)
```

#### Joint model results

```{r}
ggtraceplot(joint_fit_hba1c, "betas")
s <- summary(joint_fit_hba1c)
kable(s$Outcome1, caption = "Longitudinal Process", digits = 3)
kable(s$Survival, caption = "Event Process", digits = 3)
```

# Dynamic prediction

```{r}
#| eval: false
ND <- cgm_lmm |> filter(ID %in% c("00799-0"), Age < 16)
ND$event <- 0
ND$Ages <- 16
predLong1 <- predict(jointFit, newdata = ND, return_newdata = TRUE)
plot(predLong1)
predSurv <- predict(
  jointFit,
  newdata = ND,
  process = "event",
  times = seq(16, 20, length.out = 51),
  return_newdata = TRUE
)
plot(predLong1, predSurv)
```

