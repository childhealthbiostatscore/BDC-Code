---
title: "Advanced CGM and OGTT: Joint Models"
author: "Tim Vigers"
date: "now"
date-format: "MMMM D, YYYY [at] hh:mm a"
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    embed-resources: true
    fig-cap-location: top
    page-layout: full
editor: source
---

```{r setup}
#| include: false
library(tidyverse)
library(plotly)
library(nlme)
library(JMbayes2)
library(ggsurvfit)
library(survminer)
library(knitr)
base_dir <- switch(
  Sys.info()["nodename"],
  "togo" = "/home/tvigers/Documents/Data",
  "Tims-MacBook-Air.local" = "/Users/tim/Library/CloudStorage/OneDrive-UW",
  "Tims-Mac-mini.local" = "/Users/tim/Library/CloudStorage/OneDrive-UW",
  "Mac" = "/Users/tim/Library/CloudStorage/OneDrive-UW"
)
data_dir <- switch(
  Sys.info()["nodename"],
  "togo" = "/BDC/Andrea Steck/Advanced CGM and OGTT",
  "Tims-MacBook-Air.local" = "/UWMDI/Andrea Steck/Advanced CGM and OGTT",
  "Tims-Mac-mini.local" = "/UWMDI/Andrea Steck/Advanced CGM and OGTT",
  "Mac" = "/UWMDI/Andrea Steck/Advanced CGM and OGTT"
)
home_dir <- paste0(base_dir, data_dir)
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data cleaning}
setwd(home_dir)
# Load data
# See BDC-Code/Andrea Steck/Advanced CGM and OGTT/create_analysis_dataset.R
load("./Data_Clean/analysis_dataset.RData")
# JM options
jm_control = list(n_thin = 2, n_chains = 4, cores = 4)
```

# Across the whole day

```{r}
#| fig-cap: Mean glucose over time
mean_plot <- ggplot(
  cgm_lmm,
  aes(x = Age, y = mean_glucose, color = ID)
) +
  geom_point(alpha = 0.1) +
  geom_line(alpha = 0.5) +
  ylab("Mean Glucose (mg/dL)") +
  theme_bw() +
  theme(legend.position = "none")
ggplotly(mean_plot)
mean_plot <- ggplot(
  cgm_lmm,
  aes(x = TimeFromFirstCGM, y = mean_glucose, color = ID)
) +
  geom_point(alpha = 0.1) +
  geom_line(alpha = 0.5) +
  ylab("Mean Glucose (mg/dL)") +
  xlab("Years From First CGM") +
  theme_bw() +
  theme(legend.position = "none")
ggplotly(mean_plot)
```

```{r}
#| fig-cap: Glucose SD over time
sd_plot <- ggplot(
  cgm_lmm,
  aes(x = Age, y = sd_glucose, color = ID)
) +
  geom_point(alpha = 0.1) +
  geom_line(alpha = 0.5) +
  ylab("Glucose SD (mg/dL)") +
  theme_bw() +
  theme(legend.position = "none")
ggplotly(sd_plot)
sd_plot <- ggplot(
  cgm_lmm,
  aes(x = TimeFromFirstCGM, y = sd_glucose, color = ID)
) +
  geom_point(alpha = 0.1) +
  geom_line(alpha = 0.5) +
  ylab("Glucose SD (mg/dL)") +
  xlab("Years From First CGM") +
  theme_bw() +
  theme(legend.position = "none")
ggplotly(sd_plot)
```

```{r}
survfit2(
  Surv(AgeEndpoint, event) ~ 1,
  data = cgm_surv
) |>
  ggsurvfit() +
  labs(
    x = "Age (years)",
    y = "Overall survival probability"
  ) +
  add_confidence_interval()
survfit2(
  Surv(EndTime, event) ~ 1,
  data = cgm_surv
) |>
  ggsurvfit() +
  labs(
    x = "Years From First CGM",
    y = "Overall survival probability"
  ) +
  add_confidence_interval()
```

## Model selection (based on mean glucose)

### Cox model

For the survival submodel, AIC was compared between a Cox proportional hazards model and Weibull, exponential, gaussian, logistic,lognormal and log logistic models. The Cox PH model had the lowest AIC and visual inspection of model residuals suggested good model fit. AIC and concordance was also better for the Cox model with age as the time variable compared to the Cox model with time from first CGM as the time variable.

```{r}
# Cox model
cox_fit_age <- coxph(
  Surv(AgeEndpoint, event) ~ sex +
    Race_Ethn2 +
    screen_FDR_GP +
    maxAB_group,
  x = T,
  model = T,
  data = cgm_surv
)
cox_fit_time <- coxph(
  Surv(EndTime, event) ~ sex +
    Race_Ethn2 +
    screen_FDR_GP +
    maxAB_group,
  x = T,
  model = T,
  data = cgm_surv
)
AIC(cox_fit_age, cox_fit_time)
```

#### Results

```{r}
summary(cox_fit_age)
summary(cox_fit_time)
```

#### Diagnostics

##### Age as time variable

```{r}
ggcoxdiagnostics(cox_fit_age, type = "martingale", linear.predictions = F)
ggcoxdiagnostics(cox_fit_age, type = "deviance", linear.predictions = F)
ggcoxdiagnostics(cox_fit_age, type = "score", linear.predictions = F)
ggcoxdiagnostics(cox_fit_age, type = "schoenfeld", linear.predictions = F)
ggcoxdiagnostics(cox_fit_age, type = "partial", linear.predictions = F)
```

##### Years from first CGM as time variable

```{r}
ggcoxdiagnostics(cox_fit_time, type = "martingale", linear.predictions = F)
ggcoxdiagnostics(cox_fit_time, type = "deviance", linear.predictions = F)
ggcoxdiagnostics(cox_fit_time, type = "score", linear.predictions = F)
ggcoxdiagnostics(cox_fit_time, type = "schoenfeld", linear.predictions = F)
ggcoxdiagnostics(cox_fit_time, type = "partial", linear.predictions = F)
```

### Linear model results

Models with random slope and random intercept for participant were better than those with just a random intercept by AIC. The linear model using years from first CGM as the time variable was better than the model using age as the time variable by AIC.

```{r}
lme_fit_mean_rs_age <- lme(
  mean_glucose ~ Age,
  random = ~ Age | ID,
  data = cgm_lmm
)
lme_fit_mean_rs_time <- lme(
  mean_glucose ~ TimeFromFirstCGM,
  random = ~ TimeFromFirstCGM | ID,
  data = cgm_lmm
)
plot_df = lme_fit_mean_rs_age$data
plot_df$pred = predict(lme_fit_mean_rs_age)
ggplot(plot_df, aes(x = Age, color = ID)) +
  geom_point(aes(y = mean_glucose), alpha = 0.2) +
  theme(legend.position = "none") +
  geom_line(aes(y = pred))
plot_df = lme_fit_mean_rs_time$data
plot_df$pred = predict(lme_fit_mean_rs_time)
ggplot(plot_df, aes(x = TimeFromFirstCGM, color = ID)) +
  geom_point(aes(y = mean_glucose), alpha = 0.2) +
  theme(legend.position = "none") +
  geom_line(aes(y = pred))
```

### Linear model diagnostics

#### Age as time variable

```{r}
performance::check_model(lme_fit_mean_rs_age)
```

#### Years from first CGM as time variable

```{r}
performance::check_model(lme_fit_mean_rs_time)
```

### Joint model results

#### Age as time variable

```{r}
# Fit
joint_fit_mean_age <- jm(
  cox_fit_age,
  lme_fit_mean_rs_age,
  time_var = "Age",
  id_var = "ID",
  n_iter = 1e5,
  n_burnin = 1e3,
  control = jm_control
)
traceplot(joint_fit_mean_age)
summary(joint_fit_mean_age)
```

#### Years from first CGM as time variable

```{r}
joint_fit_mean_time <- jm(
  cox_fit_time,
  lme_fit_mean_rs_time,
  time_var = "TimeFromFirstCGM",
  id_var = "ID",
  n_iter = 1e5,
  n_burnin = 1e3,
  control = jm_control
)
traceplot(joint_fit_mean_time)
summary(joint_fit_mean_time)
```

```{r}
compare_jm(joint_fit_mean_age, joint_fit_mean_time)
```

The marginal DIC favors the joint model with time from first CGM as the time variable, but the conditional DIC favors the model with age as time. Because there is some debate about which DIC to use in joint model selection, but generally speaking marginal would be more generalizable for a prediction question  whereas conditional is more relevant to the sample included in the model. 

```{r}
newdat = full_join(cgm_lmm, cgm_surv)
roc_age = tvROC(
  joint_fit_mean_age,
  newdata = newdat,
  Tstart = quantile(cgm_surv$AgeEndpoint, 0.75),
  Dt = 1
)
tvAUC(roc_age)
roc_time = tvROC(
  joint_fit_mean_time,
  newdata = newdat,
  Tstart = quantile(cgm_surv$EndTime, 0.75),
  Dt = 1
)
tvAUC(roc_time)
```

Because there was no winner in terms of DIC and the tvROCAUC favors the age as time model when using 75% of the data, we have chosen to proceed with the age as time model for now. However, clinical intent/relevance should really be the tiebreaker between the two time variables (i.e., what are we hoping to achieve with these models?).

## Age as time model results

### Mean glucose

```{r}
plot_df = lme_fit_mean_rs_age$data
plot_df$pred = predict(lme_fit_mean_rs_age)
ggplot(plot_df, aes(x = Age, color = ID)) +
  geom_point(aes(y = mean_glucose), alpha = 0.2) +
  theme(legend.position = "none") +
  geom_line(aes(y = pred))
summary(joint_fit_mean_age)
```

### Glucose SD

```{r}
lme_fit_sd_rs_age <- lme(
  sd_glucose ~ Age,
  random = ~ Age | ID,
  data = cgm_lmm,
  control = list(opt = "optim")
)
plot_df = lme_fit_sd_rs_age$data
plot_df$pred = predict(lme_fit_sd_rs_age)
ggplot(plot_df, aes(x = Age, color = ID)) +
  geom_point(aes(y = sd_glucose), alpha = 0.2) +
  theme(legend.position = "none") +
  geom_line(aes(y = pred))
joint_fit_sd_age <- jm(
  cox_fit_age,
  lme_fit_sd_rs_age,
  time_var = "Age",
  id_var = "ID",
  n_iter = 1e5,
  n_burnin = 1e3,
  control = jm_control
)
traceplot(joint_fit_sd_age)
summary(joint_fit_sd_age)
```

### Glucose mean and SD together

```{r}
joint_fit_mean_sd_age <- jm(
  cox_fit_age,
  list(lme_fit_mean_rs_age, lme_fit_sd_rs_age),
  time_var = "Age",
  id_var = "ID",
  n_iter = 1e5,
  n_burnin = 1e3,
  control = jm_control
)
traceplot(joint_fit_sd_age)
summary(joint_fit_sd_age)
```

### Glucose CV

```{r}
lme_fit_cv_rs_age <- lme(
  cv_glucose ~ Age,
  random = ~ Age | ID,
  data = cgm_lmm
)
plot_df = lme_fit_cv_rs_age$data
plot_df$pred = predict(lme_fit_cv_rs_age)
ggplot(plot_df, aes(x = Age, color = ID)) +
  geom_point(aes(y = cv_glucose), alpha = 0.2) +
  theme(legend.position = "none") +
  geom_line(aes(y = pred))
joint_fit_cv_age <- jm(
  cox_fit_age,
  lme_fit_cv_rs_age,
  time_var = "Age",
  id_var = "ID",
  n_iter = 1e5,
  n_burnin = 1e3,
  control = jm_control
)
traceplot(joint_fit_cv_age)
summary(joint_fit_cv_age)
```

### TAR140

```{r}
lme_fit_perc_time_over_140_rs_age <- lme(
  perc_time_over_140 ~ Age,
  random = ~ Age | ID,
  data = cgm_lmm
)
plot_df = lme_fit_perc_time_over_140_rs_age$data
plot_df$pred = predict(lme_fit_perc_time_over_140_rs_age)
ggplot(plot_df, aes(x = Age, color = ID)) +
  geom_point(aes(y = perc_time_over_140), alpha = 0.2) +
  theme(legend.position = "none") +
  geom_line(aes(y = pred))
joint_fit_perc_time_over_140_age <- jm(
  cox_fit_age,
  lme_fit_perc_time_over_140_rs_age,
  time_var = "Age",
  id_var = "ID",
  n_iter = 1e5,
  n_burnin = 1e3,
  control = jm_control
)
traceplot(joint_fit_perc_time_over_140_age)
summary(joint_fit_perc_time_over_140_age)
```

### HbA1c

```{r}
lme_fit_hba1c_rs_age <- lme(
  hba1c ~ Age,
  random = ~ Age | ID,
  data = cgm_lmm
)
plot_df = lme_fit_hba1c_rs_age$data
plot_df$pred = predict(lme_fit_hba1c_rs_age)
ggplot(plot_df, aes(x = Age, color = ID)) +
  geom_point(aes(y = hba1c), alpha = 0.2) +
  theme(legend.position = "none") +
  geom_line(aes(y = pred))
joint_fit_hba1c_age <- jm(
  cox_fit_age,
  lme_fit_hba1c_rs_age,
  time_var = "Age",
  id_var = "ID",
  n_iter = 1e5,
  n_burnin = 1e3,
  control = jm_control
)
traceplot(joint_fit_hba1c_age)
summary(joint_fit_hba1c_age)
```

## Combined predictions via super-learning

```{r}
#| eval: false
cv_dats <- create_folds(cgm_lmm, V = 5, id_var = "ID")
# A function that will fit all the above models on the CV data.
fit_models <- function(fold) {
  # Cox model
  cox_fit <- coxph(
    Surv(AgeEndpoint, event) ~ sex +
      Race_Ethn2 +
      screen_FDR_GP +
      maxAB_group,
    x = T,
    model = T,
    data = cgm_surv[cgm_surv$ID %in% fold$ID, ]
  )
  # Mixed models
  lme_fit_mean <- lme(
    mean_glucose ~ Age,
    random = ~ Age | ID,
    data = fold
  )
  lme_fit_sd <- lme(
    sd_glucose ~ Age,
    random = ~ Age | ID,
    data = fold,
    control = list(opt = "optim", msMaxIter = 100)
  )
  lme_fit_cv <- lme(
    cv_glucose ~ Age,
    random = ~ Age | ID,
    data = fold
  )
  lme_fit_tar <- lme(
    perc_time_over_140 ~ Age,
    random = ~ Age | ID,
    data = fold
  )
  lme_fit_hba1c <- lme(
    hba1c ~ Age,
    random = ~ Age | ID,
    data = fold,
    control = list(opt = "optim", msMaxIter = 100)
  )
  # Joint models
  joint_fit_mean <- jm(
    cox_fit,
    lme_fit_mean,
    time_var = "Age",
    id_var = "ID",
    n_iter = 1e5,
    n_burnin = 1e3,
    control = jm_control
  )
  joint_fit_sd <- jm(
    cox_fit,
    lme_fit_sd,
    time_var = "Age",
    id_var = "ID",
    n_iter = 1e5,
    n_burnin = 1e3,
    control = jm_control
  )
  joint_fit_mean_sd <- jm(
    cox_fit,
    list(lme_fit_mean, lme_fit_sd),
    time_var = "Age",
    id_var = "ID",
    n_iter = 1e5,
    n_burnin = 1e3,
    control = jm_control
  )
  joint_fit_cv <- jm(
    cox_fit,
    lme_fit_cv,
    time_var = "Age",
    id_var = "ID",
    n_iter = 1e5,
    n_burnin = 1e3,
    control = jm_control
  )
  joint_fit_tar <- jm(
    cox_fit,
    lme_fit_tar,
    time_var = "Age",
    id_var = "ID",
    n_iter = 1e5,
    n_burnin = 1e3,
    control = jm_control
  )
  joint_fit_hba1c <- jm(
    cox_fit,
    lme_fit_hba1c,
    time_var = "Age",
    id_var = "ID",
    n_iter = 1e5,
    n_burnin = 1e3,
    control = jm_control
  )
  # Format output
  out <- list(
    Mean = joint_fit_mean,
    SD = joint_fit_sd,
    Mean_SD = joint_fit_mean_sd,
    CV = joint_fit_cv,
    TAR = joint_fit_tar,
    HbA1c = joint_fit_hba1c
  )
  class(out) <- "jmList"
  return(out)
}
models_folds <- lapply(cv_dats$training, fit_models)
```

```{r}
#| eval: false
tstr <- 6
thor <- 8
Brier_weights <- tvBrier(
  models_folds,
  newdata = cv_dats$testing,
  integrated = TRUE,
  Tstart = tstr,
  Thoriz = thor
)
Brier_weights
```

```{r}
# Write the best model for use in the Shiny app
best_model = joint_fit_mean_age
save(best_model, file = "./Data_Clean/final_model.RData")
```

