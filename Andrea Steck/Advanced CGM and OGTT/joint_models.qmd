---
title: "Advanced CGM and OGTT: Joint Models"
author: "Tim Vigers"
date: "now"
date-format: "MMMM D, YYYY [at] hh:mm a"
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    page-layout: full
editor: source
---

```{r setup}
#| include: false
library(tidyverse)
library(plotly)
library(nlme)
library(JM)
library(JMbayes2)
library(ggsurvfit)
library(knitr)
base_dir <- switch(
  Sys.info()["nodename"],
  "togo" = "/home/tvigers/Documents/Data",
  "Tims-MacBook-Air.local" = "/Users/tim/Library/CloudStorage/OneDrive-UW",
  "Tims-Mac-mini.local" = "/Users/tim/Library/CloudStorage/OneDrive-UW",
  "Mac" = "/Users/tim/Library/CloudStorage/OneDrive-UW"
)
data_dir <- switch(
  Sys.info()["nodename"],
  "togo" = "/BDC/Andrea Steck/Advanced CGM and OGTT",
  "Tims-MacBook-Air.local" = "/UWMDI/Andrea Steck/Advanced CGM and OGTT",
  "Tims-Mac-mini.local" = "/UWMDI/Andrea Steck/Advanced CGM and OGTT",
  "Mac" = "/UWMDI/Andrea Steck/Advanced CGM and OGTT"
)
home_dir <- paste0(base_dir, data_dir)
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data cleaning}
setwd(home_dir)
# Load data
# See BDC-Code/Andrea Steck/Advanced CGM and OGTT/create_analysis_dataset.R
load("./Data_Clean/analysis_dataset.RData")
# JM options
jm_control = list(n_thin = 2, n_chains = 4, cores = 4)
```

# Across the whole day

```{r}
#| fig-cap: Mean glucose over time
mean_plot <- ggplot(
  cgm_lmm,
  aes(x = Age, y = mean_glucose, color = ID)
) +
  geom_point(alpha = 0.1) +
  geom_line(alpha = 0.5) +
  theme_bw() +
  theme(legend.position = "none")
ggplotly(mean_plot)
```

```{r}
#| fig-cap: Glucose SD over time
sd_plot <- ggplot(
  cgm_lmm,
  aes(x = Age, y = sd_glucose, color = ID)
) +
  geom_point(alpha = 0.1) +
  geom_line(alpha = 0.5) +
  theme_bw() +
  theme(legend.position = "none")
ggplotly(sd_plot)
```

```{r}
survfit2(
  Surv(Ages, event) ~ 1,
  data = cgm_surv
) |>
  ggsurvfit() +
  labs(
    x = "Age (years)",
    y = "Overall survival probability"
  ) +
  add_confidence_interval()
```

## Cox model

```{r}
# Cox model
cox_fit <- coxph(
  Surv(Ages, event) ~ sex +
    Race_Ethn2 +
    screen_FDR_GP +
    maxAB_group,
  x = T,
  model = T,
  data = cgm_surv
)
```

### Results

```{r}
summary(cox_fit)
```

### Diagnostics

```{r}
performance::check_model(cox_fit, residual_type = "normal")
cox.zph(cox_fit)
plot(cox.zph(cox_fit))
```

## Mean glucose

### Linear model results

```{r}
lme_fit_mean_rs <- lme(
  mean_glucose ~ Age,
  random = ~ Age | ID,
  data = cgm_lmm
)
summary(lme_fit_mean_rs)
```

### Linear model diagnostics

```{r}
performance::check_model(lme_fit_mean_rs)
```

### Joint model results

```{r}
#| cache: true
# Fit
joint_fit_mean <- jm(
  cox_fit,
  lme_fit_mean_rs,
  time_var = "Age",
  id_var = "ID",
  n_iter = 1e5,
  n_burnin = 1e3,
  control = jm_control
)
```

```{r}
# Results
traceplot(joint_fit_mean)
s <- summary(joint_fit_mean)
kable(s$Outcome1, caption = "Longitudinal Process", digits = 3)
kable(s$Survival, caption = "Event Process", digits = 3)
```

## SD

### Linear model results

```{r}
lme_fit_sd_rs <- lme(
  sd_glucose ~ Age,
  random = ~ Age | ID,
  data = cgm_lmm,
  control = list(opt = "optim")
)
summary(lme_fit_sd_rs)
```

### Linear model diagnostics

```{r}
performance::check_model(lme_fit_sd_rs)
```

### Joint model results

```{r}
#| cache: true
# Fit
joint_fit_sd <- jm(
  cox_fit,
  lme_fit_sd_rs,
  time_var = "Age",
  id_var = "ID",
  n_iter = 1e5,
  n_burnin = 1e3,
  control = jm_control
)
```

```{r}
# Results
traceplot(joint_fit_sd)
s <- summary(joint_fit_sd)
kable(s$Outcome1, caption = "Longitudinal Process", digits = 3)
kable(s$Survival, caption = "Event Process", digits = 3)
```

## Mean and SD together

### Joint model results

```{r}
#| cache: true
# Fit
joint_fit_mean_sd <- jm(
  cox_fit,
  list(lme_fit_mean_rs, lme_fit_sd_rs),
  time_var = "Age",
  id_var = "ID",
  n_iter = 1e5,
  n_burnin = 1e3,
  control = jm_control
)
```

```{r}
# Results
traceplot(joint_fit_mean_sd)
s <- summary(joint_fit_mean_sd)
kable(s$Outcome1, caption = "Longitudinal Process 1", digits = 3)
kable(s$Outcome2, caption = "Longitudinal Process 2", digits = 3)
kable(s$Survival, caption = "Event Process", digits = 3)
```

## CV

### Linear model results

```{r}
lme_fit_cv_rs <- lme(
  cv_glucose ~ Age,
  random = ~ Age | ID,
  data = cgm_lmm
)
summary(lme_fit_cv_rs)
```

### Linear model diagnostics

```{r}
performance::check_model(lme_fit_cv_rs)
```

### Joint model results

```{r}
#| cache: true
# Fit
joint_fit_cv <- jm(
  cox_fit,
  lme_fit_cv_rs,
  time_var = "Age",
  id_var = "ID",
  n_iter = 1e5,
  n_burnin = 1e3,
  control = jm_control
)
```

```{r}
# Results
traceplot(joint_fit_cv)
s <- summary(joint_fit_cv)
kable(s$Outcome1, caption = "Longitudinal Process", digits = 3)
kable(s$Survival, caption = "Event Process", digits = 3)
```

## TAR

In order to fit a negative binomial model, percent time over 140 was rounded to the nearest integer.

### Linear model results

```{r}
lme_fit_tar_rs = mixed_model(
  perc_time_over_140 ~ Age,
  random = ~ Age | ID,
  data = cgm_lmm,
  family = "negative.binomial"
)
summary(lme_fit_tar_rs)
```

### Joint model results

```{r}
#| cache: true
# Fit
joint_fit_tar <- jm(
  cox_fit,
  lme_fit_tar_rs,
  time_var = "Age",
  id_var = "ID",
  n_iter = 1e5,
  n_burnin = 1e3,
  control = jm_control
)
```

```{r}
# Results
traceplot(joint_fit_tar)
s <- summary(joint_fit_tar)
kable(s$Outcome1, caption = "Longitudinal Process", digits = 3)
kable(s$Survival, caption = "Event Process", digits = 3)
```

## HbA1c

### Linear model results

```{r}
lme_fit_hba1c_rs <- lme(
  hba1c ~ Age,
  random = ~ Age | ID,
  data = cgm_lmm
)
summary(lme_fit_hba1c_rs)
```

### Linear model diagnostics

```{r}
performance::check_model(lme_fit_hba1c_rs)
```

### Joint model results

```{r}
#| cache: true
# Fit
joint_fit_hba1c <- jm(
  cox_fit,
  lme_fit_hba1c_rs,
  time_var = "Age",
  id_var = "ID",
  n_iter = 1e5,
  n_burnin = 1e3,
  control = jm_control
)
```

```{r}
# Results
traceplot(joint_fit_hba1c)
s <- summary(joint_fit_hba1c)
kable(s$Outcome1, caption = "Longitudinal Process", digits = 3)
kable(s$Survival, caption = "Event Process", digits = 3)
```

# Model comparisons

```{r}
# Create dataset to test on
newdat = full_join(
  cgm_surv,
  cgm_lmm,
  by = join_by(ID, Group, sex, Race_Ethn2, screen_FDR_GP, maxAB_group)
)
# Function for plotting AUC
calculate_aucs = function(jm_object, data = newdat, dt = 1, cls = 4) {
  mi = floor(min(newdat$Age))
  mx = ceiling(max(newdat$Ages))
  aucs = sapply(seq(mi, mx, by = 1), function(y) {
    roc <- tryCatch(
      tvROC(
        jm_object,
        Tstart = y,
        Dt = dt,
        cores = cls,
        newdata = newdat
      ),
      error = function(err) NA
    )
    if (length(roc) > 1) {
      return(tvAUC(roc)$auc)
    } else {
      return(NA)
    }
  })
  return(aucs)
}
```

## Predicting progression within 1 year

### tvROC AUC by years of data

```{r}
#| cache: true
mg = calculate_aucs(joint_fit_mean)
sd = calculate_aucs(joint_fit_sd)
msd = calculate_aucs(joint_fit_mean_sd)
cv = calculate_aucs(joint_fit_cv)
tar = calculate_aucs(joint_fit_tar)
a1c = calculate_aucs(joint_fit_hba1c)
```

```{r}
plot_df = data.frame(list(mg, sd, msd, cv, tar, a1c))
```