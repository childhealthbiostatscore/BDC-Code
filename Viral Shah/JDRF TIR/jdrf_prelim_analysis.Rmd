---
title: "JDRF Prelim Analysis"
author: "Casey Sakamoto"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(knitr)
library(readxl)
library(tidyverse) # data manipulation
library(lubridate)
library(ggplot2)
library(readr)
library(table1)
library(Hmisc)
library(nlme)

knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "S:/Laura/BDC/Projects/Viral Shah/JDRF"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Viral Shah/JDRF"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Viral Shah/JDRF"
}
knitr::opts_knit$set(root.dir = home_dir)

# cleaned data upload
# jdrf_data_clean <- read_csv("/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Viral Shah/JDRF/Data_Cleaned/jdrf_data_clean.csv")
jdrf_data_clean <- read_csv("S:/Laura/BDC/Projects/Viral Shah/JDRF/Data_Cleaned/jdrf_data_clean.csv")
```

```{r functions, include=FALSE}
fit_mod = function(outcome,df){

    # Fit model
  f = as.formula(paste0(outcome,"~","Group","+","visit","+","Age_DateOfEyeExam","+", "DiabetesDuration_DateOfEyeExam" ))
  mod = lme(f,
            random = ~1|MRN,
            data = df,
            na.action = na.omit)
 
  print(summary(mod))
}


# function for pvalue in table1
pvalue <- function(x, ...) {
    # Construct vectors of data y, and groups (strata) g
    y <- unlist(x)
    g <- factor(rep(1:length(x), times=sapply(x, length)))
    if (is.numeric(y)) {
        # For numeric variables, perform a standard 2-sample t-test
        p <- t.test(y ~ g)$p.value
    } else {
        # For categorical variables, perform a chi-squared test of independence
        p <- chisq.test(table(y, g))$p.value
    }
    # Format the p-value, using an HTML entity for the less-than sign.
    # The initial empty string places the output on the line below the variable label.
    c("", sub("<", "&lt;", format.pval(p, digits=3, eps=0.001)))
}

```

```{r ids check, include=FALSE}
# list to check by
# import demographics data
Group_1_Demographic_data = read_excel("S:/Laura/BDC/Projects/Viral Shah/JDRF/Data_Raw/13. JDRF_TIR/3. Data Collection/Cleaned Final Data/Group 1/2. Group 1_Demographic data_2-3-2022.xlsx",
                                      na = "NULL") %>%
  rename(Date = "Vital_VisitDate")
# need to account for na = null
# Group_1_Demographic_data =  read_excel("./Data_Raw/Group 1_Demographic data_2-3-2022.xlsx", 
#     col_types = c("numeric", "numeric", "text", 
#         "text", "text", "text", "date", "date", 
#         "numeric", "text", "text", "text", 
#         "date", "numeric", "numeric", "numeric", 
#         "text", "date", "numeric", "text", 
#         "text", "text", "text", "text", "text", 
#         "text", "text"))

Group_2_Demographic_Data = read_excel("S:/Laura/BDC/Projects/Viral Shah/JDRF/Data_Raw/13. JDRF_TIR/3. Data Collection/Cleaned Final Data/Group 2/2. Group 2_ Demographics_6-13-2022.xlsx",
                                      na = "NULL") %>%
  rename(Date = "Vital_VisitDate")
# add group number variable
Group_1_Demographic_data$Group = "Case"
Group_2_Demographic_Data$Group = "Control"
# note there is a comment variable in group 2 not in group 1
Demographic_data = full_join(Group_1_Demographic_data, Group_2_Demographic_Data)
rm(Group_1_Demographic_data, Group_2_Demographic_Data)


# check that each id is in the demogs
jdrf_data_clean = jdrf_data_clean %>% filter(MRN %in% Demographic_data$MRN)
jdrf_a1c = jdrf_data_clean %>% filter(!is.na(visit_num))

jdrf_a1c = jdrf_a1c %>% group_by(`Study ID`) %>% mutate(visit = ((max(visit_num)+1) - visit_num)) %>% select(-c(visit_num, X))
```

```{r var summarizing, include=FALSE, eval=FALSE} 
# commented out old var names
# here we are averaging subjects across visits, and then comparing these averages between groups
jdrf_data_clean = jdrf_data_clean %>% mutate(a1c = case_when(a1c == "televisit" ~ NA_character_,
                                                             a1c == "-" ~ NA_character_,
                                                             TRUE ~ a1c))
jdrf_data_clean$a1c = as.numeric(jdrf_data_clean$a1c)



cgm_table_df = jdrf_a1c %>% group_by(`Study ID`, Group) %>% summarise(mean_a1c = mean(a1c, na.rm = T),
                                                                             mean_tir = mean(tir, na.rm = T),
                                                                             mean_tbr = mean(tbr, na.rm = T),
                                                                             mean_tar = mean(tar, na.rm = T),
                                                                             mean_ttir = mean(ttir, na.rm = T),
                                                                             mean_glucose = mean(mean_glucose, na.rm = T))
# all of the variables we are interested in here is collected at baseline i believe
# so i will filter out the mrn lab data and only include those with a study id
lab_table_df = jdrf_a1c %>% 
  select(`Study ID`,Group, Age_DateOfEyeExam, Sex, Race_Ethnicity, Htcm, Wtkg, BMI, InsuranceCategory_DateOfEyeExam, DiabetesDuration_DateOfEyeExam, HistoryOfCardiovascularDisease_YesNo,
         Hyperthyroidism_YesNo, GravesDisease_YesNo, AddisonsDisease_YesNo, CeliacDisease_YesNo) %>% 
  group_by(`Study ID`, Group) %>%
  filter(!is.na(`Study ID`)) %>% distinct()

# remove dupe rows
lab_table_df = lab_table_df %>% group_by(`Study ID`) %>% fill(c(Wtkg, Htcm, BMI), .direction = "up") %>% distinct()

# combine the two for table 1
table1_df = full_join(lab_table_df, cgm_table_df) %>% filter(!is.na(Group))
table1_df = table1_df %>% ungroup 

# T1D_lab_table1 =  table1( ~ `duration_of_t1d (years)` + home_regimen + hba1c + ph + bicarbonate + glargine_dose_per_kg 
#                        | diabetes_diagnosis, data = EG_patient_char, topclass="Rtable1-zebra",
#                         render.continuous=c( "Median [IQR]"="Median [Q1, Q3]"), overall=F, extra.col=list(`P-value`=pvalue))

```

```{r var summarizing only those visits with a1c, include=FALSE} 
# commented out old var names
# here we are averaging subjects across visits, and then comparing these averages between groups
jdrf_a1c = jdrf_a1c %>% mutate(a1c = case_when(a1c == "televisit" ~ NA_character_,
                                                             a1c == "-" ~ NA_character_,
                                                             TRUE ~ a1c))
jdrf_a1c$a1c = as.numeric(jdrf_a1c$a1c)

# UACR Variable looks terrible
jdrf_a1c = jdrf_a1c %>% mutate(uacr = case_when(str_detect(uacr, "<") ~ (as.character(as.numeric(str_sub(uacr, 2))/2)),
                                                uacr == "NOTE" ~ NA_character_,
                                                uacr == "CANCELLED" ~ NA_character_,
                                                uacr == "SEE COMMENTS" ~ NA_character_,
                                                uacr == "NOTE" ~ NA_character_,
                                                uacr == "LESS THAN 4.6" ~ "2.3",
                                                uacr == "2E-3" ~ ".002",
                                                TRUE ~ uacr))
jdrf_a1c$uacr = as.numeric(jdrf_a1c$uacr)

cgm_table_df = jdrf_a1c %>% group_by(`Study ID`, Group) %>% summarise(mean_a1c = mean(a1c, na.rm = T),
                                                                      mean_tir = mean(tir, na.rm = T),
                                                                      mean_tbr = mean(tbr, na.rm = T),
                                                                      mean_tar = mean(tar, na.rm = T),
                                                                      mean_ttir = mean(ttir, na.rm = T),
                                                                      mean_glucose = mean(mean_glucose, na.rm = T),
                                                                      mean_egfr = mean(egfr, na.rm = T),
                                                                      mean_ldl = mean(ldl, na.rm = T),
                                                                      mean_hdl = mean(hdl, na.rm = T),
                                                                      mean_tc = mean(tc, na.rm = T),
                                                                      mean_uacr = mean(uacr, na.rm = T))
# all of the variables we are interested in here is collected at basaeline i believe
# so i will filter out the mrn lab data and only include those with a study id
lab_table_df = jdrf_a1c %>% 
  select(`Study ID`,Group, Age_DateOfEyeExam, Sex, Race_Ethnicity, Htcm, Wtkg, BMI, InsuranceCategory_DateOfEyeExam, DiabetesDuration_DateOfEyeExam, HistoryOfCardiovascularDisease_YesNo,
         Hyperthyroidism_YesNo, GravesDisease_YesNo, AddisonsDisease_YesNo, CeliacDisease_YesNo) %>% 
  group_by(`Study ID`, Group) %>%
  filter(!is.na(`Study ID`)) %>% distinct()

# remove dupe rows
lab_table_df = lab_table_df %>% group_by(`Study ID`) %>% fill(c(Wtkg, Htcm, BMI), .direction = "up") %>% distinct()

# combine hypertyroidism, graves, addisons, celiac -> presence of autoimmune diseases
lab_table_df = lab_table_df %>% mutate(autoimmunedisease_presence = case_when(Hyperthyroidism_YesNo == "Yes" | GravesDisease_YesNo == "Yes" |
                                                                                AddisonsDisease_YesNo == "Yes" | CeliacDisease_YesNo == "Yes" ~ "Yes",
                                                                              TRUE ~ "No")) %>% select(-c(Hyperthyroidism_YesNo, GravesDisease_YesNo,
                                                                                                          AddisonsDisease_YesNo, CeliacDisease_YesNo))

# combine the two for table 1
table1_df = full_join(lab_table_df, cgm_table_df) %>% filter(!is.na(Group))
table1_df = table1_df %>% ungroup 

table1_df = table1_df %>% select(-`Study ID`)

jdrf_table1 = table1( ~ .| Group,
                      data = table1_df,
                      topclass ="Rtable1-zebra",
                      render.continuous=c( "Mean (SD)"="Mean (SD)"),overall = FALSE, extra.col=list(`P-value`=pvalue))

# table by visit for a1c and tir
at_table = table1( ~ a1c +  tir | visit+Group,
                      data = jdrf_a1c,
                      topclass ="Rtable1-zebra",
                      render.continuous=c( "Mean (SD)"="Mean (SD)"),overall = FALSE)

# mean a1c and tir by group and visit
a1c_tir_by_visit = jdrf_a1c %>% group_by(visit, Group) %>% summarise(mean_a1c = mean(a1c, na.rm = T),
                                                                     mean_tir = mean(tir, na.rm = T),
                                                                     mean_tar = mean(tar, na.rm = T),
                                                                     mean_tbr = mean(tbr, na.rm = T),
                                                                     mean_ttir = mean(ttir, na.rm = T),
                                                                     mean_mg = mean(mean_glucose, na.rm = T),
                                                                     n_grp = n())
# plots
a1c_visit_p = ggplot(data = a1c_tir_by_visit, aes(x = visit, y = mean_a1c, group = Group, color = Group)) + theme_classic()
tir_visit_p = ggplot(data = a1c_tir_by_visit, aes(x = visit, y = mean_tir, group = Group, color = Group)) + theme_classic()
tar_visit_p = ggplot(data = a1c_tir_by_visit, aes(x = visit, y = mean_tar, group = Group, color = Group)) + theme_classic()
tbr_visit_p = ggplot(data = a1c_tir_by_visit, aes(x = visit, y = mean_tbr, group = Group, color = Group)) + theme_classic()
ttir_visit_p = ggplot(data = a1c_tir_by_visit, aes(x = visit, y = mean_ttir, group = Group, color = Group)) + theme_classic()
mg_visit_p = ggplot(data = a1c_tir_by_visit, aes(x = visit, y = mean_mg, group = Group, color = Group)) + theme_classic()




```

# Outstanding Questions/Remarks

* Subjects 216, 304 have no A1c Data in any of their visits, but some CGM; opting to include them for now

* Included visits with cgm data but no a1c

# Methods

Associations between Retinopathy and CGM groups were assessed via linear mixed models with a random intercept for subjects, adjusting for age and diabetes duration. Plots of the outcomes over visits were produced. 

# Analysis

# Table 1
```{r table1, echo=FALSE}
jdrf_table1
```

# A1c and TIR by visit and group
```{r visitgrp cgm}
Ns = a1c_tir_by_visit %>% select(visit, Group, n_grp)
kable(Ns)

a1c_visit_p + geom_line()
tir_visit_p + geom_line()
```

# a1c
Retinopathy status is associated with A1c (p = 0.01)

plot above
```{r a1c}
fit_mod(outcome = "a1c", df = jdrf_a1c)
```

# tir
Retinopathy status is associated with tir (p = 0.01)

plot above
```{r tir}
fit_mod(outcome = "tir", df = jdrf_a1c)
```

# tar
Retinopathy status is associated with tar (p = 0.005)
```{r tar}
fit_mod(outcome = "tar", df = jdrf_a1c)

tar_visit_p + geom_line()
```

# tbr
Retinopathy status is associated with tbr (p = 0.02)
```{r tbr}
fit_mod(outcome = "tbr", df = jdrf_a1c)

tbr_visit_p + geom_line()
```

# ttir
Retinopathy status is associated with ttir (p = 0.001)
```{r ttir}
fit_mod(outcome = "ttir", df = jdrf_a1c)

ttir_visit_p + geom_line()
```

# mean glucose
Retinopathy status is associated with mean glucose (p = 0.005)
```{r mg}
fit_mod(outcome = "mean_glucose", df = jdrf_a1c)

mg_visit_p + geom_line()
```