---
title: "Shah hip structural analysis"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(stringr)
library(Hmisc)
library(dplyr)
library(skimr)
library(tableone)
library(knitr)
library(tidyverse)
library(rstatix)
library(ggpubr)
library(car)
library(hablar)
library(crayon)
library(emmeans)
knitr::opts_chunk$set(echo = FALSE,warning = FALSE)
home_dir = ifelse(.Platform$OS.type == "unix",
                  "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Viral Shah/R01 bone quality in long standing T1D/Raw data",
                  "T:\\Viral Shah\\R01 bone quality in long standing T1D\\Raw data\\")
knitr::opts_knit$set(root.dir = home_dir)
```

```{r}
# options(scipen=999, digits = 4)
data <- read.csv("./HipHSA with age at dx.csv")
data$T1DStatus <- as.factor(data$T1DStatus)

# drop BMI since there are -1 values, and recalculate
data$BMI <- NULL
data$BMI <- data$Weight / ((data$Height/100)^2)

vars <- c("NN_BMD","NN_CSA","NN_CSMI","NN_WIDTH","NN_ED","NN_ACT","NN_PCD","NN_CMP","NN_SECT_MOD","NN_BR","IT_BMD","IT_CSA","IT_CSMI",
          "IT_WIDTH","IT_ED","IT_ACT","IT_PCD","IT_CMP","IT_SECT_MOD","IT_BR","FS_BMD","FS_CSA","FS_CSMI","FS_WIDTH","FS_ED","FS_ACT",
          "FS_PCD","FS_CMP","FS_SECT_MOD","FS_BR" )
NN_vars <- c("NN_CSA","NN_CSMI","NN_WIDTH","NN_ED","NN_ACT","NN_PCD","NN_CMP","NN_SECT_MOD","NN_BR")
IT_vars <- c("IT_CSA","IT_CSMI","IT_WIDTH","IT_ED","IT_ACT","IT_PCD","IT_CMP","IT_SECT_MOD","IT_BR")
FS_vars <- c("FS_CSA","FS_CSMI","FS_WIDTH","FS_ED","FS_ACT","FS_PCD","FS_CMP","FS_SECT_MOD","FS_BR")

# still need to do the following - for the manuscript
# variables vs. age and test for interaction of sex and T1D

# code menopause as Y/N -1 indicates N
data$menopause <- ifelse(data$Menopause.Year != -1,1,0)
data$menopause <- as.factor(data$menopause)

# data frame with only females
females <- data[data$Sex=="F",]
```

# Background

The purpose of this analysis was to examine differences between T1D and non-T1D participants in hip bone quality variables while controlling for potential confounders.

# Methods

Linear models were used to compare groups while adjusting for age, sex, and BMI.  An additional set of models controlled for BMD (using NN_BMD, IT_BMD, or FS_BMD, depending on the outcome of the model), in addition to age, sex, and BMI.  Finally, interaction terms were added to the fully adjusted models: (1) interaction bdtween menopause status and T1D status, in females only; (2) interaction between age and T1D status, controlling for menopause; (3) interaction between sex and T1D status, in males and females.

# Results

## Models comparing groups, adjusted for age, sex, and BMI

The output from each model can be interpreted as follows: refer to the table labeled "Coefficients."  In the row labeled "T1DStatusY," the p-value is under the column labeled "Pr(>|t|)."

```{r echo=FALSE,comment=''}
# group comparisons adjusted for age, sex, BMI
#for (i in 1:length(vars)) {
#  mod <- lm(data = data,data[,vars[i]]~T1DStatus+Age+as.factor(Sex)+BMI)
#  print(noquote(c("Adjusted model for: ", noquote(vars[i]))))
#  print(summary(mod))
#  means <- emmeans(mod,"T1DStatus")
#  print(means)
  #a <- Anova(mod,type="III")
  #print(a)
#}
```

```{r echo=FALSE,comment=''}
# group comparisons adjusted for age, sex, BMI
for (v in vars) {
  form = as.formula(paste0(v,"~T1DStatus+Age+as.factor(Sex)+BMI"))
  mod <- lm(form,data = data)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  means <- emmeans(mod,"T1DStatus")
  print(means)
  #a <- Anova(mod,type="III")
  #print(a)
}
```

## Models comparing groups, adjusted for age, sex, BMI, and NN BMD - NN variables

The output from each model can be interpreted as follows: refer to the table labeled "Coefficients."  In the row labeled "T1DStatusY," the p-value is under the column labeled "Pr(>|t|)."

```{r echo=FALSE,comment=''}
# group comparisons adjusted for age, sex, BMI
for (v in NN_vars) {
  form = as.formula(paste0(v,"~T1DStatus+Age+as.factor(Sex)+BMI + NN_BMD"))
  mod <- lm(form,data = data)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  means <- emmeans(mod,"T1DStatus")
  print(means)
  #a <- Anova(mod,type="III")
  #print(a)
}
```

## Models comparing groups, adjusted for age, sex, BMI, and FS BMD - FS variables

The output from each model can be interpreted as follows: refer to the table labeled "Coefficients."  In the row labeled "T1DStatusY," the p-value is under the column labeled "Pr(>|t|)."

```{r echo=FALSE,comment=''}
# group comparisons adjusted for age, sex, BMI
for (v in FS_vars) {
  form = as.formula(paste0(v,"~T1DStatus+Age+as.factor(Sex)+BMI + FS_BMD"))
  mod <- lm(form,data = data)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  means <- emmeans(mod,"T1DStatus")
  print(means)
  #a <- Anova(mod,type="III")
  #print(a)
}
```

## Models comparing groups, adjusted for age, sex, BMI, and IT BMD - IT variables

The output from each model can be interpreted as follows: refer to the table labeled "Coefficients."  In the row labeled "T1DStatusY," the p-value is under the column labeled "Pr(>|t|)."

```{r echo=FALSE,comment=''}
# group comparisons adjusted for age, sex, BMI
for (v in IT_vars) {
  form = as.formula(paste0(v,"~T1DStatus+Age+as.factor(Sex)+BMI + IT_BMD"))
  mod <- lm(form,data = data)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  means <- emmeans(mod,"T1DStatus")
  print(means)
  #a <- Anova(mod,type="III")
  #print(a)
}
```

## Models adjusted for age, BMI, menopause and NN BMD - NN variables, with interaction between menopause and T1D status, females only

The output from each model can be interpreted as follows: refer to the table labeled "Coefficients."  In the row labeled "T1DStatusY," the p-value is under the column labeled "Pr(>|t|)."

```{r echo=FALSE,comment=''}
# group comparisons adjusted for age, sex, BMI
for (v in NN_vars) {
  form = as.formula(paste0(v,"~T1DStatus+Age+BMI + NN_BMD + menopause + T1DStatus*menopause" ))
  mod <- lm(form,data = females)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  means <- emmeans(mod,pairwise ~ T1DStatus|menopause)
  print(means)
  p <- emmip(mod, T1DStatus ~ menopause)
  print(p)
   #a <- Anova(mod,type="III")
  #print(a)
}
```

## Models adjusted for age, BMI, menopause and FS BMD - FS variables, with interaction between menopause and T1D status, females only

The output from each model can be interpreted as follows: refer to the table labeled "Coefficients."  In the row labeled "T1DStatusY," the p-value is under the column labeled "Pr(>|t|)."

```{r echo=FALSE,comment=''}
# group comparisons adjusted for age, sex, BMI
for (v in FS_vars) {
  form = as.formula(paste0(v,"~T1DStatus+Age+BMI + FS_BMD + menopause + T1DStatus*menopause" ))
  mod <- lm(form,data = females)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  means <- emmeans(mod,pairwise ~ T1DStatus|menopause)
  print(means)
  p <- emmip(mod, T1DStatus ~ menopause)
  print(p)
   #a <- Anova(mod,type="III")
  #print(a)
}
```

## Models adjusted for age, BMI, menopause and IT BMD - IT variables, with interaction between menopause and T1D status, females only

The output from each model can be interpreted as follows: refer to the table labeled "Coefficients."  In the row labeled "T1DStatusY," the p-value is under the column labeled "Pr(>|t|)."

```{r echo=FALSE,comment=''}
# group comparisons adjusted for age, sex, BMI
for (v in IT_vars) {
  form = as.formula(paste0(v,"~T1DStatus+Age+BMI + IT_BMD + menopause + T1DStatus*menopause" ))
  mod <- lm(form,data = females)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  means <- emmeans(mod,pairwise ~ T1DStatus|menopause)
  print(means)
  p <- emmip(mod, T1DStatus ~ menopause)
  print(p)
   #a <- Anova(mod,type="III")
  #print(a)
}
```

## Models adjusted for age, BMI, menopause and NN BMD - NN variables, with interaction between age and T1D status, females only

The output from each model can be interpreted as follows: refer to the table labeled "Coefficients."  In the row labeled "T1DStatusY," the p-value is under the column labeled "Pr(>|t|)."

```{r echo=FALSE,comment=''}
# group comparisons adjusted for age, sex, BMI
for (v in NN_vars) {
  form = as.formula(paste0(v,"~T1DStatus+Age+BMI + NN_BMD + menopause + Age*menopause" ))
  mod <- lm(form,data = females)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  #means <- emmeans(mod,pairwise ~ T1DStatus|menopause)
  #print(means)
  p <- emmip(mod, menopause ~ Age, cov.reduce=range)
  print(p)
   #a <- Anova(mod,type="III")
  #print(a)
}
```

## Models adjusted for age, BMI, menopause and FS BMD - FS variables, with interaction between age and T1D status, females only

The output from each model can be interpreted as follows: refer to the table labeled "Coefficients."  In the row labeled "T1DStatusY," the p-value is under the column labeled "Pr(>|t|)."

```{r echo=FALSE,comment=''}
# group comparisons adjusted for age, sex, BMI
for (v in FS_vars) {
  form = as.formula(paste0(v,"~T1DStatus+Age+BMI + FS_BMD + menopause + Age*menopause" ))
  mod <- lm(form,data = females)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  #means <- emmeans(mod,pairwise ~ T1DStatus|menopause)
  #print(means)
  p <- emmip(mod, menopause ~ Age, cov.reduce=range)
  print(p)
   #a <- Anova(mod,type="III")
  #print(a)
}
```

## Models adjusted for age, BMI, menopause and IT BMD - IT variables, with interaction between age and T1D status, females only

The output from each model can be interpreted as follows: refer to the table labeled "Coefficients."  In the row labeled "T1DStatusY," the p-value is under the column labeled "Pr(>|t|)."

```{r echo=FALSE,comment=''}
# group comparisons adjusted for age, sex, BMI
for (v in IT_vars) {
  form = as.formula(paste0(v,"~T1DStatus+Age+BMI + IT_BMD + menopause + Age*menopause" ))
  mod <- lm(form,data = females)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  #means <- emmeans(mod,pairwise ~ T1DStatus|menopause)
  #print(means)
  p <- emmip(mod, menopause ~ Age, cov.reduce=range)
  print(p)
   #a <- Anova(mod,type="III")
  #print(a)
}
```

## Models adjusted for age, sex, BMI, and NN BMD - NN variables, with interaction between sex and T1D status

The output from each model can be interpreted as follows: refer to the table labeled "Coefficients."  In the row labeled "T1DStatusY," the p-value is under the column labeled "Pr(>|t|)."

```{r echo=FALSE,comment=''}
# group comparisons adjusted for age, sex, BMI
for (v in NN_vars) {
  form = as.formula(paste0(v,"~T1DStatus+Age+as.factor(Sex)+BMI + NN_BMD + as.factor(Sex)*T1DStatus" ))
  mod <- lm(form,data = data)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  means <- emmeans(mod,pairwise ~ as.factor(Sex)|T1DStatus)
  print(means)
  p <- emmip(mod, T1DStatus ~ as.factor(Sex))
  print(p)
   #a <- Anova(mod,type="III")
  #print(a)
}
```

## Models adjusted for age, sex, BMI, and FS BMD - FS variables, with interaction between sex and T1D status

The output from each model can be interpreted as follows: refer to the table labeled "Coefficients."  In the row labeled "T1DStatusY," the p-value is under the column labeled "Pr(>|t|)."

```{r echo=FALSE,comment=''}
# group comparisons adjusted for age, sex, BMI
for (v in FS_vars) {
  form = as.formula(paste0(v,"~T1DStatus+Age+as.factor(Sex)+BMI + FS_BMD + as.factor(Sex)*T1DStatus" ))
  mod <- lm(form,data = data)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  means <- emmeans(mod,pairwise ~ as.factor(Sex)|T1DStatus)
  print(means)
  p <- emmip(mod, T1DStatus ~ as.factor(Sex))
  print(p)
   #a <- Anova(mod,type="III")
  #print(a)
}
```

## Models adjusted for age, sex, BMI, and IT BMD - IT variables, with interaction between sex and T1D status

The output from each model can be interpreted as follows: refer to the table labeled "Coefficients."  In the row labeled "T1DStatusY," the p-value is under the column labeled "Pr(>|t|)."

```{r echo=FALSE,comment=''}
# group comparisons adjusted for age, sex, BMI
for (v in IT_vars) {
  form = as.formula(paste0(v,"~T1DStatus+Age+as.factor(Sex)+BMI + IT_BMD + as.factor(Sex)*T1DStatus" ))
  mod <- lm(form,data = data)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  means <- emmeans(mod,pairwise ~ as.factor(Sex)|T1DStatus)
  print(means)
  p <- emmip(mod, T1DStatus ~ as.factor(Sex))
  print(p)
   #a <- Anova(mod,type="III")
  #print(a)
}
```