---
title: "Day vs. Night CGM"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: word_document
---

```{r setup, include=FALSE}
library(arsenal)
library(tidyverse)
library(reshape2)
library(ggpubr)
library(pheatmap)
library(patchwork)
library(broom)
library(knitr)
knitr::opts_chunk$set(echo = FALSE,fig.height = 12,fig.width = 12)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "B:/Projects"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
}
knitr::opts_knit$set(root.dir = home_dir)
rm(home_dir)
```

```{r}
# Import
df = read.csv("./Viral Shah/Day and Night CGM/Data_Clean/combined_analysis_data.csv")
# Order
df$a1c_group = factor(df$a1c_group,levels = c("<7%","[7.0%, 8.0%)","[8.0%, 9.0%)",
                                              "[9.0%, 10.0%)",">10%"))
```

# Data Characteristics
- TIR was calculated using 2 weeks of CGM data prior to an office visit.
- For participants with multiple A1C measures, the CGM wear with the largest number of sensor readings was used. This was done to prevent auto-correlation between measures within a subject.
- CGM with < 70% wear were excluded.

# Participant Characteristics

```{r results='asis'}
columns = make.names(c('a1c','Age','Gender', 'BMI', 'DiabetesDuration_MostRecentVisitDate','Hemoglobin_Value','MCV_Value', 'eGFR_Value', 'Autoimmune Disease?', 'Retinopathy?'))

f = as.formula(paste0("~",paste0(columns,collapse = "+")))

t1 = tableby(f,data = df)
summary(t1,pfootnote = T)
```

# Summary Table and Variable Distributions

```{r results='asis'}
columns = make.names(c('mbg','total_tir_70_140','total_tir_70_180','total_tir_over_180',
                       'day_mbg','day_tir_70_140','day_tir_70_180',
                       'day_tir_over_180','night_mbg',"night_tir_70_140",
                       "night_tir_70_180","night_tir_over_180"))

f = as.formula(paste0("~",paste0(columns,collapse = "+")))

t2 = tableby(f,data = df)
summary(t2,pfootnote = T)
```

# Day vs. Night By A1C Group

## TIR 70 - 140 mg/dL

```{r}
plot_df = melt(df,id.vars = c("id","a1c_group"),
               measure.vars = c("day_tir_70_140","night_tir_70_140"),
               value.name = "TIR")
levels(plot_df$a1c_group) = c("<7.0%","7.0-7.9%","8.0-8.9%","9.0-9.9%",">=10.0%")
plot_df$variable = sub("day_tir_.*","Day",plot_df$variable)
plot_df$variable = sub("night_tir_.*","Night",plot_df$variable)
ttir = ggplot(plot_df,aes(x = a1c_group,y = TIR,fill = variable)) + 
  geom_boxplot() + 
  stat_compare_means(aes(group = variable),size = 7,label.y = 101,
                     method = "t.test",paired = T,label = "p.format") + 
  xlab("A1C Group") + ylab("TTIR") +
  theme_bw() + theme(legend.title = element_blank(),
                     panel.grid = element_blank(),
                     text = element_text(size = 25))
ttir
```

## TIR 70 - 180 mg/dL

```{r}
plot_df = melt(df,id.vars = c("id","a1c_group"),
               measure.vars = c("day_tir_70_180","night_tir_70_180"),
               value.name = "TIR")
plot_df$variable = sub("day_tir_.*","Day",plot_df$variable)
plot_df$variable = sub("night_tir_.*","Night",plot_df$variable)
tir = ggplot(plot_df,aes(x = a1c_group,y = TIR,fill = variable)) + 
  geom_boxplot() + 
  stat_compare_means(aes(group = variable),size = 7,label.y = 101,
                     method = "t.test",paired = T,label = "p.format") + 
  xlab("A1C Group") + ylab("TIR") +
  theme_bw() + theme(legend.title = element_blank(),
                     panel.grid = element_blank(),
                     text = element_text(size = 25))
tir
```

## TIR Over 180 mg/dL

```{r}
plot_df = melt(df,id.vars = c("id","a1c_group"),
               measure.vars = c("day_tir_over_180","night_tir_over_180"),
               value.name = "TIR")
plot_df$variable = sub("day_tir_.*","Day",plot_df$variable)
plot_df$variable = sub("night_tir_.*","Night",plot_df$variable)
tar = ggplot(plot_df,aes(x = a1c_group,y = TIR,fill = variable)) + 
  geom_boxplot() + 
  stat_compare_means(aes(group = variable),size = 7,label.y = 101,
                     method = "t.test",paired = T,label = "p.format") + 
  xlab("A1C Group") + ylab("TAR") +
  theme_bw() + theme(legend.title = element_blank(),
                     panel.grid = element_blank(),
                     text = element_text(size = 25))
tar
```

## Mean Sensor Glucose

```{r}
plot_df = melt(df,id.vars = c("id","a1c_group"),
               measure.vars = c("day_mbg","night_mbg"),
               value.name = "MG")
plot_df$variable = sub("day_.*","Day",plot_df$variable)
plot_df$variable = sub("night_.*","Night",plot_df$variable)
msg = ggplot(plot_df,aes(x = a1c_group,y = MG,fill = variable)) + 
  geom_boxplot() + 
  stat_compare_means(aes(group = variable),size = 7,label.y = 360,
                     method = "t.test",paired = T,label = "p.format") + 
  xlab("A1C Group") + ylab("MG") +
  theme_bw() + theme(legend.title = element_blank(),
                     panel.grid = element_blank(),
                     text = element_text(size = 25))
msg
```

# Interaction tests

To test whether there was a difference in the level of association between daytime and nighttime metrics, we used a linear model with interaction term between CGM metric and daytime vs. nighttime.

In the output below, the interaction term (of the form "metric:timenight") indicates the difference in the relationship between A1C and a given CGM metric between daytime and nighttime, with daytime as the reference group. For example, the model for TIR indicates that for every 1 unit increase in daytime TIR, A1C decreases by 0.059 on average. The "tir_70_140:timenight" coefficient shows that for each one unit increase in nighttime TIR, A1C changes by an additional 0.015, so it decreases by 0.044 on average (-0.059 + 0.015 = -0.044).

```{r}
corr_vars = c('a1c','mbg','total_tir_70_140','total_tir_70_180','total_tir_over_180',
              'day_mbg','day_tir_70_140','day_tir_70_180','day_tir_over_180',
              'night_mbg',"night_tir_70_140","night_tir_70_180","night_tir_over_180")
int_df = df %>% select(all_of(corr_vars)) %>% select(-contains("total_"),-mbg) %>% 
  pivot_longer(day_mbg:night_tir_over_180,names_to = c("time",".value"),
               names_pattern = "^(day|night)_(.*)$")

```

## TIR 70 - 140 mg/dL

```{r}
# Model
mod = lm(a1c ~ tir_70_140*time, data = int_df)
# Plot
plot_df = mod$model
plot_df$pred = predict(mod)
ggplot(plot_df,aes(x = tir_70_140,y = pred,color = time)) + 
  geom_line() + theme_bw() + xlab("TTIR (%)") + ylab("A1C (%)") +
  scale_color_discrete(name = "", labels = c("Day","Night"))
# Table
kable(tidy(mod),digits = 3)
```

## TIR 70 - 180 mg/dL

```{r}
# Model
mod = lm(a1c ~ tir_70_180*time, data = int_df)
# Plot
plot_df = mod$model
plot_df$pred = predict(mod)
ggplot(plot_df,aes(x = tir_70_180,y = pred,color = time)) + 
  geom_line() + theme_bw() + xlab("TIR (%)") + ylab("A1C (%)") +
  scale_color_discrete(name = "", labels = c("Day","Night"))
# Table
kable(tidy(mod),digits = 3)
```

## TIR Over 180 mg/dL

```{r}
# Model
mod = lm(a1c ~ tir_over_180*time, data = int_df)
# Plot
plot_df = mod$model
plot_df$pred = predict(mod)
ggplot(plot_df,aes(x = tir_over_180,y = pred,color = time)) + 
  geom_line() + theme_bw() + xlab("TAR (%)") + ylab("A1C (%)") +
  scale_color_discrete(name = "", labels = c("Day","Night"))
# Table
kable(tidy(mod),digits = 3)
```

## Mean Sensor Glucose

```{r}
# Model
mod = lm(a1c ~ mbg*time, data = int_df)
# Plot
plot_df = mod$model
plot_df$pred = predict(mod)
ggplot(plot_df,aes(x = mbg,y = pred,color = time)) + 
  geom_line() + theme_bw() + xlab("MG (mg/dL)") + ylab("A1C (%)") +
  scale_color_discrete(name = "", labels = c("Day","Night"))
# Table
kable(tidy(mod),digits = 3)
```
