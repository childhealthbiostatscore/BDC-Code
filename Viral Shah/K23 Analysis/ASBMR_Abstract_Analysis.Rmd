---
title: "ASBMR Abstract"
author: "Casey Sakamoto"
date: "4/27/2022"
output: html_document
---

```{r setup, include=FALSE}
library(readr)
library(tidyverse)
library(Hmisc)
library(stringr)

knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "S:/Laura/BDC/Projects/Viral Shah/K23"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Viral Shah/K23"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Viral Shah/K23"
}
knitr::opts_knit$set(root.dir = home_dir)

setwd("S:/Laura/BDC/Projects/Viral Shah/K23")
rm(home_dir)
```

```{r data import and clean, include=FALSE}
# import data
BSTM_t1d <- read_csv("BSTM_t1d.csv")

# only interested in patients with t1d
# want fingerstick glucose, 14 day cgm metrics, a1c, p1np and ctx
analysis = BSTM_t1d %>% filter(`2. Clinical Diagnosis of T1D` == "Yes") %>% 
  select(`Record ID`, `Finger Stick Blood Glucose mg/dl`, `HbA1C value:`, `P1NP Baseline ng/ml`, `CTX Baseline ng/ml`)

# fingerstick bg to numeric and fix "not done" to NA
analysis[ analysis == "not done" ] <- NA
analysis = analysis %>% mutate(fsbg = as.numeric(`Finger Stick Blood Glucose mg/dl`)) %>% select(- `Finger Stick Blood Glucose mg/dl`)

# some hba1c are listed with a % sign (LITERALLY WHY); need to remove that
analysis = analysis %>% mutate(hba1c = 
                                 case_when("%" %in% `HbA1C value:` ~ as.numeric(str_sub(`HbA1C value:`, 1,str_length(`HbA1C value:`)-1)),
                                           TRUE ~ as.numeric(`HbA1C value:`))) %>% select(-`HbA1C value:`)

# need to fix ctx with the truncated values by dividing by 2

analysis$


# function to output scatter, corr and linear mod; need to add in ctx later lol
fit_mod = function(outcome,df,plot = T,diagnostics = F){
  

  # Fit p1np model
  f = as.formula(paste0("`P1NP Baseline ng/ml`~",outcome))
  mod = lm(f,
            data = df,
            na.action = na.omit)
  print(summary(mod))
     # corr
  cat("\n")
  cat(paste("P1NP Pearson Corr Coef = ",sqrt(summary(mod)$r.squared)))
  cat("\n")
   # Number of obs
  cat("\n")
  cat(paste("This model was fit using",nobs(mod),"observations."))
  cat("\n")
 
  # Plot
  if(plot){
    p = 
      ggplot(data = df,aes_string(x = outcome, y = "`P1NP Baseline ng/ml`")) + 
      geom_point() + #geom_line() + 
      theme_bw() 
    print(p)
  }
 
   # Check model
  if(diagnostics){
    print(check_model(mod))
  }
}

```

# Outstanding Data Questions/ Remarks
Remarks as of 4/27/2022
* of 60 subjects in the set, 31 have a t1d diagnosis
* Waiting on clean CGM data as of 4/27/2022
* truncated values of ctx (some data listed as "<0.076") were inputted as 0.5 * truncated value

# Methods

Simple linear models  were fit with Fingerstick Glucose, 14 Days CGM metrics, and A1C respectively to assess the linear relationship with with P1NP and CTX

# Analysis
Correlation between Fingerstick glucose (available under clinic visit records) with P1NP and CTX- only in patients with type 1 diabetes  

Correlation between 14-days CGM metrics (under NIH K23 folder) with P1NP and CTX- only in patients with type 1 diabetes  
 
Correlation between A1c with P1NP and CTX - only in patients with type 1 diabetes  
 
```{r hba1c}
fit_mod(outcome = "hba1c", df = analysis)

```
