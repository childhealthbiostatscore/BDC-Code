---
title: "Control IQ 12 Month Analysis"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(arsenal)
library(tidyverse)
library(knitr)
knitr::opts_chunk$set(echo = FALSE)
home_dir = 
  ifelse(.Platform$OS.type != "unix",
         "Z:/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Cari Berget/Control IQ 12 Month MS",
         "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Cari Berget/Control IQ 12 Month MS")
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data,include=FALSE}
# Import
source("C:/Users/timvigers/Documents/GitHub/BDC-Code/Cari Berget/Control IQ 12 month analysis/clean_data.R")
# Survey scoring function
source("C:/Users/timvigers/Documents/GitHub/BDC-Code/Cari Berget/Scoring/scoring_function.R")
# Format date columns
data$date = coalesce(as.character(data$date),as.character(data$date_visit))
date_cols = c("date","demographics_diabetesdx","demographics_dob")
data[,date_cols] = lapply(data[,date_cols],lubridate::ymd)
# Fill down by participant
data = data %>% group_by(record_id) %>% 
  fill(demographics_diabetesdx,demographics_dob)
# Calculate age, etc.
data = data %>% 
  mutate(age = as.numeric(difftime(date,demographics_dob,units = "days"))/365.25)
data$age[data$age == 0] = NA
# Score surveys
data = score_for_cari(data)
# Select relevant columns
t = data %>% filter(!is.na(gyl_timepoint.factor)) %>%
  select(record_id,gyl_timepoint.factor,age,hba1c,sensor_70_180,sensor_wear)
```
