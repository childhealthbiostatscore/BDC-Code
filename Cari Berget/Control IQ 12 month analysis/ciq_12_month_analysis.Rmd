---
title: "Control IQ 12 Month Analysis"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
bibliography: "C:/Users/timvigers/Dropbox/Miscellaneous/references.bib"
csl: "C:/Users/timvigers/Dropbox/Miscellaneous/multidisciplinary-digital-publishing-institute.csl"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(arsenal)
library(lmerTest)
library(censReg)
library(plm)
library(performance)
library(broom.mixed)
library(emmeans)
library(tidyverse)
library(knitr)
home_dir = 
  ifelse(.Platform$OS.type != "unix",
         "B:/Projects/Cari Berget/Control IQ 12 Month MS",
         "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Cari Berget/Control IQ 12 Month MS")
knitr::opts_knit$set(root.dir = home_dir)
knitr::opts_chunk$set(echo = FALSE,results='asis',fig.width=12,fig.height=10)
```

```{r data,include=FALSE}
# Import
source("C:/Users/timvigers/Documents/GitHub/BDC-Code/Cari Berget/Control IQ 12 month analysis/import_peds_data.r")
source("C:/Users/timvigers/Documents/GitHub/BDC-Code/Cari Berget/Control IQ 12 month analysis/import_parent_data.r")
# Survey scoring function
source("C:/Users/timvigers/Documents/GitHub/BDC-Code/Cari Berget/Scoring/scoring_function.R")
# Format date columns
date_cols = c("date","date_visit","demographics_diabetesdx","demographics_dob")
data[,date_cols] = lapply(data[,date_cols],lubridate::ymd)
# Fill down by participant, baseline HbA1c group
data = data %>% group_by(record_id) %>% 
  fill(demographics_diabetesdx,demographics_dob,demographics_sex.factor,demographics_age)
# Calculate variables
data = data %>% filter(!is.na(gyl_timepoint.factor),record_id >= 119) %>%
  mutate(age = as.numeric(difftime(date,demographics_dob,units = "days"))/365.25,
         sensor_over_180 = sensor_181_250 + sensor_g250,
         sensor_under_70 = sensor_54_69 + sensor_u54) %>%
  group_by(record_id) %>%
  mutate(hba1c_group = cut(hba1c[row_number() == 1],c(-Inf,7,9,Inf),
                           labels = c("<7%","7-9%",">=9%"),right = F),
         age_group = cut(demographics_age[row_number() == 1],c(-Inf,14,18,Inf),
                         labels = c("<14","14-17",">=18"),right = F))
# Score surveys
data = peds_scores(data)
parent_data = parent_scores(parent_data)
# Parent surveys to long
parent_data = parent_data %>% select(record_id,p_paid_b:p_tech_b) %>%
  pivot_longer(p_paid_b:p_tech_b,
               names_to = c("survey","gyl_timepoint.factor"),
               names_pattern = "p_(.*)_(.*)") %>%
  pivot_wider(names_from = "survey",names_prefix = "p_")
parent_data$gyl_timepoint.factor =
  factor(parent_data$gyl_timepoint.factor,
         levels = c("b","m1","t1","t2","t3","t4"),
         labels = c("Baseline","Month 1/ Training F/U","3 Months",
                    "6 Months","9 Months","12 Months"))
# Dicontinuers
discontinuers = unique(data$record_id[data$time_am < 10])
discontinuers = discontinuers[!is.na(discontinuers)]
# Numeric time
data$numeric_time = data$gyl_timepoint.factor
levels(data$numeric_time) = c(0,1,3,6,9,12)
data$numeric_time = as.numeric(as.character(data$numeric_time))
# Select relevant columns, exclude discontinuers
data = data %>% 
  filter(!record_id %in% discontinuers,!grepl("arm_3",redcap_event_name)) %>%
  select(record_id,gyl_timepoint.factor,numeric_time,age_group,hba1c_group,hba1c,
         demographics_sex.factor,time_am,sensor_wear,tdd,tdd_bolus,tdd_basal,
         dailymealbolus,sleep,exercise,sensor_mean,sensor_70_180,
         sensor_over_180,sensor_g250,sensor_under_70,sensor_u54,
         all_of(peds_surveys))
# Add parent scores
data$record_id = as.character(data$record_id)
parent_data$record_id = as.character(parent_data$record_id)
data = left_join(data,parent_data,by = c("record_id", "gyl_timepoint.factor"))
# Write cleaned CSV
write.csv(data,file = "./Data_Cleaned/ciq_analysis_dataset.csv",row.names = F,na = "")
# Clean workspace
rm(list = ls()[-which(ls() %in% c("data","discontinuers"))])
```

# Table 1: Participant Characteristics at Baseline

A total of `r length(discontinuers)` participants were excluded due to HCL use <10% at 1 or more visits. 

```{r table 1}
t1 = tableby(~age_group + hba1c + hba1c_group + demographics_sex.factor + 
               sensor_wear + tdd + tdd_bolus + tdd_basal + dailymealbolus + 
               sensor_mean + sensor_70_180 + sensor_over_180 + 
               sensor_g250 + sensor_under_70 + sensor_u54 + c_paid + c_hfs_maintain + 
               c_hfs_helpless + c_hfs_worry + c_inspire + ya_paid + ya_hfs_behave + 
               ya_hfs_worry + adult_inspire + c_tech + p_paid + p_hfs_maintain + 
               p_hfs_helpless + p_hfs_worry + p_inspire + p_tech,
             data = data[data$gyl_timepoint.factor == "Baseline",])
summary(t1,labelTranslations = 
          list(age_group = "Age Group",hba1c_group = "HbA1c Group",
               demographics_sex.factor = "Sex"))
```

# Methods

## Model selection

Time was treated as numeric because timepoints are not evenly spaced, and the interpretation of interactions between a large number of categories is difficult. The final model structure was selected using mean sensor glucose as the outcome, and the same model structure was used for all following models for consistency. Although better by AIC, some random slope models did not converge, so a random intercept for participant was used in all models to account for within-subject autocorrelation.

All analyses were performed using R version `r paste0(R.version$major,".",R.version$minor)` [@rcoreteamLanguageEnvironmentStatistical2021]. Linear mixed models were fit using the `lme4` [@batesFittingLinearMixedEffects2014] package and all model assumptions were assessed visually using the `performance` package [@ludeckePerformancePackageAssessment2021]. 

```{r model selection,include=FALSE}
# Remove outlier values
mod_data = data %>% filter(sensor_mean <= 400)
# Use numeric time since the M1 visit is not equally spaced. Also, interpreting the 
# interactions between categorical time and categorical HbA1c group is a nightmare.
ri_mod = lmer(sensor_mean ~ numeric_time*hba1c_group + (1|record_id),data = mod_data)
ri_rs_mod = lmer(sensor_mean ~ numeric_time*hba1c_group + (numeric_time|record_id),
                 data = mod_data)
```

# Results

```{r model function}
fit_mod = function(df = mod_data,outcome,group = NULL,y_axis = NULL,
                   fam = "gaussian",diagnostics = T){
  f = as.formula(paste0(outcome,"~","numeric_time*",group,"+(1|record_id)"))
  if(fam == "gaussian"){
    mod = lmer(f,data = df)
  } else if (fam == "binomial"){
    mod = glmer(f,data = df,family = fam)
  }
  # Print diagnostics if necessary
  if(diagnostics){
    mod_check = check_model(mod)
    print(mod_check)
  }
  # Trend over time for groups
  t = as.formula(paste0(group," ~ numeric_time"))
  trends = emmip(mod,t,cov.reduce = range)+
    ggtitle("Estimated Change Over Time") + 
    xlab("Months From Baseline") + theme_bw() + 
    scale_x_continuous(breaks = c(0,1,3,6,9,12))
  if(!is.null(y_axis)){
    trends = trends + ylim(y_axis)
  }
  if(!is.null(group)){
    if(group == "hba1c_group"){
      trends = trends + labs(color='HbA1c Group') 
    }
    if(group == "age_group"){
      trends = trends + labs(color='Age Group') 
    }
  }
  print(trends)
  # Print table - tidy up results a bit first
  expon = (fam != "gaussian")
  coeffs = tidy(mod,"fixed",exponentiate = expon) %>% select(term:p.value)
  coeffs$term = sub("numeric_time","Months",coeffs$term)
  coeffs$term = sub("hba1c_group","HbA1c group ",coeffs$term)
  coeffs$term = sub("age_group","Age group ",coeffs$term)
  print(kable(coeffs,digits = 3,caption = "Model Results"))
  if(!is.null(group) & fam != "zi"){
    coeffs = car::Anova(mod,type = 3)
    rownames(coeffs) = sub("numeric_time","Months",rownames(coeffs))
    rownames(coeffs) = sub("hba1c_group","HbA1c group ",rownames(coeffs))
    rownames(coeffs) = sub("age_group","Age group ",rownames(coeffs))
    print(kable(coeffs,digits = 3,caption = "Type 3 Tests of Fixed Effect"))
  }
}
```

Type 3 tests of fixed effect indicate the overall effect for a categorical variable, and in the coefficient tables ":" indicates an interaction term. So, for example, a significant p value in the "Months:HbA1c group" row of the type 3 table indicates an overall significant interaction between time and HbA1c group. 

## HbA1c

### Full cohort

```{r}
fit_mod(outcome = "hba1c")
```

### By HbA1c group

```{r}
fit_mod(outcome = "hba1c",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "hba1c",group = "age_group")
```

## Sensor mean

### Full cohort

```{r}
fit_mod(outcome = "sensor_mean")
```

### By HbA1c group

```{r}
fit_mod(outcome = "sensor_mean",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "sensor_mean",group = "age_group")
```

## TIR 70 - 180 mg/dL

### Full cohort

```{r}
fit_mod(outcome = "sensor_70_180")
```

### By HbA1c group

```{r}
fit_mod(outcome = "sensor_70_180",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "sensor_70_180",group = "age_group")
```

## TIR Over 180 mg/dL

### Full cohort

```{r}
fit_mod(outcome = "sensor_over_180")
```

### By HbA1c group

```{r}
fit_mod(outcome = "sensor_over_180",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "sensor_over_180",group = "age_group")
```

## TIR Over 250 mg/dL

This outcome was heavily right skewed. Because there are lots of 0 values, we cannot log transform it, so instead we used a Tobit model with random intercept for participant to account for the zero-inflation. The continuous part of the data was also skewed, so this was log-transformed. Model coefficients are reported on the log scale. Column "Pr…t." contains the model p values.

```{r}
# Log transform the continuous part
mod_data$sensor_g250_trans = ifelse(mod_data$sensor_g250 == 0,0,
                                    log(mod_data$sensor_g250))
# Format for censReg
cens = mod_data %>% arrange(record_id,numeric_time) %>%
  select(record_id,numeric_time,hba1c_group,age_group,sensor_g250_trans)
cens = pdata.frame(cens,index = c("record_id","numeric_time"),stringsAsFactors = F)
cens$numeric_time = as.numeric(as.character(cens$numeric_time))
```

### Full cohort

```{r}
panelResult <- censReg(sensor_g250_trans ~ numeric_time, data = cens,nGHQ = 64)
s = summary(panelResult)$estimate
s = data.frame(s[1:(nrow(s)-2),])
kable(s,digits = 3)
```

### By HbA1c group

```{r}
panelResult <- censReg(sensor_g250_trans ~ numeric_time*hba1c_group,data = cens,nGHQ = 64)
s = summary(panelResult)$estimate
s = data.frame(s[1:(nrow(s)-2),])
kable(s,digits = 3)
```

### By age group

```{r}
panelResult <- censReg(sensor_g250_trans ~ numeric_time*age_group,data = cens,nGHQ = 64)
s = summary(panelResult)$estimate
s = data.frame(s[1:(nrow(s)-2),])
kable(s,digits = 3)
```

## TIR Under 70 mg/dL

This outcome was heavily right skewed. Because there are lots of 0 values, we cannot log transform it, so instead we used a Tobit model with random intercept for participant to account for the zero-inflation. The continuous part of the data was also skewed, so this was log-transformed. Model coefficients are reported on the log scale. Column "Pr…t." contains the model p values.

```{r}
# Log transform the continuous part
mod_data$sensor_under_70_trans = round(mod_data$sensor_under_70)
mod_data$sensor_under_70_trans = ifelse(mod_data$sensor_under_70_trans == 0,0,
                                    log(mod_data$sensor_under_70_trans))
# Format for censReg
cens = mod_data %>% arrange(record_id,numeric_time) %>%
  select(record_id,numeric_time,hba1c_group,age_group,sensor_under_70_trans)
cens = pdata.frame(cens,index = c("record_id","numeric_time"),stringsAsFactors = F)
cens$numeric_time = as.numeric(as.character(cens$numeric_time))
```

### Full cohort

```{r}
panelResult <- censReg(sensor_under_70_trans ~ numeric_time,data = cens,nGHQ = 64)
s = summary(panelResult)$estimate
s = data.frame(s[1:(nrow(s)-2),])
kable(s,digits = 3)
```

### By HbA1c group

```{r}
panelResult <- censReg(sensor_under_70_trans ~ numeric_time*hba1c_group,data = cens,nGHQ = 64)
s = summary(panelResult)$estimate
s = data.frame(s[1:(nrow(s)-2),])
kable(s,digits = 3)
```

### By age group

```{r}
panelResult <- censReg(sensor_under_70_trans ~ numeric_time*age_group,data = cens,nGHQ = 64)
s = summary(panelResult)$estimate
s = data.frame(s[1:(nrow(s)-2),])
kable(s,digits = 3)
```

## TIR Under 54 mg/dL

There was not enough variability in this outcome and the models would not converge (702 out of 1001 observations were 0 and 226 were 1). 

## % Time in HCL

Because this outcome was heavily left skewed with lots of values >= 90%, we dichotomized it. There were only 77 observations (out of 842) with time in AM < 70%, so 90% was used as a cutoff instead (287 < 90% vs. 555 >= 90%). Results are interpreted on the odds scale. 

```{r}
mod_data$time_am_90 = cut(mod_data$time_am,c(-Inf,90,Inf),right = F,
                          labels = c("< 90%",">= 90%"))
hist(mod_data$time_am)
```

### Full cohort

```{r}
fit_mod(outcome = "time_am_90",fam = "binomial",diagnostics = F)
```

### By HbA1c group

```{r}
fit_mod(outcome = "time_am_90",group = "hba1c_group",fam = "binomial",diagnostics = F)
```

### By age group

```{r}
fit_mod(outcome = "time_am_90",group = "age_group",fam = "binomial",diagnostics = F)
```

## % Sensor wear

Like time in HCL, this outcome was heavily left skewed with lots of values >= 90%, so we dichotomized it with 90% used as a cutoff. Results are interpreted on the odds scale. 

```{r}
mod_data$sensor_wear_90 = cut(mod_data$sensor_wear,c(-Inf,90,Inf),right = F,
                          labels = c("< 90%",">= 90%"))
hist(mod_data$sensor_wear)
```

### Full cohort

```{r}
fit_mod(outcome = "sensor_wear_90",fam = "binomial",diagnostics = F)
```

### By HbA1c group

```{r}
fit_mod(outcome = "sensor_wear_90",group = "hba1c_group",fam = "binomial",diagnostics = F)
```

### By age group

```{r}
fit_mod(outcome = "sensor_wear_90",group = "age_group",fam = "binomial",diagnostics = F)
```

## TDD

Participant 266 had a TDD of 789.70 at 9 Months, which was excluded for these models. This outcome was log transformed to improve model fit, and coefficients are reported on the log scale.

```{r}
mod_data$tdd[mod_data$tdd >= 700] = NA
mod_data$tdd_log = log(mod_data$tdd)
```

### Full cohort

```{r}
fit_mod(outcome = "tdd_log")
```

### By HbA1c group

```{r}
fit_mod(outcome = "tdd",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "tdd",group = "age_group")
```

## % TDD as basal

### Full cohort

```{r}
fit_mod(outcome = "tdd_basal")
```

### By HbA1c group

```{r}
fit_mod(outcome = "tdd_basal",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "tdd_basal",group = "age_group")
```

## % TDD as bolus

### Full cohort

```{r}
fit_mod(outcome = "tdd_bolus")
```

### By HbA1c group

```{r}
fit_mod(outcome = "tdd_bolus",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "tdd_bolus",group = "age_group")
```

## Daily meal bolus

### Full cohort

```{r}
fit_mod(outcome = "dailymealbolus")
```

### By HbA1c group

```{r}
fit_mod(outcome = "dailymealbolus",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "dailymealbolus",group = "age_group")
```

## Sleep activity

We used a Tobit model with random intercept for participant to account for the zero-inflation in this outcome. The continuous part of the data was relatively normal, so this time it was *not* log-transformed. Column "Pr…t." contains the model p values.

```{r}
# Format for censReg
cens = mod_data %>% arrange(record_id,numeric_time) %>%
  select(record_id,numeric_time,hba1c_group,age_group,sleep)
cens = pdata.frame(cens,index = c("record_id","numeric_time"),stringsAsFactors = F)
cens$numeric_time = as.numeric(as.character(cens$numeric_time))
```

### Full cohort

```{r}
panelResult <- censReg(sleep ~ numeric_time,data = cens,nGHQ = 64)
s = summary(panelResult)$estimate
s = data.frame(s[1:(nrow(s)-2),])
kable(s,digits = 3)
```

### By HbA1c group

```{r}
panelResult <- censReg(sleep ~ numeric_time*hba1c_group,data = cens,nGHQ = 64)
s = summary(panelResult)$estimate
s = data.frame(s[1:(nrow(s)-2),])
kable(s,digits = 3)
```

### By age group

```{r}
panelResult <- censReg(sleep ~ numeric_time*age_group,data = cens,nGHQ = 64)
s = summary(panelResult)$estimate
s = data.frame(s[1:(nrow(s)-2),])
kable(s,digits = 3)
```

## Exercise

This outcome was heavily right skewed. Because there are lots of 0 values, we cannot log transform it, so instead we used a Tobit model with random intercept for participant to account for the zero-inflation. The continuous part of the data was also skewed, so this was log-transformed. Model coefficients are reported on the log scale. Column "Pr…t." contains the model p values.

```{r}
# Log transform the continuous part
mod_data$exercise_trans = ifelse(mod_data$exercise == 0,0,
                                    log(mod_data$exercise))
# Format for censReg
cens = mod_data %>% arrange(record_id,numeric_time) %>%
  select(record_id,numeric_time,hba1c_group,age_group,exercise_trans)
cens = pdata.frame(cens,index = c("record_id","numeric_time"),stringsAsFactors = F)
cens$numeric_time = as.numeric(as.character(cens$numeric_time))
```

### Full cohort

```{r}
panelResult <- censReg(exercise_trans ~ numeric_time, data = cens,nGHQ = 64)
s = summary(panelResult)$estimate
s = data.frame(s[1:(nrow(s)-2),])
kable(s,digits = 3)
```

### By HbA1c group

```{r}
panelResult <- censReg(exercise_trans ~ numeric_time*hba1c_group,data = cens,nGHQ = 64)
s = summary(panelResult)$estimate
s = data.frame(s[1:(nrow(s)-2),])
kable(s,digits = 3)
```

### By age group

```{r}
panelResult <- censReg(exercise_trans ~ numeric_time*age_group,data = cens,nGHQ = 64)
s = summary(panelResult)$estimate
s = data.frame(s[1:(nrow(s)-2),])
kable(s,digits = 3)
```

## PAID Peds

### Full cohort

```{r}
fit_mod(outcome = "c_paid")
```

### By HbA1c group

```{r}
fit_mod(outcome = "c_paid",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "c_paid",group = "age_group")
```

## PAID Parents

### Full cohort

```{r}
fit_mod(outcome = "p_paid")
```

### By HbA1c group

```{r}
fit_mod(outcome = "p_paid",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "p_paid",group = "age_group")
```

## INSPIRE Peds

### Full cohort

```{r}
fit_mod(outcome = "c_inspire")
```

### By HbA1c group

```{r}
fit_mod(outcome = "c_inspire",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "c_inspire",group = "age_group")
```

## INSPIRE Parents

### Full cohort

```{r}
fit_mod(outcome = "p_inspire")
```

### By HbA1c group

```{r}
fit_mod(outcome = "p_inspire",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "p_inspire",group = "age_group")
```

## HFS Helpless Peds

### Full cohort

```{r}
fit_mod(outcome = "c_hfs_helpless")
```

### By HbA1c group

```{r}
fit_mod(outcome = "c_hfs_helpless",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "c_hfs_helpless",group = "age_group")
```

## HFS Helpless Parents

### Full cohort

```{r}
fit_mod(outcome = "p_hfs_helpless")
```

### By HbA1c group

```{r}
fit_mod(outcome = "p_hfs_helpless",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "p_hfs_helpless",group = "age_group")
```

## HFS Maintain Peds

### Full cohort

```{r}
fit_mod(outcome = "c_hfs_maintain")
```

### By HbA1c group

```{r}
fit_mod(outcome = "c_hfs_maintain",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "c_hfs_maintain",group = "age_group")
```

## HFS Maintain Parents

### Full cohort

```{r}
fit_mod(outcome = "p_hfs_maintain")
```

### By HbA1c group

```{r}
fit_mod(outcome = "p_hfs_maintain",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "p_hfs_maintain",group = "age_group")
```

## HFS Worry Peds

### Full cohort

```{r}
fit_mod(outcome = "c_hfs_worry")
```

### By HbA1c group

```{r}
fit_mod(outcome = "c_hfs_worry",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "c_hfs_worry",group = "age_group")
```

## HFS Worry Parents

### Full cohort

```{r}
fit_mod(outcome = "p_hfs_worry")
```

### By HbA1c group

```{r}
fit_mod(outcome = "p_hfs_worry",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "p_hfs_worry",group = "age_group")
```

## Diabetes Technology Peds

### Full cohort

```{r}
fit_mod(outcome = "c_tech")
```

### By HbA1c group

```{r}
fit_mod(outcome = "c_tech",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "c_tech",group = "age_group")
```

## Diabetes Technology Parents

### Full cohort

```{r}
fit_mod(outcome = "p_tech")
```

### By HbA1c group

```{r}
fit_mod(outcome = "p_tech",group = "hba1c_group")
```

### By age group

```{r}
fit_mod(outcome = "p_tech",group = "age_group")
```

# Questions

1. Many of the TIR models still don't look ideal, and the interpretation is a little tricky because of the various transformations and fancy models. Would it be better to dichotomize and use a logistic model?

2. Is the 90% cutoff for time in HCL useful? I am concerned about the numbers when using 70%.

# References
