---
title: "A1C by Tech Trends 2016 vs 2020"
author: "Casey Sakamoto"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(tidyverse)
library(knitr)
library(readxl)
library(lubridate)
library(table1)
library(nlme) # mixed models
library(emmeans)
library(ggrepel)

# import data
patientlevel <- read_excel("S:/Laura/BDC/Projects/Todd Alonso/AID tech and A1c/Data/AID A1c all master.xlsx", 
    sheet = "PatientLevel")
visitlevel <- read_excel("S:/Laura/BDC/Projects/Todd Alonso/AID tech and A1c/Data/AID A1c all master.xlsx", 
    sheet = "VisitLevel")
```

```{r dataclean}
# insurance category: remove NULL
# levels(factor(patientlevel$InsuranceCategory_IndexVisitDate))
patientlevel = patientlevel %>% filter(InsuranceCategory_IndexVisitDate != "NULL")
patientlevel = patientlevel %>% mutate(insurance_category = InsuranceCategory_IndexVisitDate)
label(patientlevel$insurance_category) = "Insurance Category"
# code the demog changes
# ethnic/race: NHW NHB H Other
patientlevel = patientlevel %>% mutate(race_ethn = case_when(Race_Ethnicity == "Hispanic" ~ "H",
                                                     Race_Ethnicity == "Non-Hispanic White" ~ "NH White",
                                                     Race_Ethnicity == "Non-Hispanic Black" ~ "NH Black",
                                                     TRUE ~ "Other"))
label(patientlevel$race_ethn) = "Race/Ethnicity"

# remove pregnant = Y visits
visitlevel = visitlevel %>% filter(`Pregnant?` == "N")

length(unique(patientlevel$MRN))
length(unique(visitlevel$MRN))

analysis = left_join( visitlevel,patientlevel)
rm(patientlevel, visitlevel)

# 617 unique ids in patient level, 602 in visit level
#length(intersect(visitlevel$MRN, patientlevel$MRN)) 597


# table 1 includes: diabetes duration at time of aid initiation (days = 0), age at day = 0, prior insulin use (non aid pump or mdi, sysyem switched to, race/ethn, insurance cat)
baseline = analysis %>% filter(DaysFromIndexVisitDate == 0)


```
719995,1320386,1994606,1756877,1255626,1410180 Null insurance removed



# Background/Objectives

Specific Questions/Hypotheses:

1.	Patients that are initiated on AID will have sustained improvements in A1c, regardless of whether they had previously been on MDI or non-automated insulin pump systems

2.	Is there a larger impact on A1c when switching from MDI to automated system

3.	Is there a larger impact on A1c with higher baseline A1c levels


# Outstanding Data Questions/ Remarks

- MRN 719995,1320386,1994606,1756877,1255626,1410180 removed: Null insurance 
- 117 pregnant = Y visits removed

- 617 unique subject mrn at the patientlevel and 602 unique subject mrn at visit level; the intersection of these subjects was n = 597; as of now ive opted to remove these

# Methods

# Analysis
