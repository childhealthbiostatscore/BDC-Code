---
title: "a1c by tech sub analyses"
author: "Casey Sakamoto"
date: '2022-05-20'
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(tidyverse)
library(knitr)
library(readxl)
library(lubridate)
library(table1)
library(nlme) # mixed models
library(emmeans)
library(RColorBrewer)

knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "S:/Laura/BDC/Projects/Todd Alonso/A1c trends 2017 to 2021 by tech"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
}
knitr::opts_knit$set(root.dir = home_dir)
rm(home_dir)

#import data
a1c_tech_2016 <- read_excel("S:/Laura/BDC/Projects/Todd Alonso/A1c trends 2017 to 2021 by tech/Data raw/Change in A1c 2017 to 2021_new.xlsx", 
    sheet = "2016-2017")
a1c_tech_2020 <- read_excel("S:/Laura/BDC/Projects/Todd Alonso/A1c trends 2017 to 2021 by tech/Data raw/Change in A1c 2017 to 2021_new.xlsx", 
    sheet = "2020-2021")
a1c_tech_2020$`Race/Ethnicity` = a1c_tech_2020$`Race/ethnicity`
a1c_tech_2020 = a1c_tech_2020 %>% select(-`Race/ethnicity`)

a1c_tech = full_join(a1c_tech_2016, a1c_tech_2020)

a1c_tech = a1c_tech %>% mutate(Race_Ethn = `Race/Ethnicity`) %>% select(-`Race/Ethnicity`)
label(a1c_tech$Race_Ethn) = "Race/Ethnicity"
```


```{r data clean, include=FALSE}
# only patients w data in both time windows 
# used cgm/pump visits instead of the actual variables to create groups to align with Todd's counts
analysis = a1c_tech %>% 
  mutate(time_group = case_when(year(VisitDate) == 2016 | year(VisitDate) == 2017 ~ "2016-2017",
                                year(VisitDate) == 2020 | year(VisitDate) == 2021 ~ "2020-2021"),
         tech_group = case_when(Pump_VisitDate == "Y" & CGM_VisitDate == "Y" ~ "CGM + Pump",
                                Pump_VisitDate == "Y" & CGM_VisitDate != "Y" ~ "Pump Alone",
                                Pump_VisitDate != "Y" & CGM_VisitDate == "Y" ~ "CGM Alone",
                                TRUE ~ "None")) %>% 
  select(EPICMRN, VisitDate, Age_A1cResultDate, A1c_Value, tech_group, time_group, DiabetesDuration_A1cResultDate, Gender, Race_Ethn) 

# factor tech type for order
analysis$tech_group = factor(analysis$tech_group, levels = c("CGM + Pump", "CGM Alone", "Pump Alone", "None"))


# list of id's in both subj
id_list = analysis %>% group_by(EPICMRN) %>% summarise(n = n())
id_list = id_list %>% filter(n == 2) %>% select(EPICMRN)
# filter based on list
analysis = analysis %>% filter(EPICMRN %in% id_list$EPICMRN); rm(id_list)


# for group change paste 2017 and 2020 group into a variable, filter by same/same (subanalsyis2) or switched groups (3)
a_2017 = analysis %>% filter(time_group == "2016-2017") %>% mutate(grp2016 = tech_group) %>% select(EPICMRN, grp2016)
a_2020 = analysis %>% filter(time_group == "2020-2021") %>% mutate(grp2020 = tech_group) %>% select(EPICMRN, grp2020)
a_combined = full_join(a_2017, a_2020) %>% mutate(tech_group_change = paste0(grp2016, "/", grp2020)); rm(a_2017, a_2020)

analysis = full_join(analysis, a_combined) # only those with both time windows
same_groups =  c("None/None", "Pump Alone/Pump Alone", "CGM Alone/CGM Alone", "CGM + Pump/CGM + Pump" )
analysis_same_grp = analysis %>% filter(tech_group_change %in% same_groups)
analysis_switch_grp = analysis %>% filter(grp2016 != grp2020)
```

```{r 2 visits, include = FALSE}
# Fit random intercept model
a1c_mod = lme(A1c_Value ~ Age_A1cResultDate + DiabetesDuration_A1cResultDate + Race_Ethn + tech_group + time_group + tech_group*time_group,
            random = ~1|EPICMRN,
            data = analysis,
            na.action = na.omit)

a1c_mod2 = lme(A1c_Value ~ Age_A1cResultDate +  tech_group + Race_Ethn + time_group + tech_group*time_group,
            random = ~1|EPICMRN,
            data = analysis,
            na.action = na.omit)
# Anova
mod_anova = anova.lme(a1c_mod, type="marginal")
mod2_anova =  anova.lme(a1c_mod2, type="marginal")
# Means
mod_means = emmeans(a1c_mod,specs=pairwise ~ tech_group:time_group, adjust="tukey")
  
# Plot
a1c_predict = cbind(analysis, a1cpred = predict(a1c_mod))
```

```{r same grp, include = FALSE}
# Fit random intercept model
a1c_mod_2 = lme(A1c_Value ~ Age_A1cResultDate + Race_Ethn + DiabetesDuration_A1cResultDate + tech_group + time_group + tech_group*time_group,
            random = ~1|EPICMRN,
            data = analysis_same_grp,
            na.action = na.omit)

a1c_mod2_2 = lme(A1c_Value ~ Age_A1cResultDate + Race_Ethn +  tech_group + time_group + tech_group*time_group,
            random = ~1|EPICMRN,
            data = analysis_same_grp,
            na.action = na.omit)
# Anova
mod_anova_2 = anova.lme(a1c_mod_2, type="marginal")
mod2_anova_2 =  anova.lme(a1c_mod2_2, type="marginal")
# Means
mod_means_2 = emmeans(a1c_mod_2,specs=pairwise ~ tech_group:time_group, adjust="tukey")
  
# Plot
a1c_predict_2 = cbind(analysis_same_grp, a1cpred = predict(a1c_mod_2))

# table for number in each group
same_t1 = table1(~tech_group,data = analysis_same_grp)
```

```{r changed grop, include=FALSE}
# model
a1c_mod_switch = lme(A1c_Value ~ Age_A1cResultDate + Race_Ethn +  tech_group_change + time_group + tech_group_change*time_group,
            random = ~1|EPICMRN,
            data = analysis_switch_grp,
            na.action = na.omit)
# anova
mod_anova_switch = anova.lme(a1c_mod_switch, type="marginal")
# means 
mod_means_switch = emmeans(a1c_mod_switch,specs=pairwise ~ tech_group_change:time_group, adjust="tukey")
  
# Plot
a1c_predict_switch = cbind(analysis_switch_grp, a1cpred = predict(a1c_mod_switch))


# table for number in each group
switch_t1 = table1(~tech_group_change,data = analysis_switch_grp)
```
# Outstanding Data Questions/ Remarks

* n/a

# Methods

A1c values were modeled with a Linear Mixed Model with time groups(2016-2017, 2020-2021) and tech groups(CGM+Pump, CGM only, Pump Only, None) and an interaction term of time and tech, adjusting for age and diabetes duration. A random intercept for subject was added to account for subjects with repeated measurements. Contrasts of estimated marginal means (least squares means) were used to determine the difference within tech groups at each time point.

For subanalyses, data were filtered for: 
* including patients with data in both time windows
* patients with data in both windows who remained in the same group
* patients who switched groups

# Analysis

## Model Fit and Contrasts (Both Time Windows)

Adjusting for age, race, and diabetes duration, there is a significant difference in A1c within the different tech groups across the 2016-2017 and 2020-2021 time periods (p < 0.0001).

The average A1c decreased by 0.44 (95% CI : 0.25, 0.63) in the CGM + Pump group (p < 0.0001), increased by 0.41 (95% CI: 0.14, 0.68) in the Pump Only groups (p = 0.01), and increased by 0.81 (95% CI: 0.55, 1.07) in the No Tech group (p < 0.0001). There was no significant difference in the time periods within the CGM only group (p = 1.00) 

```{r both windows}
kable(mod_anova,digits = 3,caption = "Test of Overall Effect")

kable(mod_means$contrasts[c(4,11,17,22),],digits = 3,caption = "Timepoint Means")

ggplot(data = a1c_predict,aes(x = time_group, y = a1cpred, group = tech_group, color = tech_group))+
  geom_smooth(method = lm, se = F,na.rm = T) + 
  xlab("Time Groups") + ylab("Predicted Mean A1c") + theme_classic() 
```

## Model Fit and Contrasts (Both Time Windows, Stayed Same Groups)
```{r table1 same}
same_t1
```
Adjusting for age and diabetes duration, there is a significant difference in A1c within the different tech groups across the 2016-2017 and 2020-2021 time periods (p < 0.0001).

The average A1c decreased by 0.45 (95% CI : 0.24, 0.66) in the CGM + Pump group (p < 0.0001), and increased by 0.83 (95% CI: 0.53, 1.13) in the No Tech group (p < 0.0001). There was no significant difference in the time periods within the CGM only group (p = 0.994) and the pump only group (p = 0.129) 
```{r both windows same grp}
kable(mod_anova_2,digits = 3,caption = "Test of Overall Effect")

kable(mod_means_2$contrasts[c(4,11,17,22),],digits = 3,caption = "Timepoint Means")

ggplot(data = a1c_predict_2,aes(x = time_group, y = a1cpred, group = tech_group, color = tech_group))+
  geom_smooth(method = lm, se = F,na.rm = T) + 
  xlab("Time Groups") + ylab("Predicted Mean A1c") + theme_classic() 
```

## Change in A1C for those who Switched Groups

Formatted 2016-2017 group/ 2020-2021 group
```{r table1 swtch}
switch_t1
```
Adjusting for age and race, there is a significant difference in A1c within the different tech groups across the 2016-2017 and 2020-2021 time periods (p < 0.0001).

There was a significant difference in A1c for patients who went from the CGM + Pump to Pump only (increased by 0.966, p = 0.038)
There was a significant difference in A1c for patients who went from Pump only to CGM + Pump (decreased by 0.585, p < 0.0001)


```{r both windowsswtch grp}
kable(mod_anova_switch,digits = 3,caption = "Test of Overall Effect")

kable(mod_means_switch$contrasts[c(12, 35, 57, 78, 98, 117, 135, 152, 168, 183, 197, 210),],digits = 3,caption = "Timepoint Means")

ggplot(data = a1c_predict_switch,aes(x = time_group, y = a1cpred, group = tech_group_change, color = tech_group_change, linetype = tech_group_change))+
  geom_smooth(method = lm, se = F,na.rm = T) + scale_linetype_manual(values = c(rep("dashed", 6), rep("solid", 6))) +
  xlab("Time Groups") + ylab("Predicted Mean A1c")  +   
  scale_color_manual(values = c(brewer.pal(6, "Paired"), brewer.pal(6, "Paired"))) + theme_classic()
```