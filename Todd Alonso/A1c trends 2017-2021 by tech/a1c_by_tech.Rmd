---
title: "A1C by Tech in first year"
author: "Casey Sakamoto"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(arsenal)
library(tidyverse)
library(performance)
library(knitr)
library(readxl)
library(lubridate)
library(Hmisc)

knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "S:/Laura/BDC/Projects/Todd Alonso/A1c trends 2017 to 2021 by tech"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
}
knitr::opts_knit$set(root.dir = home_dir)
rm(home_dir)

#import data
a1c_tech = read_excel("S:/Laura/BDC/Projects/Todd Alonso/A1c trends 2017 to 2021 by tech/Data raw/Change in A1c 2017 to 2021 by tech_only encounters to be used for analysis.xlsx")
```



```{r data clean, include=FALSE}
# stratify into oct-march 2016-2017 and oct-march 2020-2021
analysis = a1c_tech %>% 
  mutate(time_group = case_when(year(VisitDate) == 2016 | year(VisitDate) == 2017 ~ "2016-2017",
                                year(VisitDate) == 2020 | year(VisitDate) == 2021 ~ "2020-2021"),
         tech_group = case_when(tolower(InsulinRegimen) == "insulin pump" & CGM == "Yes" ~ "CGM + Pump",
                                tolower(InsulinRegimen) == "insulin pump" & CGM != "Yes" ~ "Pump Alone",
                                tolower(InsulinRegimen) != "insulin pump" & CGM == "Yes" ~ "CGM Alone",
                                TRUE ~ "None")) %>% 
  select(EPICMRN, VisitDate, Age_VisitDate, A1c_Value, tech_group, InsulinRegimen, CGM, time_group) 

# factor tech type for order
analysis$tech_group = factor(analysis$tech_group, levels = c("CGM + Pump", "CGM Alone", "Pump Alone", "None"))

```

```{r plot, include=FALSE}
a1ctech_plot_loess = ggplot(data = analysis, aes(x = Age_VisitDate, y = A1c_Value, color = tech_group, linetype = time_group)) + geom_smooth(method = "loess", se = FALSE) + theme_classic() + labs(title = "Loess")

a1ctech_plot_gam = ggplot(data = analysis, aes(x = Age_VisitDate, y = A1c_Value, color = tech_group, linetype = time_group)) + geom_smooth(method = "gam", se = FALSE) + theme_classic() + labs(title = "gam")

a1ctech_plot_lm = ggplot(data = analysis, aes(x = Age_VisitDate, y = A1c_Value, color = tech_group, linetype = time_group)) + geom_smooth(method = "lm", se = FALSE) + theme_classic() + labs(title = "lm")
```


```{r plots}
a1ctech_plot_loess
a1ctech_plot_gam
a1ctech_plot_lm
```