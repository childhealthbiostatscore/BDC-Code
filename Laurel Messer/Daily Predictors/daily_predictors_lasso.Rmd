---
title: "Daily Predictors for Diabetes Management"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(Hmisc)
library(arsenal)
library(skimr)
library(knitr)
library(tidyverse)
library(lubridate)
library(redcapAPI)
library(nlme)
library(glmmLasso)
library(parallel)
library(caret)
library(glmnet)
library(UpSetR)
knitr::opts_chunk$set(echo = F)
home_dir = ifelse(.Platform$OS.type != "unix","Z:/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects",
                  "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects")
knitr::opts_knit$set(root.dir = home_dir)
set.seed(1017)
```

```{r clean data}
source("~/GitHub/BDC-Code/Laurel Messer/Daily Predictors/clean_data.r")
# Combine race columns
race_cols = paste0("pt_race___",1:6)
races = c("White","Black or African American","American Indian or Alaskan Native",
          "Asian","Native Hawaiian or Pacific Islander","Other")
data$race = apply(data[,race_cols], 1, function(r){
  paste0(races[which(r == 1)],collapse = ", ")
})
# Calculate age and duration
data$age = as.numeric(ymd(data$pt_visit_date) - ymd(data$pt_dob))/365.25
data$duration = as.numeric(ymd(data$pt_visit_date) - ymd(data$dxdate))/365.25
# ID as factor for glmmLasso
data$record_id = as.factor(data$record_id)
```

# Participant Characteristics

```{r results = 'asis'}
# Get first row for each person
demographics = data %>% group_by(record_id) %>% filter(row_number() == 1)
# Table 
t1 = tableby(~ age + duration + pt_a1c + pt_baseline1.factor + pt_baseline5.factor + 
               pt_gender.factor + race + pt_eth.factor + p1_hedu.factor + 
               p2_hedu.factor,demographics)
# Labels
new_labels = list(age = "Age", duration = "Diabetes Duration", pt_a1c = "Baseline HbA1c",
                  pt_baseline1.factor = "Pump Hx",pt_baseline5.factor = "CGM Hx",
                  pt_gender.factor = "Gender", race = "Race", pt_eth.factor = "Ethnicity", 
                  p1_hedu.factor = "Parent 1 Education", p2_hedu.factor = "Parent 2 Education")
summary(t1,labelTranslations = new_labels)
```

# Regularization (LASSO) Results

```{r}
# Correlation between engagement survey items and subscores and:
#   Number of insulin boluses
#   Average glucose level
#   Percent time glucose levels 70-180 mg/dl (“Time-in-Range”, TIR)
#   Goal Survey Scores
morning_items = colnames(data)[grep("esq\\d+$",colnames(data))]
evening_items = colnames(data)[grep("esq\\d+_eve$",colnames(data))]
# Outcomes
goal_survey = c("n_highalerts","dm_caretime","dm_thinktime","gsq1","gsq2","gsq3")
outcomes = c("boluses","smg","tir",goal_survey)
# ID Variables
id_vars = c("record_id","redcap_event_name","es_datetimecapture")
# Optimal lambda function = needs id variables, one outcome, and predictors (nothing else)
lambda_cv = function(df,outcome_name,fam = "gaussian",
                     folds = 5,core_ratio = 0.75,n_lambda = 100){
  # Make model formula
  pred = colnames(df)[which(!colnames(df) %in% c(outcome_name,id_vars))]
  form = as.formula(paste(outcome_name,"~",paste(pred,collapse = "+")))
  # K-fold cross validation
  k = folds
  # Select min and max lambda values to try using cv.glmnet on baseline values
  # t = df %>% group_by(record_id) %>% filter(row_number()==1)
  # lambdas = cv.glmnet(as.matrix(t[,pred]),as.matrix(t[,outcome_name]),family = fam)$lambda
  # lambdas = seq(min(lambdas),max(lambdas),length.out = n_lambda)
  lambdas = seq(0,100,length.out = 100)
  # Try all the different lambdas
  cl <- makeCluster(detectCores()*core_ratio, type='PSOCK')
  clusterExport(cl,list('groupKFold','glmmLasso','R2','RMSE','MAE',
                        'outcome_name','form','lambdas','df','k','fam'),
                envir=environment())
  metrics = parLapply(cl,lambdas, function(l){
    # Cross validate
    sample <- groupKFold(df$record_id,k = k)
    cv = lapply(sample, function(s){
      # Training from group K
      train  <- df[s, ]
      # Test set
      test <- df[-s, ]
      # Fit - fairly different model results with REML vs. EM, but REML is really slow.
      # Use EM for cross validation, REML for final model fit.
      mod <- try(suppressWarnings(glmmLasso(form, rnd = list(record_id=~1),
                                            family = fam,
                                            data = train,lambda=l)),
                 silent = T)
      if(class(mod)!="try-error"){
        # Model performance
        predicted <- predict(mod, test)
        data.frame(R2 = R2(predicted, test[,outcome_name]),
                   RMSE = RMSE(predicted, test[,outcome_name]),
                   MAE = MAE(predicted, test[,outcome_name]))
      } else {
        data.frame(R2 = NA,
                   RMSE = NA,
                   MAE = NA)
      }
    })
    cv = do.call(rbind,cv)
    return(c(l,colMeans(cv,na.rm = T)))
  })
  stopCluster(cl)
  metrics = data.frame(do.call(rbind,metrics))
  colnames(metrics)[1] = "lambda"
  return(metrics)
}
```

## Morning survey

### Number of boluses

```{r}
fam = poisson(link = "log")
# Get morning variables
bolus_morning = data[,c(id_vars,morning_items,"boluses")]
bolus_morning = bolus_morning[complete.cases(bolus_morning),]
# CV for lambda values
lambda_perf = lambda_cv(df = bolus_morning,outcome_name = "boluses",
                        fam = fam)
best_lambda = lambda_perf$lambda[which.min(lambda_perf$RMSE)]
# Fit model
form = as.formula(paste0("boluses~",paste0(morning_items,collapse = "+")))
bolus_morning_mod = suppressWarnings(
  glmmLasso(form, rnd = list(record_id=~1),family = fam,
            data = bolus_morning,lambda=best_lambda)
)
# Get coefficients
bolus_morning_coefs = names(bolus_morning_mod$coefficients)[
  which(bolus_morning_mod$coefficients != 0 & 
          names(bolus_morning_mod$coefficients) != "(Intercept)")]

```

### SMG

```{r echo=TRUE}
fam = gaussian()
# Get morning variables
smg_morning = data[,c(id_vars,morning_items,"smg")]
smg_morning = smg_morning[complete.cases(smg_morning),]
# CV for lambda values
lambda_perf = lambda_cv(df = smg_morning,outcome_name = "smg",
                        fam = fam)
best_lambda = lambda_perf$lambda[which.min(lambda_perf$RMSE)]
# Fit model
form = as.formula(paste0("smg~",paste0(morning_items,collapse = "+")))
smg_morning_mod = suppressWarnings(
  glmmLasso(form, rnd = list(record_id=~1),
            family = fam,data = smg_morning,lambda=best_lambda)
)
# Get coefficients
smg_morning_coefs = names(smg_morning_mod$coefficients)[
  which(smg_morning_mod$coefficients != 0 & 
          names(smg_morning_mod$coefficients) != "(Intercept)")]
```

### TIR

```{r}
fam = gaussian()
# Get morning variables
tir_morning = data[,c(id_vars,morning_items,"tir")]
tir_morning = tir_morning[complete.cases(tir_morning),]
# CV for lambda values
lambda_perf = lambda_cv(df = tir_morning,outcome_name = "tir",
                        fam = fam)
best_lambda = lambda_perf$lambda[which.min(lambda_perf$RMSE)]
# Fit model
form = as.formula(paste0("tir~",paste0(morning_items,collapse = "+")))
tir_morning_mod = suppressWarnings(
  glmmLasso(form, rnd = list(record_id=~1),
            family = fam,data = tir_morning,lambda=best_lambda)
)
# Get coefficients
tir_morning_coefs = names(tir_morning_mod$coefficients)[
  which(tir_morning_mod$coefficients != 0 & 
          names(tir_morning_mod$coefficients) != "(Intercept)")]
```

### Upset plot

```{r}
# Format output
selected = do.call(rbind,list(
  morning_items %in% bolus_morning_coefs,
  morning_items %in% smg_morning_coefs,
  morning_items %in% tir_morning_coefs
))
colnames(selected) = morning_items
selected = data.frame(apply(selected,2,as.numeric))
# Plot
upset(selected, sets = morning_items, order.by = "freq")
```



## Evening survey



# Questions for Laurel and Emily

1. How should we combine levels of race and parent education? White vs. non-white? Above a bachelor's degree vs. bachelor's and below?
