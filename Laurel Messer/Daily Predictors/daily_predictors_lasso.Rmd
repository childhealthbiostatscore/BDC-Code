---
title: "Daily Predictors for Diabetes Management"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(Hmisc)
library(arsenal)
library(skimr)
library(knitr)
library(tidyverse)
library(lubridate)
library(redcapAPI)
library(nlme)
library(glmmLasso)
library(parallel)
library(caret)
library(glmnet)
library(UpSetR)
knitr::opts_chunk$set(echo = F,cache = T)
home_dir = ifelse(.Platform$OS.type != "unix","Z:/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects",
                  "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects")
knitr::opts_knit$set(root.dir = home_dir)
set.seed(1017)
```

```{r clean data}
source("~/GitHub/BDC-Code/Laurel Messer/Daily Predictors/clean_data.r")
# Combine race columns
race_cols = paste0("pt_race___",1:6)
races = c("White","Black or African American","American Indian or Alaskan Native",
          "Asian","Native Hawaiian or Pacific Islander","Other")
data$race = apply(data[,race_cols], 1, function(r){
  paste0(races[which(r == 1)],collapse = ", ")
})
# Calculate age and duration
data$age = as.numeric(ymd(data$pt_visit_date) - ymd(data$pt_dob))/365.25
data$duration = as.numeric(ymd(data$pt_visit_date) - ymd(data$dxdate))/365.25
# ID as factor for glmmLasso
data$record_id = as.factor(data$record_id)
# Correlation between engagement survey items and subscores and:
#   Number of insulin boluses
#   Average glucose level
#   Percent time glucose levels 70-180 mg/dl (“Time-in-Range”, TIR)
#   Goal Survey Scores
morning_items = colnames(data)[grep("esq\\d+$",colnames(data))]
evening_items = colnames(data)[grep("esq\\d+_eve$",colnames(data))]
# Outcomes
outcomes = c("boluses","smg","tir","n_highalerts","dm_caretime","dm_thinktime","gsq")
# ID Variables
id_vars = c("record_id","redcap_event_name","date")
# Combine date columns
data$es_date = as.Date.character(lubridate::ymd_hm(data$es_datetimecapture))
data$es_date_eve = as.Date.character(lubridate::ymd_hm(data$es_datetimecapture_eve))
data = data %>% unite(date,dmi_date,es_date,es_date_eve,remove = F,na.rm = T)
data$date = sapply(strsplit(data$date,"_"),function(x){
  ifelse(length(x)==0,NA,
         unique(strsplit(x,"_")[[1]]))
})
# Average gsq scores
data$gsq = rowMeans(data[,c("gsq1","gsq2","gsq3")],na.rm = T)
data$gsq[is.nan(data$gsq)] = NA
# Fill outcome in by date
data = data %>% group_by(record_id,date) %>%
  fill(all_of(outcomes),.direction = "downup") %>%
  ungroup()
# Remove outcomes not on a 24 hour scale
data = data[-which(data$n_highalerts > 500),]
data = data[-which(data$dm_thinktime > 12000),]
```

# Participant Characteristics

```{r results = 'asis'}
# Get first row for each person
demographics = data %>% group_by(record_id) %>% filter(row_number() == 1)
# Table 
t1 = tableby(~ age + duration + pt_a1c + pt_baseline1.factor + pt_baseline5.factor + 
               pt_gender.factor + race + pt_eth.factor + p1_hedu.factor + 
               p2_hedu.factor,demographics)
# Labels
new_labels = list(age = "Age", duration = "Diabetes Duration", pt_a1c = "Baseline HbA1c",
                  pt_baseline1.factor = "Pump Hx",pt_baseline5.factor = "CGM Hx",
                  pt_gender.factor = "Gender", race = "Race", pt_eth.factor = "Ethnicity", 
                  p1_hedu.factor = "Parent 1 Education", p2_hedu.factor = "Parent 2 Education")
summary(t1,labelTranslations = new_labels)
```

# Regularization (LASSO) Results

```{r}
# Optimal lambda function = needs id variables, one outcome, and predictors (nothing else)
lambda_cv = function(df,outcome_name,fam = "gaussian",n_lambda = 1000,folds = 5,
                     core_ratio = 0.75,num_coef_higher = 10){
  # Convert to dataframe since these functions can't handle tibbles
  df = data.frame(df)
  # Make model formula
  pred = colnames(df)[which(!colnames(df) %in% c(outcome_name,id_vars))]
  form = as.formula(paste(outcome_name,"~",paste(pred,collapse = "+")))
  # Find lambda starting values
  starts = seq(0,5000,by = 100)
  lambda_start = lapply(starts, function(l){
    mod <- try(suppressWarnings(glmmLasso(form, rnd = list(record_id=~1),
                                          family = fam,
                                          data = df,lambda=l)),
               silent = T)
    num_coefs = ifelse(class(mod)!="try-error",sum(coef(mod) != 0),NA)
  })
  lambda_start = data.frame("starts" = starts,"coefs" = unlist(lambda_start))
  max_lambda = lambda_start$starts[min(which(lambda_start[,2] <= num_coef_higher))]
  min_lambda = lambda_start$starts[max(which(lambda_start[,2] == length(pred)))]
  lambdas = seq(min_lambda,max_lambda,length.out = n_lambda)
  # K-fold cross validation
  k = folds
  # Try lots of different lambdas
  cl <- makeCluster(detectCores()*core_ratio, type='PSOCK')
  clusterExport(cl,list('groupKFold','glmmLasso','R2','RMSE','MAE',
                        'outcome_name','form','lambdas','df','k','fam'),
                envir=environment())
  metrics = parLapply(cl,lambdas,function(l){
    # Cross validate
    sample <- groupKFold(df$record_id,k = k)
    cv = lapply(sample, function(s){
      # Training from group K
      train  <- df[s, ]
      # Test set
      test <- df[-s, ]
      # Fit - fairly different model results with REML vs. EM, but REML is really slow.
      mod <- try(suppressWarnings(glmmLasso(form, rnd = list(record_id=~1),
                                            family = fam,
                                            data = train,lambda=l)),
                 silent = T)
      if(class(mod)!="try-error"){
        # Model performance
        predicted <- predict(mod, test)
        data.frame(R2 = R2(predicted, test[,outcome_name]),
                   RMSE = RMSE(predicted, test[,outcome_name]),
                   MAE = MAE(predicted, test[,outcome_name]))
      } else {
        data.frame(R2 = NA,
                   RMSE = NA,
                   MAE = NA)
      }
    })
    cv = do.call(rbind,cv)
    # Fit again to get final number of coefficients
    mod <- try(suppressWarnings(glmmLasso(form, rnd = list(record_id=~1),
                                          family = fam,
                                          data = df,lambda=l)),
               silent = T)
    num_coefs = ifelse(class(mod)!="try-error",sum(coef(mod) != 0),NA)
    return(c(l,colMeans(cv,na.rm = T),num_coefs))
  })
  stopCluster(cl)
  metrics = data.frame(do.call(rbind,metrics))
  colnames(metrics)[1] = "lambda"
  colnames(metrics)[5] = "num_coefs"
  return(metrics)
}
# Find lambda values where the performance is within 1 SD of the minimum and number of 
# coefficients is between user-specified bounds. Of these, pick the lambda with 
# the minimum error.
best_lambdas = function(perf_metrics = lambda_perf,metric = "RMSE",
                        num_coef_lower = 1,num_coef_higher = 10){
  m = min(perf_metrics[,metric],na.rm = T)
  s = sd(perf_metrics[,metric],na.rm = T)
  sd1 = which(perf_metrics[,metric] >= m - s & perf_metrics[,metric] >= m + s &
                perf_metrics[,"num_coefs"] <= num_coef_higher & 
                perf_metrics[,"num_coefs"] >= num_coef_lower)
  final = sd1[which.min(perf_metrics[sd1,metric])]
  return(perf_metrics$lambda[final])
}
```

## Morning survey

### Number of boluses

#### Selected variables

```{r}
fam = poisson(link = "log")
# Get morning variables
bolus_morning = data[,c(id_vars,morning_items,"boluses")]
bolus_morning = bolus_morning[complete.cases(bolus_morning),]
# CV for lambda values
lambda_perf = lambda_cv(df = bolus_morning,outcome_name = "boluses",fam = fam)
best = best_lambdas(lambda_perf,"RMSE",num_coef_lower = 5,num_coef_higher = 10)
# Fit model
form = as.formula(paste0("boluses~",paste0(morning_items,collapse = "+")))
bolus_morning_mod = suppressWarnings(
  glmmLasso(form, rnd = list(record_id=~1),family = fam,
            data = bolus_morning,lambda=best)
)
# Get coefficients
bolus_morning_coefs = names(bolus_morning_mod$coefficients)[
  which(bolus_morning_mod$coefficients != 0 & 
          names(bolus_morning_mod$coefficients) != "(Intercept)")]
# Print
l = labels(data[,bolus_morning_coefs])
kable(cbind(names(l),as.character(l)),col.names = c("Variable","Description"))
```

#### Model performance

```{r}
kable(lambda_perf[lambda_perf$lambda == best,c("R2","RMSE")])
```

### SMG

#### Selected variables

```{r}
fam = gaussian()
# Get morning variables
smg_morning = data[,c(id_vars,morning_items,"smg")]
smg_morning = smg_morning[complete.cases(smg_morning),]
# CV for lambda values
lambda_perf = lambda_cv(df = smg_morning,outcome_name = "smg",fam = fam)
best = best_lambdas(lambda_perf,"RMSE",num_coef_lower = 5,num_coef_higher = 10)
# Fit model
form = as.formula(paste0("smg~",paste0(morning_items,collapse = "+")))
smg_morning_mod = suppressWarnings(
  glmmLasso(form, rnd = list(record_id=~1),family = fam,
            data = smg_morning,lambda=best)
)
# Get coefficients
smg_morning_coefs = names(smg_morning_mod$coefficients)[
  which(smg_morning_mod$coefficients != 0 & 
          names(smg_morning_mod$coefficients) != "(Intercept)")]
# Print
l = labels(data[,smg_morning_coefs])
kable(cbind(names(l),as.character(l)),col.names = c("Variable","Description"))
```

#### Model performance

```{r}
kable(lambda_perf[lambda_perf$lambda == best,c("R2","RMSE")])
```

### TIR

#### Selected variables

```{r}
fam = gaussian()
# Get morning variables
tir_morning = data[,c(id_vars,morning_items,"tir")]
tir_morning = tir_morning[complete.cases(tir_morning),]
# CV for lambda values
lambda_perf = lambda_cv(df = tir_morning,outcome_name = "tir",fam = fam)
best = best_lambdas(lambda_perf,"RMSE",num_coef_lower = 5,num_coef_higher = 10)
# Fit model
form = as.formula(paste0("tir~",paste0(morning_items,collapse = "+")))
tir_morning_mod = suppressWarnings(
  glmmLasso(form, rnd = list(record_id=~1),family = fam,
            data = tir_morning,lambda=best)
)
# Get coefficients
tir_morning_coefs = names(tir_morning_mod$coefficients)[
  which(tir_morning_mod$coefficients != 0 & 
          names(tir_morning_mod$coefficients) != "(Intercept)")]
# Print
l = labels(data[,tir_morning_coefs])
kable(cbind(names(l),as.character(l)),col.names = c("Variable","Description"))
```

#### Model performance

```{r}
kable(lambda_perf[lambda_perf$lambda == best,c("R2","RMSE")])
```

### Number of high alerts

#### Selected variables

```{r}
fam = poisson(link = "log")
# Get morning variables
alerts_morning = data[,c(id_vars,morning_items,"n_highalerts")]
alerts_morning = alerts_morning[complete.cases(alerts_morning),]
# CV for lambda values
lambda_perf = lambda_cv(df = alerts_morning,outcome_name = "n_highalerts",fam = fam)
best = best_lambdas(lambda_perf,"RMSE",num_coef_lower = 5,num_coef_higher = 10)
# Fit model
form = as.formula(paste0("n_highalerts~",paste0(morning_items,collapse = "+")))
alerts_morning_mod = suppressWarnings(
  glmmLasso(form, rnd = list(record_id=~1),family = fam,
            data = alerts_morning,lambda=best)
)
# Get coefficients
alerts_morning_coefs = names(alerts_morning_mod$coefficients)[
  which(alerts_morning_mod$coefficients != 0 & 
          names(alerts_morning_mod$coefficients) != "(Intercept)")]
# Print
l = labels(data[,alerts_morning_coefs])
kable(cbind(names(l),as.character(l)),col.names = c("Variable","Description"))
```

#### Model performance

```{r}
kable(lambda_perf[lambda_perf$lambda == best,c("R2","RMSE")])
```

### Time spent caring for diabetes

#### Selected variables

```{r}
fam = poisson(link = "log")
# Get morning variables
caretime_morning = data[,c(id_vars,morning_items,"dm_caretime")]
caretime_morning = caretime_morning[complete.cases(caretime_morning),]
# Transform outcome - cube root
caretime_morning$dm_caretime = (caretime_morning$dm_caretime)^(1/3)
# CV for lambda values
lambda_perf = lambda_cv(df = caretime_morning,outcome_name = "dm_caretime",fam = fam)
best = best_lambdas(lambda_perf,"RMSE",num_coef_lower = 5,num_coef_higher = 10)
# Fit model
form = as.formula(paste0("dm_caretime~",paste0(morning_items,collapse = "+")))
caretime_morning_mod = suppressWarnings(
  glmmLasso(form, rnd = list(record_id=~1),family = fam,
            data = caretime_morning,lambda=best)
)
# Get coefficients
caretime_morning_coefs = names(caretime_morning_mod$coefficients)[
  which(caretime_morning_mod$coefficients != 0 & 
          names(caretime_morning_mod$coefficients) != "(Intercept)")]
# Print
l = labels(data[,caretime_morning_coefs])
kable(cbind(names(l),as.character(l)),col.names = c("Variable","Description"))
```

#### Model performance

```{r}
kable(lambda_perf[lambda_perf$lambda == best,c("R2","RMSE")])
```

### Time spent thinking about diabetes

#### Selected variables

```{r}
fam = poisson(link = "log")
# Get morning variables
thinktime_morning = data[,c(id_vars,morning_items,"dm_thinktime")]
thinktime_morning = thinktime_morning[complete.cases(thinktime_morning),]
# Transform outcome - cube root
thinktime_morning$dm_thinktime = (thinktime_morning$dm_thinktime)^(1/3)
# CV for lambda values
lambda_perf = lambda_cv(df = thinktime_morning,outcome_name = "dm_thinktime",fam = fam)
best = best_lambdas(lambda_perf,"RMSE",num_coef_lower = 5,num_coef_higher = 10)
# Fit model
form = as.formula(paste0("dm_thinktime~",paste0(morning_items,collapse = "+")))
thinktime_morning_mod = suppressWarnings(
  glmmLasso(form, rnd = list(record_id=~1),family = fam,
            data = thinktime_morning,lambda=best)
)
# Get coefficients
thinktime_morning_coefs = names(thinktime_morning_mod$coefficients)[
  which(thinktime_morning_mod$coefficients != 0 & 
          names(thinktime_morning_mod$coefficients) != "(Intercept)")]
# Print
l = labels(data[,thinktime_morning_coefs])
kable(cbind(names(l),as.character(l)),col.names = c("Variable","Description"))
```

#### Model performance

```{r}
kable(lambda_perf[lambda_perf$lambda == best,c("R2","RMSE")])
```

### Average GSQ score

#### Selected variables

```{r}
fam = gaussian()
# Get morning variables
gsq_morning = data[,c(id_vars,morning_items,"gsq")]
gsq_morning = gsq_morning[complete.cases(gsq_morning),]
# CV for lambda values
lambda_perf = lambda_cv(df = gsq_morning,outcome_name = "gsq",fam = fam)
best = best_lambdas(lambda_perf,"RMSE",num_coef_lower = 5,num_coef_higher = 10)
# Fit model
form = as.formula(paste0("gsq~",paste0(morning_items,collapse = "+")))
gsq_morning_mod = suppressWarnings(
  glmmLasso(form, rnd = list(record_id=~1),family = fam,
            data = gsq_morning,lambda=best)
)
# Get coefficients
gsq_morning_coefs = names(gsq_morning_mod$coefficients)[
  which(gsq_morning_mod$coefficients != 0 & 
          names(gsq_morning_mod$coefficients) != "(Intercept)")]
# Print
l = labels(data[,gsq_morning_coefs])
kable(cbind(names(l),as.character(l)),col.names = c("Variable","Description"))
```

#### Model performance

```{r}
kable(lambda_perf[lambda_perf$lambda == best,c("R2","RMSE")])
```

### Upset plot

```{r}
# Format output
selected_morning = do.call(rbind,list(
  morning_items %in% bolus_morning_coefs,
  morning_items %in% smg_morning_coefs,
  morning_items %in% tir_morning_coefs,
  morning_items %in% alerts_morning_coefs,
  morning_items %in% caretime_morning_coefs,
  morning_items %in% thinktime_morning_coefs,
  morning_items %in% gsq_morning_coefs
))
colnames(selected_morning) = morning_items
selected_morning = data.frame(apply(selected_morning,2,as.numeric))
# Plot
upset(selected_morning,nsets = ncol(selected_morning),order.by = "freq")
```

## Evening survey

### Number of boluses

#### Selected variables

```{r}
fam = poisson(link = "log")
# Get evening variables
bolus_evening = data[,c(id_vars,evening_items,"boluses")]
bolus_evening = bolus_evening[complete.cases(bolus_evening),]
# CV for lambda values
lambda_perf = lambda_cv(df = bolus_evening,outcome_name = "boluses",fam = fam)
best = best_lambdas(lambda_perf,"RMSE",num_coef_lower = 5,num_coef_higher = 10)
# Fit model
form = as.formula(paste0("boluses~",paste0(evening_items,collapse = "+")))
bolus_evening_mod = suppressWarnings(
  glmmLasso(form, rnd = list(record_id=~1),family = fam,
            data = bolus_evening,lambda=best)
)
# Get coefficients
bolus_evening_coefs = names(bolus_evening_mod$coefficients)[
  which(bolus_evening_mod$coefficients != 0 & 
          names(bolus_evening_mod$coefficients) != "(Intercept)")]
# Print
l = labels(data[,bolus_evening_coefs])
kable(cbind(names(l),as.character(l)),col.names = c("Variable","Description"))
```

#### Model performance

```{r}
kable(lambda_perf[lambda_perf$lambda == best,c("R2","RMSE")])
```

### SMG

#### Selected variables

```{r}
fam = gaussian()
# Get evening variables
smg_evening = data[,c(id_vars,evening_items,"smg")]
smg_evening = smg_evening[complete.cases(smg_evening),]
# CV for lambda values
lambda_perf = lambda_cv(df = smg_evening,outcome_name = "smg",fam = fam)
best = best_lambdas(lambda_perf,"RMSE",num_coef_lower = 5,num_coef_higher = 10)
# Fit model
form = as.formula(paste0("smg~",paste0(evening_items,collapse = "+")))
smg_evening_mod = suppressWarnings(
  glmmLasso(form, rnd = list(record_id=~1),family = fam,
            data = smg_evening,lambda=best)
)
# Get coefficients
smg_evening_coefs = names(smg_evening_mod$coefficients)[
  which(smg_evening_mod$coefficients != 0 & 
          names(smg_evening_mod$coefficients) != "(Intercept)")]
# Print
l = labels(data[,smg_evening_coefs])
kable(cbind(names(l),as.character(l)),col.names = c("Variable","Description"))
```

#### Model performance

```{r}
kable(lambda_perf[lambda_perf$lambda == best,c("R2","RMSE")])
```

### TIR

#### Selected variables

```{r}
fam = gaussian()
# Get evening variables
tir_evening = data[,c(id_vars,evening_items,"tir")]
tir_evening = tir_evening[complete.cases(tir_evening),]
# CV for lambda values
lambda_perf = lambda_cv(df = tir_evening,outcome_name = "tir",fam = fam)
best = best_lambdas(lambda_perf,"RMSE",num_coef_lower = 5,num_coef_higher = 10)
# Fit model
form = as.formula(paste0("tir~",paste0(evening_items,collapse = "+")))
tir_evening_mod = suppressWarnings(
  glmmLasso(form, rnd = list(record_id=~1),family = fam,
            data = tir_evening,lambda=best)
)
# Get coefficients
tir_evening_coefs = names(tir_evening_mod$coefficients)[
  which(tir_evening_mod$coefficients != 0 & 
          names(tir_evening_mod$coefficients) != "(Intercept)")]
# Print
l = labels(data[,tir_evening_coefs])
kable(cbind(names(l),as.character(l)),col.names = c("Variable","Description"))
```

#### Model performance

```{r}
kable(lambda_perf[lambda_perf$lambda == best,c("R2","RMSE")])
```

### Number of high alerts

#### Selected variables

```{r}
fam = poisson(link = "log")
# Get evening variables
alerts_evening = data[,c(id_vars,evening_items,"n_highalerts")]
alerts_evening = alerts_evening[complete.cases(alerts_evening),]
# CV for lambda values
lambda_perf = lambda_cv(df = alerts_evening,outcome_name = "n_highalerts",fam = fam)
best = best_lambdas(lambda_perf,"RMSE",num_coef_lower = 5,num_coef_higher = 10)
# Fit model
form = as.formula(paste0("n_highalerts~",paste0(evening_items,collapse = "+")))
alerts_evening_mod = suppressWarnings(
  glmmLasso(form, rnd = list(record_id=~1),family = fam,
            data = alerts_evening,lambda=best)
)
# Get coefficients
alerts_evening_coefs = names(alerts_evening_mod$coefficients)[
  which(alerts_evening_mod$coefficients != 0 & 
          names(alerts_evening_mod$coefficients) != "(Intercept)")]
# Print
l = labels(data[,alerts_evening_coefs])
kable(cbind(names(l),as.character(l)),col.names = c("Variable","Description"))
```

#### Model performance

```{r}
kable(lambda_perf[lambda_perf$lambda == best,c("R2","RMSE")])
```

### Time spent caring for diabetes

#### Selected variables

```{r}
fam = poisson(link = "log")
# Get evening variables
caretime_evening = data[,c(id_vars,evening_items,"dm_caretime")]
caretime_evening = caretime_evening[complete.cases(caretime_evening),]
# Transform outcome - cube root
caretime_evening$dm_caretime = (caretime_evening$dm_caretime)^(1/3)
# CV for lambda values
lambda_perf = lambda_cv(df = caretime_evening,outcome_name = "dm_caretime",fam = fam)
best = best_lambdas(lambda_perf,"RMSE",num_coef_lower = 5,num_coef_higher = 10)
# Fit model
form = as.formula(paste0("dm_caretime~",paste0(evening_items,collapse = "+")))
caretime_evening_mod = suppressWarnings(
  glmmLasso(form, rnd = list(record_id=~1),family = fam,
            data = caretime_evening,lambda=best)
)
# Get coefficients
caretime_evening_coefs = names(caretime_evening_mod$coefficients)[
  which(caretime_evening_mod$coefficients != 0 & 
          names(caretime_evening_mod$coefficients) != "(Intercept)")]
# Print
l = labels(data[,caretime_evening_coefs])
kable(cbind(names(l),as.character(l)),col.names = c("Variable","Description"))
```

#### Model performance

```{r}
kable(lambda_perf[lambda_perf$lambda == best,c("R2","RMSE")])
```

### Time spent thinking about diabetes

#### Selected variables

```{r}
fam = poisson(link = "log")
# Get evening variables
thinktime_evening = data[,c(id_vars,evening_items,"dm_thinktime")]
thinktime_evening = thinktime_evening[complete.cases(thinktime_evening),]
# Transform outcome - cube root
thinktime_evening$dm_thinktime = (thinktime_evening$dm_thinktime)^(1/3)
# CV for lambda values
lambda_perf = lambda_cv(df = thinktime_evening,outcome_name = "dm_thinktime",fam = fam)
best = best_lambdas(lambda_perf,"RMSE",num_coef_lower = 5,num_coef_higher = 10)
# Fit model
form = as.formula(paste0("dm_thinktime~",paste0(evening_items,collapse = "+")))
thinktime_evening_mod = suppressWarnings(
  glmmLasso(form, rnd = list(record_id=~1),family = fam,
            data = thinktime_evening,lambda=best)
)
# Get coefficients
thinktime_evening_coefs = names(thinktime_evening_mod$coefficients)[
  which(thinktime_evening_mod$coefficients != 0 & 
          names(thinktime_evening_mod$coefficients) != "(Intercept)")]
# Print
l = labels(data[,thinktime_evening_coefs])
kable(cbind(names(l),as.character(l)),col.names = c("Variable","Description"))
```

#### Model performance

```{r}
kable(lambda_perf[lambda_perf$lambda == best,c("R2","RMSE")])
```

### Average GSQ score

#### Selected variables

```{r}
fam = gaussian()
# Get evening variables
gsq_evening = data[,c(id_vars,evening_items,"gsq")]
gsq_evening = gsq_evening[complete.cases(gsq_evening),]
# CV for lambda values
lambda_perf = lambda_cv(df = gsq_evening,outcome_name = "gsq",fam = fam)
best = best_lambdas(lambda_perf,"RMSE",num_coef_lower = 5,num_coef_higher = 10)
# Fit model
form = as.formula(paste0("gsq~",paste0(evening_items,collapse = "+")))
gsq_evening_mod = suppressWarnings(
  glmmLasso(form, rnd = list(record_id=~1),family = fam,
            data = gsq_evening,lambda=best)
)
# Get coefficients
gsq_evening_coefs = names(gsq_evening_mod$coefficients)[
  which(gsq_evening_mod$coefficients != 0 & 
          names(gsq_evening_mod$coefficients) != "(Intercept)")]
# Print
l = labels(data[,gsq_evening_coefs])
kable(cbind(names(l),as.character(l)),col.names = c("Variable","Description"))
```

#### Model performance

```{r}
kable(lambda_perf[lambda_perf$lambda == best,c("R2","RMSE")])
```

### Upset plot

```{r}
# Format output
selected_evening = do.call(rbind,list(
  evening_items %in% bolus_evening_coefs,
  evening_items %in% smg_evening_coefs,
  evening_items %in% tir_evening_coefs,
  evening_items %in% alerts_evening_coefs,
  evening_items %in% caretime_evening_coefs,
  evening_items %in% thinktime_evening_coefs,
  evening_items %in% gsq_evening_coefs
))
colnames(selected_evening) = evening_items
selected_evening = data.frame(apply(selected_evening,2,as.numeric))
# Plot
upset(selected_evening,nsets = ncol(selected_evening),order.by = "freq")
```

