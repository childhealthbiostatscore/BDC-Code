---
title: "BBGD! Mixed Models"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(arsenal)
library(skimr)
library(knitr)
library(tidyverse)
library(caret)
library(glmnet)
library(Hmisc)
library(UpSetR)
library(GLMMadaptive)
library(lme4)
library(lmerTest)
library(emmeans)
knitr::opts_chunk$set(echo = FALSE)
home_dir = ifelse(.Platform$OS.type != "unix",
                  "Z:/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Kim Driscoll/Bring BG Down/",
                  "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Kim Driscoll/Bring BG Down/")
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data}
df = read.csv("./Data_Cleaned/cleaned_df.csv",na.strings = "")
# Variable formatting
df$X = NULL
df$c_gender = factor(df$c_gender)
# Dichotomize variables
df$Total.Household.Income = factor(df$Total.Household.Income)
levels(df$Total.Household.Income) = 
  c("$90K+","<$90K","<$90K","<$90K","<$90K","<$90K","<$90K","<$90K","<$90K","$90K+","<$90K")
df$Highest.Degree.Parent.Completed = factor(df$Highest.Degree.Parent.Completed)
levels(df$Highest.Degree.Parent.Completed) = 
  c("Associate's or High School","Bachelor's or above","Bachelor's or above",
    "Associate's or High School","Bachelor's or above")
df$Parent.s.Marital.Status = factor(df$Parent.s.Marital.Status)
levels(df$Parent.s.Marital.Status) = 
  c("Single","Living with Partner","Living with Partner","Single")
df = df %>% unite(Parent.Race.Ethnicity,Parent.Ethnicity,Parent.Race,na.rm = T,remove = F)
df$Parent.Race.Ethnicity[df$Parent.Race.Ethnicity == ""] = NA
df$Parent.Race.Ethnicity = factor(df$Parent.Race.Ethnicity)
levels(df$Parent.Race.Ethnicity) = c("Ethnic Minority","Ethnic Minority","White")
# Fix birthdays and age
df$c_dob[df$participant_id == 420] = "2007-05-15"
df$c_dob[df$participant_id == 429] = "2008-01-08"
df$age = as.numeric(difftime(lubridate::ymd(df$t1_date),lubridate::ymd(df$c_dob),
                             units = "days"))/365.25
# Fill down
df = df %>% filter(participant_id != 430) %>%
  group_by(participant_id) %>% fill(Total.Household.Income)
# Write for checking SAS models
write.csv(df,file = "./Data_Cleaned/cleaned_data_for_sas.csv",row.names = F)
```

# Table 1: Participant Characteristics

```{r results='asis'}
# Table 1
t1 = tableby(treatment_group~age+c_gender+Parent.Maintain.High.BG.of.HFS+Parent.Worry.Helplessness.Subscale.of.HFS+Parent.Social.Consequences.Subscale.of.HFS+Parent.GAD.7.Score+Private.Insurance+fe(Total.Household.Income)+fe(Parent.s.Marital.Status)+fe(Highest.Degree.Parent.Completed)+fe(Parent.Race.Ethnicity)+fe(Primary.Male.Caretaker),
             data = df[df$studyvisit == 1,])
summary(t1,pfootnote = T)
```

# Methods

All variables from Table 1 were included as covariates in model selection despite not being significantly different in univariate tests. Model selection for covariates was performed at study visit 1, because elasticnet regularization has not been implemented for longitudinal models. Time was treated as a continuous variable, and final models were re-fit using all timepoints. Elasticnet was used in place of the lasso because it is more effective when selecting between correlated variables. Optimal tuning parameters were selected to minimize root mean square error based on leave one out cross validation.

Household income and education were dichotomized into >= \$90K vs. < $90K and associate's degree or high school vs. bachelor's degree and above. Gender, income, and race were selected for all outcomes, and were thus included in the final model results (along with age, which is of clinical interest).

# Model results

```{r}
fit_mod = function(outcome,pred = predictors,dat = df,fam = "gaussian"){
  form = as.formula(paste0(outcome,"~","factor(studyvisit)*treatment_group+",
                           paste0(pred,collapse = "+"),"+(1|participant_id)"))
  zi_form = as.formula(paste0(outcome,"~","studyvisit*treatment_group+",
                              paste0(pred,collapse = "+")))
  fixed = as.formula(paste0("~",paste0(pred,collapse = "+")))
  if(fam == "gaussian"){
    mod = lmer(form,data = dat)
  } else if (fam == "zi.poisson"){
    # Complete cases
    dat = dat[,c("participant_id","studyvisit","treatment_group",outcome,pred)]
    dat = dat[complete.cases(dat),]
    mod = 
      mixed_model(update(form,.~.-(1|participant_id)), 
                  random = ~1|participant_id,zi_fixed = ~treatment_group,
                  data = dat,family = zi.poisson())
  }
  else {
    mod = glmer(form,data = dat,family = fam)
  }
  return(mod)
}
# Selected predictors
predictors = 
  c("age","c_gender","Total.Household.Income")
form = as.formula(paste0("~","studyvisit*treatment_group+",
                         paste0(predictors,collapse = "+")))
# Fill down
df = df %>% group_by(participant_id) %>% 
  fill(all_of(predictors))
```

## Parent Maintain High BG of HFS

```{r}
mod = lmer(update(form,Parent.Maintain.High.BG.of.HFS ~ .+(1|participant_id)),data = df)
kable(summary(mod)$coefficients,caption = "Mixed Model Coefficients")
```

```{r}
# Holly! Here below is how to get model means
# Model visit as categorical for easier plotting
plot_form = as.formula(paste0("~","factor(studyvisit)*treatment_group+",
                              paste0(predictors,collapse = "+")))
mod = lmer(update(plot_form,Parent.Maintain.High.BG.of.HFS ~ .+(1|participant_id)),data = df)
means = data.frame(emmeans(mod,~studyvisit+factor(treatment_group)))
# Plot
ggplot(means,aes(x = studyvisit,y = emmean,color = factor(treatment_group))) +
  geom_point() + geom_line() + 
  geom_errorbar(aes(ymin=emmean-SE, ymax=emmean+SE),width = 0.2) + 
  xlab("Visit") + ylab("Mean Score") +
  theme_bw()
```

## Parent Worry/Helplessness Subscale of HFS

```{r}
mod = lmer(update(form,Parent.Worry.Helplessness.Subscale.of.HFS ~ .+(1|participant_id)),
           data = df)
kable(summary(mod)$coefficients,caption = "Mixed Model Coefficients")
```

```{r}
# Holly! Here below is how to get model means
# Model visit as categorical for easier plotting
plot_form = as.formula(paste0("~","factor(studyvisit)*treatment_group+",
                              paste0(predictors,collapse = "+")))
mod = lmer(update(plot_form,Parent.Worry.Helplessness.Subscale.of.HFS ~ .+(1|participant_id)),
           data = df)
means = data.frame(emmeans(mod,~studyvisit+factor(treatment_group)))
# Plot
ggplot(means,aes(x = studyvisit,y = emmean,color = factor(treatment_group))) +
  geom_point() + geom_line() + 
  geom_errorbar(aes(ymin=emmean-SE, ymax=emmean+SE),width = 0.2) + 
  xlab("Visit") + ylab("Mean Score") +
  theme_bw()
```

## Parent Social Consequences Subscale of HFS

This outcome was analyzed using a zero-inflated Poisson model with random intercept for participant. Coefficients are interpreted on the log count scale. 

```{r}
mod = mixed_model(update(form,Parent.Social.Consequences.Subscale.of.HFS~.), 
              random = ~1|participant_id,zi_fixed = ~1,
              data = df,family = zi.poisson())
kable(summary(mod)$coef_table,caption = "Mixed Model Coefficients")
```

```{r}
# Holly! Here below is how to get model means
# Model visit as categorical for easier plotting
plot_form = as.formula(paste0("Parent.Social.Consequences.Subscale.of.HFS~",
                              "factor(studyvisit)*treatment_group+",
                              paste0(predictors,collapse = "+")))
mod = mixed_model(plot_form,random = ~1|participant_id,zi_fixed = ~1,
              data = df,family = zi.poisson())
means = data.frame(emmeans(mod,~studyvisit+factor(treatment_group)))
# Plot
ggplot(means,aes(x = studyvisit,y = emmean,color = factor(treatment_group))) +
  geom_point() + geom_line() + 
  geom_errorbar(aes(ymin=emmean-SE, ymax=emmean+SE),width = 0.2) + 
  xlab("Visit") + ylab("Mean Score") +
  theme_bw()
```

## Parent GAD-7 Score

This outcome was analyzed using a Poisson model with random intercept for participant. Coefficients are interpreted on the log count scale. 

```{r}
mod = glmer(update(form,Parent.GAD.7.Score~.+(1|participant_id)),data = df,
            family = "poisson",
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
kable(summary(mod)$coefficients,caption = "Mixed Model Coefficients")
```

```{r}
# Holly! Here below is how to get model means
# Model visit as categorical for easier plotting
plot_form = as.formula(paste0("~","factor(studyvisit)*treatment_group+",
                              paste0(predictors,collapse = "+")))
mod = lmer(update(plot_form,Parent.GAD.7.Score ~ .+(1|participant_id)),
           data = df)
means = data.frame(emmeans(mod,~studyvisit+factor(treatment_group)))
# Plot
ggplot(means,aes(x = studyvisit,y = emmean,color = factor(treatment_group))) +
  geom_point() + geom_line() + 
  geom_errorbar(aes(ymin=emmean-SE, ymax=emmean+SE),width = 0.2) + 
  xlab("Visit") + ylab("Mean Score") +
  theme_bw()
```
